<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design in Python: A Database</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design in Python</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../tester/">
      A Testing Framework
    </a>
  </li>
  
  <li>
    <a href="../interpreter/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../backup/">
      Versioned File Backups
    </a>
  </li>
  
  <li>
    <a href="../cache/">
      A File Cache
    </a>
  </li>
  
  <li>
    <a href="../persistence/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Storage
    </a>
  </li>
  
  <li>
    <a href="../builder/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../templating/">
      A Static Site Generator
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li>
    <a href="../matching/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parser/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../linter/">
      A Style Checker
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../packman/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../dataframe/">
      A Dataframe
    </a>
  </li>
  
  <li>
    <a href="../database/">
      <strong>A Database</strong>
    </a>
  </li>
  
  <li class="todo">
    <a href="../pipeline/">
      A Pipeline Runner
    </a>
  </li>
  
  <li class="todo">
    <a href="../editor/">
      An Editor
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 19: A Database</h1>


          
            
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">FIXME</li>
  
  </ul>
  

  

  


            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#index_database" markdown="1">index (a database)</a>, <a class="gl-ref" href="../glossary/#log_structured_db" markdown="1">log-structured database</a>, <a class="gl-ref" href="../glossary/#null_byte" markdown="1">null byte</a>, <a class="gl-ref" href="../glossary/#open_page" markdown="1">open page</a>, <a class="gl-ref" href="../glossary/#page" markdown="1">page</a>, <a class="gl-ref" href="../glossary/#row_wise" markdown="1">row-wise storage</a>, <a class="gl-ref" href="../glossary/#thrashing" markdown="1">thrashing</a>
</p>


            <div class="page-toc"></div>
            <p>The introduction said that this book would focus on tools programmers use themselves,
so a database may seem a little out of place.
However,
issue trackers, logging frameworks, and many other tools are built on top of databases,
and their implementation is a good way to introduce a few new ideas.
This chapter therefore shows how to build a
<span class="ix-entry" ix-key="log-structured database; database!log-structured" markdown="1"><a class="gl-ref" href="../glossary/#log_structured_db" markdown="1">log-structured database</a></span>
with four key features:</p>
<ol>
<li>
<p>It uses <span class="ix-entry" ix-key="row-wise storage; storage!row-wise" markdown="1"><a class="gl-ref" href="../glossary/#row_wise" markdown="1">row-wise</a></span> storage
    (<a class="x-ref" href="../dataframe/">Chapter 18</a>),
    i.e.,
    the values in each record are stored together.</p>
</li>
<li>
<p>The <span class="ix-entry" ix-key="database index; index!database" markdown="1"><a class="gl-ref" href="../glossary/#index_database" markdown="1">index</a></span>
    is stored in memory.</p>
</li>
<li>
<p>Existing records are never overwritten.
    Instead,
    new data is appended to the end of the database.</p>
</li>
</ol>
<p>Our implementation is based on
<span class="ix-entry" ix-key="Stack, Connor" markdown="1">Connor Stack</span>&lsquo;s <a href="https://cstack.github.io/db_tutorial/">Let&rsquo;s Build a Simple Database</a> tutorial
and on <span class="ix-entry" ix-key="Johnson, Nick" markdown="1">Nick Johnson</span>&lsquo;s article on
<a href="http://blog.notdot.net/2009/12/Damn-Cool-Algorithms-Log-structured-storage">log-structured storage</a>.</p>
<h2 id="database-memory">Section 19.1: In Memory</h2>
<p>To keep things simple,
our database will store a single table with three fields
(<a class="fig-ref" href="../database/#database-record">Figure 19.1</a>):</p>
<ul>
<li><code>userid</code>: a 32-bit integer.</li>
<li><code>machine</code>: a 16-byte string recording the name of a computer that user accessed.
    Note that the size is specified in bytes not characters;
    when we translate from <span class="ix-entry" ix-key="Unicode" markdown="1">Unicode</span> to bytes,
    we have to make sure the result is no larger than this.</li>
<li><code>timestamp</code>: a 32-bit integer representing the time the user accessed the machine.</li>
</ul>
<figure id="database-record">
  <img src="./database_record.svg" alt="Database record structure"/>
  <figcaption markdown="1">Figure 19.1: The structure of a single binary database record.</figcaption>
</figure>

<p>As we saw in <a class="x-ref" href="../binary/">Chapter 7</a>,
we can use Python&rsquo;s <a href="https://docs.python.org/3/library/struct.html">struct</a> module
to pack data into a binary record
and unpack those records to recover the values.
Let&rsquo;s define a couple of functions to do this,
along with a third function to report the size of each binary record:</p>
<div class="code-sample lang-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>


<span class="n">MACHINE_LEN</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">FORMAT</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;!i</span><span class="si">{</span><span class="n">MACHINE_LEN</span><span class="si">}</span><span class="s2">si&quot;</span>
<span class="n">PAGE_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="k">def</span> <span class="nf">record_pack</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MACHINE_LEN</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">record_unpack</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
    <span class="n">userid</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
    <span class="n">machine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">userid</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">timestamp</span>

<span class="k">def</span> <span class="nf">record_size</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Null bytes</h3>
<p>The function <code>record_unpack</code>
includes the expression <code>machine.split(b"\0", 1)[0]</code>.
To see why,
have a look at this short program and its output:</p>
<div class="code-sample lang-py" title="null_bytes.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">FORMAT</span> <span class="o">=</span> <span class="s2">&quot;8s&quot;</span>

<span class="n">original</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
<span class="n">buf</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

<span class="n">packed</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;packed data&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">packed</span><span class="p">))</span>

<span class="n">unpacked</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="n">packed</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unpacked data&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">unpacked</span><span class="p">)))</span>

<span class="n">final</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final data&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">final</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="null_bytes.out">
<div class="highlight"><pre><span></span><code>packed data b&#39;test\x00\x00\x00\x00&#39;
unpacked data &quot;b&#39;test\\x00\\x00\\x00\\x00&#39;&quot;
final data &#39;test\x00\x00\x00\x00&#39;
</code></pre></div>
</div>
<p><code>FORMAT</code> specifies that strings are stored in 8 bytes.
When we store a string that&rsquo;s shorter than this,
the struct module fills the trailing bytes with zero,
which is sometimes called a <a class="gl-ref" href="../glossary/#null_byte" markdown="1">null byte</a>.
When we unpack the data,
those null bytes are retained and wind up in our final string.
To get rid of them,
we have to split the buffer of packed data at the first null byte
and convert whatever comes before it
rather than converting the whole buffer.</p>
</div>
<p>Now that we have a way to represent records,
we need to think about how to store large numbers of them.
We will use fixed-size blocks of memory called
<span class="ix-entry" ix-key="page (in database)" markdown="1"><a class="gl-ref" href="../glossary/#page" markdown="1">pages</a></span> for this,
and pack as many records into each page as can fit
(<a class="fig-ref" href="../database/#database-packing">Figure 19.2</a>.</p>
<figure id="database-packing">
  <img src="./database_packing.svg" alt="Packing records into pages"/>
  <figcaption markdown="1">Figure 19.2: Packing database records into pages.</figcaption>
</figure>

<p>Each time we want to append a record to the database,
we check how much space is left in the current page.
If the record fits, we add it;
if not,
we start a new page.
If an application wants a record,
it provides the record&rsquo;s index;
after checking that it&rsquo;s valid,
we multiply the index by the record size
to find the starting location of the record in memory.
The whole class is:</p>
<div class="code-sample lang-py" title="page_memory.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DBError</span><span class="p">,</span> <span class="n">record_size</span>

<span class="n">RECORD_SIZE</span> <span class="o">=</span> <span class="n">record_size</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PageMemory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="n">PAGE_SIZE</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">page_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">=</span> <span class="n">page_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_size</span> <span class="o">=</span> <span class="n">RECORD_SIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="n">RECORD_SIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;Wrong size of record&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;No room for record&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="n">RECORD_SIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;Wrong size of record&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_size</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;Index out of range&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_size</span> <span class="o">*</span> <span class="n">index</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">start</span><span class="p">:(</span><span class="n">start</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_record_size</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Choosing a page size</h3>
<p>Every computer&rsquo;s filesystem manages storage using pages
like the ones we&rsquo;ve just created.
These pages are typically four kilobytes,
which means the basic unit of file I/O is that large.
Databases typically use the same size for their pages
to make data transfer as efficient as possible.</p>
</div>
<p>While <code>PageMemory</code> stores a page of records,
<code>DBMemory</code> stores a list of pages.
The last page in the list,
called the <span class="ix-entry" ix-key="open page" markdown="1"><a class="gl-ref" href="../glossary/#open_page" markdown="1">open page</a></span>,
is the only one the database can write to.
When an application wants to add a record,
<code>DBMemory</code> either appends it to the open page
or adds a new page to the end of the list:</p>
<div class="code-sample lang-py" title="db_memory.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DBMemory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="n">PAGE_SIZE</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">=</span> <span class="n">page_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">Page</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Page</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Equally,
when an application wants to retrieve a record,
<code>DBMemory</code> figures out which page that record must lie in
and asks the page to get it:</p>
<div class="code-sample lang-py" title="db_memory.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">records_per_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">//</span> <span class="n">record_size</span><span class="p">()</span>
        <span class="n">page_number</span> <span class="o">=</span> <span class="n">index</span> <span class="o">//</span> <span class="n">records_per_page</span>
        <span class="k">if</span> <span class="n">page_number</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;Index out of range&quot;</span><span class="p">)</span>
        <span class="n">within_page</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">records_per_page</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">page_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">within_page</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="database-retrieve">
  <img src="./database_retrieve.svg" alt="Retrieving database records"/>
  <figcaption markdown="1">Figure 19.3: Retrieving records from a paged database.</figcaption>
</figure>

<h2 id="database-file">Section 19.2: On Disk</h2>
<p>A database that only stores things in memory isn&rsquo;t particularly useful.
What we want is something that will save data to disk automatically,
and reload data on demand.
Let&rsquo;s extend <code>PageMemory</code> to create a new class <code>PageFile</code>
that can do this:</p>
<div class="code-sample lang-py" title="page_file.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">page_memory</span> <span class="kn">import</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PageMemory</span>

<span class="k">class</span> <span class="nc">PageFile</span><span class="p">(</span><span class="n">PageMemory</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_number</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="n">PAGE_SIZE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">page_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page_number</span> <span class="o">=</span> <span class="n">page_number</span>

    <span class="k">def</span> <span class="nf">page_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_number</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_path</span><span class="p">(</span><span class="n">db_dir</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_path</span><span class="p">(</span><span class="n">db_dir</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_page_number</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.page&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue"><code>PageFile</code> also keeps track of which page it is,
i.e.,
whether it is the first, the second, and so on.
Storing this information simplifies bookkeeping later on.</p>
<p><code>DBFile</code> is the counterpart to <code>PageFile</code>,
but after a bit of work we decided to write it from scratch
rather than extending <code>DBMemory</code>.
While the two database classes have some methods in common,
every single one of <code>DBMemory</code>&lsquo;s would have to be overridden
to create <code>DBFile</code>.</p>
<p><code>DBFile</code> still keeps all pages in memory,
but can also write them to disk and refill them when asked to.
It caches pages by page number:
<code>_ensure_space</code> adds a page if necessary;
the open page is the one with the highest page number at any time.
<code>_ensure_in_memory</code> is a placeholder for future work.
(We actually didn&rsquo;t create it until we started on the next version.)</p>
<div class="code-sample lang-py" title="db_file.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DBError</span><span class="p">,</span> <span class="n">record_size</span>
<span class="kn">from</span> <span class="nn">page_file</span> <span class="kn">import</span> <span class="n">PageFile</span> <span class="k">as</span> <span class="n">Page</span>

<span class="k">class</span> <span class="nc">DBFile</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="n">PAGE_SIZE</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span> <span class="o">=</span> <span class="n">db_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">=</span> <span class="n">page_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_space</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_page</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">num_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">records_per_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">//</span> <span class="n">record_size</span><span class="p">()</span>
        <span class="n">page_number</span> <span class="o">=</span> <span class="n">index</span> <span class="o">//</span> <span class="n">records_per_page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_in_memory</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>
        <span class="n">within_page</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">records_per_page</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">page_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">within_page</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="n">page_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_in_memory</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">page</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_number</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">page_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad bad number </span><span class="si">{</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">current_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_page</span><span class="o">.</span><span class="n">fits</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">current_page</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="p">)</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">current_page</span><span class="o">.</span><span class="n">page_number</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">next_page</span><span class="p">]</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">next_page</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_current_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">page_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span>
</code></pre></div>
</div>
<h2 id="database-swap">Section 19.3: Swapping Pages</h2>
<p>Databases exist in part because many datasets won&rsquo;t fit in memory.
The third step in building our database is therefore
to store only a subset of pages in memory at any time.
We will use the same <code>PageFile</code> structure,
but modify <code>DBFile</code> so that
<code>_ensure_in_memory</code> and <code>_ensure_space</code> call a new method <code>_maintain_cache</code>.
If there are too many pages in memory when we try to read or add a record,
<code>_maintain_cache</code> drops a page–but not the current page (yes, we made this mistake).
And not the page that&rsquo;s just been added (yes, we made this mistake too).</p>
<div class="code-sample lang-py" title="db_swap.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DBError</span><span class="p">,</span> <span class="n">record_size</span>
<span class="kn">from</span> <span class="nn">page_file</span> <span class="kn">import</span> <span class="n">PageFile</span> <span class="k">as</span> <span class="n">Page</span>
<span class="kn">from</span> <span class="nn">db_file</span> <span class="kn">import</span> <span class="n">DBFile</span>

<span class="k">class</span> <span class="nc">DBSwap</span><span class="p">(</span><span class="n">DBFile</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">,</span> <span class="n">max_pages</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="n">PAGE_SIZE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db_dir</span><span class="p">,</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_pages</span> <span class="o">=</span> <span class="n">max_pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">records_per_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span> <span class="o">//</span> <span class="n">record_size</span><span class="p">()</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">records_per_page</span> <span class="o">*</span> <span class="n">record_size</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">previous</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">num_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span><span class="o">.</span><span class="n">page_number</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_ensure_in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_number</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">page_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">page_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">page_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maintain_cache</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="n">current_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_page</span><span class="o">.</span><span class="n">fits</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">current_page</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="p">)</span>
        <span class="n">next_number</span> <span class="o">=</span> <span class="n">current_page</span><span class="o">.</span><span class="n">page_number</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">next_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_page_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">next_number</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maintain_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_current_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span>

    <span class="k">def</span> <span class="nf">_maintain_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_pages</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_page</span><span class="o">.</span><span class="n">page_number</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">exclude</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span>
</code></pre></div>
</div>
<p>While it&rsquo;s an improvement over its predecessors,
<code>DBSwap</code> does not track how recently pages have been used,
which means it is susceptible to <span class="ix-entry" ix-key="thrashing" markdown="1"><a class="gl-ref" href="../glossary/#thrashing" markdown="1">thrashing</a></span>:
we could load a page into memory,
dump it,
immediately re-load it,
dump it again,
and so on.
As in <a class="x-ref" href="../cache/">Chapter 5</a>,
we will explore ways to address this in the exercises.</p>
<h2 id="database-summary">Section 19.4: Summary</h2>
<figure id="database-concept-map">
  <img src="./database_concept_map.svg" alt="Concept map for databases"/>
  <figcaption markdown="1">Figure 19.4: Concepts for databases.</figcaption>
</figure>

<h2 id="database-exercises">Section 19.5: Exercises</h2>
          
        </main>
      </div>
    </div>
  </body>
</html>
