<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sdxpy">
  <meta name="build_date" content="2023-08-01">
  <meta name="template" content="default">
  <meta name="major" content="layout">
  <meta name="has_slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: Page Layout</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design by Example</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      Running Tests
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      Functions and Closures
    </a>
  </li>
  
  <li>
    <a href="../protocols/">
      Protocols
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      <strong>Page Layout</strong>
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../ftp/">
      Transferring Files
    </a>
  </li>
  
  <li>
    <a href="../http/">
      Serving Web Pages
    </a>
  </li>
  
  <li>
    <a href="../viewer/">
      A File Viewer
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../bonus/">
      Bonus Material
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 14: Page Layout</h1>


          
<div class="draft notex">
  <p class="draft">
    DRAFT 2023-08-01
  </p>
  <p>
    awaiting revision<br>
    Please use section heading links to submit feedback
    or go to <a href="https://github.com/gvwilson/sdxpy">https://github.com/gvwilson/sdxpy</a>.
  </p>
</div>


	  
<div class="chapterinfo">

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">A layout engine determines where to place text and other page elements based on their size and organization.</li>
  
  <li markdown="1">Page elements are organized as a tree of basic blocks, rows, and columns.</li>
  
  <li markdown="1">The layout engine calculates the position of each block based on its size and the position of its parent.</li>
  
  <li markdown="1">Drawing blocks on top of each other from top to bottom is an easy way to render them.</li>
  
  <li markdown="1">Use multiple inheritance and mixin classes to inject methods into classes without modifying their parent class.</li>
  
  </ul>
  

  

  

  

  

  

  

  

  

  

  

  

  



<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#gl:accidental_complexity" markdown="1">accidental complexity</a>, <a class="gl-ref" href="../glossary/#gl:block_page" markdown="1">block (on page)</a>, <a class="gl-ref" href="../glossary/#gl:confirmation_bias" markdown="1">confirmation bias</a>, <a class="gl-ref" href="../glossary/#gl:easy_mode" markdown="1">easy mode</a>, <a class="gl-ref" href="../glossary/#gl:intrinsic_complexity" markdown="1">intrinsic complexity</a>, <a class="gl-ref" href="../glossary/#gl:layout_engine" markdown="1">layout engine</a>, <a class="gl-ref" href="../glossary/#gl:liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a>, <a class="gl-ref" href="../glossary/#gl:mixin_class" markdown="1">mixin class</a>, <a class="gl-ref" href="../glossary/#gl:z_buffering" markdown="1">z-buffering</a>
</p>


</div>


          <div class="page-toc"></div>
          <p>You might be reading this as <span class="ix-entry" ix-key="HTML" markdown="1">HTML</span> in your browser,
as an e-book (which is basically the same thing),
or on the printed page.
In all three cases
a <a class="gl-ref" href="../glossary/#gl:layout_engine" title="A piece of software that decides where to place text, images, and other elements on a page." markdown="1">layout engine</a> took some text and some layout instructions
and decided where to put each character and image.
To explore how they work,
we will build a small layout engine
based on <span class="ix-entry" ix-key="Brubeck, Matt" markdown="1"><a href="https://limpet.net/mbrubeck/">Matt Brubeck&rsquo;s</a></span> <a href="https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html">tutorial</a>
and on <a href="https://pavpanchekha.com/">Pavel Panchekha</a> and <a href="https://twitter.com/chrishtr">Chris Harrelson&rsquo;s</a>
<a href="https://browser.engineering/"><em>Web Browser Engineering</em></a>.
Since our focus is layout rather than parsing,
we will create objects in memory that represent
<span class="ix-entry" ix-key="DOM" markdown="1">DOM</span> nodes
to test our ideas.</p>
<div class="callout">
<h3>Upside Down</h3>
<p>The <span class="ix-entry" ix-key="coordinate system" markdown="1">coordinate systems</span> for screens
puts (0, 0) in the upper left corner instead of the lower left.
X increases to the right as usual,
but Y increases as we go down, rather than up
(<a class="fig-ref" href="../layout/#layout-coordinate-system">Figure 14.1</a>).
This convention is a holdover from the days of teletype terminals
that printed lines on rolls of paper;
as <span class="ix-entry" ix-key="Hoye, Mike" markdown="1"><a href="http://exple.tive.org/blarg/">Mike Hoye</a></span> has <a href="http://exple.tive.org/blarg/2020/11/26/punching-holes/">observed</a>,
the past is all around us.</p>
</div>
<figure id="layout-coordinate-system">
<img src="./coordinate_system.svg" alt="Coordinate system"/>
<figcaption markdown="1">Figure 14.1: Coordinate system with (0, 0) in the upper left corner.</figcaption>
</figure>

<h2 id="layout-size">Section 14.2: Sizing</h2>
<p>Let&rsquo;s start on <a class="gl-ref" href="../glossary/#gl:easy_mode" title="A term borrowed from gaming meaning to do something with obstacles or difficulties simplified or removed, often for practice purposes." markdown="1">easy mode</a>
without margins, padding, line-wrapping, or other complications.
Everything we can put on the screen is represented as a rectangular cell,
and every cell is either a row, a column, or a <a class="gl-ref" href="../glossary/#gl:block_page" title="A rectangular region of a page that may contain text, images, and other visual elements along with other blocks." markdown="1">block</a>.
A block has a fixed width and height:</p>
<div class="code-sample lang-py" title="easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Block</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
</code></pre></div>
</div>
<p>A row arranges one or more cells horizontally;
its width is the sum of the widths of its children,
while its height is the height of its tallest <span class="ix-entry" ix-key="child" markdown="1">child</span>
(<a class="fig-ref" href="../layout/#layout-sizing">Figure 14.2</a>):</p>
<div class="code-sample lang-py" title="easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Row</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
            <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<figure id="layout-sizing">
<img src="./sizing.svg" alt="Calculating sizes of fixed blocks"/>
<figcaption markdown="1">Figure 14.2: Calculating sizes of blocks with fixed width and height.</figcaption>
</figure>

<p>Finally,
a column arranges one or more cells vertically:
its width is the width of its widest child
and its height is the sum of the heights of its children.
(Here and elsewhere we use the abbreviation <code>col</code> when referring to columns.)</p>
<div class="code-sample lang-py" title="easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Col</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
            <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
</code></pre></div>
</div>
<p>Rows and columns nest inside one another:
a row cannot span two or more columns,
and a column cannot cross the boundary between two rows.
We can therefore represent our document as a <span class="ix-entry" ix-key="tree" markdown="1">tree</span>
and calculate the width and height of each cell every time we need it.
This is simple but inefficient:
we could calculate both width and height at the same time
and <span class="ix-entry" ix-key="cache" markdown="1">cache</span> those values to avoid recalculation,
but we called this &ldquo;easy mode&rdquo; for a reason.</p>
<p>As simple as it is,
this code could still contain errors (and did during development),
so we write some tests to check that it works as desired
before trying to build anything more complicated:</p>
<div class="code-sample lang-py" title="test_easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">easy_mode</span> <span class="kn">import</span> <span class="n">Block</span><span class="p">,</span> <span class="n">Col</span><span class="p">,</span> <span class="n">Row</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_single_unit_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_large_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_row_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_column_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span>

<span class="c1"># [example]</span>
<span class="k">def</span> <span class="nf">test_lays_out_a_grid_of_rows_of_columns</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span>
        <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
        <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">14</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">22</span>
<span class="c1"># [/example]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_easy_mode.out">
<div class="highlight"><pre><span></span><code>========================= test session starts \
==========================
platform darwin -- Python 3.11.3, pytest-7.3.1, pluggy-1.0.0
rootdir: /sd4ds/layout
plugins: pyfakefs-5.2.2
collected 5 items

test_easy_mode.py ..... \
[100%]

========================== 5 passed in 0.01s \
===========================
</code></pre></div>
</div>
<h2 id="layout-position">Section 14.3: Positioning</h2>
<p>Once we know how big cells are we can figure out where to put them.
Suppose we start with the upper left corner of the browser:
upper because we lay out the page top-to-bottom
and left because we are doing left-to-right layout.
If the cell is a block, we place it there.
If the cell is a row, on the other hand,
we get its height
and then calculate its lower edge as y1 = y0 + height.
We then place the first child&rsquo;s upper-left corner at (x0, y1),
the second child&rsquo;s at (x0 + width0, y1), and so on
(<a class="fig-ref" href="../layout/#layout-layout">Figure 14.3</a>).
Similarly,
if the cell is a column
we place the first child at (x0, y0),
the next at (x0, y0 + height0),
and so on.</p>
<figure id="layout-layout">
<img src="./layout.svg" alt="Laying out rows and columns"/>
<figcaption markdown="1">Figure 14.3: Laying out rows and columns of fixed-size blocks.</figcaption>
</figure>

<p>To save ourselves some work we will derive the classes that know how to do layout
from the classes we wrote before.
Our blocks are:</p>
<div class="code-sample lang-py" title="placed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PlacedBlock</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">while our columns are:</p>
<div class="code-sample lang-py" title="placed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PlacedCol</span><span class="p">(</span><span class="n">Col</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="n">y_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y_current</span><span class="p">)</span>
            <span class="n">y_current</span> <span class="o">+=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;col&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">and our rows are:</p>
<div class="code-sample lang-py" title="placed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PlacedRow</span><span class="p">(</span><span class="n">Row</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># [place_row]</span>
    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">x_current</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child_y</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
            <span class="n">child</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x_current</span><span class="p">,</span> <span class="n">child_y</span><span class="p">)</span>
            <span class="n">x_current</span> <span class="o">+=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>
    <span class="c1"># [/place_row]</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;row&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
</code></pre></div>
</div>
<p>Once again,
we write and run some tests to check that everything is doing what it&rsquo;s supposed to:</p>
<div class="code-sample lang-py" title="test_placed.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedBlock</span> <span class="k">as</span> <span class="n">Block</span>
<span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedCol</span> <span class="k">as</span> <span class="n">Col</span>
<span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedRow</span> <span class="k">as</span> <span class="n">Row</span>

<span class="k">def</span> <span class="nf">test_places_a_single_unit_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_places_a_large_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_places_a_row_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">&quot;row&quot;</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">test_places_a_column_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">&quot;col&quot;</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_placed.out">
<div class="highlight"><pre><span></span><code>========================= test session starts \
==========================
platform darwin -- Python 3.11.3, pytest-7.3.1, pluggy-1.0.0
rootdir: /sd4ds/layout
plugins: pyfakefs-5.2.2
collected 5 items

test_placed.py ..... \
[100%]

========================== 5 passed in 0.01s \
===========================
</code></pre></div>
</div>
<h2 id="layout-render">Section 14.4: Rendering</h2>
<p>We drew blocks on graph paper
to figure out the expected answers for the tests shown above.
We can do something similar in software by creating a &ldquo;screen&rdquo; of space characters
and then having each block draw itself in the right place.
If we do this starting at the <span class="ix-entry" ix-key="root" markdown="1">root</span> of the tree,
child blocks will overwrite the markings made by their parents,
which will automatically produce the right appearance
(<a class="fig-ref" href="../layout/#layout-draw-over">Figure 14.4</a>).
(A more sophisticated version of this called <a class="gl-ref" href="../glossary/#gl:z_buffering" title="A drawing method that keeps track of the depth of what lies &quot;under&quot; each pixel so that it displays whatever is nearest to the observer." markdown="1">z-buffering</a>
keeps track of the visual depth of each pixel
in order to draw things in three dimensions.)</p>
<figure id="layout-draw-over">
<img src="./draw_over.svg" alt="Children drawing over their parents"/>
<figcaption markdown="1">Figure 14.4: Render blocks by drawing child nodes on top of parent nodes.</figcaption>
</figure>

<p>Our pretended screen is just an array of arrays of characters:</p>
<div class="code-sample lang-py" title="render.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_screen</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot; &quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">screen</span>
</code></pre></div>
</div>
<p class="continue">We will use successive lower-case characters to show each block,
i.e.,
the root block will draw itself using &lsquo;a&rsquo;,
while its children will be &lsquo;b&rsquo;, &lsquo;c&rsquo;, and so on.</p>
<div class="code-sample lang-py" title="render.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="n">next_fill</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fill</span>

<span class="k">def</span> <span class="nf">next_fill</span><span class="p">(</span><span class="n">fill</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;a&quot;</span> <span class="k">if</span> <span class="n">fill</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To teach each kind of cell how to render itself,
we have to derive a new class from each of the ones we have
and give the new class a <code>render</code> method with the same <span class="ix-entry" ix-key="signature" markdown="1">signature</span>.
Since Python supports <span class="ix-entry" ix-key="multiple inheritance" markdown="1">multiple inheritance</span>,
we can do this with a <a class="gl-ref" href="../glossary/#gl:mixin_class" title="A class that is not meant to be instantiated itself, but which contains methods to be added to other classes (typically via multiple inheritance)." markdown="1">mixin class</a>
(<a class="fig-ref" href="../layout/#layout-mixin">Figure 14.5</a>):</p>
<div class="code-sample lang-py" title="rendered.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedBlock</span><span class="p">,</span> <span class="n">PlacedCol</span><span class="p">,</span> <span class="n">PlacedRow</span>

<span class="k">class</span> <span class="nc">Renderable</span><span class="p">:</span>
    <span class="c1"># [render]</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">fill</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()):</span>
                <span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">iy</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
    <span class="c1"># [/render]</span>

<span class="k">class</span> <span class="nc">RenderedBlock</span><span class="p">(</span><span class="n">PlacedBlock</span><span class="p">,</span> <span class="n">Renderable</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RenderedCol</span><span class="p">(</span><span class="n">PlacedCol</span><span class="p">,</span> <span class="n">Renderable</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RenderedRow</span><span class="p">(</span><span class="n">PlacedRow</span><span class="p">,</span> <span class="n">Renderable</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</div>
<figure id="layout-mixin">
<img src="./mixin.svg" alt="Adding methods with a mixin class"/>
<figcaption markdown="1">Figure 14.5: Using multiple inheritance and a mixin class to add methods.</figcaption>
</figure>

<div class="callout">
<h3>(Not) The Right Way to Do It</h3>
<p>If we were building a real layout engine,
a cleaner solution would be to go back and create
a class called <code>Cell</code> with this <code>render</code> method,
then derive our <code>Block</code>, <code>Row</code>, and <code>Col</code> classes from that.
In general,
if two or more classes need to be able to do something,
we should add a method to do that to their lowest common ancestor.</p>
</div>
<p>Our simpler tests are a little easier to read using rendering,
though we still had to draw things on paper to figure out our complex ones:</p>
<div class="code-sample lang-py" title="test_rendered.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_renders_a_grid_of_rows_of_columns</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span>
        <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">render</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;bddd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bddd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cddd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cddd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ehhh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ehhh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ehhh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ehhh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eiig&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fiig&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fiig&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The fact that our tests are difficult to understand
is a sign that we should do more testing
It would be very easy for us to get a wrong result
and convince ourselves that it was actually correct;
<a class="gl-ref" href="../glossary/#gl:confirmation_bias" title="The tendency for someone to look for evidence that they are right rather than searching for reasons why they might be wrong." markdown="1">confirmation bias</a> of this kind
is very common in software development.</p>
<h2 id="layout-fit">Section 14.5: Wrapping</h2>
<p>One of the biggest differences between a browser and a printed page
is that the text in the browser wraps automatically as the window is resized.
(The other, these days, is that the printed page doesn&rsquo;t spy on us,
though someone is undoubtedly working on that.)</p>
<p>To add wrapping to our layout engine,
suppose we fix the width of a row.
If the total width of the children is greater than the row&rsquo;s width,
the layout engine needs to wrap the children around.
This assumes that columns can be made as tall as they need to be,
i.e.,
that we can grow vertically to make up for limited space horizontally.
It also assumes that none of a row&rsquo;s children is wider than the width of the row
so that each can fit in a row of its own if necessary.
We will look at what happens when this isn&rsquo;t true in the exercises.</p>
<p>Our layout engine manages wrapping by transforming the tree.
The height and width of blocks are fixed,
so they become themselves.
Columns become themselves as well,
but since they have children that might need to wrap,
the class representing columns needs a new method:</p>
<div class="code-sample lang-py" title="wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WrappedBlock</span><span class="p">(</span><span class="n">PlacedBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">WrappedCol</span><span class="p">(</span><span class="n">PlacedCol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PlacedCol</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
</code></pre></div>
</div>
<p>Rows do all the hard work.
Each original row is replaced with a new row
that contains a single column with one or more rows,
each of which is one &ldquo;line&rdquo; of wrapped cells
(<a class="fig-ref" href="../layout/#layout-wrap">Figure 14.6</a>).
This replacement is unnecessary when everything will fit on a single row,
but it&rsquo;s easiest to write the code that does it every time;
we will look at making this more efficient in the exercises.</p>
<figure id="layout-wrap">
<img src="./wrap.svg" alt="Wrapping rows"/>
<figcaption markdown="1">Figure 14.6: Wrapping rows by introducing a new row and column.</figcaption>
</figure>

<p>Our new wrappable row&rsquo;s constructor takes a fixed width followed by the children
and returns that fixed width when asked for its size:</p>
<div class="code-sample lang-py" title="wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WrappedRow</span><span class="p">(</span><span class="n">PlacedRow</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Need non-negative width&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>


    <span class="c1"># [bucket]</span>
    <span class="k">def</span> <span class="nf">_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_x</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">child_width</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">current_x</span> <span class="o">+</span> <span class="n">child_width</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                <span class="n">current_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">current_x</span> <span class="o">+=</span> <span class="n">child_width</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_row</span><span class="p">)</span>
                <span class="n">current_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="p">]</span>
                <span class="n">current_x</span> <span class="o">=</span> <span class="n">child_width</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_row</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c1"># [/bucket]</span>
</code></pre></div>
</div>
<p class="continue">Wrapping puts the row&rsquo;s children into buckets,
then converts the buckets to a row of a column of rows:</p>
<div class="code-sample lang-py" title="wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bucket</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
    <span class="n">new_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">PlacedRow</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="n">new_col</span> <span class="o">=</span> <span class="n">PlacedCol</span><span class="p">(</span><span class="o">*</span><span class="n">new_rows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PlacedRow</span><span class="p">(</span><span class="n">new_col</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Once again we bring forward all the previous tests
and write some new ones to test the functionality we&rsquo;ve added:</p>
<div class="code-sample lang-py" title="test_wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_wrap_a_row_of_two_blocks_that_do_not_fit_on_one_row</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">fixture</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
    <span class="n">wrapped</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">&quot;row&quot;</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;col&quot;</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
        <span class="p">],</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_wrapped.out">
<div class="highlight"><pre><span></span><code>========================= test session starts \
==========================
platform darwin -- Python 3.11.3, pytest-7.3.1, pluggy-1.0.0
rootdir: /sd4ds/layout
plugins: pyfakefs-5.2.2
collected 7 items

test_wrapped.py ....... \
[100%]

========================== 7 passed in 0.01s \
===========================
</code></pre></div>
</div>
<p>Note that we could have had columns handle resizing rather than rows,
but we (probably) don&rsquo;t need to make both resizeable.
This is an example of <a class="gl-ref" href="../glossary/#gl:intrinsic_complexity" title="The inherent difficult of a problem. The term is used in contrast to accidental complexity." markdown="1">intrinsic complexity</a>:
the problem really is this hard,
so something, somewhere, has to deal with it.
(Programs often contain <a class="gl-ref" href="../glossary/#gl:accidental_complexity" title="The extra difficulty added to a problem because of poor notation, poor tooling, an unclear problem statement, distractions, etc. The term is used in contrast with intrinsic complexity." markdown="1">accidental complexity</a>
as well,
which can be fixed if people are willing to accept that it is unnecessary
and are willing to change.
In practice,
these requirements usually mean that it isn&rsquo;t ever fixed.)</p>
<div class="callout">
<h3>The Liskov Substitution Principle</h3>
<p>We are able to re-use tests as our code evolved
because of the <a class="gl-ref" href="../glossary/#gl:liskov_substitution_principle" title="A design rule stating that it should be possible to replace objects in a program with objects of derived classes without breaking the program. Design by contract is intended to enforce this rule." markdown="1">Liskov Substitution Principle</a>,
which states that
it should be possible to replace objects in a program
with objects of derived classes
without breaking anything.
In order to satisfy this principle,
new code must handle the same set of inputs as the old code,
though it may be able to process more inputs as well.
Conversely,
its output must be a subset of what the old code produced
so that whatever is downstream from it won&rsquo;t be surprised.
Thinking in these terms leads to the methodology called
<span class="ix-entry" ix-key="design by contract" markdown="1">design by contract</span> discussed in <a class="x-ref" href="../oop/">Chapter 2</a>.</p>
</div>
<h2 id="layout-summary">Section 14.6: Summary</h2>
<figure id="layout-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map for page layout"/>
<figcaption markdown="1">Figure 14.7: Page layout concept map.</figcaption>
</figure>

<h2 id="layout-exercises">Section 14.7: Exercises</h2>
<h3 class="exercise">Refactoring</h3>
<p>Refactor the classes used to represent blocks, rows, and columns so that:</p>
<ol>
<li>
<p>They all derive from a common <span class="ix-entry" ix-key="parent class" markdown="1">parent class</span>.</p>
</li>
<li>
<p>All common behavior is defined in that parent (if only with placeholder methods).</p>
</li>
</ol>
<h3 class="exercise">Recycling</h3>
<p>Modify the wrapping code so that new rows and columns are only created if needed.
For example,
if a row of width 10 contains a text node that is only 4 characters wide,
a new row and column are <em>not</em> inserted.</p>
<h3 class="exercise">Rendering a Clear Background</h3>
<p>Modify the rendering code so that only the text in block nodes is shown,
i.e.,
so that the empty space in rows and columns is rendered as spaces.</p>
<h3 class="exercise">Clipping Text</h3>
<ol>
<li>
<p>Modify the wrapping and rendering so that
    if a block of text is too wide for the available space
    the extra characters are clipped.
    For example,
    if a column of width 5 contains a line &ldquo;unfittable&rdquo;,
    only &ldquo;unfit&rdquo; appears.</p>
</li>
<li>
<p>Extend your solution to break lines on spaces as needed
    in order to avoid clipping.</p>
</li>
</ol>
<h3 class="exercise">Bidirectional Rendering</h3>
<p>Modify the existing software to do either left-to-right or right-to-left rendering
upon request.</p>
<h3 class="exercise">Equal Sizing</h3>
<p>Modify the existing code to support elastic columns,
i.e.,
so that all of the columns in a row are automatically sized to have the same width.
If the number of columns does not divide evenly into the width of the row,
allocate the extra space as equally as possible from left to right.</p>
<h3 class="exercise">Drawing Borders</h3>
<ol>
<li>
<p>Modify the existing code so that elements are drawn with borders like this:</p>
<div class="highlight"><pre><span></span><code>+----+
|text|
+----+
</code></pre></div>
</li>
</ol>
<h3 class="exercise">Padding Elements</h3>
<p>Modify the existing code so that:</p>
<ol>
<li>
<p>Authors can define a <code>padding</code> <span class="ix-entry" ix-key="attribute" markdown="1">attribute</span> for row and column elements.</p>
</li>
<li>
<p>When the node is rendered, that many blank spaces are added on all four sides of the contents.</p>
</li>
</ol>
<p class="continue">For example, string <code>"text"</code> with a padding of 1 would render as:</p>
<div class="highlight"><pre><span></span><code>+------+
|      |
| text |
|      |
+------+
</code></pre></div>
<p class="continue">where the lines show the outer border of the rendering.</p>
<h3 class="exercise">Properties</h3>
<p>Look at the documentation for Python&rsquo;s <a href="https://docs.python.org/3/library/functions.html#property"><code>@property</code></a> <span class="ix-entry" ix-key="decorator" markdown="1">decorator</span>
and modify the block classes to replace the <code>get_width</code> and <code>get_height</code> methods
with properties called <code>width</code> and <code>height</code>.</p>
<h3 class="exercise">Tables</h3>
<p>Add another node type <code>Table</code> such that:</p>
<ol>
<li>
<p>All the children of a table must be rows.</p>
</li>
<li>
<p>Every row must contain exactly the same number of columns.</p>
</li>
<li>
<p>When the table is rendered, every column has the same width in every row.</p>
</li>
</ol>
        </main>
      </div>
    </div>
  </body>
</html>
