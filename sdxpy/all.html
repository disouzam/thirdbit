<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- paged.js links -->
  <link rel="stylesheet" href="pagedJS/css/book.css">
  <link rel="stylesheet" href="pagedJS/css/global/style.css">

  <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>
  <script src="https://unpkg.com/css-tree@1.1.2/dist/csstree.min.js"></script>
  <script src="pagedJS/js/imposition.js"></script>
  <script src="pagedJS/js/createToc.js"></script>
  <script src="pagedJS/js/reload-in-place.js"></script>
  <script src="pagedJS/js/bibref.js"></script>

  <script>
    // Hook to generate the ToC
    class toc extends Paged.Handler {
        constructor(chunker, polisher, caller) {
            super(chunker, polisher, caller);
        }

        beforeParsed(content) {
            createToc({
                content: content,
                tocElement: '.tocElement',
                titleElements: ['h1', 'h2']
            });
        }

    }
    Paged.registerHandlers(toc);
  </script>
  <title>Software Design in Python: a tool-based introduction</title>
</head>
<body>
    <section class="cover">
      <h1>Software Design in Python: a tool-based introduction</h1>
    </section>
    <section class="tocElement" id="tocElement">
      <h1 id="ToC">Table of Contents</h1>
    </section>
<section class="new-chapter"><h1 id="introduction">Chapter: Chapter 1: Introduction</h1>

<div class="page-toc"></div>
<blockquote>
<p>We shape our tools, and thereafter our tools shape us.</p>
<p>— Marshall McLuhan</p>
</blockquote>
<p>The best way to learn software design is to study examples,
and the best examples can be found in
the tools programmers use themselves.
These lessons therefore build small versions of file backup systems,
testing frameworks,
and regular expression matchers
in order to shed light on how experienced programmers think.
We also hope that if you know how these tools work,
you will be more likely to use them
and better able to use them well.</p>
<h2 id="introduction-audience">Section 1.1: Audience</h2>
<p>These <a href="https://teachtogether.tech/en/index.html#s:process-personas">personas</a> describe who this book is for <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Wilson2019">Wilson2019</a>]</span>:</p>
<ul>
<li>
<p>Aïsha has a master’s degree in genomics
    and does very complicated science things in a wet lab.
    She has taught herself enough Python to do some sophisticated data analysis,
    but is constantly frustrated by what she <em>doesn’t</em> know about how software actually works.
    This material will take away some of the mystery.</p>
</li>
<li>
<p>Rupinder is studying computer science at college.
    He uses Git and style checkers in his assignments
    and wants to know how they work.
    This material will take away some of the mystery
    and show him how to build new tools of his own.</p>
</li>
<li>
<p>Yim teaches two college courses on web programming.
    They are frustrated that so many books talk about algorithms but not about design
    and use examples that their students can’t relate to.
    This material will give them material they can use in class
    and starting points for course projects.</p>
</li>
</ul>
<p>Like these three personas, readers should be able to:</p>
<ul>
<li>
<p>Write Python programs using dictionaries, exceptions, and classes.
    (We assume that if you can use these,
    you can also use lists, loops, conditionals, and functions.)</p>
</li>
<li>
<p>Create static web pages using HTML and CSS.</p>
</li>
<li>
<p>Use <a href="https://git-scm.com/">Git</a> to save and share files.
    (It’s OK not to know <a href="https://git-man-page-generator.lokaltog.net/">the more obscure commands</a>.)</p>
</li>
<li>
<p>Process a tree’s nodes recursively.
    (Trees and recursion are the most complicated things we <em>don’t</em> explain.)</p>
</li>
</ul>
<p>You can read this book on its own or use it as a classroom resource.
If you need projects for a software design course,
adding a tool to those covered here would be fun as well as educational:
please email <a class="email" href="mailto:gvwilson@third-bit.com">gvwilson@third-bit.com</a> if you’d like to chat.</p>
<h2 id="introduction-contents">Section 1.2: Topics</h2>
<p>Programmers have invented <a href="https://en.wikipedia.org/wiki/Programming_tool">a lot of tools</a> over the years.
This book focuses on those that people use while building code,
but includes a few things (like databases and web servers)
that are primarily used in finished applications.</p>
<p><a class="x-ref" href="#glossary">Appendix F</a> defines the terms these lessons introduce,
which in turn define this book’s big ideas:</p>
<ul>
<li>
<p>How to process a program like any other piece of text.</p>
</li>
<li>
<p>How to turn a program into a data structure that can be analyzed and modified.</p>
</li>
<li>
<p>What design patterns are and which ones are used most often.</p>
</li>
<li>
<p>How programs are executed and how we can control and inspect their execution.</p>
</li>
<li>
<p>How we can analyze programs’ performance in order to make sensible design tradeoffs.</p>
</li>
<li>
<p>How to find and run code modules on the fly.</p>
</li>
</ul>
<h2 id="introduction-layout">Section 1.3: Layout</h2>
<p>We display Python source code like this:</p>
<div class="code-sample lang-py" title="python_sample.py">
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and Unix shell commands like this:</p>
<div class="code-sample lang-sh" title="shell_sample.sh">
<div class="highlight"><pre><span></span><code><span class="k">for</span> filename <span class="k">in</span> *.dat
<span class="k">do</span>
    cut -d , -f <span class="m">10</span> <span class="nv">$filename</span>
<span class="k">done</span>
</code></pre></div>
</div>
<p class="continue">Data files and program output are shown in italics:</p>
<div class="code-sample lang-out" title="output_sample.out">
<div class="highlight"><pre><span></span><code>Package,Releases
0,1
0-0,0
0-0-1,1
00print-lol,2
00smalinux,0
01changer,0
</code></pre></div>
</div>
<div class="code-sample lang-yml" title="data_sample.yml">
<div class="highlight"><pre><span></span><code>- name: read
  params:
  - sample_data.csv
</code></pre></div>
</div>
<p>We use <code>...</code> to show where lines have been omitted,
and occasionally wrap lines in unnatural ways to make them fit on the page.
Where we need to break lines for the same reason,
we end all but the last line with a single backslash <code>\</code>.
The full listings are all available in <a href="https://github.com/gvwilson/sdxpy">our Git repository</a>
and <a href="https://gvwilson.github.io/sdxpy">on our website</a>.</p>
<p>Finally,
we write functions as <code>function_name</code> rather than <code>function_name()</code>.
The latter is more common,
but people don’t use <code>array_name[]</code> for arrays,
and the empty parentheses makes it hard to tell
whether we’re talking about “the function itself” or “a call to the function with no parameters”.</p>
<h2 id="introduction-use">Section 1.4: Contributing</h2>
<p>All of the written material in this book
is available under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons - Attribution - NonCommercial 4.0 International license</a>
(CC-BY-NC-4.0),
while the software is available under the <a href="https://firstdonoharm.dev/">Hippocratic License</a>.
The first allows you to use and remix this material for non-commercial purposes,
as-is or in adapted form,
provided you cite its original source.
The second allows you to use and remix the software on this site
provided you do not violate international agreements governing human rights;
please see <a class="x-ref" href="#license">Appendix C</a> for details.</p>
<p>If you would like to improve what we have,
add new material,
or ask questions,
please file an issue in <a href="https://github.com/gvwilson/sdxpy">our GitHub repository</a>
or email <a class="email" href="mailto:gvwilson@third-bit.com">gvwilson@third-bit.com</a>.
Please note that all contributors are required to abide by our Code of Conduct
(<a class="x-ref" href="#conduct">Appendix D</a>).</p>
<h2 id="introduction-acknowledgments">Section 1.5: Acknowledgments</h2>
<p>This book was inspired by
classics like <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Kernighan1979">Kernighan1979</a>, <a class="bib-ref" href="../bibliography/#Kernighan1981">Kernighan1981</a>, <a class="bib-ref" href="../bibliography/#Kernighan1983">Kernighan1983</a>, <a class="bib-ref" href="../bibliography/#Kernighan1988">Kernighan1988</a>, <a class="bib-ref" href="../bibliography/#Petre2016">Petre2016</a>]</span>,
and by:</p>
<ul>
<li>the entries in the <a href="https://aosabook.org/"><em>Architecture of Open Source Applications</em></a> series <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Brown2011">Brown2011</a>, <a class="bib-ref" href="../bibliography/#Brown2012">Brown2012</a>, <a class="bib-ref" href="../bibliography/#Armstrong2013">Armstrong2013</a>, <a class="bib-ref" href="../bibliography/#Brown2016">Brown2016</a>]</span>;</li>
<li><a href="https://maryrosecook.com/">Mary Rose Cook</a>‘s <a href="http://gitlet.maryrosecook.com/">Gitlet</a>;</li>
<li><a href="https://limpet.net/mbrubeck/">Matt Brubeck</a>‘s <a href="https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html">browser engine tutorial</a>;</li>
<li><a href="https://pavpanchekha.com/">Pavel Panchekha</a> and <a href="https://twitter.com/chrishtr">Chris Harrelson</a>‘s <a href="https://browser.engineering/"><em>Web Browser Engineering</em></a></li>
<li><a href="https://connorstack.com/">Connor Stack</a>‘s <a href="https://cstack.github.io/db_tutorial/">database tutorial</a>;</li>
<li><a href="https://arcanis.github.io/">Maël Nison</a>‘s <a href="https://classic.yarnpkg.com/blog/2017/07/11/lets-dev-a-package-manager/">package manager tutorial</a>;</li>
<li><a href="https://viewsourcecode.org/">Paige Ruten</a>‘s <a href="https://viewsourcecode.org/snaptoken/kilo/index.html">kilo text editor</a>
    and <a href="https://wasimlorgat.com/">Wasim Lorgat</a>‘s <a href="https://wasimlorgat.com/posts/editor.html">editor tutorial</a>;</li>
<li><a href="http://journal.stuffwithstuff.com/">Bob Nystrom</a>‘s <a href="https://craftinginterpreters.com/"><em>Crafting Interpreters</em></a> <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Nystrom2021">Nystrom2021</a>]</span>;
    and </li>
<li><a href="https://jvns.ca/">Julia Evans</a>‘ posts and <a href="https://wizardzines.com/">zines</a>.</li>
</ul>
<p>I am also grateful to the creators of
<a href="https://black.readthedocs.io/">Black</a>,
<a href="https://flake8.pycqa.org/">flake8</a>,
<a href="https://github.com/carpentries/glosario">Glosario</a>,
<a href="https://www.gnu.org/software/make/">GNU Make</a>,
<a href="https://pycqa.github.io/isort/">isort</a>,
<a href="https://www.dmulholl.com/docs/ivy/main/">ivy</a>,
<a href="https://www.latex-project.org/">LaTeX</a>,
<a href="https://pip.pypa.io/">pip</a>,
<a href="https://www.python.org/">Python</a>,
<a href="https://chrome.google.com/webstore/detail/svg-screenshot/nfakpcpmhhilkdpphcjgnokknpbpdllg">SVG Screenshot</a>,
<a href="https://wave.webaim.org/">WAVE</a>,
and many other open source tools:
if we all give a little,
we all get a lot.</p>
<div class="center">
<p><em>This one’s for Mike and Jon:</em>
<br/>
<em>I’m glad you’ve always found it hard to say no.</em></p>
</div>
</section>
<section class="new-chapter"><h1 id="tester">Chapter: Chapter 2: A Testing Framework</h1>

<ul class="syllabus">
<li markdown="1">Functions are objects you can save in data structures or pass to other functions.</li>
<li markdown="1">Python stores local and global variables in dictionary-like structures.</li>
<li markdown="1">A unit test function performs an operation on a fixture and passes, fails, or produces an error.</li>
<li markdown="1">A program can introspect to find functions and other objects at runtime.</li>
<li markdown="1">Temporarily replacing functions with mock objects can simplify testing.</li>
<li markdown="1">Python defines protocols so that users' code can be triggered by keywords in the language.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>, <a class="gl-ref" href="../glossary/#actual_result" markdown="1">actual result (of test)</a>, <a class="gl-ref" href="../glossary/#assertion" markdown="1">assertion</a>, <a class="gl-ref" href="../glossary/#context_manager" markdown="1">context manager</a>, <a class="gl-ref" href="../glossary/#defensive_programming" markdown="1">defensive programming</a>, <a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a>, <a class="gl-ref" href="../glossary/#error_test" markdown="1">error (result of test)</a>, <a class="gl-ref" href="../glossary/#expected_result" markdown="1">expected result (of test)</a>, <a class="gl-ref" href="../glossary/#fail_test" markdown="1">failure (result of test)</a>, <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>, <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>, <a class="gl-ref" href="../glossary/#mock_object" markdown="1">mock object</a>, <a class="gl-ref" href="../glossary/#pass_test" markdown="1">pass (result of test)</a>, <a class="gl-ref" href="../glossary/#protocol" markdown="1">protocol</a>, <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>, <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>, <a class="gl-ref" href="../glossary/#stdout" markdown="1">standard output</a>, <a class="gl-ref" href="../glossary/#throw_exception" markdown="1">throw exception</a>, <a class="gl-ref" href="../glossary/#unit_test" markdown="1">unit test</a>
</p>
<div class="page-toc"></div>
<p>We’re going to write a lot of programs in this book.
To make sure they work correctly,
we’re going to write a lot of <a class="gl-ref" href="../glossary/#unit_test" markdown="1">unit tests</a> using <a href="https://docs.pytest.org/">pytest</a>.
Like the earlier tools that inspired it <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Meszaros2007">Meszaros2007</a>]</span>,
<a href="https://docs.pytest.org/">pytest</a> finds and runs tests automatically;
to show how,
this chapter builds a simple unit testing framework.
It also introduces the single most important idea in this book:</p>
<div class="center">
<p><em>Programs are just another kind of data.</em></p>
</div>
<h2 id="tester-funcobj">Section 2.1: Storing and Running Tests</h2>
<p>The first thing we need to understand is that a function is an object.
While the bytes in a string represent characters
and the bytes in an image represent pixels,
the bytes in a function are instructions
(<a class="fig-ref" href="../tester/#tester-func-obj">Figure 2.1</a>).
When Python executes the code below,
it creates an object in memory
that contains the instructions to print a string
and assigns that object to the variable <code>example</code>:</p>
<div class="code-sample lang-py" title="func_obj.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"in example"</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="tester-func-obj">
<img alt="Bytes as characters, pixels, or instructions" src="./tester/tester_func_obj.svg"/>
<figcaption markdown="1">Figure 2.1: Bytes can be interpreted as text, images, instructions, and more.</figcaption>
</figure>
<p>We can assign the function to another variable:</p>
<div class="code-sample lang-py" title="func_obj.py">
<div class="highlight"><pre><span></span><code><span class="n">alias</span> <span class="o">=</span> <span class="n">example</span>
<span class="n">alias</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_obj.out">
<div class="highlight"><pre><span></span><code>in example
</code></pre></div>
</div>
<p class="continue">or replace the function by assigning a new value
to the original variable:</p>
<div class="code-sample lang-py" title="replacement.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">replacement</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"in replacement"</span><span class="p">)</span>

<span class="n">example</span> <span class="o">=</span> <span class="n">replacement</span>
<span class="n">example</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="replacement.out">
<div class="highlight"><pre><span></span><code>in replacement
</code></pre></div>
</div>
<p>We can also store functions in a list just like numbers or strings
(<a class="fig-ref" href="../tester/#tester-func-list">Figure 2.2</a>):</p>
<div class="code-sample lang-py" title="func_list.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">first</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"First"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Second"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">third</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Third"</span><span class="p">)</span>

<span class="n">everything</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="p">]</span>
<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">everything</span><span class="p">:</span>
    <span class="n">func</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_list.out">
<div class="highlight"><pre><span></span><code>First
Second
Third
</code></pre></div>
</div>
<figure id="tester-func-list">
<img alt="A list of functions" src="./tester/tester_func_list.svg"/>
<figcaption markdown="1">Figure 2.2: A list of functions.</figcaption>
</figure>
<p class="continue">When we loop over the list <code>everything</code>,
Python assigns each function to the variable <code>func</code> in turn.
We can then call the function as <code>func()</code>
just as we called <code>example</code> using <code>alias()</code>.</p>
<p>Now suppose we have a function we want to test:</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">and some functions that test it
(two of which contain deliberate errors):</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>We can put all the test functions in a list:</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="n">TESTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">test_sign_negative</span><span class="p">,</span>
    <span class="n">test_sign_positive</span><span class="p">,</span>
    <span class="n">test_sign_zero</span><span class="p">,</span>
    <span class="n">test_sign_error</span>
<span class="p">]</span>
</code></pre></div>
</div>
<p>Each test does something to a <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>
(such as the number -3)
and uses <a class="gl-ref" href="../glossary/#assertion" markdown="1">assertions</a>
to compare the <a class="gl-ref" href="../glossary/#actual_result" markdown="1">actual result</a>
against the <a class="gl-ref" href="../glossary/#expected_result" markdown="1">expected result</a>.
The outcome of each test is exactly one of:</p>
<ul>
<li>
<p><a class="gl-ref" href="../glossary/#pass_test" markdown="1">Pass</a>:
    the test subject works as expected.</p>
</li>
<li>
<p><a class="gl-ref" href="../glossary/#fail_test" markdown="1">Fail</a>:
    something is wrong with the test subject.</p>
</li>
<li>
<p><a class="gl-ref" href="../glossary/#error_test" markdown="1">Error</a>:
    something is wrong in the test itself,
    which means we don’t know if
    the thing we’re testing is working properly or not.</p>
</li>
</ul>
<p>To implement this classification scheme
we need to distinguish failing tests from broken ones.
Our rule is that
if a test <a class="gl-ref" href="../glossary/#throw_exception" markdown="1">throws</a> an <code>AssertionError</code>
then one of our checks is reporting a failure,
while any other kind of exception indicates that the test contains an error.</p>
<p>Translating that rules into code gives us the function <code>run_tests</code>
that runs every test in a list
and counts how many outcomes of each kind it sees:</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">all_tests</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"pass"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"fail"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">all_tests</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test</span><span class="p">()</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"pass"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"fail"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pass </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fail </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">'fail'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"error </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="n">TESTS</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">If a test completes without an exception, it passes.
If any of the assertions inside it raise an <code>AssertionError</code> the test fails,
and if it raises any other exception it’s an error.</p>
<div class="code-sample lang-out" title="dry_run.out">
<div class="highlight"><pre><span></span><code>pass 2
fail 1
error 1
</code></pre></div>
</div>
<div class="callout">
<h3>Independence</h3>
<p>Our function runs tests in the order they appear in the list.
The tests should not rely on that:
every unit test should work independently
so that an error or failure in an early test
doesn’t affect other tests’ behavior.</p>
</div>
<h2 id="tester-reflection">Section 2.2: Finding Functions</h2>
<p>Making lists of functions is clumsy and error-prone:
sooner or later we’ll add a test twice or forget to add it at all.
We’d therefore like our test runner to find tests for itself,
which it can do by exploiting the fact that
Python stores variables in a structure similar to a dictionary.</p>
<p>Run the Python interpreter and call the <code>globals</code> function:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; globals()
{
    '__name__': '__main__',
    '__doc__': None,
    '__package__': None,
    '__loader__': &lt;class '_frozen_importlib.BuiltinImporter'&gt;,
    '__spec__': None,
    '__annotations__': {},
    '__builtins__': &lt;module 'builtins' (built-in)&gt;
}
</code></pre></div>
<p class="continue">As the output shows,
<code>globals</code> a dictionary containing
all the variables at the top (global) level of the program.
Since we just started the interpreter,
we see the variables that Python defines automatically.
(By convention,
Python uses double underscores for names that mean something special to it.)</p>
<p>What happens when we define a variable of our own?</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; my_variable = 123
&gt;&gt;&gt; globals()
{
    '__name__': '__main__',
    '__doc__': None,
    '__package__': None,
    '__loader__': &lt;class '_frozen_importlib.BuiltinImporter'&gt;,
    '__spec__': None,
    '__annotations__': {},
    '__builtins__': &lt;module 'builtins' (built-in)&gt;,
    'my_variable': 123
}
</code></pre></div>
<p class="continue">Sure enough,
<code>my_variable</code> is now in the dictionary.</p>
<div class="callout">
<h3>Local Variables</h3>
<p>Another function called <code>locals</code> returns
all the variables defined in the current (local) <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>:</p>
<div class="code-sample lang-py" title="show_locals.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">show_off</span><span class="p">(</span><span class="n">some_parameter</span><span class="p">):</span>
    <span class="n">some_variable</span> <span class="o">=</span> <span class="n">some_parameter</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"local values"</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>

<span class="n">show_off</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="show_locals.out">
<div class="highlight"><pre><span></span><code>local values {'some_parameter': 'hello', 'some_variable': 'hellohello'}
</code></pre></div>
</div>
</div>
<p>If function names are just variables
and a program’s variables are stored in a dictionary,
we can loop over that dictionary
to find all the functions whose names start with <code>test_</code>:</p>
<div class="code-sample lang-py" title="find_list_test_funcs.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

<span class="n">find_tests</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="find_list_test_funcs.out">
<div class="highlight"><pre><span></span><code>test_sign_negative &lt;function test_sign_negative at 0x10cad39d0&gt;
test_sign_positive &lt;function test_sign_positive at 0x10cad3e50&gt;
test_sign_zero &lt;function test_sign_zero at 0x10cad3ee0&gt;
test_sign_error &lt;function test_sign_error at 0x10cad3f70&gt;
</code></pre></div>
</div>
<p class="continue">Notice that when we print a function,
Python shows us its name and its address in memory.</p>
<p>Having a program find things in itself like this at runtime
is called <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>.
Combining introspection with the pass-fail-error pattern of the previous section
gives us something that finds test functions,
runs them,
and summarizes their results:</p>
<div class="code-sample lang-py" title="find_report_tests.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"passed"</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"failed"</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"had error"</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="find_report_tests.out">
<div class="highlight"><pre><span></span><code>test_sign_negative passed
test_sign_positive passed
test_sign_zero failed
test_sign_error had error
</code></pre></div>
</div>
<div class="callout">
<h3>Calling Conventions</h3>
<p>We actually can’t call a function we’ve found by introspection unless:</p>
<ol>
<li>
<p>we know its <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>
    (i.e, how many parameters of what type it needs in what order)
    or</p>
</li>
<li>
<p>the function uses <code>*args*</code> or <code>**kwargs</code> to capture “extra” arguments.</p>
</li>
</ol>
<p>To keep things simple,
most unit testing frameworks require test functions to take no parameters
so that they can be called as <code>test()</code>.</p>
</div>
<h2 id="tester-further">Section 2.3: Going Further</h2>
<p>Since functions are objects,
they can have attributes.
The function <code>dir</code> (short for “directory”) returns a list of those attributes’ names:</p>
<div class="code-sample lang-py" title="func_dir.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="s2">"Docstring for example."</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"in example"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">example</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_dir.out">
<div class="highlight"><pre><span></span><code>['__annotations__', '__call__', '__class__', '__closure__', '__code__', \
'__defaults__', '__delattr__', '__dict__', '__dir__', '__doc__', \
'__eq__', '__format__', '__ge__', '__get__', '__getattribute__', \
'__globals__', '__gt__', '__hash__', '__init__', '__init_subclass__', \
'__kwdefaults__', '__le__', '__lt__', '__module__', '__name__', \
'__ne__', '__new__', '__qualname__', '__reduce__', '__reduce_ex__', \
'__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__']
</code></pre></div>
</div>
<p>Most programmers never need to use most of these,
but <code>__name__</code> holds the function’s original name
and <code>__doc__</code> holds its <span class="ix-entry" ix-key="docstring" markdown="1"><a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a></span>:</p>
<div class="code-sample lang-py" title="func_attr.py">
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s2">"docstring:"</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name:"</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_attr.out">
<div class="highlight"><pre><span></span><code>docstring: Docstring for example.
name: example
</code></pre></div>
</div>
<p>We can modify our test runner to use this for reporting tests’ results
using the function’s <code>__name__</code> attribute
instead of the key in the <code>globals</code> dictionary:</p>
<div class="code-sample lang-py" title="with_name.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">"passed"</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">"failed"</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">"had error"</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="with_name.out">
<div class="highlight"><pre><span></span><code>test_sign_negative passed
test_sign_positive passed
test_sign_zero failed
test_sign_error had error
</code></pre></div>
</div>
<p>More usefully,
we can say that if a test function’s docstring contains the string <code>"test:skip"</code>
then we should skip the test,
while <code>"test:fail"</code> means we expect this test to fail.
Let’s rewrite our tests to show this off:</p>
<div class="code-sample lang-py" title="docstring.py">
<div class="highlight"><pre><span></span><code><span class="n">TEST_FAIL</span> <span class="o">=</span> <span class="s2">"test:fail"</span>
<span class="n">TEST_SKIP</span> <span class="o">=</span> <span class="s2">"test:skip"</span>

<span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="s2">"test:skip"</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="s2">"test:fail"</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="sd">"""Expect an error."""</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">and then modify <code>run_tests</code> to look for these strings and act accordingly:</p>
<div class="code-sample lang-py" title="docstring.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">prefixed_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">prefixed_names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TEST_SKIP</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"skip: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pass: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TEST_FAIL</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pass (expected failure): </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fail: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"/</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">else</span> <span class="s2">""</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"error: </span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">doc</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The output is now:</p>
<div class="code-sample lang-out" title="docstring.out">
<div class="highlight"><pre><span></span><code>skip: test_sign_negative
error: test_sign_positive argument of type 'NoneType' is not iterable
pass (expected failure): test_sign_zero
error: test_sign_error/Expect an error. name 'sgn' is not defined
</code></pre></div>
</div>
<p>Instead of (ab)using docstrings like this,
we can add attributes of our own to test functions.
Let’s say that if a function has an attribute called <code>skip</code> with the value <code>True</code>
then the function is to be skipped,
while if it has an attribute called <code>fail</code> whose value is <code>True</code>
then the test is expected to fail.
Our tests become:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">test_sign_negative</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">test_sign_zero</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>We can write a helper function called <code>classify</code> to classify tests.
Note that it uses <code>hasattr</code> to check if an attribute is present
before trying to get its value:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">"skip"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"skip"</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">"fail"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"fail"</span>
    <span class="k">return</span> <span class="s2">"run"</span>
</code></pre></div>
</div>
<p>Finally,
our test runner becomes:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">prefixed_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">prefixed_names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">"skip"</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"skip: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pass: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">"fail"</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pass (expected failure): </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fail: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"error: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="tester-mock">Section 2.4: Mock Objects</h2>
<p>We can do more than look up functions:
we can change them to make testing easier.
For example,
if the function we want to test uses the time of day,
we can temporarily replace the real <code>time.time</code> function
with one that returns a specific value
so we know what result to expect:</p>
<div class="code-sample lang-py" title="mock_time.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">elapsed</span><span class="p">(</span><span class="n">since</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">since</span>

<span class="k">def</span> <span class="nf">mock_time</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">200</span>

<span class="k">def</span> <span class="nf">test_elapsed</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">mock_time</span>
    <span class="k">assert</span> <span class="n">elapsed</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">==</span> <span class="mi">150</span>
</code></pre></div>
</div>
<p>Temporary replacements like this are called <a class="gl-ref" href="../glossary/#mock_object" markdown="1">mock objects</a>
because we usually use objects even if the thing we’re replacing is a function.
We can do this because Python lets us create objects
that can be “called” just like functions.
If an object <code>obj</code> has a <code>__call__</code> method,
then <code>obj(…)</code> is automatically turned into <code>obj.__call__(…)</code>.
For example,
the code below defines a class <code>Adder</code> whose instances add a constant to ther input:</p>
<div class="code-sample lang-py" title="callable.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Adder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="n">add_3</span> <span class="o">=</span> <span class="n">Adder</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">add_3</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"add_3(8): </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="callable.out">
<div class="highlight"><pre><span></span><code>add_3(8): 11
</code></pre></div>
</div>
<p>Let’s create a reusable mock object class that:</p>
<ol>
<li>
<p>defines a <code>__call__</code> method so that instances can be called like functions;</p>
</li>
<li>
<p>declares the parameters of that method to be <code>*args*</code> and <code>**kwargs</code>
    so that it can be called with any number of regular or keyword arguments;</p>
</li>
<li>
<p>stores those arguments so we can see how the replaced function was called;
    and</p>
</li>
<li>
<p>returns either a fixed value or a value produced by a user-defined function.</p>
</li>
</ol>
<p>The class itself is only 11 lines long:</p>
<div class="code-sample lang-py" title="mock_object.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Fake</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>
</div>
<p>For convenience,
let’s also define a function that replaces some function we’ve already defined
with an instance of our <code>Fake</code> class:</p>
<div class="code-sample lang-py" title="mock_object.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fixit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="n">fake</span> <span class="o">=</span> <span class="n">Fake</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake</span>
    <span class="k">return</span> <span class="n">fake</span>
</code></pre></div>
</div>
<p>To show how this works,
we define a function that adds two numbers
and write a test for it:</p>
<div class="code-sample lang-py" title="mock_object.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">adder</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">test_with_real_function</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">adder</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>
</div>
<p>We then use <code>fixit</code> to replace the real <code>adder</code> function
with a mock object that always returns 99
(<a class="fig-ref" href="../tester/#tester-mock-timeline">Figure 2.3</a>):</p>
<div class="code-sample lang-py" title="mock_object.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_fixed_return_value</span><span class="p">():</span>
    <span class="n">fixit</span><span class="p">(</span><span class="s2">"adder"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">adder</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">99</span>
</code></pre></div>
</div>
<figure id="tester-mock-timeline">
<img alt="Timeline of mock operation" src="./tester/tester_mock_timeline.svg"/>
<figcaption markdown="1">Figure 2.3: Timeline of mock operation.</figcaption>
</figure>
<p>Another test proves that our <code>Fake</code> class records
all of the calls:</p>
<div class="code-sample lang-py" title="mock_object.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_fake_records_calls</span><span class="p">():</span>
    <span class="n">fake</span> <span class="o">=</span> <span class="n">fixit</span><span class="p">(</span><span class="s2">"adder"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">adder</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">99</span>
    <span class="k">assert</span> <span class="n">adder</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">99</span>
    <span class="k">assert</span> <span class="n">adder</span><span class="o">.</span><span class="n">calls</span> <span class="o">==</span> <span class="p">[[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">{}],</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">{}]]</span>
</code></pre></div>
</div>
<p>And finally,
the user can provide a function to calculate a return value:</p>
<div class="code-sample lang-py" title="mock_object.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_fake_calculates_result</span><span class="p">():</span>
    <span class="n">fixit</span><span class="p">(</span><span class="s2">"adder"</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">adder</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">23</span>
</code></pre></div>
</div>
<h2 id="tester-protocols">Section 2.5: Protocols</h2>
<p>Mock objects are very useful,
but the way we’re using them is going to cause strange errors.
The problem is that
every test except the first one replaces <code>adder</code> with a mock object
that does something different.
As a result,
any test that <em>doesn’t</em> replace <code>adder</code> will run with
whatever mock object was last put in place
rather than with the original <code>adder</code> function.</p>
<p>We could tell users it’s their job to put everthing back after each test,
but people are forgetful.
It would be better if Python did this automatically;
luckily for us,
it provides a <a class="gl-ref" href="../glossary/#protocol" markdown="1">protocol</a> for exactly this purpose.
A protocol is a rule that specifies how programs can tell Python
to do specific things at specific moments.
Giving a class a <code>__call__</code> method is an example of this:
when Python sees <code>thing(…)</code>,
it automatically checks if <code>thing</code> has that method.
Defining an <code>__init__</code> method for a class is another example:
if a class has a method with that name,
Python calls it automatically when constructing a new instance of that class.</p>
<p>What we want for managing mock objects is
a <a class="gl-ref" href="../glossary/#context_manager" markdown="1">context manager</a>
that replaces the real function with our mock at the start of a block of code
and then puts the original back at the end.
The protocol for this relies on two methods called <code>__enter__</code> and <code>__exit__</code>.
If the class is called <code>C</code>,
then when Python executes a <code>with</code> block like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">C</span><span class="p">(</span><span class="err">…</span><span class="n">args</span><span class="err">…</span><span class="p">)</span> <span class="k">as</span> <span class="n">name</span><span class="p">:</span>
    <span class="err">…</span><span class="n">do</span> <span class="n">things</span><span class="err">…</span>
</code></pre></div>
<p class="continue">it does the following:</p>
<ol>
<li>Call <code>C</code>‘s constructor to create an object that it associates with the code block.</li>
<li>Call that object’s <code>__enter__</code> method
    and assign the result to the variable <code>name</code>.</li>
<li>Run the code inside the <code>with</code> block.</li>
<li>Call <code>name.__exit__()</code> when the block finishes.</li>
</ol>
<p>Here’s a mock object that inherits all the capabilities of <code>Fake</code>
and adds the two methods needed by <code>with</code>:</p>
<div class="code-sample lang-py" title="mock_context.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ContextFake</span><span class="p">(</span><span class="n">Fake</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original</span>
</code></pre></div>
</div>
<p>Notice that <code>__enter__</code> doesn’t take any extra parameters:
anything it needs should be provided to the constructor.
On the other hand,
<code>__exit__</code> will always be called with three values
that tell it whether an exception occurred,
and if so,
what the exception was.</p>
<p class="continue">Here’s a test to prove that our context manager works:</p>
<div class="code-sample lang-py" title="mock_context.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">subber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">check_no_lasting_effects</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">subber</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">with</span> <span class="n">ContextFake</span><span class="p">(</span><span class="s2">"subber"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span> <span class="k">as</span> <span class="n">fake</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">subber</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1234</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">subber</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>
</div>
<h2 id="tester-summary">Section 2.6: Summary</h2>
<figure id="tester-concept-map">
<img alt="Concept map of unit testing tool" src="./tester/tester_concept_map.svg"/>
<figcaption markdown="1">Figure 2.4: Unit tester concept map.</figcaption>
</figure>
<h2 id="tester-exercises">Section 2.7: Exercises</h2>
<h3 class="exercise">Why a copy?</h3>
<p>Why does the function <code>globals</code> return a copy of the dictionary
containing the program’s global variables?
Why doesn’t it return the dictionary itself so that programs can modify it?
Why use a function at all instead of simply using a variable called <code>__globals__</code>?</p>
<h3 class="exercise">Counting results</h3>
<ol>
<li>
<p>Modify the test framework so that it reports which tests passed, failed, or had errors
    and also reports a summary of how many tests produced each result.</p>
</li>
<li>
<p>Write unit tests to check that your answer to part 1 works correctly.</p>
</li>
<li>
<p>Think of another plausible way to interpret part 1
    that <em>wouldn’t</em> pass the tests you wrote for part 2.</p>
</li>
</ol>
<h3 class="exercise">Literal strings</h3>
<p>If we have defined a variable with the test-skipping marker,
why can’t we use that variable as the docstring for several functions like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">TEST_SKIP</span> <span class="o">=</span> <span class="s2">"test:skip"</span>

<span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="n">TEST_SKIP</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="n">TEST_SKIP</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
<h3 class="exercise">Failing on purpose</h3>
<p>Putting assertions into code to check that it is behaving correctly
is called <a class="gl-ref" href="../glossary/#defensive_programming" markdown="1">defensive programming</a>;
it’s a good practice,
but we should make sure those assertions are failing when they’re supposed to,
just as we should test our smoke detectors every once in a while.</p>
<p>Modify the tester so that
if a test function’s docstring is <code>"test:assert"</code>,
the test passes if it raises an <code>AssertionErro</code>
and fails if it does not.
Tests whose docstring don’t contain <code>"test:assert"</code>
should behave as before.</p>
<h3 class="exercise">Timing tests</h3>
<ol>
<li>
<p>Modify the testing tool so that it records how long it takes to run each test.
    (The function <code>time.time</code> may be useful.)</p>
</li>
<li>
<p>Use Python’s own <a href="https://docs.pytest.org/">pytest</a> library to test your implementation.
    (Hint: you may want to replace <code>time.time</code> with a mock object for testing.)</p>
</li>
</ol>
<h3 class="exercise">Timing blocks</h3>
<p>Create a context manager called <code>Timer</code> that reports how long it has been
since a block of code started running:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># your class goes here</span>

<span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">start</span><span class="p">:</span>
    <span class="c1"># ...do some lengthy operation...</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">elapsed</span><span class="p">())</span>  <span class="c1"># time since the start of the block</span>
</code></pre></div>
<h3 class="exercise">Approximately equal</h3>
<ol>
<li>
<p>Write a function <code>assert_approx_equal</code>
    that does nothing if two values are within a certain tolerance of each other
    but throws an exception if they are not:</p>
<pre><code>// throws exception
assert_approx_equal(1.0, 2.0, 0.01, "Values are too far apart")

// does not throw
assert_approx_equal(1.0, 2.0, 10.0, "Large margin of error")
</code></pre>
</li>
<li>
<p>Modify the function so that a default tolerance is used if none is specified:</p>
<pre><code>// throws exception
assert_approx_equal(1.0, 2.0, "Values are too far apart")

// does not throw
assert_approx_equal(1.0, 2.0, "Large margin of error", 10.0)
</code></pre>
</li>
<li>
<p>Modify the function again so that it checks the <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>
    instead of the <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>.
    (The relative error is the absolute value of the difference between the actual and expected value,
    divided by the absolute value.)</p>
</li>
</ol>
<h3 class="exercise">Capturing output</h3>
<ol>
<li>
<p>Read <a href="https://docs.pytest.org/en/6.2.x/capture.html">the documentation</a>
    that explains how to capture <a class="gl-ref" href="../glossary/#stdout" markdown="1">standard output</a>
    when using <a href="https://docs.pytest.org/">pytest</a>.</p>
</li>
<li>
<p>Modify this chapter’s testing tool so that
    users can check what a function prints to standard output
    as part of a unit test.</p>
</li>
</ol>
<h3 class="exercise">Selecting tests</h3>
<p>Modify the testing tool so that if a user provides <code>-s pattern</code> or <code>--select pattern</code>
then it only runs tests that contain the string <code>pattern</code> in their name.</p>
<h3 class="exercise">Setup and teardown</h3>
<p>Testing frameworks often allow programmers to specify a <code>setup</code> function
that is to be run before each test
and a corresponding <code>teardown</code> function
that is to be run after each test.
(<code>setup</code> usually re-creates complicated test fixtures,
while <code>teardown</code> functions are sometimes needed to clean up after tests,
e.g., to close database connections or delete temporary files.)</p>
<p>Modify the testing tool in this chapter so that
if a file of tests contains a function called <code>setup</code>
then the tool calls it exactly once before running each test in the file.
Add a similar way to register a teardown function.</p>
</section>
<section class="new-chapter"><h1 id="interpreter">Chapter: Chapter 3: An Interpreter</h1>

<ul class="syllabus">
<li markdown="1">Compilers and interpreters are just programs.</li>
<li markdown="1">Basic arithmetic operations are just functions that have special notation.</li>
<li markdown="1">Programs can be represented as trees, which can be stored as nested lists.</li>
<li markdown="1">Interpreters recurisvely dispatch operations to functions that implement low-level details.</li>
<li markdown="1">Programs store variables in stacked dictionaries called environments.</li>
<li markdown="1">One way to evaluate a program's design is to ask how extensible it is.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#argument" markdown="1">argument</a>, <a class="gl-ref" href="../glossary/#call_stack" markdown="1">call stack</a>, <a class="gl-ref" href="../glossary/#control_flow" markdown="1">control flow</a>, <a class="gl-ref" href="../glossary/#dictionary_comprehension" markdown="1">dictionary comprehension</a>, <a class="gl-ref" href="../glossary/#dispatch" markdown="1">dispatch</a>, <a class="gl-ref" href="../glossary/#dynamic_scoping" markdown="1">dynamic scoping</a>, <a class="gl-ref" href="../glossary/#eager_evaluation" markdown="1">eager evaluation</a>, <a class="gl-ref" href="../glossary/#environment" markdown="1">environment</a>, <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensibility</a>, <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>, <a class="gl-ref" href="../glossary/#json" markdown="1">JavaScript Object Notation</a>, <a class="gl-ref" href="../glossary/#lazy_evaluation" markdown="1">lazy evaluation</a>, <a class="gl-ref" href="../glossary/#lexical_scoping" markdown="1">lexical scoping</a>, <a class="gl-ref" href="../glossary/#parameter" markdown="1">parameter</a>, <a class="gl-ref" href="../glossary/#parser" markdown="1">parser</a>, <a class="gl-ref" href="../glossary/#recursion" markdown="1">recursion</a>, <a class="gl-ref" href="../glossary/#runtime" markdown="1">runtime</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>, <a class="gl-ref" href="../glossary/#stack_frame" markdown="1">stack frame</a>
</p>
<div class="page-toc"></div>
<p><a class="x-ref" href="#tester">Chapter 2</a> introduced the idea that programs are just another kind of data.
Similarly,
the compilers and interpreters that make programs run are just programs themselves.
instead of changing the characters in a block of memory like text editors,
or calculating sums and averages like spreadsheets,
compilers turn text into instructions for interpreters or hardware to run.</p>
<p>Most real programming languages have two parts:
a <a class="gl-ref" href="../glossary/#parser" markdown="1">parser</a> that translates the source code into a data structure in memory,
and a <a class="gl-ref" href="../glossary/#runtime" markdown="1">runtime</a> that executes the instructions in that data structure.
This chapter focuses on the runtime;
<a class="x-ref" href="#parser">Chapter 13</a> will explore parsing,
whle <a class="x-ref" href="#vm">Chapter 15</a> will look at more efficient ways to execute instructions.</p>
<h2 id="interpreter-expressions">Section 3.1: Expressions</h2>
<p>Let’s start by building something that can evaluate simple expressions
like <code>1+2</code> or <code>abs(-3.5)</code>.
We represent each expression as a list
with the name of the operation as the first item
and the values to be operated on as the other items.
To add 1 and 2 we use:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</code></pre></div>
<p class="continue">and to calculate the absolute value of -3.5 we use:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">"abs"</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5</span><span class="p">]</span>
</code></pre></div>
<div class="callout">
<h3>Nothing Special</h3>
<p>We have special symbols for addition, subtraction, and so on for historical reasons,
but our list representation doesn’t distinguish between things like <code>+</code> and <code>abs</code>
because it doesn’t need to.
If our program is being compiled into low-level instructions for a particular CPU,
it’s the compiler’s job to decide what can be done directly
and what needs multiple instructions.
For example,
early CPUs didn’t have instructions to do division,
while modern CPUs may have instructions to do addition or multiplication
on multiple values at once.</p>
</div>
<p>We can represent more complicated expressions using nested lists.
For example, <code>abs(1+2)</code> is:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">"abs"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"add"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
</code></pre></div>
<p>The function to add two expressions looks like this:</p>
<div class="code-sample lang-py" title="expr.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_add</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span>
</code></pre></div>
</div>
<p class="continue">Its single parameter is a list containing
the two sub-expressions to be evaluated and added.
After checking that it has the right number of parameters,
it calls the function <code>do</code> <a class="gl-ref" href="../glossary/#recursion" markdown="1">recursively</a> to evaluate those sub-expressions.
(We’ve called the function <code>do</code> instead of <code>eval</code>
because Python already has a function called <code>eval</code>.)
Once <code>do_add</code> has two actual values,
it adds them and returns the result
(<a class="fig-ref" href="../interpreter/#interpreter-recursive-evaluation">Figure 3.1</a>)</p>
<figure id="interpreter-recursive-evaluation">
<img alt="Recursive evaluation of an expression tree" src="./interpreter/interpreter_recursive_evaluation.svg"/>
<figcaption markdown="1">Figure 3.1: Recursively evaluation an expression tree.</figcaption>
</figure>
<div class="callout">
<h3>Arguments versus Parameters</h3>
<p>Many programmers use the words <a class="gl-ref" href="../glossary/#argument" markdown="1">argument</a>
and <a class="gl-ref" href="../glossary/#parameter" markdown="1">parameter</a> interchangeably,
but to make our meaning clear,
we call the values passed into a function its arguments
and the names the function uses to refer to them as its parameters.
Put it another way,
parameters are part of the definition
and arguments are given when the function is called.</p>
</div>
<p><code>do_abs</code>, which calculates absolute value,
works the same way.
The only differences are that it expects one value instead of two
and calculates a different return value:</p>
<div class="code-sample lang-py" title="expr.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_abs</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</code></pre></div>
</div>
<p>So how does <code>do</code> work?
It starts by checking if its input is an integer.
If so,
it returns that value right away
because integers “evaluate” to themselves:
no more calculation is needed.
Otherwise,
<code>do</code> checks that its parameter is a list
and then uses the first value in the list
to decide what other function to call.
This process is often called <a class="gl-ref" href="../glossary/#dispatch" markdown="1">dispatch</a>.</p>
<div class="code-sample lang-py" title="expr.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="c1"># Integers evaluate to themselves.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="c1"># Lists trigger function calls.</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"abs"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_abs</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_add</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown operation </span><span class="si">{</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p>Finally,
the main body of the program reads
the file containing the instructions to execute,
calls <code>do</code>,
and prints the result:</p>
<div class="code-sample lang-py" title="expr.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"Usage: expr.py filename"</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">program</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"=&gt; </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Our program is a list of lists (of lists…)
so we can read it as <a class="gl-ref" href="../glossary/#json" markdown="1">JSON</a> using <code>json.load</code>.
If our program file contains:</p>
<div class="code-sample lang-tll" title="expr.tll">
<div class="highlight"><pre><span></span><code>["add", ["abs", -3], 2]
</code></pre></div>
</div>
<p class="continue">then our little interpreter prints:</p>
<div class="code-sample lang-out" title="expr.out">
<div class="highlight"><pre><span></span><code>=&gt; 5
</code></pre></div>
</div>
<p>This is a lot of code to do something that Python already does,
but it shows what Python (and other languages) do themselves.
When we run our little interpreter with:</p>
<div class="highlight"><pre><span></span><code>$ python expr.py expr.tll
</code></pre></div>
<p>Python reads <code>expr.py</code>,
turns it into a data structure with operation identifiers and constants,
then uses those operation identifiers to decide what functions to call.
Those functions are written in C
and have been compiled to machine instructions,
but the cycle of lookup, call, and recurse is exactly the same.</p>
<h2 id="interpreter-variables">Section 3.2: Variables</h2>
<p>Adding up constants is a start,
but our programs will be easier to read with variables
that let us give names to values.
We can add them to our interpreter
by passing around a dictionary containing all the variables seen so far.
Such a dictionary is sometimes called an <a class="gl-ref" href="../glossary/#environment" markdown="1">“environment</a>
because it is the setting in which expressions are evaluated;
the dictionaries returned by the <code>globals</code> and <code>locals</code> functions
introduced in <a class="x-ref" href="#tester">Chapter 2</a> are both environments.</p>
<p>Let’s modify <code>do_add</code> and <code>do_abs</code>
to take an environment as an extra parameter and pass it on to <code>do</code> as needed:</p>
<div class="code-sample lang-py" title="vars.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_abs</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Looking up variables when we need their values is straightfoward.
We check that we have a variable name and that the name is in the environment,
then return the stored value:</p>
<div class="code-sample lang-py" title="vars.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_get</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown variable </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</code></pre></div>
</div>
<p>To define a new variable or change an existing one,
we evaluate an expression and store its value in the environment:</p>
<div class="code-sample lang-py" title="vars.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_set</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">env</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
</div>
<p>We need to add one more function to make this all work.
Our programs no longer consist of a single expression;
instead,
we may have several expressions that set variables’ values
and then use them in calculations.
To handle this,
we add a function <code>do_seq</code> that runs a sequence of expressions one by one.
This function is our first piece of <a class="gl-ref" href="../glossary/#control_flow" markdown="1">control flow</a>:
rather than calculating a value itself,
it controls when and how other expressions are evaluated.
Its implementation is:</p>
<div class="code-sample lang-py" title="vars.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_seq</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>Let’s try it out.
Our test program is:</p>
<div class="code-sample lang-tll" title="vars.tll">
<div class="highlight"><pre><span></span><code>[
    "seq",
    ["set", "alpha", 1],
    ["set", "beta", 2],
    ["add", ["get", "alpha"], ["get", "beta"]]
]
</code></pre></div>
</div>
<div class="code-sample lang-out" title="vars.out">
<div class="highlight"><pre><span></span><code>=&gt; 3
</code></pre></div>
</div>
<h2 id="interpreter-introspection">Section 3.3: Introspection Again</h2>
<p>Before we add more operations,
let’s have a look at the current state of <code>do</code>:</p>
<div class="code-sample lang-py" title="vars.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
    <span class="c1"># Integers evaluate to themselves.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="c1"># Lists trigger function calls.</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"abs"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_abs</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_add</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"get"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_get</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"seq"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_seq</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"set"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">do_set</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown operation </span><span class="si">{</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p>The sequence of <code>if</code> statements that decide what function to call
is going to become unreadably long.
Let’s use <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a> to create a lookup table instead
by finding and storing every function whose name starts with <code>do_</code>:</p>
<div class="code-sample lang-py" title="vars_reflect.py">
<div class="highlight"><pre><span></span><code><span class="n">OPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"do_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">func</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"do_"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">Line by line:</p>
<ol>
<li>
<p>We use a <a class="gl-ref" href="../glossary/#dictionary_comprehension" markdown="1">dictionary comprehension</a>
    to create a dictionary in a single statement.</p>
</li>
<li>
<p>We only add functions whose names start with <code>do_</code>.</p>
</li>
<li>
<p>Each key-value pair in the dictionary is the name of an operation
    and the function that implements the operation.
    The operation’s name is what comes after <code>do_</code> in the function’s name.</p>
</li>
</ol>
<p>With this lookup table in hand,
the code to select and run an operation is:</p>
<div class="code-sample lang-py" title="vars_reflect.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
    <span class="c1"># Integers evaluate to themselves.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="c1"># Lists trigger function calls.</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">OPS</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown operation </span><span class="si">{</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">OPS</span><span class="p">[</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</code></pre></div>
</div>
<p>As with unit test functions in <a class="x-ref" href="#tester">Chapter 2</a>,
the <code>do_*</code> functions must have exactly the same <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>
so that we can all any of them with an environment and a list of arguments
without knowing exactly which function we’re calling.
And as with finding tests,
introspection is more reliable than a hand-written lookup table,
but it isn’t necessarily easier to understand.
If we write out the lookup table explicitly like this:</p>
<div class="code-sample lang-py" title="vars_table.py">
<div class="highlight"><pre><span></span><code><span class="n">OPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"abs"</span><span class="p">:</span> <span class="n">do_abs</span><span class="p">,</span>
    <span class="s2">"add"</span><span class="p">:</span> <span class="n">do_add</span><span class="p">,</span>
    <span class="s2">"get"</span><span class="p">:</span> <span class="n">do_get</span><span class="p">,</span>
    <span class="s2">"seq"</span><span class="p">:</span> <span class="n">do_seq</span><span class="p">,</span>
    <span class="s2">"set"</span><span class="p">:</span> <span class="n">do_set</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">then it’s easy to see exactly what operations are available
and what their names are.
If we use introspection,
we have to search through the source file (or possibly several files)
to find all the available operations.</p>
<h2 id="interpreter-statements">Section 3.4: Statements</h2>
<p>Now that we have recursive evaluation, function lookup, and environments,
it’s easy to add more features to our little language.
Our goal is to execute this program,
which starts with the number 1 and doubles it four times:</p>
<div class="code-sample lang-tll" title="doubling.tll">
<div class="highlight"><pre><span></span><code>[
    "seq",
    ["comment", "Double a number repeatedly"],
    ["set", "a", 1],
    ["print", "initial", ["get", "a"]],
    [
        "repeat",
        4,
        [
            "seq",
            ["set", "a", ["add", ["get", "a"], ["get", "a"]]],
        ["if",
        ["leq", ["get", "a"], 10],
        ["print", "small", ["get", "a"]],
        ["print", "large", ["get", "a"]]
        ]
        ]
    ]
]
</code></pre></div>
</div>
<p>The simplest of the new operations is <code>comment</code>,
which does nothing and returns <code>None</code>:</p>
<div class="code-sample lang-py" title="stmt.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_comment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">"""Ignore instructions.</span>
<span class="sd">    ["comment" "text"] =&gt; None</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p>An <code>if</code> statement is a bit more complex.
If its first argument is true it evaluates and returns its second argument
(the “if” branch).
Otherwise,
it evaluates and returns its second argument (the “else” branch):</p>
<div class="code-sample lang-py" title="stmt.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_if</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">"""Make a choice: only one sub-expression is evaluated.</span>
<span class="sd">    ["if" C A B] =&gt; A if C else B</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">This is called <a class="gl-ref" href="../glossary/#lazy_evaluation" markdown="1">lazy evaluation</a>
to distinguish it from the more usual <a class="gl-ref" href="../glossary/#eager_evaluation" markdown="1">eager evaluation</a>
that evaluates everything up front.
<code>do_if</code> only evaluates what it absolutely needs to;
most languages do this so that we can safely write things like:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">x</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p class="continue">If the language always evaluated both branches
then the code shown above would fail whenever <code>x</code> was zero,
even though it’s supposed to handle that case.
In this case it might seem obvious what the language should do,
but most languages use lazy evaluation for <code>and</code> and <code>or</code> as well
so that expressions like:</p>
<div class="highlight"><pre><span></span><code><span class="n">reference</span> <span class="ow">and</span> <span class="n">reference</span><span class="o">.</span><span class="n">part</span>
</code></pre></div>
<p class="continue">will produce <code>None</code> if <code>reference</code> is <code>None</code>
and <code>reference.part</code> if it isn’t.</p>
<h2 id="interpreter-functions">Section 3.5: Functions</h2>
<p>One way to evaluate the design of a piece of software is
to ask how <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensible</a> it is,
i.e.,
how easily we can add or change things <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Wilson2022">Wilson2022</a>]</span>.
The answer for our interpreter is now, “Pretty easily,”
but for our little language is, “Not at all,”
because there’s no way for users to create new operations of their own.
We need to give users a way to define and call functions.</p>
<p>Doing this takes less than 60 lines:</p>
<ol>
<li>
<p>A function definition looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">"def"</span><span class="p">,</span> <span class="s2">"same"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"num"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"get"</span><span class="p">,</span> <span class="s2">"num"</span><span class="p">]]</span>
</code></pre></div>
<p>It has a name, a (possibly empty) list of parameter names,
and a single instruction as a body
(which will usually be a <code>"seq"</code> instruction).</p>
</li>
<li>
<p>Functions are stored in the environment like any other value.
    The value stored for the function defined above would be:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">"func"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"num"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"get"</span><span class="p">,</span> <span class="s2">"num"</span><span class="p">]]</span>
</code></pre></div>
<p>We don’t need to store the name: that’s recorded by the environment,
just like it is for any other variable.</p>
</li>
<li>
<p>A function call looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">"call"</span><span class="p">,</span> <span class="s2">"same"</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</code></pre></div>
<p>The values passed to the functions are normally expressions rather than constants,
and are <em>not</em> put in a sub-list.
The implementation:
1.  Evaluates all of these expressions.
2.  Looks up the function.
3.  Creates a new environment whose keys are the parameters’ names
    and whose values are the expressions’ values.
4.  Calls <code>do</code> to run the function’s action and captures the result.
5.  Discards environment created two steps previously.
6.  Returns the function’s result.</p>
</li>
<li>
<p>Instead of using a single dictionary to store an environment
    we use a list of dictionaries.
    The first dictionary is the global environment;
    the others store the variables belonging to active function calls.</p>
</li>
<li>
<p>When we get or set a variable,
    we check the most recent environment first
    (i.e., the one that’s last in the list);
    if the variable isn’t there we look in the global environment.
    We don’t look at the environments in between;
    the exercises explore why not.</p>
</li>
</ol>
<div class="callout">
<h3>Scoping rules</h3>
<p>The set of active environments makes up the program’s
<span class="ix-entry" ix-key="call stack" markdown="1"><a class="gl-ref" href="../glossary/#call_stack" markdown="1">call stack</a></span>.
For historical reasons,
each environment is sometimes called a <span class="ix-entry" ix-key="call stack!stack frame;stack frame" markdown="1"><a class="gl-ref" href="../glossary/#stack_frame" markdown="1">stack frame</a></span>.
Searching through all active stack frames for a variable
is called is <span class="ix-entry" ix-key="dynamic scoping;scoping!dynamic" markdown="1"><a class="gl-ref" href="../glossary/#dynamic_scoping" markdown="1">dynamic scoping</a></span>.
In contrast,
most programming languages used <span class="ix-entry" ix-key="lexical scoping;scoping!lexical" markdown="1"><a class="gl-ref" href="../glossary/#lexical_scoping" markdown="1">lexical scoping</a></span>,
which figures out what a variable name refers to based on the structure of the program text.</p>
</div>
<p>Here’s the implementation of <code>do_def</code>:</p>
<div class="code-sample lang-py" title="func.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_def</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">"""Define a new function.</span>
<span class="sd">    ["def" name [...params...] body] =&gt; None # and define function</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">env_set</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="s2">"func"</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">body</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p class="continue">And here’s the implementation of <code>do_call</code>:</p>
<div class="code-sample lang-py" title="func.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_def</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">"""Define a new function.</span>
<span class="sd">    ["def" name [...params...] body] =&gt; None # and define function</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">env_set</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="s2">"func"</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">body</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p class="continue">Our test program and its output are:</p>
<div class="code-sample lang-tll" title="func.tll">
<div class="highlight"><pre><span></span><code>[
    "seq",
    [
        "def",
        "double",
        ["num"],
        ["add", ["get", "num"], ["get", "num"]]
    ],
    ["set", "a", 1],
    [
        "repeat",
        4,
        [
            "seq",
            ["set", "a", ["call", "double", ["get", "a"]]],
            ["print", ["get", "a"]]
        ]
    ]
]
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func.out">
<div class="highlight"><pre><span></span><code>2
4
8
16
=&gt; None
</code></pre></div>
</div>
<p>Once again,
Python and other languages work exactly as shown here.
The interpreter
(or the CPU, if we’re running code compiled to machine instructions)
reads an instruction,
figures out what operation it corresponds to,
and executes that operation.</p>
<h2 id="interpreter-summary">Section 3.6: Summary</h2>
<figure id="interpreter-concept-map">
<img alt="Concept map of interpreter" src="./interpreter/interpreter_concept_map.svg"/>
<figcaption markdown="1">Figure 3.2: Interpreter concept map.</figcaption>
</figure>
<h2 id="interpreter-exercises">Section 3.7: Exercises</h2>
<h3 class="exercise">Arrays</h3>
<p>Implement fixed-size one-dimensional arrays:
<code>["array", "new", 10]</code> creates an array of 10 elements,
while other instructions get and set particular array elements by index.</p>
<h3 class="exercise">While loops</h3>
<ol>
<li>
<p>Add a <code>while</code> loop using a Python <code>while</code> loop.</p>
</li>
<li>
<p>Add a <code>while</code> loop using recursion.</p>
</li>
</ol>
<h3 class="exercise">Loop counters</h3>
<p>The <code>"repeat"</code> instruction runs some other instruction(s) several times,
but there is no way to access the loop counter inside those instructions.
Modify <code>"repeat"</code> so that programs can do this.
(Hint: allow people to create a new variable to hold the loop counter’s current value.)</p>
<h3 class="exercise">Chained maps</h3>
<p>Look at the documentation for the <a href="https://docs.python.org/3/library/collections.html#collections.ChainMap"><code>ChainMap</code></a> class
and modify the interpreter to use that to manage environments.</p>
<h3 class="exercise">Better error handling</h3>
<p>Several of the instruction functions started with <code>assert</code> statements,
which means that users get a stack trace of TLL itself
when there’s a bug in their program.</p>
<ol>
<li>
<p>Define a new exception class called <code>TLLException</code>.</p>
</li>
<li>
<p>Write a utility function called <code>check</code>
    that raises a <code>TLLException</code> with a useful error message
    when there’s a problem.</p>
</li>
<li>
<p>Add a <code>catch</code> statement to handle these errors.</p>
</li>
</ol>
<h3 class="exercise">Tracing</h3>
<p>Add a <code>--trace</code> command-line flag to the interpreter.
When enabled, it makes TLL print a messages showing each function call and its result.</p>
<h3 class="exercise">Early return</h3>
<p>Add a <code>"return"</code> instruction to TLL that ends a function call immediately
and returns a single value.</p>
<h3 class="exercise">Variable argument lists</h3>
<p>Add variable-length parameter lists to functions.</p>
<h3 class="exercise">Scoping</h3>
<ol>
<li>
<p>Our interpreter looks for variables in
    the current function call’s environment
    and in the global environment,
    but not in the environments in between.
    Why not?
    How could looking in those intermediate environments
    make programs harder to debug?</p>
</li>
<li>
<p>The interpreter allows users to define functions inside functions.
    What variables can the inner function access when you do this?
    What variables <em>should</em> it be able to access?
    What would you have to do to enable this?</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="backup">Chapter: Chapter 4: Versioned File Backups</h1>

<ul class="syllabus">
<li markdown="1">Version control tools use hashing to uniquely identify each saved file.</li>
<li markdown="1">Cryptographic hash functions create identifiers that are randomly distributed and depend on every bit in their input.</li>
<li markdown="1">Hash functions often have streaming interfaces that can process files incrementally.</li>
<li markdown="1">Each snapshot of a set of files is recorded in a manifest.</li>
<li markdown="1">Using a mock filesystem to test version control is safer and faster than using the real thing.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#api" markdown="1">Application Programming Interface</a>, <a class="gl-ref" href="../glossary/#collision" markdown="1">collision (in hashing)</a>, <a class="gl-ref" href="../glossary/#utc" markdown="1">Coordinated Universal Time</a>, <a class="gl-ref" href="../glossary/#cryptographic_hash_function" markdown="1">cryptographic hash function</a>, <a class="gl-ref" href="../glossary/#data_migration" markdown="1">data migration</a>, <a class="gl-ref" href="../glossary/#hash_code" markdown="1">hash code</a>, <a class="gl-ref" href="../glossary/#hash_function" markdown="1">hash function</a>, <a class="gl-ref" href="../glossary/#manifest" markdown="1">manifest</a>, <a class="gl-ref" href="../glossary/#mock_object" markdown="1">mock object</a>, <a class="gl-ref" href="../glossary/#race_condition" markdown="1">race condition</a>, <a class="gl-ref" href="../glossary/#sha256" markdown="1">SHA-256 hash code</a>, <a class="gl-ref" href="../glossary/#streaming_api" markdown="1">streaming API</a>, <a class="gl-ref" href="../glossary/#toctou" markdown="1">time of check - time of use</a>, <a class="gl-ref" href="../glossary/#timestamp" markdown="1">timestamp</a>, <a class="gl-ref" href="../glossary/#version_control_system" markdown="1">version control system</a>
</p>
<div class="page-toc"></div>
<p>We’ve written almost a thousand lines of Python so far.
We could recreate it if we had to,
but we’d rather not find ourselves in that situation.
We’d also like to be able to see what we’ve changed,
and to collaborate with other people.
A <span class="ix-entry" ix-key="version control system" markdown="1"><a class="gl-ref" href="../glossary/#version_control_system" markdown="1">version control system</a></span>
like <span class="ix-entry" ix-key="Git;version control system!Git" markdown="1"><a href="https://git-scm.com/">Git</a></span>
solves all of these problems at once.
It keeps track of changes to files
so that we can see what we’ve changed,
recover old versions,
and merge our changes with those made by other people.</p>
<p>The core of a modern version control tool
is a way to archive files that:</p>
<ol>
<li>
<p>records which versions of which files existed at the same time
    (so that we can go back to a consistent previous state), and</p>
</li>
<li>
<p>stores any particular version of a file only once,
    so that we don’t waste disk space.</p>
</li>
</ol>
<p>This chapter builds a tool that does both tasks.
It won’t create and merge branches,
but that’s a relatively straightforward extension:
if you would like to see how it works,
please see <span class="ix-entry" ix-key="Cook, Mary Rose" markdown="1"><a href="https://maryrosecook.com/">Mary Rose Cook’s</a></span> <a href="http://gitlet.maryrosecook.com/">Gitlet</a>
or <span class="ix-entry" ix-key="Polge, Thibault" markdown="1">Thibault Polge</span>‘s <a href="https://wyag.thb.lt/">Write yourself a Git</a>.</p>
<h2 id="backup-unique">Section 4.1: Identifying Unique Files</h2>
<p>To avoid storing redundant copies of files,
we need a way to know when two files contain the same data.
We can’t rely on names because files can be renamed or moved over time;
we could compare the files byte by byte,
but a quicker way is to use a <span class="ix-entry" ix-key="hash function" markdown="1"><a class="gl-ref" href="../glossary/#hash_function" markdown="1">hash function</a></span>
that turns arbitrary data into a fixed-length string of bits
(<a class="fig-ref" href="../backup/#backup-hash-function">Figure 4.1</a>).</p>
<figure id="backup-hash-function">
<img alt="Hash functions" src="./backup/backup_hash_function.svg"/>
<figcaption markdown="1">Figure 4.1: How hash functions speed up lookup.</figcaption>
</figure>
<p>A hash function always produces the same <span class="ix-entry" ix-key="hash code" markdown="1"><a class="gl-ref" href="../glossary/#hash_code" markdown="1">hash code</a></span> for a given input.
A <span class="ix-entry" ix-key="cryptographic hash function;hash function!cryptographic" markdown="1"><a class="gl-ref" href="../glossary/#cryptographic_hash_function" markdown="1">cryptographic hash function</a></span>
has two extra properties:</p>
<ol>
<li>
<p>The outputs look like random numbers:
    they are unpredictable and evenly distributed
    (i.e., the odds of getting any specific hash code are the same).</p>
</li>
<li>
<p>The output depends on the entire input:
    changing even a single byte almost certainly changes the hash code.</p>
</li>
</ol>
<p>It’s easy to write a bad hash function,
but very hard to write one that meets these two conditions.
We will therefore use Python’s <a href="https://docs.python.org/3/library/hashlib.html">hashlib</a> module
to calculate <span class="ix-entry" ix-key="hash code!SHA256;SHA256 hash code" markdown="1"><a class="gl-ref" href="../glossary/#sha256" markdown="1">SHA256</a></span> hashes of our files.
These are not random enough to keep data secret from a patient, well-funded attacker,
but that’s not what we’re using them for:
we just want hashes that are random enough to make
<span class="ix-entry" ix-key="hash function!collision;collision (in hashing)" markdown="1"><a class="gl-ref" href="../glossary/#collision" markdown="1">collision</a></span>
extremely unlikely.</p>
<div class="callout">
<h3>The Birthday Problem</h3>
<p>The odds that two people share a birthday are 1/365 (ignoring February 29).
The odds that they <em>don’t</em> are therefore 364/365.
When we add a third person,
the odds that they don’t share a birthday with either of the preceding two people are 363/365,
so the overall odds that nobody shares a birthday are (364/365)×(363/365).
If we keep going,
there’s a 50% chance of two people sharing a birthday in a group of just 23 people,
and a 99.9% chance with 70 people.</p>
<p>The same math can tell us how many files we need to hash before there’s a 50% chance of a collision.
According to <a href="https://en.wikipedia.org/wiki/Birthday_problem">Wikipedia</a>,
the answer is approximately \(4{\times}10^{38}\) files.
We’re willing to take that risk…</p>
</div>
<p>To calculate the hash of a file,
we create an object that keeps track of the current state of the hashing calculation
and then feed it some bytes.
When we are done,
we call its <code>hexdigest</code> method to  get the final result:</p>
<div class="code-sample lang-py" title="hash_stream.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># how much data to read at once</span>

<span class="k">def</span> <span class="nf">hash_stream</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
    <span class="n">sha256</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">sha256</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sha256</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"rb"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">hash_stream</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="hash_stream.sh">
<div class="highlight"><pre><span></span><code>python hash_stream.py frankenstein.txt
</code></pre></div>
</div>
<div class="code-sample lang-out" title="hash_stream.out">
<div class="highlight"><pre><span></span><code>0219696507d0db0e8c21c28e1b2de642b94de91be5ad9cfff0c27e5c51456987
</code></pre></div>
</div>
<p>To prove that it really does generate a unique code,
let’s calculate the hash of the novel <em>Dracula</em>:</p>
<div class="code-sample lang-sh" title="hash_stream_dracula.sh">
<div class="highlight"><pre><span></span><code>python hash_stream.py dracula.txt
</code></pre></div>
</div>
<div class="code-sample lang-out" title="hash_stream_dracula.out">
<div class="highlight"><pre><span></span><code>15d9da9ec739b9c59225ddf9bd5ca26441d761b63556fa92be556ebbf5ad442c
</code></pre></div>
</div>
<div class="callout">
<h3>Streaming</h3>
<p>This chunk-at-a-time interface is called
a <span class="ix-entry" ix-key="streaming API;execution!streaming" markdown="1"><a class="gl-ref" href="../glossary/#streaming_api" markdown="1">streaming</a></span> <a class="gl-ref" href="../glossary/#api" markdown="1">API</a>
because it processes a stream of data one piece at a time
rather than requiring all of the data to be in memory at once.
Many applications use streams
so that programs don’t have to read large files into memory.</p>
</div>
<h2 id="backup-files">Section 4.2: Saving Files</h2>
<p>Many files only change occasionally after they’re created, or not at all.
It would be wasteful for a version control system to make copies
each time the user saved a snapshot of a project,
so instead our tool will copy each unique file to something like <code>abcd1234.bck</code>,
where <code>abcd1234</code> is the hash of the file’s contents.
It will then keep a record of the filenames and hash keys in each snapshot.
The hash keys tell it which unique files are part of the snapshot,
while the filenames tell us what each file’s contents were called when the snapshot was made
(so that files can be moved or renamed).
To restore a particular snapshot,
we will copy the <code>.bck</code> files back to where they were
(<a class="fig-ref" href="../backup/#backup-storage">Figure 4.2</a>).</p>
<figure id="backup-storage">
<img alt="Backup file storage" src="./backup/backup_storage.svg"/>
<figcaption markdown="1">Figure 4.2: Organization of backup file storage.</figcaption>
</figure>
<p>The first step is to find all the files in or below a given directory
that we need to save.
The simple pattern matching in Python’s <a href="https://docs.python.org/3/library/glob.html">glob</a> module
can do this for us.
If we have this directory structure:</p>
<div class="code-sample lang-sh" title="show_try_glob.sh">
<div class="highlight"><pre><span></span><code>tree --charset ascii sample_dir
</code></pre></div>
</div>
<div class="code-sample lang-out" title="show_try_glob.out">
<div class="highlight"><pre><span></span><code>sample_dir
|-- a.txt
|-- b.txt
`-- subdir
    `-- c.txt

1 directory, 3 files
</code></pre></div>
</div>
<p class="continue">then a single call to <code>glob.glob</code> will find all the files with two-part names:</p>
<div class="code-sample lang-py" title="try_glob.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">root_dir</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"**/*.*"</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="try_glob.sh">
<div class="highlight"><pre><span></span><code>python try_glob.py sample_dir
</code></pre></div>
</div>
<div class="code-sample lang-out" title="try_glob.out">
<div class="highlight"><pre><span></span><code>b.txt
a.txt
subdir/c.txt
</code></pre></div>
</div>
<p>Let’s combine this with our hashing function
to create a table of files and hashes:</p>
<div class="code-sample lang-py" title="hash_all.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">hash_stream</span> <span class="kn">import</span> <span class="n">hash_stream</span>

<span class="k">def</span> <span class="nf">hash_all</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"**/*.*"</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">hash_code</span> <span class="o">=</span> <span class="n">hash_stream</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">hash_code</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">root_dir</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">"filename"</span><span class="p">,</span> <span class="s2">"hash"</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="hash_all.sh">
<div class="highlight"><pre><span></span><code>python hash_all.py sample_dir
</code></pre></div>
</div>
<div class="code-sample lang-out" title="hash_all.out">
<div class="highlight"><pre><span></span><code>filename,hash
b.txt,3cf9a1a81f6bdeaf08a343c1e1c73e89cf44c06ac2427a892382cae825e7c9c1
a.txt,17e682f060b5f8e47ea04c5c4855908b0a5ad612022260fe50e11ecb0cc0ab76
subdir/c.txt,5695d82a086b677962a0b0428ed1a213208285b7b40d7d3604876d36a710302a
</code></pre></div>
</div>
<h2 id="backup-test">Section 4.3: Testing</h2>
<p>Before we go any further
we need to figure out how we’re going to test our code.
The obvious approach is to create directories and sub-directories
containing some files we can use as <span class="ix-entry" ix-key="fixture" markdown="1">fixtures</span>.
However,
we are going to change or delete those files
as we back things up and restore them.
To make sure early tests don’t contaminate later ones
we would have to re-create those files and directories after each test.</p>
<p>A better approach is to use a <span class="ix-entry" ix-key="mock object" markdown="1"><a class="gl-ref" href="../glossary/#mock_object" markdown="1">mock object</a></span>
instead of the real filesystem (<a class="x-ref" href="#tester">Chapter 2</a>).
The <a href="https://pytest-pyfakefs.readthedocs.io/">pyfakefs</a> module replaces key functions like <code>read</code>
with functions that act the same
but act on “files” stores in memory
(<a class="fig-ref" href="../backup/#backup-mock-fs">Figure 4.3</a>).
Using it prevents our tests from accidentally disturbing the filesystem;
it also makes tests much faster
since in-memory operations are thousands of times faster than ones that touch the disk.</p>
<figure id="backup-mock-fs">
<img alt="Mock filesystem" src="./backup/backup_mock_fs.svg"/>
<figcaption markdown="1">Figure 4.3: Using a mock filesystem to simplify testing.</figcaption>
</figure>
<p>If we <code>import pyfakefs</code>,
we automatically get a fixture called <code>fs</code>
that we can use to create files.
We tell <a href="https://docs.pytest.org/">pytest</a> we want to use this fixture
by passing it as an argument to our testing function:</p>
<div class="code-sample lang-py" title="test_mock_fs.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">test_simple_example</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="s2">"This file contains one sentence."</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"alpha.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">sentence</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"alpha.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"alpha.txt"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">==</span> <span class="n">sentence</span>
</code></pre></div>
</div>
<p>We can use <code>fs</code> to create more complicated fixtures of our own
with multiple directories and files:</p>
<div class="code-sample lang-py" title="test_mock_tree.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">our_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"aaa"</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"b.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"bbb"</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"subdir/c.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"ccc"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_nested_example</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"b.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"subdir/c.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_deletion_example</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">Path</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">and then test that <code>hash_all</code> finds all the files:</p>
<div class="code-sample lang-py" title="test_hash_all.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">hash_all</span> <span class="kn">import</span> <span class="n">hash_all</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">our_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"aaa"</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"b.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"bbb"</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"subdir/c.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"ccc"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_hashing</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"a.txt"</span><span class="p">,</span> <span class="s2">"b.txt"</span><span class="p">,</span> <span class="s2">"subdir/c.txt"</span><span class="p">}</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">64</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and that hashes change when files change:</p>
<div class="code-sample lang-py" title="test_hash_all.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_change</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
    <span class="n">original</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">original</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"a.txt"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"a.txt"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"this is new content for a.txt"</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">changed</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"a.txt"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">original</span> <span class="o">!=</span> <span class="n">changed</span>
</code></pre></div>
</div>
<h2 id="backup-track">Section 4.4: Tracking Backups</h2>
<p>The second part of our backup tool keeps track of which files have and haven’t been backed up already.
It stores backups in a directory that contains files like <code>abcd1234.bck</code>
(the hash followed by <code>.bck</code>)
and CSV <a class="gl-ref" href="../glossary/#manifest" markdown="1">manifests</a> that describe the contents of particular snapshots.
The latter are named <code>ssssssssss.csv</code>,
where <code>ssssssssss</code> is the <a class="gl-ref" href="../glossary/#utc" markdown="1">UTC</a> <a class="gl-ref" href="../glossary/#timestamp" markdown="1">timestamp</a> of the backup’s creation.</p>
<div class="callout">
<h3>Time of check/time of use</h3>
<p>Our naming convention for index files will fail if we try to create more than one backup per second.
This might seem very unlikely,
but many faults and security holes are the result of programmers assuming things weren’t going to happen.</p>
<p>We could try to avoid this problem by using a two-part naming scheme <code>ssssssss-a.csv</code>,
<code>ssssssss-b.csv</code>, and so on,
but this leads to a <span class="ix-entry" ix-key="race condition" markdown="1"><a class="gl-ref" href="../glossary/#race_condition" markdown="1">race condition</a></span>
called <span class="ix-entry" ix-key="race condition!time of check/time of use;time of check/time of use" markdown="1"><a class="gl-ref" href="../glossary/#toctou" markdown="1">time of check/time of use</a></span>.
If two users run the backup tool at the same time,
they will both see that there isn’t a file (yet) with the current timestamp,
so they will both try to create the first one.
We will look at better schemes in the exercises.</p>
</div>
<p>This function creates a backup:</p>
<div class="code-sample lang-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">):</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">current_time</span><span class="p">()</span>
    <span class="n">write_manifest</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
    <span class="n">copy_files</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">manifest</span>
</code></pre></div>
</div>
<p class="continue">When writing the manifest,
we check that the backup directory exists,
create it if it does not,
and then save the manifest as CSV:</p>
<div class="code-sample lang-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">write_manifest</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
    <span class="n">backup_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">backup_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">backup_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">"filename"</span><span class="p">,</span> <span class="s2">"hash"</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We then copy those files that <em>haven’t</em> already been saved:</p>
<div class="code-sample lang-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">copy_files</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hash_code</span><span class="p">)</span> <span class="ow">in</span> <span class="n">manifest</span><span class="p">:</span>
        <span class="n">source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">hash_code</span><span class="si">}</span><span class="s2">.bck"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Finally,
we could call <code>time.time()</code> directly to get the current time,
but we will wrap it up to give ourselves something
that we can easily replace with a mock for testing:</p>
<div class="code-sample lang-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">current_time</span><span class="p">():</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
</div>
<p>Let’s do one test with real files:</p>
<div class="code-sample lang-sh" title="test_backup_manual.sh">
<div class="highlight"><pre><span></span><code>python backup.py sample_dir /tmp/backups
tree --charset ascii /tmp/backups
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_backup_manual.out">
<div class="highlight"><pre><span></span><code>/tmp/backups
|-- 1662312920.csv
|-- 17e682f060b5f8e47ea04c5c4855908b0a5ad612022260fe50e11ecb0cc0ab76.bck
|-- 3cf9a1a81f6bdeaf08a343c1e1c73e89cf44c06ac2427a892382cae825e7c9c1.bck
`-- 5695d82a086b677962a0b0428ed1a213208285b7b40d7d3604876d36a710302a.bck

0 directories, 4 files
</code></pre></div>
</div>
<p>The rest of our tests use a fake filesystem
and a mock replacement for the <code>current_time</code> function
(so that we know what the manifest file will be called).
The setup is:</p>
<div class="code-sample lang-py" title="test_backup.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">backup</span> <span class="kn">import</span> <span class="n">backup</span>

<span class="n">FILES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"a.txt"</span><span class="p">:</span> <span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"b.txt"</span><span class="p">:</span> <span class="s2">"bbb"</span><span class="p">,</span> <span class="s2">"subdir/c.txt"</span><span class="p">:</span> <span class="s2">"ccc"</span><span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">our_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">FILES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">contents</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and an example of a single test is:</p>
<div class="code-sample lang-py" title="test_backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_nested_example</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">"backup.current_time"</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">backup</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"/backup"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">hash_code</span> <span class="ow">in</span> <span class="n">manifest</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"/backup"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">hash_code</span><span class="si">}</span><span class="s2">.bck"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"/backup"</span><span class="p">,</span> <span class="s2">"1234.csv"</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>
</div>
<h2 id="backup-summary">Section 4.5: Summary</h2>
<figure id="backup-concept-map">
<img alt="Concept map of file backup" src="./backup/backup_concept_map.svg"/>
<figcaption markdown="1">Figure 4.4: Concept map for hashing-based file backup.</figcaption>
</figure>
<h2 id="backup-exercises">Section 4.6: Exercises</h2>
<h3 class="exercise">Odds of collision</h3>
<p>If hashes were only 2 bits long,
then the chances of collision with each successive file
assuming no previous collision are:</p>
<table>
<thead>
<tr>
<th>Number of Files</th>
<th>Odds of Collision</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0%</td>
</tr>
<tr>
<td>2</td>
<td>25%</td>
</tr>
<tr>
<td>3</td>
<td>50%</td>
</tr>
<tr>
<td>4</td>
<td>75%</td>
</tr>
<tr>
<td>5</td>
<td>100%</td>
</tr>
</tbody>
</table>
<p>A colleague of yours says this means that if we hash four files,
there’s only a 75% chance of any collision occurring.
What are the actual odds?</p>
<h3 class="exercise">Streaming I/O</h3>
<p>Write a small program using <code>fs.createReadStream</code> and <code>fs.createWriteStream</code>
that copies a file piece by piece
instead of reading it into memory and then writing it out again.</p>
<h3 class="exercise">Sequencing backups</h3>
<p>Modify the backup program so that manifests are numbered sequentially
as <code>00000001.csv</code>, <code>00000002.csv</code>, and so on
rather than being timestamped.
Why doesn’t this solve the time of check/time of use race condition mentioned earlier.</p>
<h3 class="exercise">JSON manifests</h3>
<ol>
<li>
<p>Modify <code>backup.py</code> so that it can save JSON manifests as well as CSV manifests
    based on a command-line flag.</p>
</li>
<li>
<p>Write another program called <code>migrate.py</code> that converts a set of manifests
    from CSV to JSON.
    (The program’s name comes from the term <a class="gl-ref" href="../glossary/#data_migration" markdown="1">data migration</a>.)</p>
</li>
<li>
<p>Modify <code>backup.py</code> programs so that each manifest stores the user name of the person who created it
    along with file hashes,
    and then modify <code>migrate.py</code> to transform old files into the new format.</p>
</li>
</ol>
<h3 class="exercise">Mock hashes</h3>
<ol>
<li>
<p>Modify the file backup program so that it uses a function called <code>ourHash</code> to hash files.</p>
</li>
<li>
<p>Create a replacement that returns some predictable value, such as the first few characters of the data.</p>
</li>
<li>
<p>Rewrite the tests to use this function.</p>
</li>
</ol>
<p>How did you modify the main program so that the tests could control which hashing function is used?</p>
<h3 class="exercise">Comparing manifests</h3>
<p>Write a program <code>compare-manifests.py</code> that reads two manifest files and reports:</p>
<ul>
<li>
<p>Which files have the same names but different hashes
    (i.e., their contents have changed).</p>
</li>
<li>
<p>Which files have the same hashes but different names
    (i.e., they have been renamed).</p>
</li>
<li>
<p>Which files are in the first hash but neither their names nor their hashes are in the second
    (i.e., they have been deleted).</p>
</li>
<li>
<p>Which files are in the second hash but neither their names nor their hashes are in the first
    (i.e., they have been added).</p>
</li>
</ul>
<h3 class="exercise">From one state to another</h3>
<ol>
<li>
<p>Write a program called <code>from_to.py</code> that takes the name of a directory
    and the name of a manifest file
    as its command-line arguments,
    then adds, removes, and/or renames files in the directory
    to restore the state described in the manifest.
    The program should only perform file operations when it needs to,
    e.g.,
    it should not delete a file and re-add it if the contents have not changed.</p>
</li>
<li>
<p>Write some tests for <code>from_to.py</code> using pytest and a mock filesystem.</p>
</li>
</ol>
<h3 class="exercise">File history</h3>
<ol>
<li>
<p>Write a program called <code>file_history.py</code>
    that takes the name of a file as a command-line argument
    and displays the history of that file
    by tracing it back in time through the available manifests.</p>
</li>
<li>
<p>Write tests for your program using pytest and a mock filesystem.</p>
</li>
</ol>
<h3 class="exercise">Pre-commit hooks</h3>
<p>Modify <code>backup.py</code> to load and run a function called <code>pre_commit</code> from a file called <code>pre_commit.py</code>
stored in the root directory of the files being backed up.
If <code>pre_commit</code> returns <code>True</code>, the backup proceeds;
if it returns <code>False</code> or throws an exception,
no backup is created.</p>
<h3 class="exercise">Naming manifests</h3>
<ol>
<li>
<p>How does Git keep track of the manifests that record
    which files are in each snapshot?</p>
</li>
<li>
<p>Add a simple version of this scheme to the backup tool
    developed in this chapter.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="cache">Chapter: Chapter 5: A File Cache</h1>

<ul class="syllabus">
<li markdown="1">Software systems often uses caches to store a subset of files in order to use less disk space.</li>
<li markdown="1">Caching systems can replace actual files with placeholders containing metadata.</li>
<li markdown="1">Object-oriented systems are often implemented in stages to break large design problems into smaller, more manageable ones.</li>
<li markdown="1">In a good design, derived classes only have to override a few (preferably none) of the methods implemented in parent classes.</li>
<li markdown="1">Implementing a minimum testable class allows early testing of core functionality.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#abstract_class" markdown="1">abstract class</a>, <a class="gl-ref" href="../glossary/#atomic_operation" markdown="1">atomic operation</a>, <a class="gl-ref" href="../glossary/#authentication" markdown="1">authentication</a>, <a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a>, <a class="gl-ref" href="../glossary/#cognitive_load" markdown="1">cognitive load</a>, <a class="gl-ref" href="../glossary/#context_manager" markdown="1">context manager</a>, <a class="gl-ref" href="../glossary/#immutable" markdown="1">immutable</a>, <a class="gl-ref" href="../glossary/#minimum_testable_class" markdown="1">minimum testable class</a>, <a class="gl-ref" href="../glossary/#named_tuple" markdown="1">named tuple</a>, <a class="gl-ref" href="../glossary/#placeholder_file" markdown="1">placeholder file</a>
</p>
<div class="page-toc"></div>
<p>Data scientists often want to analyze the same files in several projects.
Those files might be too sensitive or too large to store in version control.
Even when that’s not the case,
storing several copies eventually results in someone analyzing an out-of-date version of the data.</p>
<p>Tools like <a href="https://git-lfs.github.io/">Git LFS</a> and <a href="https://dvc.org/">DVC</a> are an alternative.
These tools replace the actual data file with a <a class="gl-ref" href="../glossary/#placeholder_file" markdown="1">placeholder file</a>
that contains a unique ID,
such as a hash of the data file’s contents
(<a class="fig-ref" href="../cache/#cache-architecture">Figure 5.1</a>).
The placeholder file is small,
so it can be committed to version control,
and if the file it refers to changes,
that change will be visible in the version control history.</p>
<figure id="cache-architecture">
<img alt="Cache architecture" src="./cache/cache_architecture.svg"/>
<figcaption markdown="1">Figure 5.1: Architecture of a local file cache.</figcaption>
</figure>
<p>The data file is stored on a server or in the cloud
and downloaded on demand.
Since the data file might be shared between several projects,
it is usually not downloaded into any particular project.
Instead,
it is stored in a <a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a>
that all projects have access to.
If the cache gets too large,
files in it can be deleted
and re-downloaded later.</p>
<p>This architecture has four parts:
the permanent archive of data files,
an index of all the files it contains,
the cache of locally-available files,
and the placeholder files that are actually saved in version control.
There are several ways to implement each of these,
so our implementation will give us a chance to explore some ideas in object-oriented programming.</p>
<h2 id="cache-index">Section 5.1: A File Index</h2>
<p>Let’s start by creating the index of archived files.
We need to record each file’s unique identifier
and the time it was added to the archive;
we could define a class for this,
but since instances of that class are just passive data records,
we use a <a class="gl-ref" href="../glossary/#named_tuple" markdown="1">named tuple</a> instead:</p>
<div class="code-sample lang-py" title="index_base.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">CacheEntry</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"CacheEntry"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"identifier"</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">])</span>
</code></pre></div>
</div>
<p>Next,
we create an <a class="gl-ref" href="../glossary/#abstract_class" markdown="1">abstract class</a>
that defines the operation an index can do,
but doesn’t actually implement them—or rather,
only implements the ones that can be defined in terms of lower-level operations
that derived class will implement:</p>
<div class="code-sample lang-py" title="index_base.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IndexBase</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">TIME_FORMAT</span> <span class="o">=</span> <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">:%H:%M:%S"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_index_dir</span><span class="p">(</span><span class="n">index_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_index_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dir</span>

    <span class="k">def</span> <span class="nf">set_index_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_dir</span> <span class="o">=</span> <span class="n">index_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">identifier</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">known</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">CacheEntry</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">current_time</span><span class="p">())</span>
        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The methods of <code>IndexBase</code> can:</p>
<ul>
<li>get and set the directory where the index file is stored;</li>
<li>check if a particular file is known (using its identifier, not its name);</li>
<li>get a list of all known files (again, by identifier rather than name); and</li>
<li>add an identifier to the index with a timestamp.</li>
</ul>
<p class="continue">These methods rely on three abstract methods to
initialize the index if it doesn’t already exist,
load the index,
and save the index.
Their definitions are:</p>
<div class="code-sample lang-py" title="index_base.py">
<div class="highlight"><pre><span></span><code>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Load entire index."""</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">"""Save entire index."""</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_initialize_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Initialize index file if necessary."""</span>
</code></pre></div>
</div>
<p>Finally,
we define a function <code>current_time</code>
that returns a time we can use in an index record.
Doing this gives us something that will be easy to mock for testing:</p>
<div class="code-sample lang-py" title="index_base.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">current_time</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Naming Things</h3>
<p>The index stores files’ unique IDs rather than their names
because the latter are unreliable.
A file may be moved or renamed several times within a project,
or may have different names in different projects;
our design therefore relies on something intrinsic to the file
rather than something under the user’s control.</p>
<p>The price for this decision is that files’ “names” are meaningless.
Whether we use sequence numbers or hashes,
remembering that <code>health_records.csv</code> is file 177234
increases the <a class="gl-ref" href="../glossary/#cognitive_load" markdown="1">cognitive load</a> on our users.</p>
</div>
<p>By writing <code>IndexBase</code>,
we have turned a large, amorphous design problem
into a smaller and more focused one
(<a class="fig-ref" href="../cache/#cache-methods">Figure 5.2</a>).
For example,
if we decide to store the index as a JSON file or in a SQLite database,
we should only need to provide the methods to handle that file format;
we should not need to re-write or re-test any of the other methods.
This rule gives us a way to evaluate our designs:
the fewer methods we have to override,
the better the original division of labor was.</p>
<p>To try it out,
let’s implement a concrete index class that stores data in a CSV file.
<code>load</code> checks that the cache directory exists
and that it contains an index file,
then reads that file and turns its contents into <code>CacheEntry</code> records:</p>
<div class="code-sample lang-py" title="index_csv.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IndexCSV</span><span class="p">(</span><span class="n">IndexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CacheException</span><span class="p">(</span><span class="s2">"Cache directory not set in index"</span><span class="p">)</span>

        <span class="n">index_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_index_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CacheException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Index file </span><span class="si">{</span><span class="n">index_path</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">CacheEntry</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIME_FORMAT</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reader</span>
            <span class="p">]</span>
</code></pre></div>
</div>
<figure id="cache-methods">
<img alt="Cache index methods" src="./cache/cache_methods.svg"/>
<figcaption markdown="1">Figure 5.2: Calling relationships between cache index methods.</figcaption>
</figure>
<p>Similarly,
<code>save</code> checks that the cache directory exists
and then writes each record to the index file.
This method automatically creates the index file
if it doesn’t already exist:</p>
<div class="code-sample lang-py" title="index_csv.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IndexCSV</span><span class="p">(</span><span class="n">IndexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CacheException</span><span class="p">(</span><span class="s2">"Cache directory not set in index"</span><span class="p">)</span>

        <span class="n">index_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_index_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CacheException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Index file </span><span class="si">{</span><span class="n">index_path</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">CacheEntry</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIME_FORMAT</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reader</span>
            <span class="p">]</span>
</code></pre></div>
</div>
<p>Finally,
we need to write <code>_initialize_index</code>,
which is called by the <code>set_index_dir</code> method in the base class
rather than being invoked directly by the user.
While we’re doing that,
we’ll define the name for the index file
and write a helper method that produces its full path:</p>
<div class="code-sample lang-py" title="index_csv.py">
<div class="highlight"><pre><span></span><code>    <span class="n">INDEX_FILE</span> <span class="o">=</span> <span class="s2">"index.csv"</span>

    <span class="k">def</span> <span class="nf">_initialize_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_index_path</span><span class="p">()</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_index_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CacheException</span><span class="p">(</span><span class="s2">"Cache directory not set in index"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">INDEX_FILE</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Time to do some testing.
As in <a class="x-ref" href="#backup">Chapter 4</a>,
we will use <a href="https://pytest-pyfakefs.readthedocs.io/">pyfakefs</a> instead of creating files on disk
and pytest’s <code>fixture</code> decorator to set things up:</p>
<div class="code-sample lang-py" title="test_index_csv.py">
<div class="highlight"><pre><span></span><code><span class="n">CACHE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"/cache"</span><span class="p">)</span>
<span class="n">INDEX_FILE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">,</span> <span class="n">IndexCSV</span><span class="o">.</span><span class="n">INDEX_FILE</span><span class="p">)</span>
<span class="n">LOCAL_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">disk</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">)</span>
</code></pre></div>
</div>
<p>If we create a new cache,
it should be empty:</p>
<div class="code-sample lang-py" title="test_index_csv.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_csv_loads_initially</span><span class="p">(</span><span class="n">disk</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">IndexCSV</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="o">==</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">known</span><span class="p">()</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">If we add an entry,
it should still be there when we reload the index:</p>
<div class="code-sample lang-py" title="test_index_csv.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_csv_saves_changes</span><span class="p">(</span><span class="n">disk</span><span class="p">):</span>
    <span class="n">right_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">IndexCSV</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">"index_base.current_time"</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">right_now</span><span class="p">):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"abcd1234"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="n">CacheEntry</span><span class="p">(</span><span class="s2">"abcd1234"</span><span class="p">,</span> <span class="n">right_now</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">known</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"abcd1234"</span><span class="p">}</span>
</code></pre></div>
</div>
<p>And if we check whether or not something is in the index,
the answer should be “yes” for things we’ve added
and “no” for things we haven’t:</p>
<div class="code-sample lang-py" title="test_index_csv.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_csv_has_entry</span><span class="p">(</span><span class="n">disk</span><span class="p">):</span>
    <span class="n">right_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">IndexCSV</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">"index_base.current_time"</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">right_now</span><span class="p">):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"abcd1234"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">"abcd1234"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">"dcba4321"</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="cache-local">Section 5.2: A Local Cache</h2>
<p>Just as <code>IndexBase</code> defined the behavior every cache index must have,
<code>CacheBase</code> defines the required behavior of caches themselves.
As the listing below shows,
it is less than three dozen lines long:</p>
<div class="code-sample lang-py" title="cache_base.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CacheBase</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">CACHE_SUFFIX</span> <span class="o">=</span> <span class="s2">"cache"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_identifier</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">identifier</span>

    <span class="k">def</span> <span class="nf">get_cache_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CacheException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown file identifier </span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cache_path</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">known</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">known</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hash_stream</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_cache_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CACHE_SUFFIX</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
        <span class="sd">"""Add a file with a given identifer from a given local path."""</span>
</code></pre></div>
</div>
<p><code>CacheBase</code> encapsulates several design decisions.
Cached files are named <code><em>identifier</em>.cache</code>,
and are all stored in a single directory.
This scheme works well if the cache only ever has a few thousand files,
but if that number might grow into the tens or hundreds of thousands,
we might want to divide the cached files between several sub-directories
(which is what most browsers do).</p>
<p>All of <code>CacheBase</code>‘s operations are implemented in terms of
an index derived from <code>IndexBase</code>,
a helper method that makes a file identifier by hashing the file’s contents,
another helper method that constructs the path to a cached file,
and a single abstract method called <code>_add</code>
that actually adds a file to the cache.
<code>CacheBase</code> <em>doesn’t</em> rely on how the index is implemented,
which means we can defer making that decision until we absolutely have to.
Equally,
encapsulating the specifics of file storage in a single method
allows us to do most of the implementation
before figuring that out.</p>
<p>With <code>CacheBase</code> in place,
we can create a class called <code>CacheFilesystem</code>
that copies files to the local cache
but doesn’t actually archive them anywhere:</p>
<div class="code-sample lang-py" title="cache_filesystem.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CacheFilesystem</span><span class="p">(</span><span class="n">CacheBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cache_path</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">)</span>
</code></pre></div>
</div>
<p>A file archiving system that doesn’t actually archive files
isn’t particularly useful in practice,
but it enables us to write some useful tests.
Developers often create
a <span class="ix-entry" ix-key="minimum testable class" markdown="1"><a class="gl-ref" href="../glossary/#minimum_testable_class" markdown="1">minimum testable class</a></span>
for this reason.
Just as creating an abstract base class that implements operations
in terms of a small number of methods
helps us break a design problem into smaller, more manageable pieces,
building a minimum testable class
enables us to check some things right away
so that we can focus later testing effort
on implementation-specific details.</p>
<p>By now our testing should look familiar.
We create a fixture for the filesystem as a whole
and another for the cache:</p>
<div class="code-sample lang-py" title="test_cache_filesystem.py">
<div class="highlight"><pre><span></span><code><span class="n">CACHE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"/cache"</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">disk</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fs</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">cache</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">CacheFilesystem</span><span class="p">(</span><span class="n">IndexCSV</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">),</span> <span class="n">CACHE_DIR</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and then write a test to check that
if we haven’t ever added files to the cache,
no files are present:</p>
<div class="code-sample lang-py" title="test_cache_filesystem.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_filesystem_no_files_before_add</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">known</span><span class="p">()</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We can then start testing that (for example)
if we add two files with different names,
the cache contains two files:</p>
<div class="code-sample lang-py" title="test_cache_filesystem.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_filesystem_two_files_present_after_add</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="s2">"ab"</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.txt"</span>
        <span class="n">disk</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">known</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>
</div>
<h2 id="cache-limit">Section 5.3: A Limited Cache</h2>
<p>The next step is to archive all the files remotely
and only cache a few locally.
We will simulate remote storage using a second directory on our own machine,
and limit the number of files in the cache
rather than their total size;
we’ll look at a size-based cache in the exercises.</p>
<div class="callout">
<h3>Figure It Out Later</h3>
<p>As soon as we start storing files on remote servers,
we need to figure out how to <a class="gl-ref" href="../glossary/#authentication" markdown="1">authenticate</a> the user,
i.e.,
how to establish that they are who they say they are.
Again,
building our system piece by piece lets us sort out other details now
and worry about those ones later.
We are taking a risk, though:
it’s possible that we won’t be able to extend our design to handle those extra requirements,
but will instead have to tear it down and start over.
Experience is the only reliable guide;
the real aim of lessons like this one is
to pass on experience so that the next person doesn’t have to step on all the landmines themselves.</p>
</div>
<p>Our new class <code>CacheLimited</code> needs:</p>
<ul>
<li>an index to keep track of files;</li>
<li>the path to the cache directory;</li>
<li>the path to the archive directory
    that we’re using to simulate remote storage;
    and</li>
<li>the maximum number of files the cache is allowed to contain.</li>
</ul>
<p>Its constructor is therefore:</p>
<div class="code-sample lang-py" title="cache_limited.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CacheLimited</span><span class="p">(</span><span class="n">CacheFilesystem</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span> <span class="n">local_limit</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span> <span class="o">=</span> <span class="n">archive_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_limit</span> <span class="o">=</span> <span class="n">local_limit</span>
</code></pre></div>
</div>
<p>At this point we are going to do something that
we said earlier we wouldn’t need to do.
<code>CacheBase</code> defines a method <code>get_cache_path</code>,
and <code>CacheFilesystem</code> used that method without altering it.
In contrast,
our new <code>CacheLimited</code> class overrides it
to ensure there’s a local copy of a file
whenever we want to read it.
In doing so,
<code>get_cache_path</code> ensures that
the cache has enough space for that file.
More specifically,
if we add a file when the cache is full,
<code>CacheLimited</code> will:</p>
<ul>
<li>delete a file from the cache;</li>
<li>add the new file to the cache; and</li>
<li>add it to archival storage.</li>
</ul>
<div class="code-sample lang-py" title="cache_limited.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_cache_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_cache_path</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_cache_space</span><span class="p">()</span>
            <span class="n">archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_archive_path</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache_path</span>
</code></pre></div>
</div>
<p>The method that ensures the cache has space for a new file
checks the cache’s size
and removes a file if necessary:</p>
<div class="code-sample lang-py" title="cache_limited.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_ensure_cache_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check size.</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="n">cache_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_limit</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Remove a file.</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">cache_files</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_limit</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We also need to implement <code>_add</code>
to handle the case of adding an entirely new file</p>
<div class="code-sample lang-py" title="cache_limited.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_archive</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_cache_space</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The tests for <code>CacheLimited</code> look like those we’ve written before:</p>
<div class="code-sample lang-py" title="test_cache_limited.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_limited_single_file_present_after_add</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
    <span class="n">disk</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"test.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">)</span>
    <span class="n">ident</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"test.txt"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">known</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="n">ident</span><span class="p">}</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_path</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">CACHE_DIR</span><span class="p">)</span>
    <span class="n">archive_path</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">_make_archive_path</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>
</div>
<p>One difference is that they check the archive directory
as well as the cache directory.
To do this,
the tests may use a method like <code>_make_archive_path</code>
that isn’t intended for general consumption.
Application programs should never do this,
but it’s generally regarded as acceptable for tests
(not least because the alternative is
to make that “private” method generally available).</p>
<h2 id="cache-placeholders">Section 5.4: Placeholders</h2>
<p>The last thing we need for a fully-functional repository-friendly file-caching system is
a reliable way to create the placeholder files
that take the place of actual data files in version control.
Each file holds a cache entry identifier,
so if we do our job properly,
users will never need to see these or remember them.</p>
<p>Python provides an <code>open</code> function for opening files,
so we will create a <code>cache_open</code> function to open cached files:</p>
<div class="code-sample lang-py" title="cache_io.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">cache_open</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">CACHE_SUFFIX</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">CACHE_SUFFIX</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No local cache file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_path</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>If the actual file is called <code>a.txt</code>,
this function looks for <code>a.txt.cache</code>,
reads the file identifier from it,
uses that to find the path to the cached file,
and opens that file for reading.
We don’t allow users to open files for writing,
since that would almost certainly put the file’s contents
out of step with its identifier.
This restriction is similar to Python’s requirement that
dictionaries’ keys be <a class="gl-ref" href="../glossary/#immutable" markdown="1">immutable</a>;
we will explore alternatives in the exercises.</p>
<p><code>cache_save</code> is the complement to <code>cache_open</code>.
Given the name of a local file that the user wants to cache,
this function saves it in the cache
and constructs a placeholder file:</p>
<div class="code-sample lang-py" title="cache_io.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">cache_save</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">identifier_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">cache</span><span class="o">.</span><span class="n">CACHE_SUFFIX</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">identifier_file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
</code></pre></div>
</div>
<p>These two functions work as designed,
but neither should be used in production.
The problem is that neither guarantees
<span class="ix-entry" ix-key="atomic operation" markdown="1"><a class="gl-ref" href="../glossary/#atomic_operation" markdown="1">atomic operation</a></span>:
in both cases,
if something goes wrong part-way through the function,
the caching system can be left in an inconsistent state.
While there’s no obvious way for these functions to fail mid-flight,
there’s always the possibility of a power failure
or of the user typing Control-C to interrupt the program
at just the wrong spot.
Tools like <a href="https://dvc.org/">DVC</a> do a lot of extra work
to guarantee that this can’t happen.</p>
<h2 id="cache-summary">Section 5.5: Summary</h2>
<figure id="cache-concept-map">
<img alt="Concept map for file cache" src="./cache/cache_concept_map.svg"/>
<figcaption markdown="1">Figure 5.3: Concepts for file cache.</figcaption>
</figure>
<h2 id="cache-exercises">Section 5.6: Exercises</h2>
<h3 class="exercise">An alternative index</h3>
<p>Create a new class <code>IndexJSON</code> that stores the index as a JSON file
instead of as CSV.
You should be able to use your new class with the existing cache classes
without changing the latter.</p>
<h3 class="exercise">Another alternative index</h3>
<p>Create a new class <code>IndexSQLite</code> that stores the index in a <a href="https://sqlite.org/">SQLite</a> database
instead of as CSV.
You should be able to use your new class with the existing cache classes
without changing the latter.</p>
<h3 class="exercise">Consolidation</h3>
<p>Write a tool that finds all the placeholder files in a project
and copies the files they refer to from the cache into the project,
deleting placeholders as it does so.</p>
<h3 class="exercise">Cache size</h3>
<ol>
<li>Modify the cache so that it only stores files up to a specified total size.</li>
<li>How should the cache decide which files to delete
    when a new file would put it over its size limit?</li>
<li>What should the cache do if someone tries to add a file
    that is larger than the size limit?</li>
</ol>
<h3 class="exercise">Least recently used</h3>
<ol>
<li>Modify the cache and index to keep track of when files are used
    as well as when they are created.</li>
<li>Modify the cache cleanup code to delete least recently used file
    when extra space is needed.</li>
</ol>
<h3 class="exercise">Compressing files</h3>
<ol>
<li>
<p>Modify the system to compress files when they are archived.
    Use Python’s <a href="https://docs.python.org/3/library/zipfile.html">zipfile</a> module to handle compression.</p>
</li>
<li>
<p>Modify the system again so that users can specify
    whether files should be compressed in both the archive and the cache,
    only compressed in the archive,
    or never compressed.</p>
</li>
</ol>
<h3 class="exercise">Reading cached files</h3>
<p>Modify <code>cache_open</code> so that files can be opened in binary mode
and so that the function can be used in <code>with</code> statements.
(Hint: look up <a class="gl-ref" href="../glossary/#context_manager" markdown="1">context manager</a>.)</p>
<h3 class="exercise">Storing files remotely</h3>
<ol>
<li>Create a small web server (<a class="x-ref" href="#server">Chapter 11</a>) that accepts
    file upload and file download requests.</li>
<li>Modify the cache so that it sends new files to the server
    and downloads files from the server on demand.</li>
</ol>
<h3 class="exercise">Commenting</h3>
<ol>
<li>
<p>Modify the system so that users can add comments about files
    in the local placeholder files.</p>
</li>
<li>
<p>Suppose two projects A and B are stored in separate version control repositories,
    but use the same data files.
    If comments are stored in placeholder files
    then comments saved in A won’t be visible in B and vice versa.
    How could you modify your solution to part 1 to enable inter-project sharing of comments?</p>
</li>
</ol>
<h3 class="exercise">Appending</h3>
<p>Modify the system so that users can append data to existing files:</p>
<ol>
<li>
<p>Each placeholder file stores the IDs of one or more cached files
    and the number of bytes in each.</p>
</li>
<li>
<p>When a user wants to read from a file,
    they may specify a byte offset from the start of the (logical) file
    where reading is to start.</p>
</li>
<li>
<p>When a user opens a file for appending,
    another chunk is created in the cache
    and writes are appended to it.
    When they close the file,
    an entry is added to the placeholder file
    with information about the new chunk.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="persistence">Chapter: Chapter 6: Object Persistence</h1>

<ul class="syllabus">
<li markdown="1">A persistence framework saves and restores objects.</li>
<li markdown="1">Persistence must handle aliasing and circularity.</li>
<li markdown="1">Users should be able to extend persistence to handle objects of their own types.</li>
<li markdown="1">Software designs should be open for extension but closed for modification.</li>
<li markdown="1">Extensibility can be implemented using multiple inheritance, duck typing, or helper classes.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#alias" markdown="1">alias</a>, <a class="gl-ref" href="../glossary/#atomic_value" markdown="1">atomic value</a>, <a class="gl-ref" href="../glossary/#duck_typing" markdown="1">duck typing</a>, <a class="gl-ref" href="../glossary/#dynamic_dispatch" markdown="1">dynamic dispatch</a>, <a class="gl-ref" href="../glossary/#escape_sequence" markdown="1">escape sequence</a>, <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>, <a class="gl-ref" href="../glossary/#helper_class" markdown="1">helper class</a>, <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>, <a class="gl-ref" href="../glossary/#json" markdown="1">JavaScript Object Notation</a>, <a class="gl-ref" href="../glossary/#list_comprehension" markdown="1">list comprehension</a>, <a class="gl-ref" href="../glossary/#open_closed_principle" markdown="1">Open-Closed Principle</a>, <a class="gl-ref" href="../glossary/#persistence" markdown="1">persistence</a>, <a class="gl-ref" href="../glossary/#pythonic" markdown="1">Pythonic</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>
</p>
<div class="page-toc"></div>
<p>Version control systems can manage our files for us,
but what should we put in those files?
Plain text is one option
(in fact, the only option that most version control systems fully support),
but another is to store objects,
i.e.,
to save a list of dictionaries as-is
rather than flattering it into rows and columns.
Python’s <a href="https://docs.python.org/3/library/pickle.html">pickle</a> module does this in a Python-specific way,
while the <a href="https://docs.python.org/3/library/json.html">json</a> module saves some kinds of objects as text
formatted as <a class="gl-ref" href="../glossary/#json" markdown="1">JSON</a>,
which program written in other languages can read.</p>
<p>The phrase “some kinds of objects” is the most important part of the preceding paragraph.
Since programs can define new classes,
a <span class="ix-entry" ix-key="persistence" markdown="1"><a class="gl-ref" href="../glossary/#persistence" markdown="1">persistence framework</a></span>
has to choose one of the following:</p>
<ol>
<li>
<p>Only handle built-in types,
    or even more strictly,
    only handle types that are common across many languages,
    so that data saved by Python can be read by JavaScript and vice versa.</p>
</li>
<li>
<p>Provide a way for programs to convert from user-defined types
    to built-in types
    and then save those.
    This option is less restrictive than the first
    but can lead to some information being lost.
    For example,
    if instances of a program’s <code>User</code> class are saved as dictionaries,
    the program that reads data will wind up with dictionaries instead of users.</p>
</li>
<li>
<p>Save class definitions as well as objects’ values
    so that when a program reads saved data
    it can reconstruct the classes
    and then create fully-functional instances of them.
    This choice is the most powerful,
    but it is also the hardest to implement,
    particularly across languages.
    It is also the riskiest:
    if a program is reading and then running saved methods,
    it has to trust that those methods aren’t doing anything malicious.</p>
</li>
</ol>
<p>This chapter starts by implementing the first option (built-in types only),
then extends it to handle <a class="gl-ref" href="../glossary/#alias" markdown="1">aliases</a>
(which JSON does not),
and finally adds ways to convert user-defined types to storable data.
To keep parsing and testing simple
our framework will store everything as text with one value per line;
we will look at non-text options in <a class="x-ref" href="#binary">Chapter 7</a>.</p>
<h2 id="persistence-builtin">Section 6.1: Built-in Types</h2>
<p>The first thing we need to do is specify our data format.
We will store each <a class="gl-ref" href="../glossary/#atomic_value" markdown="1">atomic value</a> on a line of its own
with the type’s name first and the value second.
For example,
the integer <code>123</code> will be saved as:</p>
<div class="highlight"><pre><span></span><code>int:123
</code></pre></div>
<p>The function <code>save</code> handles three of Python’s built-in types to start with:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"bool:</span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"float:</span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"int:</span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"unknown type of thing </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The function that loads data starts by reading a single line,
stripping off the newline at the end
(which is added automatically by the <code>print</code> in <code>save</code>),
and then splitting the line on the colon.
After checking that there are two fields,
it uses the type name in the first field
to decide how to handle the second:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">line</span><span class="p">,</span> <span class="s2">"Nothing to read"</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Badly-formed line </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span>

    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"bool"</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"True"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"False"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">names</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown Boolean </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"float"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"int"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"unknown type of thing </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Saving a list is almost as easy:
we save the number of items in the list,
and then save each item with a recursive called to <code>save</code>
(<a class="fig-ref" href="../persistence/#persistence-lists">Figure 6.1</a>).
For example,
the list <code>[55, True, 2.71]</code> is saved as:</p>
<div class="highlight"><pre><span></span><code>list:3
int:55
bool:True
float:2.71
</code></pre></div>
<figure id="persistence-lists">
<img alt="Saving lists" src="./persistence/persistence_lists.svg"/>
<figcaption markdown="1">Figure 6.1: Saving nested data structures.</figcaption>
</figure>
<p>The code to do this is:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"list:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
            <span class="n">save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To load data we just read the specified number of items back into a list:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>
</code></pre></div>
</div>
<p>Notice that these two functions don’t need to know
what kinds of values are in the list:
each recursive call to <code>save</code> or <code>load</code>
advances the input or output stream
by precisely as many lines as it needs to.
Notice also that this approach handles nested lists without any extra work.</p>
<p>Our functions handle sets in exactly the same was as lists;
the only difference is using the keyword <code>set</code> instead of the keyword <code>list</code>
in the opening line.
To save a dictionary,
we save the number of entries
and then save each key and value in turn:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"dict:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">thing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The code to load a dictionary is analogous.</p>
<p>We now need to write some unit tests.
We will use two tricks when doing this:</p>
<ol>
<li>
<p>The <code>StringIO</code> class from Python’s <a href="https://docs.python.org/3/library/io.html">io</a> module
    allows us to read from strings and write to them
    using the functions we normally use to read and write files.
    Using this lets us run our tests
    without creating lots of little files as a side effect.</p>
</li>
<li>
<p>The <code>dedent</code> function from Python’s <a href="https://docs.python.org/3/library/textwrap.html">textwrap</a> module
    removes leading indentation from the body of a string.
    As the example below shows,
    <code>dedent</code> allows us to indent a <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>
    the same way we indent our Python code,
    which makes the test easier to read.</p>
</li>
</ol>
<div class="code-sample lang-py" title="test_builtin.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_save_list_flat</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="sd">"""\</span>
<span class="sd">    list:2</span>
<span class="sd">    int:0</span>
<span class="sd">    bool:False</span>
<span class="sd">    """</span>
    <span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fixture</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>
</div>
<p>We still need to decide how to save strings.
We can’t print them out as-is because they might contain newlines,
which would break our reader.
One option would be to save each string’s representation,
using the two-character <a class="gl-ref" href="../glossary/#escape_sequence" markdown="1">escape sequence</a> <code>\n</code> for newline.
Instead,
we choose to break each string on newlines
and then save the number of lines
followed by each line.
For example,
the two-line text <code>"hello\nthere"</code> is saved as:</p>
<div class="highlight"><pre><span></span><code>str:2
hello
there
</code></pre></div>
<p>The <code>elif</code> branch to do this in <code>save</code> is:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"set:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
            <span class="n">save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and the corresponding clause in <code>load</code> is:</p>
<div class="code-sample lang-py" title="builtin.py">
<div class="highlight"><pre><span></span><code>    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"str"</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))])</span>
</code></pre></div>
</div>
<h2 id="persistance-oop">Section 6.2: Converting to Classes</h2>
<p>The <code>save</code> and <code>load</code> functions we built in the previous section work,
but as we were extending them
we had to modify their internals
every time we wanted to do something new.</p>
<p>The <span class="ix-entry" ix-key="Open-Closed Principle;software design!Open-Closed Principle" markdown="1"><a class="gl-ref" href="../glossary/#open_closed_principle" markdown="1">Open-Closed Principle</a></span> states that
software should be open for extension but closed for modification,
i.e., that it should be possible to extend functionality
without having to rewrite existing code.
This allows old code to use new code,
but only if our design permits the kinds of extensions people are going to want to make.
Since we can’t anticipate everything,
it is normal to have to revise a design the first two or three times we try to extend it.
As <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Brand1995">Brand1995</a>]</span> said of buildings,
the things we make learn how to do things better as we use them.</p>
<p>In this case,
we can follow the Open-Closed Principle by rewriting our functions as classes.
We will also use <a class="gl-ref" href="../glossary/#dynamic_dispatch" markdown="1">dynamic dispatch</a>
as we did in <a class="x-ref" href="#interpreter">Chapter 3</a>
to handle each item
so that we don’t have to modify a multiway <code>if</code> statement
each time we add a new capability.
The core of our saving class is:</p>
<div class="code-sample lang-py" title="oop.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SaveOop</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Unknown object type </span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">"</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">thing</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">(We have called it <code>SaveOop</code> instead of just <code>Save</code>
because we are going to create several variations on it.)</p>
<p><code>SaveOop.save</code> figures out which method to call to save a particular thing
by constructing a name based on the thing’s type,
checking whether that method exists,
and then calling it.
Again,
as in <a class="x-ref" href="#interpreter">Chapter 3</a>,
the methods that handle specific items
must all have the same <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>
so that they can be called interchangeably.
For example,
the methods that write integers and strings are:</p>
<div class="code-sample lang-py" title="oop.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"int"</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"str"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">)</span>
</code></pre></div>
</div>
<p><code>LoadOop.load</code> combines dynamic dispatch with
the string handling of our original <code>load</code> function:</p>
<div class="code-sample lang-py" title="oop.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoadOop</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">line</span><span class="p">,</span> <span class="s2">"Nothing to read"</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Badly-formed line </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Unknown object type </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The methods that load individual items are even simpler:</p>
<div class="code-sample lang-py" title="oop.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="persistence-aliasing">Section 6.3: Aliasing</h2>
<p>Consider the two lines of code below,
which created the data structure show in <a class="fig-ref" href="../persistence/#persistence-shared">Figure 6.2</a>.
If we save this structure and then reload it
using what we have built so far
we will wind up duplicating the string <code>"shared"</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">shared</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"shared"</span><span class="p">]</span>
<span class="n">fixture</span> <span class="o">=</span> <span class="p">[</span><span class="n">shared</span><span class="p">,</span> <span class="n">shared</span><span class="p">]</span>
</code></pre></div>
<figure id="persistence-shared">
<img alt="Saving aliased data incorrectly" src="./persistence/persistence_shared.svg"/>
<figcaption markdown="1">Figure 6.2: Saving aliased data without respecting aliases.</figcaption>
</figure>
<p>To reconstruct the original data correctly we need to:</p>
<ol>
<li>
<p>keep track of everything we have saved;</p>
</li>
<li>
<p>save a marker instead of the object itself
    when we try to save it a second time;
    and</p>
</li>
<li>
<p>reverse this process when loading data.</p>
</li>
</ol>
<p>Luckily,
Python has a built-in function <code>id</code>
that returns a unique ID for every object in the program.
Even if two lists or dictionaries contain the same data,
<code>id</code> will report different IDs
because they’re stored in different locations in memory.
We can use this to:</p>
<ol>
<li>
<p>store the IDs of all the objects we’ve already saved
    in a set, and then</p>
</li>
<li>
<p>write a special entry with the keyword <code>alias</code>
    and its unique ID
    when we see an object for the second time.</p>
</li>
</ol>
<p>Here’s the start of <code>SaveAlias</code>:</p>
<div class="code-sample lang-py" title="aliasing_wrong.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SaveAlias</span><span class="p">(</span><span class="n">SaveOop</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">thing_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thing_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"alias"</span><span class="p">,</span> <span class="n">thing_id</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Unknown object type </span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">"</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">thing</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Its constructor creates an empty set of IDs seen so far.
If <code>SaveAlias.save</code> notices that the object it’s about to save
has been saved before,
it writes a line like this:</p>
<div class="highlight"><pre><span></span><code>alias:12345678:
</code></pre></div>
<p>where <code>12345678</code> is the object’s ID.
Otherwise,
it saves the object’s type,
its ID,
and either its value or its length:</p>
<div class="code-sample lang-py" title="aliasing_wrong.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"list"</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
</div>
<p><code>SaveAlias._list</code> is a little different from <code>SaveOop._list</code>
because it has to save each object’s identifier
along with its type and its value or length.
Our <code>LoadAlias</code> class,
on the other hand,
can recycle all the loading methods for particular datatypes
from <code>LoadOop</code>.
All that has to change is the <code>load</code> method itself,
which looks to see if we’re restoring aliased data
or loading something new:</p>
<div class="code-sample lang-py" title="aliasing_wrong.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoadAlias</span><span class="p">(</span><span class="n">LoadOop</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">line</span><span class="p">,</span> <span class="s2">"Nothing to read"</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Badly-formed line </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span>

        <span class="c1"># the lines below contain a bug</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">"alias"</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ident</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span>

        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Unknown object type </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>The first test of our new code is:</p>
<div class="code-sample lang-py" title="test_aliasing_wrong.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_aliasing_no_aliasing</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"b"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="p">{</span><span class="s2">"c"</span><span class="p">:</span> <span class="s2">"d"</span><span class="p">}}]</span>
    <span class="k">assert</span> <span class="n">roundtrip</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span> <span class="o">==</span> <span class="n">fixture</span>
</code></pre></div>
</div>
<p class="continue">which uses this helper function:</p>
<div class="code-sample lang-py" title="test_aliasing_wrong.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">roundtrip</span><span class="p">(</span><span class="n">fixture</span><span class="p">):</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">Save</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">Load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">There isn’t any aliasing in the test case,
but that’s deliberate:
we want to make sure we haven’t broken code that was working
before we move on.</p>
<p>Here’s a test that actually includes some aliasing:</p>
<div class="code-sample lang-py" title="test_aliasing_wrong.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_aliasing_shared_child</span><span class="p">():</span>
    <span class="n">shared</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"shared"</span><span class="p">]</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="p">[</span><span class="n">shared</span><span class="p">,</span> <span class="n">shared</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">roundtrip</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">fixture</span>
    <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"changed"</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"changed"</span>
</code></pre></div>
</div>
<p class="continue">It checks that the aliased sub-list is actually aliased after the data is restored,
and then checks that modifying that sub-list works as it should
(i.e.,
that changes made through one alias are visible through the other).
The second check ought to be redundant,
but it’s still comforting.</p>
<p>There’s one more case to check,
and unfortunately it turns up a bug in our code.
The two lines:</p>
<div class="highlight"><pre><span></span><code><span class="n">fixture</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fixture</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
</code></pre></div>
<p class="continue">create the data structure shown in <span class="fixme">FIXME persistence-circular</span>,
in which an object contains a reference to itself.
Our code ought to handle this case but doesn’t:
when we try to read in the saved data,
<code>LoadAlias.load</code> sees the <code>alias</code> line
but then says it can’t find the object being referred to.</p>
<figure id="persistence-circular">
<img alt="A circular data structure" src="./persistence/persistence_circular.svg"/>
<figcaption markdown="1">Figure 6.3: A data structure that contains a reference to itself</figcaption>
</figure>
<p class="continue">The problem is these lines in <code>LoadAlias.load</code>
marked as containing a bug,
in combination with these lines inherited from <code>LoadOop</code>:</p>
<div class="code-sample lang-py" title="oop.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>
</code></pre></div>
</div>
<p class="continue">Let’s trace execution for the saved data:</p>
<div class="highlight"><pre><span></span><code>list:4484025600:1
alias:4484025600:
</code></pre></div>
<ol>
<li>
<p>The first line tells us that there’s a list whose ID is <code>4484025600</code>
    so we <code>LoadOop._list</code> to load a list of one element.</p>
</li>
<li>
<p><code>LoadOop._list</code> called <code>LoadAlias.load</code> recursively to load that one element.</p>
</li>
<li>
<p><code>LoadAlias.load</code> reads the second line of saved data,
    which tells it to re-use the data whose ID is <code>4484025600</code>.
    But <code>LoadOop._list</code> hasn’t created and returned that list yet—it
    is still reading in the elements—so
    <code>LoadAlias.load</code> hasn’t had a chance to add the list to the <code>seen</code> dictionary
    of previously-read items.</p>
</li>
</ol>
<p>The solution is to reorder the operations,
which unfortunately means writing new versions
of all the methods defined in <code>LoadOop</code>.
The new implementation of <code>_list</code> is:</p>
<div class="code-sample lang-py" title="aliasing.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>This method creates the list it’s going to return,
adds that list to the <code>seen</code> dictionary immediately,
and <em>then</em> loads list items recursively.
We have to pass it the ID of the list
to use as the key in <code>seen</code>,
and we have to use a loop rather than a <a class="gl-ref" href="../glossary/#list_comprehension" markdown="1">list comprehension</a>,
but the changes to <code>_set</code> and <code>_dict</code> follow exactly the same pattern.</p>
<h2 id="persistence-extend">Section 6.4: User-Defined Classes</h2>
<p>It’s time to extend our framework to handle user-defined classes.
We’ll start by refactoring our code so that the <code>save</code> method doesn’t get any larger:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SaveExtend</span><span class="p">(</span><span class="n">SaveAlias</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliased</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builtin</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Don't know how to handle </span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s2">"</span>

    <span class="c1"># [save_aliased]</span>
    <span class="k">def</span> <span class="nf">_aliased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">thing_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thing_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"alias"</span><span class="p">,</span> <span class="n">thing_id</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># [/save_aliased]</span>

    <span class="c1"># [save_builtin]</span>
    <span class="k">def</span> <span class="nf">_builtin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># [/save_builtin]</span>
</code></pre></div>
</div>
<p class="continue">The method to handle built-in types is:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_builtin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p class="continue">and the one that handles aliases is:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_aliased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="n">thing_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thing_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"alias"</span><span class="p">,</span> <span class="n">thing_id</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p class="continue">None of this code is new:
we’ve just moved things into methods
to make each piece easier to understand.</p>
<p>So how does a class indicate that it can be saved and loaded by our framework?
Our options are:</p>
<ol>
<li>
<p>Require it to inherit from a base class that we provide
    so that we can use <code>isinstance</code> to check if an object is persistable.
    This approach is used in strictly-typed languages like Java,
    but method #2 below is considered more <a class="gl-ref" href="../glossary/#pythonic" markdown="1">Pythonic</a>.</p>
</li>
<li>
<p>Require it to implement a method with a specific name and signature
    without deriving from a particular base class.
    This approach is called <span class="ix-entry" ix-key="duck typing" markdown="1"><a class="gl-ref" href="../glossary/#duck_typing" markdown="1">duck typing</a></span>:
    if it walks like a duck and quacks like a duck, it’s a duck.
    Since option #1 would require users to write this method anyway,
    it’s the one we’ll choose.</p>
</li>
<li>
<p>Require users to register a <a class="gl-ref" href="../glossary/#helper_class" markdown="1">helper class</a>
    that knows how to save and load objects of the class we’re interested in.
    This approach is also commonly used in strictly-typed languages
    as a way of adding persistence after the fact
    without disrupting the class hierarchy;
    we’ll explore it in the exercises.</p>
</li>
</ol>
<p>To implement option #2,
we specify that if a class has a method called <code>to_dict</code>,
we’ll call that to get its contents as a dictionary
and then persist the dictionary.
Before doing that,
though,
we will save a line indicating that
this dictionary should be used to reconstruct an object
of a particular class:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="s2">"to_dict"</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">"@extension"</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">),</span> <span class="n">thing</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p>Loading user-defined classes requires more work
because we have to map class names back to actual classes.
(We could also use <span class="ix-entry" ix-key="introspection" markdown="1"><a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a></span>
to find <em>all</em> the classes in the program
and build a lookup table of the ones with the right method;
we’ll explore that in the exercises.)
We start by modifying the loader’s constructor
to take zero or more extension classes as arguments
and then build a name-to-class lookup table from them:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoadExtend</span><span class="p">(</span><span class="n">LoadAlias</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="o">*</span><span class="n">extensions</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">}</span>
</code></pre></div>
</div>
<p>The <code>load</code> method then looks for aliases,
built-in types,
and extensions in that order.
Instead of using a chain of <code>if</code> statements
we loop over the methods that handle these cases.
If a method decides that it can handle the incoming data
it returns a result;
if it can’t,
it throws a <code>KeyError</code>,
and if none of the methods handle a case
we fail:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aliased</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builtin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extension</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Don't know how to handle </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ident</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p>The code to handle built-ins and aliases is copied from our previous work
and modified to raise <code>KeyError</code>:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_aliased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">"alias"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">ident</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_builtin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">method</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">ident</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The method that handles extensions
checks that the value on the line just read indicates an extension,
then reads the dictionary containing the object’s contents
from the input stream
and uses it to build an instance of the right class:</p>
<div class="code-sample lang-py" title="extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">"@extension"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">contents</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Here’s a class that defines the required method:</p>
<div class="code-sample lang-py" title="user_classes.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
</code></pre></div>
</div>
<p>and here’s a test to make sure everything works:</p>
<div class="code-sample lang-py" title="test_extend.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_extend_extension_class</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Parent</span><span class="p">(</span><span class="s2">"subject"</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">Save</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">Parent</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Parent</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">fixture</span><span class="o">.</span><span class="n">name</span>
</code></pre></div>
</div>
<div class="callout">
<h3>What’s in a name?</h3>
<p>The first version of these classes used the word <code>"extension"</code>
rather than <code>"@extension"</code>.
That led to the most confusing bug in this whole chapter.
When <code>load</code> reads a line,
it runs <code>self._builtin</code> before running <code>self._extension</code>.
If the first word on the line is <code>"extension"</code> (without the <code>@</code>)
then <code>self._builtin</code> constructs the method name <code>_extension</code>,
finds that method,
and calls it
as if we were loading an object of a built-in type:
which we’re not.
Using <code>@extension</code> as the leading indicator
leads to <code>self._builtin</code> checking for <code>"_@extension"</code> in the loader’s attributes,
which doesn’t exist,
so everything goes as it should.</p>
</div>
<h2 id="persistence-summary">Section 6.5: Summary</h2>
<figure id="persistence-concept-map">
<img alt="Concept map for persistence" src="./persistence/persistence_concept_map.svg"/>
<figcaption markdown="1">Figure 6.4: Concepts for persistence.</figcaption>
</figure>
<h2 id="persistence-exercises">Section 6.6: Exercises</h2>
<h3 class="exercise">Reset</h3>
<p><code>SaveAlias</code>, <code>SaveExtend</code>, and their loading counterparts
don’t re-set the tables of objects seen so far between runs.</p>
<ol>
<li>
<p>If we construct one saver object and use it repeatedly on different data,
    can it create incorrect or misleading archives?</p>
</li>
<li>
<p>What about loading?
    If we re-use a loader,
    can it construct objects that aren’t what they should be?</p>
</li>
<li>
<p>Create new classes <code>SaveReset</code> and <code>LoadReset</code>
    that fix the problems you have identified.
    How much of the existing code did you have to change?</p>
</li>
</ol>
<h3 class="exercise">A dangling colon</h3>
<p>Why is there a colon at the end of the line <code>alias:12345678:</code>
when we create an alias marker?</p>
<h3 class="exercise">Versioning</h3>
<p>We now have several versions of our data storage format.
Early versions of our code can’t read the archives created by later ones,
and later ones can’t read the archives created early on
(which used two fields per line rather than three).
This problem comes up all the time in long-lived libraries and applications,
and the usual solution is to include some sort of version marker
at the start of each archive
to indicate what version of the software created it
(and therefore how it should be read).
Modify the code we have written so far to do this.</p>
<h3 class="exercise">Strings</h3>
<p>Modify the framework so that strings are stored using escape characters like <code>\n</code>
instead of being split across several lines.</p>
<h3 class="exercise">Who calculates?</h3>
<p>Why doesn’t <code>LoadAlias.load</code> calculate object IDs?
Why does it use the IDs saved in the archive instead?</p>
<h3 class="exercise">Fallback</h3>
<ol>
<li>
<p>Modify <code>LoadExtend</code> so that
    if the user didn’t provide the class needed to reconstruct some archived data,
    the <code>load</code> method returns a simple dictionary instead.</p>
</li>
<li>
<p>Why is this a bad idea?</p>
</li>
</ol>
<h3 class="exercise">Looking around</h3>
<p><a class="x-ref" href="#tester">Chapter 2</a> introduced the function <code>globals</code>,
which can be used to look up everything defined at the top level of a program.</p>
<ol>
<li>
<p>Modify <code>LoadExtend</code> so that it looks for classes using <code>globals</code>
    rather than requiring the caller to pass in
    the classes it’s allowed to use.</p>
</li>
<li>
<p>Why is this a bad idea?</p>
</li>
</ol>
<h3 class="exercise">Removing exceptions</h3>
<p>Rewrite <code>LoadExtend</code> so that it doesn’t use exceptions
when <code>_aliased</code>, <code>_builtin</code>, and <code>extension</code> decide
they aren’t the right method to handle a particular case.
Is the result simpler or more complex than the exception-based approach?</p>
<h3 class="exercise">Helper classes</h3>
<p>Modify the framework so that
if a user wants to save and load instances of a class <code>X</code>,
they must register a class <code>Persist_X</code> with the framework
that does the saving and loading for <code>X</code>.</p>
<h3 class="exercise">Self-referential objects</h3>
<p>Suppose an object contains a reference to itself:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Example</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">ex</span> <span class="o">=</span> <span class="n">Example</span><span class="p">()</span>
<span class="n">ex</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ex</span>
</code></pre></div>
<ol>
<li>
<p>Why can’t <code>SaveExtend</code> and <code>LoadExtend</code> handle this correctly?</p>
</li>
<li>
<p>How would they have to be changed to handle this?</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="binary">Chapter: Chapter 7: Binary Storage</h1>

<ul class="syllabus">
<li markdown="1">Programs usually store integers using two's complement rather than sign and magnitude.</li>
<li markdown="1">Floating-point numbers have a sign, a mantissa, and an exponent.</li>
<li markdown="1">Characters are usually encoded as bytes using either ASCII, UTF-8, or UTF-32.</li>
<li markdown="1">Programs can use bitwise operators to manipulate the bits representing data directly.</li>
<li markdown="1">The relative error in a floating point number is usually more important than the absolute error.</li>
<li markdown="1">Low-level compiled languages usually store raw values, while high-level interpreted languages use boxed values.</li>
<li markdown="1">Sets of values can be packed into contiguous byte arrays for efficient transmission and storage.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>, <a class="gl-ref" href="../glossary/#ansi_encoding" markdown="1">ANSI character encoding</a>, <a class="gl-ref" href="../glossary/#ascii" markdown="1">ASCII character encoding</a>, <a class="gl-ref" href="../glossary/#big_endian" markdown="1">big endian</a>, <a class="gl-ref" href="../glossary/#bit_mask" markdown="1">bit mask</a>, <a class="gl-ref" href="../glossary/#bit_shift" markdown="1">bit shifting</a>, <a class="gl-ref" href="../glossary/#bitwise_operation" markdown="1">bitwise operation</a>, <a class="gl-ref" href="../glossary/#boxed_value" markdown="1">boxed value</a>, <a class="gl-ref" href="../glossary/#code_point" markdown="1">code point</a>, <a class="gl-ref" href="../glossary/#control_code" markdown="1">control code</a>, <a class="gl-ref" href="../glossary/#exclusive_or" markdown="1">exclusive or</a>, <a class="gl-ref" href="../glossary/#exponent" markdown="1">exponent</a>, <a class="gl-ref" href="../glossary/#garbage_collection" markdown="1">garbage collection</a>, <a class="gl-ref" href="../glossary/#hexadecimal" markdown="1">hexadecimal</a>, <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>, <a class="gl-ref" href="../glossary/#little_endian" markdown="1">little endian</a>, <a class="gl-ref" href="../glossary/#mantissa" markdown="1">mantissa</a>, <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>, <a class="gl-ref" href="../glossary/#sign_magnitude" markdown="1">sign and magnitude</a>, <a class="gl-ref" href="../glossary/#twos_complement" markdown="1">two's complement</a>, <a class="gl-ref" href="../glossary/#unicode" markdown="1">Unicode</a>, <a class="gl-ref" href="../glossary/#utf_32" markdown="1">UTF-32</a>, <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a>, <a class="gl-ref" href="../glossary/#variable_length_encoding" markdown="1">variable-length encoding</a>, <a class="gl-ref" href="../glossary/#word_memory" markdown="1">word (of memory)</a>
</p>
<div class="page-toc"></div>
<p>Python and other high-level languages shield programmers from low-level details,
but sooner or later someone has to worry about bits and bytes.
This chapter explores how computers represent numbers and text
and shows how to work with binary data.</p>
<h2 id="binary-int">Section 7.1: Integers</h2>
<p>Let’s start by looking at how integers are stored.
The natural way to do this with ones and zeroes uses base 2,
so 1001 in binary is (1×8)+(0×4)+(0×2)+(1×1) or 9 base 10.
We can handle negative numbers by reserving the top bit for the sign,
so that 01001 is +9 and 11001 is -9.</p>
<p>This representation has two drawbacks.
The minor one is that it gives us two zeroes,
one positive and one negative.
More importantly,
the hardware needed to do arithmetic
on this <a class="gl-ref" href="../glossary/#sign_magnitude" markdown="1">sign and magnitude</a> representation
is more complicated than the hardware needed for another scheme
called <a class="gl-ref" href="../glossary/#twos_complement" markdown="1">two’s complement</a>.
Instead of mirroring positive values,
two’s complement rolls over when going below zero like an odometer.
For example,
with three-bit integers we get the values in <a class="tbl-ref" href="../binary/#binary-3bit">Table 7.1</a>.</p>
<div class="table"><table id="binary-3bit"><caption>Table 7.1: 3-bit integer values</caption>
<thead>
<tr>
<th>Base 10</th>
<th>Base 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>011</td>
</tr>
<tr>
<td>2</td>
<td>010</td>
</tr>
<tr>
<td>1</td>
<td>001</td>
</tr>
<tr>
<td>0</td>
<td>000</td>
</tr>
<tr>
<td>-1</td>
<td>111</td>
</tr>
<tr>
<td>-2</td>
<td>110</td>
</tr>
<tr>
<td>-3</td>
<td>101</td>
</tr>
<tr>
<td>-4</td>
<td>100</td>
</tr>
</tbody>
</table>
</div>
<p>We can still tell whether a number is positive or negative
by looking at the first bit:
negative numbers have a 1, positives have a 0.
However,
two’s complement is asymmetric:
since 0 counts as a positive number,
numbers go from -4 to 3, or -16 to 15, and so on.
As a result,
even if <code>x</code> is a valid number,
<code>-x</code> may not be.</p>
<p>We can write binary numbers directly in Python using the <code>0b</code> prefix:
for example,
<code>0b0011</code> is 3 base 10.
Programmers usually write <a class="gl-ref" href="../glossary/#hexadecimal" markdown="1">hexadecimal</a> (base 16) instead:
the digits 0–9 have the usual meaning,
and the letters A-F (or a-f) are used to represent the digits 11–15.
We signal that we’re using hexadecimal with a <code>0x</code> prefix,
so <code>0xF7</code> is (15×16)+7 or 247 base 10.
Each hexadecimal digit corresponds to four bits (<a class="tbl-ref" href="../binary/#binary-hex">Table 7.2</a>),
which makes it easy to translate bits to digits and vice versa:
for example,
<code>0xF7</code> is <code>0b11110111</code>.
As a bonus,
two hexadecimal digits is exactly one byte.</p>
<div class="table"><table id="binary-hex"><caption>Table 7.2: Bitwise operations</caption>
<thead>
<tr>
<th>Decimal</th>
<th>Hexadecimal</th>
<th>Bits</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0000</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0001</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>0010</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>0011</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>0100</td>
</tr>
<tr>
<td>5</td>
<td>5</td>
<td>0101</td>
</tr>
<tr>
<td>6</td>
<td>6</td>
<td>0110</td>
</tr>
<tr>
<td>7</td>
<td>7</td>
<td>0111</td>
</tr>
<tr>
<td>8</td>
<td>8</td>
<td>1000</td>
</tr>
<tr>
<td>9</td>
<td>9</td>
<td>1001</td>
</tr>
<tr>
<td>10</td>
<td>A</td>
<td>1010</td>
</tr>
<tr>
<td>11</td>
<td>B</td>
<td>1011</td>
</tr>
<tr>
<td>12</td>
<td>C</td>
<td>1100</td>
</tr>
<tr>
<td>13</td>
<td>D</td>
<td>1101</td>
</tr>
<tr>
<td>14</td>
<td>E</td>
<td>1110</td>
</tr>
<tr>
<td>15</td>
<td>F</td>
<td>1111</td>
</tr>
</tbody>
</table>
</div>
<h2 id="binary-bitops">Section 7.2: Bitwise Operations</h2>
<p>Like most languages based on C,
Python provides <a class="gl-ref" href="../glossary/#bitwise_operation" markdown="1">bitwise operations</a>
for working directly with 1’s and 0’s in memory:
<code>&amp;</code> (and),
<code>|</code> (or),
<code>^</code> (xor),
<code>~</code> (not).
<code>&amp;</code> yields a 1 only if both its inputs are 1’s,
while <code>|</code> yields 1 if either or both are 1.
<code>^</code>, called <a class="gl-ref" href="../glossary/#exclusive_or" markdown="1">exclusive or</a> or “xor” (pronounced “ex-or”),
produces 1 if either but <em>not</em> both of its arguments are 1;
putting it another way,
<code>^</code> produces 0 if its inputs are the same and 1 if they are different.
Finally,
<code>~</code> flips its argument: 1 becomes 0, and 0 becomes 1.</p>
<p>When these operators are used on multibit values
they work on corresponding bits independently as shown in <a class="tbl-ref" href="../binary/#binary-ops">Table 7.3</a>.</p>
<div class="table"><table id="binary-ops"><caption>Table 7.3: Bitwise operations</caption>
<thead>
<tr>
<th>Expression</th>
<th>Bitwise</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>12 &amp; 6</code></td>
<td><code>1100 &amp; 0110</code></td>
<td><code>4</code> (<code>0100</code>)</td>
</tr>
<tr>
<td><code>12 | 6</code></td>
<td><code>1100 | 0110</code></td>
<td><code>14</code> (<code>1110</code>)</td>
</tr>
<tr>
<td><code>12 ^ 6</code></td>
<td><code>1100 ^ 0110</code></td>
<td><code>10</code> (<code>1010</code>)</td>
</tr>
<tr>
<td><code>~ 6</code></td>
<td><code>~ 0110</code></td>
<td><code>9</code> (<code>1001</code>)</td>
</tr>
<tr>
<td><code>12 &lt;&lt; 2</code></td>
<td><code>1100 &lt;&lt; 2</code></td>
<td><code>48</code> (<code>110000</code>)</td>
</tr>
<tr>
<td><code>12 &gt;&gt; 2</code></td>
<td><code>1100 &gt;&gt; 2</code></td>
<td><code>3</code> (<code>0011</code>)</td>
</tr>
</tbody>
</table>
</div>
<p>We can set or clear individual bits with these operators.
To set a particular bit,
create a value in which that bit is 1 and the rest are 0.
When this is or’d with a value,
the bit we set is guaranteed to come out 1;
the other bits will be left as they are.
Similarly,
to  set a bit to zero,
create a <a class="gl-ref" href="../glossary/#bit_mask" markdown="1">mask</a> in which that bit is 0 and the others are 1,
then use <code>&amp;</code> to combine the two.
To make things easier to read,
programmers often set a single bit,
negative it with <code>~</code>,
and then use <code>&amp;</code>:</p>
<div class="code-sample lang-py" title="bit_mask.py">
<div class="highlight"><pre><span></span><code><span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x0100</span>  <span class="c1"># binary 1111 1110 1111 1111</span>
<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>  <span class="c1">#    clears this ^ bit</span>
</code></pre></div>
</div>
<p>Python also has <a class="gl-ref" href="../glossary/#bit_shift" markdown="1">bit shifting</a> operators
that move bits left or right.
Shifting the bits <code>0110</code> left by one place produces <code>1100</code>,
while shifting it right by one place produces <code>0011</code>.
In Python,
this is written <code>x &lt;&lt; 1</code> or <code>x &gt;&gt; 1</code>.
Just as shifting a decimal number left corresponds to multiplying by 10,
shifting a binary number left is the same as multiplying it by 2.
Similarly,
shifting a number right corresponds to dividing by 2 and throwing away the remainder,
so <code>17 &gt;&gt; 3</code> is 2.</p>
<p>But what if the top bit of an integer changes from 1 to 0 or vice versa as a result of shifting?
If we’re using two’s complement,
then the bits <code>1111</code> represent the value -1;
if we shift right we get <code>0111</code> which is 7.
Similarly,
if we shift <code>0111</code> to the left we get <code>1110</code> (assuming we fill in the bottom with 0),
which is -2.</p>
<p>Different languages deal with this problem in different ways.
Python always fills with zeroes,
while Java provides two versions of right shift:
<code>&gt;&gt;</code> fills in the high end with zeroes
while <code>&gt;&gt;&gt;</code> copies in the topmost (sign) bit of the original value.
C (and by extension C++) lets the underlying hardware decide,
which means that if you want to be sure of getting a particular answer
you have to handle the top bit yourself.</p>
<h2 id="binary-text">Section 7.3: Text</h2>
<p>The rules for storing text make integers look simple.
By the early 1970s most programs used <a class="gl-ref" href="../glossary/#ascii" markdown="1">ASCII</a>,
which represented unaccented Latin characters using the numbers from 32 to 127.
(The numbers 0 to 31 were used for <a class="gl-ref" href="../glossary/#control_code" markdown="1">control codes</a>
such as newline, carriage return, and bell.)
Since computers use 8-bit bytes and the numbers 0–127 only need 7 bits,
programmers were free to use the numbers 128–255 for other characters.
Unfortunately,
different programmers used them to represent different symbols:
non-Latin characters,
graphic characters like boxes,
and so on.
The chaos was eventually tamed by the <a class="gl-ref" href="../glossary/#ansi_encoding" markdown="1">ANSI</a> standard
which (for example) defined the value 231 to mean the character “ç”.</p>
<p>But the ANSI standard only solved part of the problem.
It didn’t include characters from Turkish, Devanagari, and many other alphabets,
much less the thousands of characters used in some East Asian writing systems.
One solution would have been to use 16 or even 32 bits per character,
but:</p>
<ol>
<li>existing text files using ANSI would have to be transcribed, and</li>
<li>documents would be two or four times larger.</li>
</ol>
<p>The solution was a new two-part standard called <a class="gl-ref" href="../glossary/#unicode" markdown="1">Unicode</a>.
The first part defined a <a class="gl-ref" href="../glossary/#code_point" markdown="1">code point</a> for every character:
U+0065 for an upper-case Latin “A”,
U+2605 for a black star,
and so on.
(The <a href="https://www.unicode.org/">Unicode Consortium site</a> offers a complete list.)</p>
<p>The second part defined ways to store these values in memory.
The simplest of these is <a class="gl-ref" href="../glossary/#utf_32" markdown="1">UTF-32</a>,
which stores every character as a 32-bit number.
This scheme waste a lot of memory if the text is written in a Western European language,
since it uses four times as much storage as is absolutely necessary,
but it’s easy to process.</p>
<p>The most popular encoding is <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a>,
which is <a class="gl-ref" href="../glossary/#variable_length_encoding" markdown="1">variable length</a>.
Every code point from 0 to 127 is stored in a single byte whose high bit is 0,
just as it was in the original ASCII standard.
If the top bit in the byte is 1,
on the other hand,
the number of 1’s after the high bit but before the first 0
tells UTF-8 how many more bytes that character is using.
For example,
if the first byte of the character is <code>11101101</code> then:</p>
<ul>
<li>the first 1 signals that this is a multi-byte character;</li>
<li>the next two 1’s signal that the character includes bits
    from the following two bytes as well as this one;</li>
<li>the 0 separates the byte count from the first few bits used in the character;
    and</li>
<li>the final 1101 is the first four bits of the character.</li>
</ul>
<p>But that’s not all:
every byte that’s a continuation of a character starts with 10.
This rule means that if we look at any byte in a string
we can immediately tell if it’s the start of a character
or the continuation of a character.
Thus,
if we want to represent a character whose code point is 1789:</p>
<ul>
<li>We convert to binary 11011111101.</li>
<li>We count and realize that we’ll need two bytes:
    the first storing the high 5 bits of the character,
    the second storing the low 6 bits.</li>
<li>We encode the high 5 bits as 11011011,
    meaning “start of a character with one continuation byte
    and the 5 payload bits 11011”.</li>
<li>We encode the low 6 bits as 10111101,
    meaning “a continuation byte with 6 payload bits 111101”.</li>
</ul>
<h2 id="binary-fp">Section 7.4: Floating Point Numbers</h2>
<p>The rules for floating point numbers make Unicode look simple.
The root of the problem is that
we cannot represent an infinite number of real values
with a finite set of bit patterns.
And no matter what values we represent,
there will be an infinite number of values between each of them that we can’t.</p>
<div class="callout">
<h3>Go to the source</h3>
<p>The explanation that follows is simplified to keep it manageable;
please read <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Goldberg1991">Goldberg1991</a>]</span> for more detail.</p>
</div>
<p>Floating point numbers are represented by a sign,
a <a class="gl-ref" href="../glossary/#mantissa" markdown="1">mantissa</a>,
and an <a class="gl-ref" href="../glossary/#exponent" markdown="1">exponent</a>.
In a 32-bit <a class="gl-ref" href="../glossary/#word_memory" markdown="1">word</a>
the <span class="ix-entry" ix-key="IEEE 754 standard" markdown="1">IEEE 754</span> standard calls for 1 bit of sign,
23 bits for the mantissa,
and 8 bits for the exponent.
We will illustrate how it works using a much smaller representation:
no sign,
3 bits for the mantissa,
and 2 for the exponent.
<a class="fig-ref" href="../binary/#binary-floating-point">Figure 7.1</a> shows the values this scheme can represent.</p>
<figure id="binary-floating-point">
<img alt="Representing floating point numbers" src="./binary/binary_floating_point.svg"/>
<figcaption markdown="1">Figure 7.1: Representing floating point numbers.</figcaption>
</figure>
<p>The IEEE standard avoids the redundancy in this representation by shifting things around.
Even with that,
though,
formats like this can’t represent a lot of values:
for example,
ours can store 8 and 10 but not 9.
This is exactly like the problem hand calculators have
with fractions like 1/3:
in decimal, we have to round that to 0.3333 or 0.3334.</p>
<p>But if this scheme has no representation for 9
then 8+1 must be stored as either 8 or 10.
What should 8+1+1 be?
If we add from the left,
(8+1)+1 is 8+1 is 8,
but if we add from the right,
8+(1+1) is 8+2 is 10.
Changing the order of operations makes the difference between right and wrong.</p>
<p>The authors of numerical libraries spend a lot of time worrying about things like this.
In this case
sorting the values and adding them from smallest to largest
gives the best chance of getting the best possible answer.
In other situations,
like inverting a matrix, the rules are much more complicated.</p>
<p>Another observation about our number line is that
while the values are unevenly spaced,
the <em>relative</em> spacing between each set of values stays the same:
the first group is separated by 1,
then the separation becomes 2,
then 4,
and so on.
This observation leads to a couple of useful definitions:</p>
<ul>
<li>
<p>The <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a> in an approximation
    is the absolute value of the difference
    between the approximation and the actual value.</p>
</li>
<li>
<p>The <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>
    is the ratio of the absolute error
    to the absolute value we’re approximating.</p>
</li>
</ul>
<p>For example,
being off by 1 in approximating 8+1 and 56+1 is the same absolute error,
but the relative error is larger in the first case than in the second.
Relative error is almost always more useful than absolute:
it makes little sense to say that we’re off by a hundredth
when the value in question is a billionth.</p>
<p>One implication of this is that
we should never compare floating point numbers with <code>==</code> or <code>!=</code>
because two numbers calculated in different ways
will probably not have exactly the same bits.
It’s safe to use <code>&lt;</code>, <code>&gt;=</code>, and other orderings,
though,
since they don’t depend on being the same down to the last bit.</p>
<p>If we do want to compare floating point numbers
we can use something like <a href="https://docs.pytest.org/en/4.6.x/reference.html#pytest-approx">the <code>approx</code> class</a> from <a href="https://docs.pytest.org/">pytest</a>
which checks whether two numbers are within some tolerance of each other.
A completely different approach is to use something like
the <a href="https://docs.python.org/3/library/fractions.html">fractions</a> module,
which (as its name suggests) uses numerators and denominators
to avoid some precision issues.
<a href="https://www.textualize.io/blog/posts/7-things-about-terminals">This post</a> describes one clever use of the module.</p>
<h2 id="binary-binary">Section 7.5: And Now, Persistence</h2>
<p><a class="x-ref" href="#persistence">Chapter 6</a> showed how to store data as human-readable text.
There are generally four reasons to store it in formats that people can’t easily read:</p>
<dl>
<dt>Size</dt>
<dd>The string <code>"10239472"</code> is 8 bytes long,
but the 32-bit integer it represents only needs 4 bytes in memory.
This doesn’t matter for small data sets,
but it does for large ones,
and it definitely does when data has to move between disk and memory
or between different computers.</dd>
<dt>Speed</dt>
<dd>Adding the integers 34 and 56 is a single machine operation.
Adding the values represented by the strings <code>"34"</code> and <code>"56"</code> is dozens;
we’ll explore this in the exercises.
Most programs that read and write text files
convert the values in those files into binary data
using something like the <code>int</code> or <code>float</code> functions,
but if we’re going to process the data many times,
it makes sense to avoid paying the conversion cost over and over.</dd>
<dt>Hardware</dt>
<dd>Someone, somewhere, has to convert the signal from the thermocouple to a number,
and that signal probably arrives arrives as a stream of 1’s and 0’s.</dd>
<dt>Lack of anything better</dt>
<dd>It’s possible to represent images as ASCII art, but sound?
Or video?
It would be possible, but it would hardly be sensible.</dd>
</dl>
<p>The first step toward saving and loading binary data
is to write it and read it correctly.
If we open a file for reading using <code>open("filename", "r")</code>
then Python assumes we want to read character strings from the file.
It therefore:</p>
<ul>
<li>
<p>uses our system’s default encoding (which is probably UTF-8)
    to convert bytes to characters, and</p>
</li>
<li>
<p>converts Windows line endings (which are the two characters <code>"\r\n"</code>)
    into their Unix equivalents (the single character <code>"\n"</code>)
    so that our program only has to deal with the latter.</p>
</li>
</ul>
<p>These translations are handy when we’re working with text,
but they mess up binary data:
we probably don’t want the pixels in our PNG image translated in these ways.
If we use <code>open("filename", "rb")</code> with a lower-case ‘b’ after the ‘r’,
on the other hand,
Python gives us back the file’s contents as a <code>bytes</code> object
instead of as character strings.
In this case we will almost always use <code>file.read(N)</code>
to read <code>N</code> bytes at a time
rather than using the file in a <code>for</code> loop
(which reads up to the next line ending).</p>
<p>What about the values we actually store?
C and Fortran manipulate “naked” values:
programs use what the hardware provides directly.
Python and other dynamic languages,
on the other hand,
put each value in a data structure
that keeps track of its type along with a bit of extra administrative information
(<a class="fig-ref" href="../binary/#binary-boxing">Figure 7.2</a>).
Something stored this was is called a <a class="gl-ref" href="../glossary/#boxed_value" markdown="1">boxed value</a>;
this extra data allows the language to do <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>,
<a class="gl-ref" href="../glossary/#garbage_collection" markdown="1">garbage collection</a>,
and much more.</p>
<figure id="binary-boxing">
<img alt="Boxed values" src="./binary/binary_boxing.svg"/>
<figcaption markdown="1">Figure 7.2: Using boxed values to store metadata.</figcaption>
</figure>
<p>The same is true of collections.
For example,
Fortran stores the values in an array side by side in one big block of memory
(<a class="fig-ref" href="../binary/#binary-arrays">Figure 7.3</a>).
Writing this to disk is easy:
if the array starts at location L in memory and has N values,
each of which is B bytes long,
we just copy the bytes from L to L+NB-1 to the file.</p>
<figure id="binary-arrays">
<img alt="Storing arrays" src="./binary/binary_arrays.svg"/>
<figcaption markdown="1">Figure 7.3: Low-level and high-level array storage.</figcaption>
</figure>
<p>A Python list,
on the other hand,
stores references to values rather than the values themselves.
To put the values in a file
we can either write them one at a time
or pack them into a contiguous block and write that.
Similarly,
when reading from a file,
we can either grab the values one by one
or read a larger block and then unpack it in memory.</p>
<p>Packing data is a lot like formatting values for textual output.
The format specifies what types of data are being packed,
how big they are (e.g., is this a 32-bit or 64-bit floating point number?),
and how many values there are,
which in turn exactly determines how much memory is required by the packed representation.</p>
<p>Unpacking reverses this process.
After reading data into memory
we can unpack it according to a format.
The most important thing is that
<em>we can unpack data any way we want</em>.
We might pack an integer and then unpack it as four characters,
since both are 32 bits long
(<a class="fig-ref" href="../binary/#binary-packing-unpacking">Figure 7.4</a>).
Or we might save two characters,
an integer,
and two more characters,
then unpack it as a 64-bit floating point number.
The bits are just bits:
it’s our responsibility to make sure we keep track of their meaning
when they’re down there on disk.</p>
<figure id="binary-packing-unpacking">
<img alt="Packing and unpacking values" src="./binary/binary_packing_unpacking.svg"/>
<figcaption markdown="1">Figure 7.4: Packing and unpacking binary values.</figcaption>
</figure>
<p>Python’s <a href="https://docs.python.org/3/library/struct.html">struct</a> module packs and unpacks data for us.
The function <code>pack(format, val_1, val_2, …)</code>
takes a format string and a bunch of values as arguments
and packs them into a <code>bytes</code> object.
The inverse function,
<code>unpack(format, string)</code>,
takes some bytes and a format
and returns a tuple containing the unpacked values.
Here’s an example:</p>
<div class="code-sample lang-py" title="simple_struct.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">fmt</span> <span class="o">=</span> <span class="s2">"ii"</span>  <span class="c1"># two 32-bit integers</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">31</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">65</span>

<span class="n">binary</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"binary representation:"</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">binary</span><span class="p">))</span>

<span class="n">normal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">binary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"back to normal:"</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="simple_struct.out">
<div class="highlight"><pre><span></span><code>binary representation: b'\x1f\x00\x00\x00A\x00\x00\x00'
back to normal: (31, 65)
</code></pre></div>
</div>
<p>What is <code>\x1f</code> and why is it in our data?
If Python finds a character in a string that doesn’t have a printable representation,
it prints a 2-digit escape sequence in <a class="gl-ref" href="../glossary/#hexadecimal" markdown="1">hexadecimal</a> (base 16).
This uses the letters A-F (or a-f) to represent the digits from 10 to 15,
so that (for example) <code>3D5</code> is (3×16^2^)+(13×16^1^)+(5×16^0^), or 981 in decimal.
Python is therefore telling us that
our string contains the eight bytes
<code>['\x1f', '\x00', '\x00', '\x00', 'A', '\x00', '\x00', '\x00']</code>.
<code>1F</code> in hex is (1×16^1^)+(15×16^0^), or 31;
<code>'A'</code> is our 65,
because the ASCII code for an upper-case letter A is the decimal value 65.
All the other bytes are zeroes (<code>"\x00"</code>)
because each of our integers is 32 bits long
and the significant digits only fill one byte’s worth of each.</p>
<div class="table"><table id="binary-formats"><caption>Table 7.4: <code>struct</code> package formats</caption>
<thead>
<tr>
<th>Format</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>"c"</code></td>
<td>Single character (i.e., string of length 1)</td>
</tr>
<tr>
<td><code>"B"</code></td>
<td>Unsigned 8-bit integer</td>
</tr>
<tr>
<td><code>"h"</code></td>
<td>Short (16-bit) integer</td>
</tr>
<tr>
<td><code>"i"</code></td>
<td>32-bit integer</td>
</tr>
<tr>
<td><code>"f"</code></td>
<td>32-bit float</td>
</tr>
<tr>
<td><code>"d"</code></td>
<td>Double-precision (64-bit) float</td>
</tr>
</tbody>
</table>
</div>
<p>The <code>struct</code> module offers a lot of different formats,
some of which are shown in <a class="tbl-ref" href="../binary/#binary-formats">Table 7.4</a>.
The <code>"B"</code>, <code>"h"</code>, and <code>"2"</code> formats deserve some explanation.
<code>"B"</code> takes the least significant 8 bits out of an integer and packs those;
<code>"h"</code> takes the least significant 16 bits and does likewise.
They’re needed because binary data formats often store only as much data as they need to,
so we need a way to get 8- and 16-bit values out of files.
(Many audio formats,
for example,
only store 16 bits per sample.)</p>
<p>Any format can be preceded by a count,
so the format <code>"3i"</code> means “three integers”:</p>
<div class="code-sample lang-py" title="pack_count.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="s2">"3i"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="s2">"5s"</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="s2">"5s"</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="s2">"a longer string"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pack_count.out">
<div class="highlight"><pre><span></span><code>b'\x01\x00\x00\x00\x02\x00\x00\x00\x03\x00\x00\x00'
b'hello'
b'a lon'
</code></pre></div>
</div>
<p>We get the wrong answer in the last call
because we only told Python to pack five characters.
How can we tell it to pack all the data that’s there regardless of length?</p>
<p>The short answer is that we can’t:
we must specify how much we want packed.
But that doesn’t mean we can’t handle variable-length strings;
it just means that we have to construct the format on the fly
using an expression like this:</p>
<div class="highlight"><pre><span></span><code><span class="nb">format</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="si">}</span><span class="s2">s"</span>
</code></pre></div>
<p class="continue">If <code>str</code> contains the string <code>"example"</code>,
the expression above will assign <code>"7s"</code> to <code>format</code>,
which just happens to be exactly the right format to use to pack it.</p>
<p>That’s fine when we’re writing,
but how do we know how much data to get if we’re reading?
For example, suppose we have the two strings “hello” and “Python”.
we can pack them like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">pack</span><span class="p">(</span><span class="s1">'5s6s'</span><span class="p">,</span> <span class="s1">'hello'</span><span class="p">,</span> <span class="s1">'Python'</span><span class="p">)</span>
</code></pre></div>
<p class="continue">but how do I know how to unpack 5 characters then 6?
The trick is to save the size along with the data.
If we always use exactly the same number of bytes to store the size,
we can read it back safely,
then use it to figure out how big our string is:</p>
<div class="code-sample lang-py" title="pack_str.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="k">def</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">as_string</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">"i"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">as_string</span><span class="p">))</span>
    <span class="n">as_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">as_string</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span>
    <span class="nb">format</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">as_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2">s"</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">as_bytes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pack_string</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pack_str.out">
<div class="highlight"><pre><span></span><code>b'\x05\x00\x00\x00hello'
</code></pre></div>
</div>
<p>The unpacking function is analogous.
We break the buffer into a header that’s exactly four bytes long
(i.e., the right size for an integer)
and a body made up of whatever’s left.
We then unpack the header,
whose format we know,
to determine how many characters are in the string.
Once we’ve got that we use the trick shown earlier
to construct the right format on the fly
and then unpack the string and return it.</p>
<div class="code-sample lang-py" title="unpack_str.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">unpack</span>

<span class="k">def</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
   <span class="n">header</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
   <span class="n">length</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">"i"</span><span class="p">,</span> <span class="n">header</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
   <span class="nb">format</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">s"</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">body</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
   <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># [omit]</span>
    <span class="kn">from</span> <span class="nn">pack_str</span> <span class="kn">import</span> <span class="n">pack_string</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">pack_string</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
    <span class="c1"># [/omit]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="unpack_str.out">
<div class="highlight"><pre><span></span><code>hello
</code></pre></div>
</div>
<p>Something to notice here is that
the least significant byte of an integer comes first.
This is called <a class="gl-ref" href="../glossary/#little_endian" markdown="1">little-endian</a> and is used by all Intel processors.
Some other processors put the most significant byte first,
which is called <a class="gl-ref" href="../glossary/#big_endian" markdown="1">big-endian</a>.
There are pro’s and con’s to both, which we won’t go into here.
What you <em>do</em> need to know is that if you move data from one architecture to another,
it’s your responsibility to flip the bytes around,
because the machine doesn’t know what the bytes mean.
This is such a pain that the <code>struct</code> library and other libraries like
will do things for you if you ask it to.
If you’re using <code>struct</code>,
the first character of a format string optionally indicates the byte order
(<a class="tbl-ref" href="../binary/#binary-endian">Table 7.5</a>).</p>
<div class="table"><table id="binary-endian"><caption>Table 7.5: <code>struct</code> package endian indicators</caption>
<thead>
<tr>
<th>Character</th>
<th>Byte order</th>
<th>Size</th>
<th>Alignment</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@</code></td>
<td>native</td>
<td>native</td>
<td>native</td>
</tr>
<tr>
<td><code>=</code></td>
<td>native</td>
<td>standard</td>
<td>none</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>little</td>
<td>endian</td>
<td>standard none</td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>big</td>
<td>endian</td>
<td>standard none</td>
</tr>
<tr>
<td><code>!</code></td>
<td>network</td>
<td>standard</td>
<td>none</td>
</tr>
</tbody>
</table>
</div>
<p>You should also use the <code>struct</code> library’s <code>calcsize</code> function,
which tells you how large (in bytes) the data produced or consumed by a format will be:</p>
<div class="code-sample lang-py" title="calcsize.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">calcsize</span>

<span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"4s"</span><span class="p">,</span> <span class="s2">"3i4s5d"</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"format '</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">' needs </span><span class="si">{</span><span class="n">calcsize</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="calcsize.out">
<div class="highlight"><pre><span></span><code>format '4s' needs 4 bytes
format '3i4s5d' needs 56 bytes
</code></pre></div>
</div>
<p>Binary data is to programming what chemistry is to biology:
you don’t want to spend any more time thinking at its level than you have to,
but there’s no substitute when you <em>do</em> have to.
Please remember that libraries already exist to handle almost every binary format ever created
and to read data from almost every instrument on the market.
You shouldn’t worry about 1’s and 0’s unless you really have to.</p>
<h2 id="binary-summary">Section 7.6: Summary</h2>
<figure id="binary-concept-map">
<img alt="Concept map for binary data" src="./binary/binary_concept_map.svg"/>
<figcaption markdown="1">Figure 7.5: Concepts for binary data.</figcaption>
</figure>
<h2 id="binary-exercises">Section 7.7: Exercises</h2>
<h3 class="exercise">Adding strings</h3>
<p>Write a function that takes two strings of digits
and adds them as if they were numbers
<em>without</em> actually converting them to numbers.
For example,
<code>add_str("12", "5")</code> should produce the string <code>"17"</code>.</p>
<h3 class="exercise">Roundoff</h3>
<ol>
<li>Write a program that loops over the integers from 1 to 9
    and uses them to create the values 0.9, 0.09, and so on.</li>
<li>Calculate the same values by subtracting 0.1 from 1,
    then subtracting 0.01,
    and so on.</li>
<li>Calculate the absolute and relative differences between corresponding values
    (which should be identical).</li>
<li>Repeat the exercise using the <code>Fraction</code> class
    from the <a href="https://docs.python.org/3/library/fractions.html">fractions</a> module.</li>
</ol>
<h3 class="exercise">Epsilon</h3>
<p>What is the smallest floating-point number your computer can represent?
What is the smallest number ε for which 1+ε is different from 1?</p>
<h3 class="exercise">Endian testing</h3>
<p>Write a program that reports whether the machine it is running on
is big-endian or little-ending.</p>
<h3 class="exercise">Encoding and decoding</h3>
<ol>
<li>
<p>Write a function that takes a list of integers representing Unicode code points as input
    and returns a list of single-byte integers with their UTF-8 encoding.</p>
</li>
<li>
<p>Write the complementary function that turns a list of single-byte integers
    into the corresponding code points
    and reports an error if anything is incorrectly formatted.</p>
</li>
</ol>
<h3 class="exercise">Binary persistence</h3>
<p>Rewrite the persistence framework of <a class="x-ref" href="#persistence">Chapter 6</a> to store and load binary data.</p>
<h3 class="exercise">Storing arrays</h3>
<p>Python’s <a href="https://docs.python.org/3/library/array.html">array</a> module manages a block of basic values
(characters, integers, or floating-point numbers).
Write a function that takes a list as input,
checks that all values in the list are of the same basic type,
and if so,
packs them into an array and then uses the <code>struct</code> module to pack that.</p>
<h3 class="exercise">Performance</h3>
<p>Getting a single value out of an array created with the <a href="https://docs.python.org/3/library/array.html">array</a> module takes time,
since the value must be boxed before it can be used.
Write some tests to see how much slower working with values in arrays is
compared to working with values in lists.</p>
<h3 class="exercise">File types</h3>
<p>The first eight bytes of a PNG image file always contain the following (base-10) values:</p>
<div class="highlight"><pre><span></span><code>137 80 78 71 13 10 26 10
</code></pre></div>
<p>Write a program that determines whether a file is a PNG image or not.</p>
<h3 class="exercise">Converting integers to bits</h3>
<p>Using Python’s bitwise operators,
write a function that returns the binary representation of an integer.
Write another function that converts a string of 1’s and 0’s into an integer.
(How) do your functions handle negative values?</p>
</section>
<section class="new-chapter"><h1 id="builder">Chapter: Chapter 8: A Build Manager</h1>

<ul class="syllabus">
<li markdown="1">Build managers track dependencies between files and update files that are stale.</li>
<li markdown="1">Every build rule has a target, some dependencies, and a recipe for updating the target.</li>
<li markdown="1">Build rules form a directed graph which must not contain cycles.</li>
<li markdown="1">Pattern rules describe the dependencies and recipes for sets of similar files.</li>
<li markdown="1">Pattern rules can use automatic variables to specify targets and dependencies in recipes.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#affordance" markdown="1">affordance</a>, <a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variable</a>, <a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a>, <a class="gl-ref" href="../glossary/#build_recipe" markdown="1">build recipe</a>, <a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rule</a>, <a class="gl-ref" href="../glossary/#csv" markdown="1">comma-separated values</a>, <a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled language</a>, <a class="gl-ref" href="../glossary/#dependency" markdown="1">dependency (in build)</a>, <a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a>, <a class="gl-ref" href="../glossary/#dry_run" markdown="1">dry run</a>, <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensibility</a>, <a class="gl-ref" href="../glossary/#json" markdown="1">JavaScript Object Notation</a>, <a class="gl-ref" href="../glossary/#link" markdown="1">link (a program)</a>, <a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rule (in build)</a>, <a class="gl-ref" href="../glossary/#phony_target" markdown="1">phony target</a>, <a class="gl-ref" href="../glossary/#refactor" markdown="1">refactor</a>, <a class="gl-ref" href="../glossary/#regression" markdown="1">regression</a>, <a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale (in build)</a>, <a class="gl-ref" href="../glossary/#build_target" markdown="1">target (in build)</a>, <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological order</a>, <a class="gl-ref" href="../glossary/#yaml" markdown="1">Yet Another Markup Language</a>
</p>
<div class="page-toc"></div>
<p>We wrote programs in <a class="x-ref" href="#interpreter">Chapter 3</a> as lists of lists
which we then interpreted directly.
Programs in <span class="ix-entry" ix-key="compiled language;language!compiled" markdown="1"><a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled languages</a></span>
like <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="Java" markdown="1">Java</span>,
on the other hand,
have to be translated into lower-level forms before they can run.
There are usually two stages to the translation:
compiling each source file into some intermediate form,
and then <span class="ix-entry" ix-key="linking (compiled language);compiled language!linking" markdown="1"><a class="gl-ref" href="../glossary/#link" markdown="1">linking</a></span> the compiled modules
to each other and to libraries
to create a runnable program
(<a class="fig-ref" href="../builder/#builder-compiling">Figure 8.1</a>).
If a source file hasn’t changed,
we don’t need to recompile it before linking.
Skipping unnecessary work in this way can save a lot of time
when we are working with programs that contains thousands or tens of thousands of files.</p>
<figure id="builder-compiling">
<img alt="Compiling and linking" src="./builder/builder_compiling.svg"/>
<figcaption markdown="1">Figure 8.1: Compiling source files and linking the resulting modules.</figcaption>
</figure>
<p><span class="ix-entry" ix-key="build manager" markdown="1"><a class="gl-ref" href="../glossary/#build_manager" markdown="1">Build managers</a></span>
were invented to keep track of all of this automatically.
A build manager takes a description of what depends on what,
figures out which files are out of date,
determines an order in which to rebuild things,
and then does whatever is required and only what is required <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Smith2011">Smith2011</a>]</span>.
The first build manager,
<span class="ix-entry" ix-key="Make" markdown="1"><a href="https://www.gnu.org/software/make/">Make</a></span>,
was built to manage C programs,
but build managers are used to update packages,
regenerate websites (<a class="x-ref" href="#templating">Chapter 9</a>),
re-create documentation from source code,
and run tests.
This chapter creates a simple build manager to illustrate how they work.</p>
<h2 id="builder-structure">Section 8.1: Structure</h2>
<p>The input to a build manager is
a set of <span class="ix-entry" ix-key="build rule;rule!build" markdown="1"><a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rules</a></span>,
each of which has:</p>
<ul>
<li>
<p>a <span class="ix-entry" ix-key="build target;target!build" markdown="1"><a class="gl-ref" href="../glossary/#build_target" markdown="1">target</a></span>,
    which is the file to be updated;</p>
</li>
<li>
<p>some <span class="ix-entry" ix-key="dependency (in build);build!dependency" markdown="1"><a class="gl-ref" href="../glossary/#dependency" markdown="1">dependencies</a></span>,
    which are the things that file depends on;
    and</p>
</li>
<li>
<p>a <span class="ix-entry" ix-key="recipe (in build);build!recipe" markdown="1"><a class="gl-ref" href="../glossary/#build_recipe" markdown="1">recipe</a></span>
    that specifies how to update the target
    if it is out of date compared to its dependencies.</p>
</li>
</ul>
<p>The target of one rule can be a dependency of another rule,
so their relationships form a <span class="ix-entry" ix-key="directed acyclic graph (DAG);DAG" markdown="1"><a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a></span>
(<a class="fig-ref" href="../builder/#builder-dependencies">Figure 8.2</a>).
The graph is directed because “A depends on B” is a one-way relationship,
while “acyclic” means it cannot contains loops:
if something depends on itself we can never finish updating it.</p>
<figure id="builder-dependencies">
<img alt="Respecting dependencies" src="./builder/builder_dependencies.svg"/>
<figcaption markdown="1">Figure 8.2: How a build manager finds and respects dependencies.</figcaption>
</figure>
<p>We say that a target is <span class="ix-entry" ix-key="stale (in build);build!stale" markdown="1"><a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale</a></span>
if it is older than any of its dependencies.
When this happens,
we use the recipes to bring it up to date.
Our build manager therefore must:</p>
<ol>
<li>
<p>Read a file containing rules.</p>
</li>
<li>
<p>Construct the dependency graph.</p>
</li>
<li>
<p>Figure out which targets are stale.</p>
</li>
<li>
<p>Build those targets,
    making sure to build things <em>before</em> anything that depends on them is built.</p>
</li>
</ol>
<div class="callout">
<h3>Topological order</h3>
<p>A <span class="ix-entry" ix-key="topological order" markdown="1"><a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological ordering</a></span> of a graph
arranges the nodes so that every node comes after everything it depends on.
For example,
if A depends on both B and C,
then (B, C, A) and (C, B, A) are both valid topological orders of the graph.</p>
</div>
<h2 id="builder-rules">Section 8.2: Representing Rules</h2>
<p>We will store our rules in <a class="gl-ref" href="../glossary/#yaml" markdown="1">YAML</a> files like this:</p>
<div class="code-sample lang-yml" title="three_simple_rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  - C
  recipes:
  - "update A from B and C"
- target: B
  depends:
  - C
  recipes:
  - "update B from C"
- target: C
  depends: []
  recipes: []
</code></pre></div>
</div>
<p class="continue">We could equally well have used <a class="gl-ref" href="../glossary/#json" markdown="1">JSON</a>,
but it wouldn’t have made sense to use <a class="gl-ref" href="../glossary/#csv" markdown="1">CSV</a>:
rules have a nested structure,
and CSV doesn’t represent nesting gracefully.</p>
<p>We would normally implement all of the builder’s methods at once,
but we will instead write them them one by one to make the evolving code easier to follow.
Let’s start by defining a class that loads a configuration file:</p>
<div class="code-sample lang-py" title="config_loader.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">yaml</span>

<span class="k">class</span> <span class="nc">ConfigLoader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules_file</span> <span class="o">=</span> <span class="n">rules_file</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">"Configuration must be array"</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We also need a method to check each rule because YAML is a generic file format
that doesn’t know anything about the extra requirements of our rules:</p>
<div class="code-sample lang-py" title="config_loader.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">"""Check a single rule."""</span>
        <span class="k">assert</span> <span class="p">(</span><span class="s2">"target"</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">rule</span><span class="p">[</span><span class="s2">"target"</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">"Rule </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2"> does not have 'target'"</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">"depends"</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">"depends"</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">"depends"</span><span class="p">])</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">"Bad 'depends' for rule </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">"</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">"recipes"</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">"recipes"</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">"recipes"</span><span class="p">])</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">"Bad 'recipes' for rule </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p>The next step is to turn the configuration into a graph in memory.
We derive a class from <code>ConfigLoader</code> so that we can recycle the code we’ve already written
and call a couple of methods that we are planning to add:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">config_loader</span> <span class="kn">import</span> <span class="n">ConfigLoader</span>
<span class="kn">from</span> <span class="nn">networkx.readwrite</span> <span class="kn">import</span> <span class="n">json_graph</span>

<span class="k">class</span> <span class="nc">GraphCreator</span><span class="p">(</span><span class="n">ConfigLoader</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We use the <a href="https://networkx.org/">networkx</a> module to manage nodes and links
rather than writing our own classes for graphs,
and store the recipe to rebuild a node in that node:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">"target"</span><span class="p">],</span> <span class="n">recipes</span><span class="o">=</span><span class="n">rule</span><span class="p">[</span><span class="s2">"recipes"</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">"depends"</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">rule</span><span class="p">[</span><span class="s2">"target"</span><span class="p">])</span>
</code></pre></div>
</div>
<p><code>networkx</code> implements some common graph algorithms,
including one to find cycles,
so let’s add that next:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">check_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Dependency graph contains cycles </span><span class="si">{</span><span class="n">cycles</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p>Finally,
we write a <code>__str__</code> method so we can see what we’ve built:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">json_graph</span><span class="o">.</span><span class="n">node_link_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">temp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"nodes"</span><span class="p">,</span> <span class="s2">"links"</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
</div>
<p>When we run this with our three simple rules as input we get:</p>
<div class="code-sample lang-sh" title="graph_creator.sh">
<div class="highlight"><pre><span></span><code>python graph_creator.py three_simple_rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="graph_creator.out">
<div class="highlight"><pre><span></span><code>{
  "nodes": [
    {
      "recipes": [
        "update A from B and C"
      ],
      "id": "A"
    },
    {
      "recipes": [
        "update B from C"
      ],
      "id": "B"
    },
    {
      "recipes": [],
      "id": "C"
    }
  ],
  "links": [
    {
      "source": "B",
      "target": "A"
    },
    {
      "source": "C",
      "target": "A"
    },
    {
      "source": "C",
      "target": "B"
    }
  ]
}
</code></pre></div>
</div>
<p>Let’s write a quick test to make sure the cycle detector works as intended:</p>
<div class="code-sample lang-yml" title="circular_rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  recipes:
  - "update A from B"
- target: B
  depends:
  - A
  recipes:
  - "update B from A"
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="check_cycles.sh">
<div class="highlight"><pre><span></span><code>python graph_creator.py circular_rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="check_cycles.out">
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File "/u/sdxpy/builder/graph_creator.py", line 46, in &lt;module&gt;
    builder.build()
  File "/u/sdxpy/builder/graph_creator.py", line 12, in build
    self.check_cycles()
  File "/u/sdxpy/builder/graph_creator.py", line 30, in check_cycles
    assert len(cycles) == 0, f"Dependency graph contains cycles \
    {cycles}"
AssertionError: Dependency graph contains cycles [['A', 'B']]
</code></pre></div>
</div>
<h2 id="builder-timestamp">Section 8.3: Stale Files</h2>
<p>The next step is to figure out which files are out of date.
Make does this by comparing the <span class="ix-entry" ix-key="timestamp!in build;build!timestamp" markdown="1">timestamps</span> of the files in question,
but this isn’t always reliable:
<span class="ix-entry" ix-key="clock synchronization (in build);build!clock synchronization" markdown="1">computers’ clocks may be slightly out of sync</span>,
which can produce a wrong answer on a networked filesystem,
and the operating system may only report file update times to the nearest millisecond
(which seemed very short in 1970 but seems very long today).</p>
<p>More modern build systems store a <span class="ix-entry" ix-key="hash code!in build;build!hash code" markdown="1">hash</span> of each file’s contents
and compare the current hash to the stored one to see if the file has changed.
We looked at hashing in <a class="x-ref" href="#backup">Chapter 4</a>,
so we will use the timestamp approach here.
We should also test using a mock filesystem,
but for variety’s sake
we will load another configuration file that specifies timestamps for files:</p>
<div class="code-sample lang-yml" title="add_timestamps.yml">
<div class="highlight"><pre><span></span><code>A: 2
B: 5
C: 8
</code></pre></div>
</div>
<p>Since we want to associate those timestamps with files,
we add steps to the constructor and the <code>build</code> method
to read the timestamp file and add information to the graph’s nodes:</p>
<div class="code-sample lang-py" title="add_timestamps.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AddTimestamps</span><span class="p">(</span><span class="n">GraphCreator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules_file</span><span class="p">,</span> <span class="n">times_file</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rules_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_file</span> <span class="o">=</span> <span class="n">times_file</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timestamps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">and then implement <code>add_timestamps</code>:</p>
<div class="code-sample lang-py" title="add_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">add_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">}</span> <span class="o">-</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">times</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Name(s) missing from times: </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Before we move on,
let’s make sure that adding timestamps works as we want:</p>
<div class="code-sample lang-sh" title="add_timestamps.sh">
<div class="highlight"><pre><span></span><code>python add_timestamps.py three_simple_rules.yml add_timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="add_timestamps.out">
<div class="highlight"><pre><span></span><code>{
  "nodes": [
    {
      "recipes": [
        "update A from B and C"
      ],
      "timestamp": 2,
      "id": "A"
    },
    {
      "recipes": [
        "update B from C"
      ],
      "timestamp": 5,
      "id": "B"
    },
    {
      "recipes": [],
      "timestamp": 8,
      "id": "C"
    }
  ],
  "links": [
    {
      "source": "B",
      "target": "A"
    },
    {
      "source": "C",
      "target": "A"
    },
    {
      "source": "C",
      "target": "B"
    }
  ]
}
</code></pre></div>
</div>
<h2 id="builder-update">Section 8.4: Updating Files</h2>
<p>To figure out which recipes to execute and in which order,
we set the pretended current time to the latest time of any file,
then look at each file in topological order.
If a file is older than any of its dependencies,
we update the file <em>and</em> its pretended timestamp
to trigger an update of anything that depends on it.
First,
we add a step to <code>build</code>:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UpdateTimestamps</span><span class="p">(</span><span class="n">AddTimestamps</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timestamps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Next,
we implement the <code>run</code> method.
We can pretend that updating a file always takes one unit of time,
so we advance our fictional clock by one for each build.
Using <code>networkx.topological_sort</code> to create the topological order,
we get this:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">)</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2">: START"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">))):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stale</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"timestamp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2">: END"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <code>run</code> method:</p>
<ol>
<li>
<p>Gets a sorted list of nodes.</p>
</li>
<li>
<p>Sets the starting time to be one unit past the largest file time.</p>
</li>
<li>
<p>Checks each file in order.
    If that file is stale,
    we print the steps we would run and then update the file’s timestamp.
    We only advance the notional current time when we do an update.</p>
</li>
</ol>
<p>To check if a file is stale,
we see if any of its dependencies currently have timestamps
greater than or equal to the target’s timestamp:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">is_stale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">"timestamp"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"timestamp"</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<p>Our <code>update</code> method simply prints the actions it would take:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">):"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"recipes"</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>When we run this,
it seems to do the right thing:</p>
<div class="code-sample lang-sh" title="update_timestamps.sh">
<div class="highlight"><pre><span></span><code>python update_timestamps.py three_simple_rules.yml add_timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="update_timestamps.out">
<div class="highlight"><pre><span></span><code>9: START
- A (9):
  - update A from B and C
- B (10):
  - update B from C
11: END
</code></pre></div>
</div>
<h2 id="builder-variables">Section 8.5: Variables</h2>
<p>We don’t want to have to write a hundred nearly-identical recipes
if our program has a hundred files
or our website has a hundred blog posts.
Instead,
we want to write generic <span class="ix-entry" ix-key="build!rule;rule (in build)" markdown="1">build rules</span>.
To do this we need:</p>
<ul>
<li>
<p>a way to define a set of files;</p>
</li>
<li>
<p>a way to specify a generic rule;
    and</p>
</li>
<li>
<p>a way to fill in parts of that rule.</p>
</li>
</ul>
<p>We will achieve this by overriding <code>build_graph</code> to replace variables in recipes with values.
Once again,
object-oriented programming lets us change only what we need to,
provided we divided our problem into sensible chunks in the first place.</p>
<div class="callout">
<h3>Extensibility and Experience</h3>
<p><a class="x-ref" href="#interpreter">Chapter 3</a> said that one way to evaluate a program’s design
is to ask how <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensible</a> it is.
In practice,
extensibility usually comes from experience:
we can’t know what <a class="gl-ref" href="../glossary/#affordance" markdown="1">affordances</a> to provide
until we’ve tried extending our code in different ways a couple of times.
We <a class="gl-ref" href="../glossary/#refactor" markdown="1">refactored</a> the examples in this book several times
as we wrote the explanations
so that early versions left room for later ones.
Don’t be surprised or disappointed if you have to do this for your own code;
after you’ve extended and refactored something two or three times,
it usually settles down into its final form.</p>
</div>
<p>Make provides
<span class="ix-entry" ix-key="automatic variable (in build);build!automatic variable" markdown="1"><a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variables</a></span>
with cryptic names like <code>$&lt;</code> and <code>$@</code>
to represent the parts of a rule.
Our variables will be more readable:
we will use <code>@TARGET</code> for the target,
<code>@DEPENDENCIES</code> for the dependencies (in order),
and <code>@DEP[1]</code>, <code>@DEP[2]</code>, and so on for specific dependencies
(<a class="fig-ref" href="../builder/#builder-pattern-rules">Figure 8.3</a>).</p>
<figure id="builder-pattern-rules">
<img alt="Pattern rules" src="./builder/builder_pattern_rules.svg"/>
<figcaption markdown="1">Figure 8.3: Turning patterns rules into runnable commands.</figcaption>
</figure>
<p>Our variable expander looks like this:</p>
<div class="code-sample lang-py" title="expand_variables.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">expand_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expand_one</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expand_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="n">recipes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">"recipes"</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recipes</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">recipe</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"@TARGET"</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">"@DEPENDENCIES"</span><span class="p">,</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">"@DEP[</span><span class="si">{</span><span class="nb">id</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">]"</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">"recipes"</span><span class="p">][</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>After adding this,
we immediately test that it works when there <em>aren’t</em> any variables to expand
by running it on the same example we used previously:</p>
<div class="code-sample lang-sh" title="expand_variables_no_vars.sh">
<div class="highlight"><pre><span></span><code>python expand_variables.py three_simple_rules.yml add_timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="expand_variables_no_vars.out">
<div class="highlight"><pre><span></span><code>9: START
- A (9):
  - update A from B and C
- B (10):
  - update B from C
11: END
</code></pre></div>
</div>
<p class="continue">This is perhaps the most important reason to create tests:
they tell us if something we have added or changed
has caused a <a class="gl-ref" href="../glossary/#regression" markdown="1">regression</a>,
i.e., has broken something that used to work.
If so,
the problem will be easier to fix while
the breaking change is still fresh in our minds.</p>
<h2 id="builder-generic">Section 8.6: Generic Rules</h2>
<p>Now we need to add <span class="ix-entry" ix-key="pattern rule (in build);build!pattern rule" markdown="1"><a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rules</a></span>:
Our test rules file is:</p>
<div class="code-sample lang-yml" title="pattern_rules.yml">
<div class="highlight"><pre><span></span><code>- target: left.out
  depends: []
  recipes: []
- target: left.in
  depends: []
  recipes: []
- target: right.out
  depends: []
  recipes: []
- target: right.in
  depends: []
  recipes: []
- target: "%.out"
  depends:
  - "%.in"
  recipes:
  - "update @TARGET from @DEPENDENCIES"
</code></pre></div>
</div>
<p class="continue">and our first attempt at reading it extracts rules before expanding variables:</p>
<div class="code-sample lang-py" title="pattern_attempt.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PatternAttempt</span><span class="p">(</span><span class="n">ExpandVariables</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_variables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timestamps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">extract_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"%"</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">"recipes"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
</div>
<p>However,
it doesn’t work:</p>
<div class="code-sample lang-sh" title="pattern_attempt.sh">
<div class="highlight"><pre><span></span><code>python pattern_attempt.py pattern_rules.yml pattern_times.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern_attempt.out">
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File "/u/sdxpy/builder/pattern_attempt.py", line 32, in &lt;module&gt;
    builder.build()
  File "/u/sdxpy/builder/pattern_attempt.py", line 8, in build
    self.extract_rules()
  File "/u/sdxpy/builder/pattern_attempt.py", line 19, in extract_rules
    self.rules[target] = self.graph.nodes[target]["recipes"]
KeyError: 'recipes'
</code></pre></div>
</div>
<p>After a bit of poking around with a <span class="ix-entry" ix-key="debugger" markdown="1">debugger</span>
we realize that
the failure occurs when we’re looking at the rule for <code>%.in</code>.
When we create edges in the graph between a target and its dependencies,
<code>networkx</code> automatically adds a node for the dependency
if one didn’t exist yet.
As a result,
when we say that <code>%.out</code> depends on <code>%.in</code>,
we wind up with a node for <code>%.in</code> that doesn’t have any recipes.</p>
<p>We can fix our problem by changing the <code>build_graph</code> method
so that it saves pattern rules in a dictionary
and then builds the graph from the non-pattern rules:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s2">"target"</span><span class="p">]:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="k">if</span> <span class="s2">"%"</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">"target"</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="k">if</span> <span class="s2">"%"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">"target"</span><span class="p">]]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">Expanding rules relies on two helper methods:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">expand_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rule</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_rule</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill_in</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The first helper finds rules:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">find_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">"."</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"%.</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and the second adds links and recipes to the graph:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">fill_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="n">stem</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">"recipes"</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">"recipes"</span><span class="p">]</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"%"</span><span class="p">,</span> <span class="n">stem</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">"depends"</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">depends</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We’re finally ready to test:</p>
<div class="code-sample lang-sh" title="pattern_final.sh">
<div class="highlight"><pre><span></span><code>python pattern_final.py pattern_rules.yml pattern_times.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern_final.out">
<div class="highlight"><pre><span></span><code>4: START
- right.out (4):
  - update left.out from left.in
- left.out (5):
  - update left.out from left.in
6: END
</code></pre></div>
</div>
<h2 id="builder-discuss">Section 8.7: Discussion</h2>
<p>Our design uses the <span class="ix-entry" ix-key="Template Method pattern;design pattern!Template Method" markdown="1">Template Method</span> pattern:
a method in a parent class defines the overall order of operations,
while child classes implement those operations without changing the flow of control.
We have added a lot of steps to our original template method,
which makes it a bit of a stretch to claim that the overall operation hasn’t changed.
Knowing what we know now,
we could go back and modify the original <code>SkeletonBuilder.build</code> method
to include those extra steps and provide do-nothing implementations.</p>
<p>The root of the problem is that we didn’t anticipate all the steps that would be involved
when we wrote our template method.
As we said earlier,
we typically have to refactor our base code
the first two or three times we try to extend it.
If it never settles down,
then Template Method is probably the wrong pattern for our situation.
Realizing this isn’t a failure in initial design:
we always learn about our problem as we try to capture it in code,
and if we know enough to anticipate 100% of the issues that are going to come up,
it’s time to put what we’ve learned in a library for future use.</p>
<h2 id="builder-summary">Section 8.8: Summary</h2>
<figure id="builder-concept-map">
<img alt="Concept map for build manager" src="./builder/builder_concept_map.svg"/>
<figcaption markdown="1">Figure 8.4: Concepts for build manager.</figcaption>
</figure>
<h2 id="builder-exercises">Section 8.9: Exercises</h2>
<h3 class="exercise">Reporting</h3>
<ol>
<li>
<p>Modify the build manager so that it expands all pattern rules
    and prints out a fully-expanded YAML build file.</p>
</li>
<li>
<p>Test your extension by having the build manager read and execute
    the file it just created.</p>
</li>
</ol>
<h3 class="exercise">Handle failure</h3>
<ol>
<li>
<p>Modify the build manager so that if a recipe fails,
    other targets that don’t depend on it are still built.</p>
</li>
<li>
<p>Write tests to check that this change works correctly.</p>
</li>
</ol>
<h3 class="exercise">Dry run</h3>
<ol>
<li>
<p>Modify the build manager so that it can show what recipes it would execute
    without actually executing them.
    (Doing this is called a <a class="gl-ref" href="../glossary/#dry_run" markdown="1">dry run</a>.)</p>
</li>
<li>
<p>Write tests to make sure that dry runs don’t change any files.</p>
</li>
</ol>
<h3 class="exercise">Merge files</h3>
<ol>
<li>
<p>Modify the build manager so that it can read multiple build files
    and execute their combined rules.</p>
</li>
<li>
<p>What does your solution do if two or more files specify rules
    for the same target?
    What does the <em>existing</em> code do?</p>
</li>
</ol>
<h3 class="exercise">Specific targets</h3>
<p>Modify the build manager so that users can specify
which targets they want to update.
The build manager should only execute recipes needed to update those targets.</p>
<h3 class="exercise">Phony targets</h3>
<p>A <a class="gl-ref" href="../glossary/#phony_target" markdown="1">phony target</a> is one that doesn’t create or modify a file.
Programmers often put phony targets in build files
to do tasks like executing tests in a reproducible way.
Modify the build manager so that
users can specify and run phony targets.</p>
<h3 class="exercise">Conditional execution</h3>
<p>Modify the build manager so that:</p>
<ol>
<li>
<p>The user can pass <code>name=true</code> and <code>name=false</code> arguments on the command-line
    to define variables.</p>
</li>
<li>
<p>Rules can contain an <code>if: variable</code> field.</p>
</li>
<li>
<p>Those rules are only executed if the variable is defined and true.</p>
</li>
</ol>
<p>Write tests to check that this works correctly.</p>
<h3 class="exercise">Define filesets</h3>
<p>Modify the build manager so that users can define sets of files:</p>
<div class="highlight"><pre><span></span><code>fileset:
  name: everything
  contains:
    - X
    - Y
    - Z
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @everything
</code></pre></div>
<h3 class="exercise">Globbing</h3>
<p>Modify the build manager so that it can dynamically construct a set of files:</p>
<div class="highlight"><pre><span></span><code>glob:
  name: allAvailableInputs
  pattern: "./*.in"
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @allAvailableInputs
</code></pre></div>
<h3 class="exercise">Use hashes</h3>
<ol>
<li>
<p>Write a program called <code>build_init.py</code> that calculates a hash
    for every file mentioned in the build configuration
    and stores the hash along with the file’s name in <code>build_hash.json</code>.</p>
</li>
<li>
<p>Modify the build manager to compare the current hashes of files
    with those stored in <code>build_hash.json</code>
    to determine what is out of date,
    and to update <code>build_hash.json</code> each time it runs.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="templating">Chapter: Chapter 9: A Static Site Generator</h1>

<ul class="syllabus">
<li markdown="1">Static site generators create HTML pages from templates, directives, and data.</li>
<li markdown="1">A static site generator must have the same core features as a programming language.</li>
<li markdown="1">Programs can use the Visitor pattern to separate traversal of a data structure from operations on its elements.</li>
<li markdown="1">HTML documents are usually represented in memory as trees using the Document Object Model (DOM).</li>
<li markdown="1">The style of code that programmers find easiest to read changes as they become more experienced.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#abstract_method" markdown="1">abstract method</a>, <a class="gl-ref" href="../glossary/#api" markdown="1">Application Programming Interface</a>, <a class="gl-ref" href="../glossary/#cognitive_load" markdown="1">cognitive load</a>, <a class="gl-ref" href="../glossary/#static_method" markdown="1">static method</a>, <a class="gl-ref" href="../glossary/#static_site_generator" markdown="1">static site generator</a>, <a class="gl-ref" href="../glossary/#truthy" markdown="1">truthy</a>, <a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor pattern</a>
</p>
<div class="page-toc"></div>
<p>Every program needs documentation in order to be usable,
and the best place to put that documentation is on the web.
Writing and updating pages by hand is time-consuming and error-prone,
particularly when many parts are the same,
so most documentation sites use some kind of
<span class="ix-entry" ix-key="static site generator" markdown="1"><a class="gl-ref" href="../glossary/#static_site_generator" markdown="1">static site generator</a></span>
to create web pages from templates.</p>
<p>At the heart of every static site generator is a page templating system.
Thousands of these have been written in the last thirty years
in every popular programming language,
and a language called <span class="ix-entry" ix-key="PHP" markdown="1"><a href="https://www.php.net/">PHP</a></span> was created primarily for this purpose.
Most of these systems use one of three designs
(<a class="fig-ref" href="../templating/#templating-options">Figure 9.1</a>):</p>
<ol>
<li>
<p>Mix commands in an existing language such as JavaScript with the HTML or Markdown
    using some kind of marker to indicate which parts are commands
    and which parts are to be taken as-is.
    This approach is taken by <span class="ix-entry" ix-key="EJS" markdown="1"><a href="https://ejs.co/">EJS</a></span>.</p>
</li>
<li>
<p>Create a mini-language with its own commands like <span class="ix-entry" ix-key="Jekyll" markdown="1"><a href="https://jekyllrb.com/">Jekyll</a></span>.
    Mini-languages are appealing because they are smaller and safer than general-purpose languages,
    but eventually they acquire most of the features of a general-purpose language.
    Again, some kind of marker must be used to show
    which parts of the page are code and which are ordinary text.</p>
</li>
<li>
<p>Put directives in specially-named attributes in the HTML.
    This approach has been the least popular,
    but since pages are valid HTML,
    it eliminates the need for a special parser.</p>
</li>
</ol>
<figure id="templating-options">
<img alt="Three options for page templates" src="./templating/templating_options.svg"/>
<figcaption markdown="1">Figure 9.1: Three different ways to implement page templating.</figcaption>
</figure>
<p>This chapter builds a simple page templating system using the third strategy.
We will process each page independently by parsing the HTML
and walking the <span class="ix-entry" ix-key="DOM" markdown="1">DOM</span> to find nodes with special attributes.
Our program will execute the instructions in those nodes
to implement loops and if/else statements;
other nodes will be copied as-is to create text.</p>
<h2 id="templating-syntax">Section 9.1: Syntax</h2>
<p>Let’s start by deciding what “done” looks like.
Suppose we want to turn an array of strings into an HTML list.
Our page will look like this:</p>
<div class="code-sample lang-ht" title="loop.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;Expect three items&lt;/p&gt;
    &lt;ul z-loop="item:names"&gt;
      &lt;li&gt;&lt;span z-var="item"/&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p>The attribute <code>z-loop</code> tells the tool to repeat the contents of that node;
the loop variable and the collection being looped over are separated by a colon.
The <code>span</code> with the attribute <code>z-var</code>
tells the tool to fill in the node with the value of the variable.
When our tool processes this page,
the output will be standard HTML without any traces of how it was created:</p>
<div class="code-sample lang-out" title="loop.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;Expect three items&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span&gt;Johnson&lt;/span&gt;&lt;/li&gt;

&lt;li&gt;&lt;span&gt;Vaughan&lt;/span&gt;&lt;/li&gt;

&lt;li&gt;&lt;span&gt;Jackson&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="callout">
<h3>Human-readable vs. machine-readable</h3>
<p>Mini-languages for page templating can quickly become unreadable.
We have already started down that road
by putting the loop variable and loop target in a single attribute
and splitting that attribute to get them out.
Doing this makes loops easy for people to type,
but hides important information from standard HTML processing tools:
they can’t know that this particular attribute of these particular elements
contains multiple values
or that those values should be extracted by splitting a string on a colon.
We could instead use two attributes like this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">ul</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">"names"</span> <span class="na">z-loop-var</span><span class="o">=</span><span class="s">"item"</span><span class="p">&gt;</span>
</code></pre></div>
<p>but we have decided to save ourselves a little typing.
And strictly speaking
we should call our attributes <code>data-something</code> instead of <code>z-something</code>
to conform with <span class="ix-entry" ix-key="HTML5 specification" markdown="1">[the HTML5 specification][html5-data-attributes]</span>,
but by the time we’re finished processing our templates,
there shouldn’t be any <code>z-*</code> attributes left to confuse a browser.</p>
</div>
<p>The next step is to define the <a class="gl-ref" href="../glossary/#api" markdown="1">API</a> for filling in templates.
Our tool needs the template itself,
somewhere to write its output,
and some variables to use in the expansion.
These variables might come from a configuration file,
from a YAML header in the file itself,
or from some mix of the two;
for the moment,
we will just pass them into the expansion function as an object:</p>
<div class="code-sample lang-py" title="example_call.py">
<div class="highlight"><pre><span></span><code><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"names"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Johnson"</span><span class="p">,</span> <span class="s2">"Vaughan"</span><span class="p">,</span> <span class="s2">"Jackson"</span><span class="p">]}</span>

<span class="n">dom</span> <span class="o">=</span> <span class="n">read_html</span><span class="p">(</span><span class="s2">"template.html"</span><span class="p">)</span>
<span class="n">expander</span> <span class="o">=</span> <span class="n">Expander</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
<span class="n">expander</span><span class="o">.</span><span class="n">walk</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">expander</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="templating-values">Section 9.2: Managing Variables</h2>
<p>As soon as we have variables we need a way to track their values.
We also need to maintain multiple sets of variables
so that (for example) variables used inside a loop
don’t conflict with ones used outside it.
As in <a class="x-ref" href="#interpreter">Chapter 3</a>,
we will use a stack of environments,
each of which is a dictionary.</p>
<p>Our stack-handling class <code>Env</code> has methods  to push and pop new stack frames
and find a variable given its name.
If the variable can’t be found,
<code>Env.find</code> returns <code>None</code> instead of throwing an exception
(<a class="fig-ref" href="../templating/#templating-stack">Figure 9.2</a>).</p>
<div class="code-sample lang-py" title="env.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Env</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">frame</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="templating-stack">
<img alt="Variable stack" src="./templating/templating_stack.svg"/>
<figcaption markdown="1">Figure 9.2: Using a stack to manage variables.</figcaption>
</figure>
<h2 id="templating-nodes">Section 9.3: Visiting Nodes</h2>
<p>HTML pages have a nested structure,
so we will process them using
the <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1"><a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor</a></span> design pattern.
<code>Visitor</code>‘s constructor takes the root node of the DOM tree as an argument and saves it.
When we call <code>Visitor.walk</code> without a value,
it starts recursing from that saved root;
if <code>.walk</code> is given a value (as it is during recursive calls),
it uses that instead.</p>
<div class="code-sample lang-py" title="visitor.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>


<span class="k">class</span> <span class="nc">Visitor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p class="continue"><code>Visitor</code> defines two <a class="gl-ref" href="../glossary/#abstract_method" markdown="1">abstract methods</a> <code>open</code> and <code>close</code>
that are called when we first arrive at a node and when we are finished with it
(<a class="fig-ref" href="../templating/#templating-visitor">Figure 9.3</a>).
Any class derived from <code>Visitor</code> must define these two methods.</p>
<figure id="templating-visitor">
<img alt="The Visitor pattern" src="./templating/templating_visitor.svg"/>
<figcaption markdown="1">Figure 9.3: Using the Visitor pattern to evaluate a page template.</figcaption>
</figure>
<p>The <code>Expander</code> class is specialization of <code>Visitor</code>
that uses an <code>Env</code> to keep track of variables.
It imports handlers for each type of special node—we will write those in a moment—and
uses them to process each type of node:</p>
<ol>
<li>
<p>If the node is plain text, copy it to the output.</p>
</li>
<li>
<p>If there is a handler for the node,
    call the handler’s <code>open</code> or <code>close</code> method.</p>
</li>
<li>
<p>Otherwise, open or close a regular tag.</p>
</li>
</ol>
<div class="code-sample lang-py" title="expander.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">NavigableString</span><span class="p">,</span> <span class="n">Tag</span>
<span class="kn">from</span> <span class="nn">env</span> <span class="kn">import</span> <span class="n">Env</span>
<span class="kn">from</span> <span class="nn">visitor</span> <span class="kn">import</span> <span class="n">Visitor</span>
<span class="kn">from</span> <span class="nn">z_if</span> <span class="kn">import</span> <span class="n">z_if</span>
<span class="kn">from</span> <span class="nn">z_loop</span> <span class="kn">import</span> <span class="n">z_loop</span>
<span class="kn">from</span> <span class="nn">z_num</span> <span class="kn">import</span> <span class="n">z_num</span>
<span class="kn">from</span> <span class="nn">z_var</span> <span class="kn">import</span> <span class="n">z_var</span>

<span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"z-if"</span><span class="p">:</span> <span class="n">z_if</span><span class="p">,</span> <span class="s2">"z-loop"</span><span class="p">:</span> <span class="n">z_loop</span><span class="p">,</span> <span class="s2">"z-num"</span><span class="p">:</span> <span class="n">z_num</span><span class="p">,</span> <span class="s2">"z-var"</span><span class="p">:</span> <span class="n">z_var</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">Expander</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">Env</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">HANDLERS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">NavigableString</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasHandler</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHandler</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">NavigableString</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasHandler</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getHandler</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To check if there is a handler for a particular node
and get it if there is
we just look at the node’s attributes:</p>
<div class="code-sample lang-py" title="expander.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">hasHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Should be exactly one handler"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</code></pre></div>
</div>
<p>Finally, we need a few helper methods to show tags and generate output:</p>
<div class="code-sample lang-py" title="expander.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">showTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">closing</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">closing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&lt;/</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&lt;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"z-"</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="sa">f</span><span class="s1">' </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">="</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">"&gt;"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"UNDEF"</span> <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Notice that this class adds strings to an array and joins them all right at the end
rather than concatenating strings repeatedly.
Doing this is more efficient;
it also helps with debugging,
since each string in the array corresponds to a single method call.</p>
<h2 id="templating-handlers">Section 9.4: Implementing Handlers</h2>
<p>At this point
we have built a lot of infrastructure but haven’t actually processed any special nodes.
To do that,
let’s write a handler that copies a constant number into the output:</p>
<div class="code-sample lang-py" title="z_num.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">z_num</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"z-num"</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <code>z_num</code> expander is a class,
but we don’t plan to create instances of it.
Instead,
it’s just a way to manage a pair of related <code>open</code> and <code>close</code> functions,
which we declare as <span class="ix-entry" ix-key="static method" markdown="1"><a class="gl-ref" href="../glossary/#static_method" markdown="1">static methods</a></span>.
When we enter a node like <code>&lt;span z-num="123"/&gt;</code>
this handler asks the expander to show an opening tag
followed by the value of the <code>z-num</code> attribute.
When we exit the node,
the handler asks the expander to close the tag.
The handler doesn’t know whether things are printed immediately,
added to an output list,
or something else;
it just knows that whoever called it implements the low-level operations it needs.</p>
<p>So much for constants; what about variables?</p>
<div class="code-sample lang-py" title="z_var.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">z_var</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">expander</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"z-var"</span><span class="p">]))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">This code is almost the same as the previous example.
The only difference is that instead of copying the attribute’s value
directly to the output,
we use it as a key to look up a value.</p>
<p>These two pairs of handlers look plausible, but do they work?
To find out,
we can build a program that loads variable definitions from a JSON file,
reads an HTML template using the <a href="https://beautiful-soup-4.readthedocs.io/">Beautiful Soup</a> library,
and does the expansion:</p>
<div class="code-sample lang-py" title="template.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">expander</span> <span class="kn">import</span> <span class="n">Expander</span>


<span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_template</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s2">"html.parser"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"html"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">read_template</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">expander</span> <span class="o">=</span> <span class="n">Expander</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
    <span class="n">expander</span><span class="o">.</span><span class="n">walk</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">expander</span><span class="o">.</span><span class="n">getResult</span><span class="p">())</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We added new variables for our test cases one by one
as we were writing this chapter.
To avoid repeating text repeatedly,
here’s the entire set:</p>
<div class="code-sample lang-json" title="vars.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"firstVariable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstValue"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"secondVariable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"secondValue"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"variableName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"variableValue"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"showThis"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"doNotShowThis"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Johnson"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Vaughan"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Jackson"</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Our first test:
is static text copied over as-is?</p>
<div class="code-sample lang-ht" title="static_text.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;h1&gt;Static Text&lt;/h1&gt;
    &lt;p&gt;This page has:&lt;/p&gt;
    &lt;ul&gt;
      &lt;li&gt;static&lt;/li&gt;
      &lt;li&gt;text&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="code-sample lang-out" title="static_text.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Static Text&lt;/h1&gt;
&lt;p&gt;This page has:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;static&lt;/li&gt;
&lt;li&gt;text&lt;/li&gt;
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p>Good.
Now, does the expander handle constants?</p>
<div class="code-sample lang-ht" title="single_constant.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;&lt;span z-num="123"/&gt;&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="code-sample lang-out" title="single_constant.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;&lt;span&gt;123&lt;/span&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p class="continue">What about a single variable?</p>
<div class="code-sample lang-ht" title="single_variable.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;&lt;span z-var="variableName"/&gt;&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="code-sample lang-out" title="single_variable.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;&lt;span&gt;variableValue&lt;/span&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p>What about a page containing multiple variables?
There’s no reason it should fail if the single-variable case works,
but we should still check—again,
software isn’t done until it has been tested.</p>
<div class="code-sample lang-ht" title="multiple_variables.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;&lt;span z-var="firstVariable" /&gt;&lt;/p&gt;
    &lt;p&gt;&lt;span z-var="secondVariable" /&gt;&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="code-sample lang-out" title="multiple_variables.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;&lt;span&gt;firstValue&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;secondValue&lt;/span&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<h2 id="templating-flow">Section 9.5: Control Flow</h2>
<p>Our tool supports conditional expressions and loops.
Since it doesn’t handle Boolean expressions like <code>and</code> and <code>or</code>,
implementing a conditional is as simple as looking up a variable
and then expanding the node if Python thinks the value is <a class="gl-ref" href="../glossary/#truthy" markdown="1">truthy</a>:</p>
<div class="code-sample lang-py" title="z_if.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">z_if</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">expander</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"z-if"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">check</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expander</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"z-if"</span><span class="p">]):</span>
            <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Let’s test it:</p>
<div class="code-sample lang-ht" title="conditional.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;p z-if="showThis"&gt;This should be shown.&lt;/p&gt;
    &lt;p z-if="doNotShowThis"&gt;This should &lt;em&gt;not&lt;/em&gt; be shown.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="code-sample lang-out" title="conditional.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;This should be shown.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="callout">
<h3>Spot the Bug</h3>
<p>This implementation of <code>if</code> contains a subtle bug.
The <code>open</code> and <code>close</code> functions both check the value of the control variable.
If something inside the body of the <code>if</code> changes that value,
the result could be an opening tag without a matching closing tag or vice versa.
We haven’t implemented an assignment operator,
so right now there’s no way for that to happen,
but it’s a plausible thing for us to add later,
and tracking down a bug in old code that is revealed by new code
is always a headache.</p>
</div>
<p>Finally we have loops.
For these,
we need to get the array we’re looping over from the environment
and do something for each of its elements.
That “something” is:</p>
<ol>
<li>
<p>Create a new stack frame holding the current value of the loop variable.</p>
</li>
<li>
<p>Expand all of the node’s children with that stack frame in place.</p>
</li>
<li>
<p>Pop the stack frame to get rid of the temporary variable.</p>
</li>
</ol>
<div class="code-sample lang-py" title="z_loop.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">z_loop</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">index_name</span><span class="p">,</span> <span class="n">target_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"z-loop"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
        <span class="c1"># delete node.attrs['z-loop']</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">expander</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">expander</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">push</span><span class="p">({</span><span class="n">index_name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">expander</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">expander</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">expander</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">expander</span><span class="o">.</span><span class="n">showTag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Once again,
it’s not done until we test it:</p>
<div class="code-sample lang-ht" title="loop.ht">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;Expect three items&lt;/p&gt;
    &lt;ul z-loop="item:names"&gt;
      &lt;li&gt;&lt;span z-var="item"/&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<div class="code-sample lang-out" title="loop.out">
<div class="highlight"><pre><span></span><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;Expect three items&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span&gt;Johnson&lt;/span&gt;&lt;/li&gt;

&lt;li&gt;&lt;span&gt;Vaughan&lt;/span&gt;&lt;/li&gt;

&lt;li&gt;&lt;span&gt;Jackson&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<h2 id="templating-learning">Section 9.6: How We Got Here</h2>
<p>We have just implemented another simple programming language.
It can’t do arithmetic,
but if we wanted to add tags like:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">z</span><span class="o">-</span><span class="nx">math</span><span class="o">=</span><span class="s2">"+"</span><span class="o">&gt;&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">z</span><span class="o">-</span><span class="kd">var</span><span class="o">=</span><span class="s2">"width"</span><span class="o">/&gt;&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">z</span><span class="o">-</span><span class="nx">num</span><span class="o">=</span><span class="s2">"1"</span><span class="c1">//&gt;</span><span class="w"></span>
</code></pre></div>
<p class="continue">we could.
It’s unlikely anyone would use the result—typing all of that
is so much clumsier than typing <code>width+1</code> that people wouldn’t use it
unless they had no other choice—but the basic design is there.</p>
<p>We didn’t invent any of this from scratch,
any more than we invented the simple interpreter in <a class="x-ref" href="#interpreter">Chapter 3</a>.
Instead,
we did what you are doing now:
we read what other programmers had written
and tried to make sense of the key ideas.</p>
<p>The problem is that “making sense” depends on who we are.
When we use a low-level language,
we incur the <span class="ix-entry" ix-key="cognitive load" markdown="1"><a class="gl-ref" href="../glossary/#cognitive_load" markdown="1">cognitive load</a></span>
of assembling micro-steps into something more meaningful.
When we use a high-level language,
on the other hand,
we incur a similar load translating functions of functions of functions
into actual operations on actual data.</p>
<p>More experienced programmers are more capable at both ends of the curve,
but that’s not the only thing that changes.
If a novice’s comprehension curve looks like the lower one in <a class="fig-ref" href="../templating/#templating-comprehension">Figure 9.4</a>,
then an expert’s looks like the upper one.
Experts don’t just understand more at all levels of abstraction;
their <em>preferred</em> level has also shifted
so they find \(\sqrt{x^2 + y^2}\) easier to read
than the medieval expression
“the side of the square whose area is the sum of the areas of the two squares
whose sides are given by the first part and the second part”.</p>
<figure id="templating-comprehension">
<img alt="Comprehension curves" src="./templating/templating_comprehension.svg"/>
<figcaption markdown="1">Figure 9.4: Novice and expert comprehension curves.</figcaption>
</figure>
<p>This curve means that for any given task,
the code that is quickest for a novice to comprehend
will almost certainly be different from the code that
an expert can understand most quickly.
In an ideal world our tools would automatically re-represent programs at different levels
just as we could change the colors used for syntax highlighting.
But today’s tools don’t do that,
and any IDE smart enough to translate between comprehension levels automatically
would also be smart enough to write the code without our help.</p>
<h2 id="templating-summary">Section 13.4: Summary</h2>
<figure id="templating-concept-map">
<img alt="Concept map for HTML templating" src="./templating/templating_concept_map.svg"/>
<figcaption markdown="1">Figure 9.5: HTML templating concept map.</figcaption>
</figure>
<h2 id="templating-exercises">Section 9.8: Exercises</h2>
<h3 class="exercise">Tracing execution</h3>
<p>Add a directive <code>&lt;span z-trace="variable"/&gt;</code>
that prints the current value of a variable for debugging.</p>
<h3 class="exercise">Unit tests</h3>
<p>Write unit tests for template expansion using <a href="https://docs.pytest.org/">pytest</a>.</p>
<h3 class="exercise">Sub-keys</h3>
<p>Modify the template expander so that a variable name like <code>person.name</code>
looks up the <code>"name"</code> value in a dictionary called <code>"person"</code>
in the current environment.</p>
<h3 class="exercise">Literal text</h3>
<p>Add a directive <code>&lt;div z-literal="true"&gt;…&lt;/div&gt;</code> that copies the enclosed text as-is
without interpreting or expanding any contained directives.
(A directive like this would be needed when writing documentation for the template expander.)</p>
<h3 class="exercise">Including other files</h3>
<ol>
<li>
<p>Add a directive <code>&lt;div z-include="filename.html"/&gt;</code> that includes another file
    in the file being processed.</p>
</li>
<li>
<p>Should included files be processed and the result copied into the including file,
    or should the text be copied in and then processed?
    What difference does it make to the way variables are evaluated?</p>
</li>
</ol>
<h3 class="exercise">HTML snippets</h3>
<p>Add a directive <code>&lt;div z-snippet="variable"&gt;…&lt;/div&gt;</code> that saves some text in a variable
so that it can be displayed later.
For example:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">z-snippet</span><span class="o">=</span><span class="s">"prefix"</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Important:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">"item:names"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"prefix"</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"item"</span><span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">would printed the word “Important:” in bold before each item in the list.</p>
<h3 class="exercise">YAML headers</h3>
<p>Modify the template expander to handle variables defined in a YAML header in the page being processed.
For example, if the page is:</p>
<div class="highlight"><pre><span></span><code>---
name: "Dorothy Johnson Vaughan"
---
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"name"</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">will create a paragraph containing the given name.</p>
<h3 class="exercise">Expanding all files</h3>
<p>Write a program <code>expand_all.py</code> that takes two directory names as command-line arguments
and builds a website in the second directory by expanding all of the HTML files found in the first
or in sub-directories of the first.</p>
<h3 class="exercise">Counting loops</h3>
<p>Add a directive <code>&lt;div z-index="indexName" z-limit="limitName"&gt;…&lt;/div&gt;</code>
that loops from zero to the value in the variable <code>limitName</code>,
putting the current iteration index in <code>indexName</code>.</p>
<h3 class="exercise">Boolean expression</h3>
<p>Design and implement a way to express the Boolean operators <code>and</code> and <code>or</code>.</p>
</section>
<section class="new-chapter"><h1 id="layout">Chapter: Chapter 10: Page Layout</h1>

<ul class="syllabus">
<li markdown="1">A layout engine determines where to place text and other page elements based on their size and organization.</li>
<li markdown="1">Page elements are organized as a tree of basic blocks, rows, and columns.</li>
<li markdown="1">The layout engine calculates the position of each block based on its size and the position of its parent.</li>
<li markdown="1">Drawing blocks on top of each other from top to bottom is an easy way to render them.</li>
<li markdown="1">Use multiple inheritance and mixin classes to inject methods into classes without modifying their parent class.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a>, <a class="gl-ref" href="../glossary/#confirmation_bias" markdown="1">confirmation bias</a>, <a class="gl-ref" href="../glossary/#design_by_contract" markdown="1">design by contract</a>, <a class="gl-ref" href="../glossary/#easy_mode" markdown="1">easy mode</a>, <a class="gl-ref" href="../glossary/#intrinsic_complexity" markdown="1">intrinsic complexity</a>, <a class="gl-ref" href="../glossary/#layout_engine" markdown="1">layout engine</a>, <a class="gl-ref" href="../glossary/#liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a>, <a class="gl-ref" href="../glossary/#mixin" markdown="1">mixin</a>, <a class="gl-ref" href="../glossary/#multiple_inheritance" markdown="1">multiple inheritance</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>, <a class="gl-ref" href="../glossary/#z_buffering" markdown="1">z-buffering</a>
</p>
<div class="page-toc"></div>
<p>You might be reading this as HTML in your browser,
as an e-book (which is basically the same thing),
or on the printed page.
In all three cases
a <span class="ix-entry" ix-key="layout engine" markdown="1"><a class="gl-ref" href="../glossary/#layout_engine" markdown="1">layout engine</a></span> took some text and some layout instructions
and decided where to put each character and image.
To explore how they work,
we will build a small layout engine
based on <span class="ix-entry" ix-key="Brubeck, Matt" markdown="1"><a href="https://limpet.net/mbrubeck/">Matt Brubeck’s</a></span> <a href="https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html">tutorial</a>
and on <a href="https://pavpanchekha.com/">Pavel Panchekha</a> and <a href="https://twitter.com/chrishtr">Chris Harrelson</a>‘s
<a href="https://browser.engineering/"><em>Web Browser Engineering</em></a>.
Since our focus is layout rather than parsing,
we will create objects in memory that represent <span class="ix-entry" ix-key="DOM" markdown="1">DOM</span> nodes
to test our ideas.</p>
<div class="callout">
<h3>Upside down</h3>
<p>The <span class="ix-entry" ix-key="coordinate system" markdown="1">coordinate systems</span> for screens
puts (0, 0) in the upper left corner instead of the lower left.
X increases to the right as usual,
but Y increases as we go down, rather than up
(<a class="fig-ref" href="../layout/#layout-coordinate-system">Figure 10.1</a>).
This convention is a holdover from the days of teletype terminals
that printed lines on rolls of paper;
as <span class="ix-entry" ix-key="Hoye, Mike" markdown="1"><a href="http://exple.tive.org/blarg/">Mike Hoye</a></span> has <a href="http://exple.tive.org/blarg/2020/11/26/punching-holes/">observed</a>,
the past is all around us.</p>
</div>
<figure id="layout-coordinate-system">
<img alt="Coordinate system" src="./layout/layout_coordinate_system.svg"/>
<figcaption markdown="1">Figure 10.1: Coordinate system with (0, 0) in the upper left corner.</figcaption>
</figure>
<h2 id="layout-size">Section 10.2: Sizing</h2>
<p>Let’s start on <a class="gl-ref" href="../glossary/#easy_mode" markdown="1">easy mode</a>
without margins, padding, line-wrapping, or other complications.
Everything we can put on the screen is represented as a rectangular cell,
and every cell is either a row, a column, or a block.
A block has a fixed width and height:</p>
<div class="code-sample lang-py" title="easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Block</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
</code></pre></div>
</div>
<p>A row arranges one or more cells horizontally;
its width is the sum of the widths of its children,
while its height is the height of its tallest child
(<a class="fig-ref" href="../layout/#layout-sizing">Figure 10.2</a>):</p>
<div class="code-sample lang-py" title="easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Row</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="layout-sizing">
<img alt="Calculating sizes of fixed blocks" src="./layout/layout_sizing.svg"/>
<figcaption markdown="1">Figure 10.2: Calculating sizes of blocks with fixed width and height.</figcaption>
</figure>
<p>Finally,
a column arranges one or more cells vertically:
its width is the width of its widest child
and its height is the sum of the heights of its children.
(Here and elsewhere we use the abbreviation <code>col</code> when referring to columns.)</p>
<div class="code-sample lang-py" title="easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Col</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
</code></pre></div>
</div>
<p>Rows and columns nest inside one another:
a row cannot span two or more columns,
and a column cannot cross the boundary between two rows.
We can therefore represent our document as a tree
and calculate the width and height of each cell every time we need it.
This is simple but inefficient:
we could calculate both width and height at the same time
and <span class="ix-entry" ix-key="cache!calculated values" markdown="1"><a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a></span> those values to avoid recalculation,
but we called this “easy mode” for a reason.</p>
<p>As simple as it is,
this code could still contain errors (and did during development),
so we write some tests to check that it works as desired
before trying to build anything more complicated:</p>
<div class="code-sample lang-py" title="test_easy_mode.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">easy_mode</span> <span class="kn">import</span> <span class="n">Block</span><span class="p">,</span> <span class="n">Col</span><span class="p">,</span> <span class="n">Row</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_single_unit_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_large_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_row_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_column_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span>

<span class="k">def</span> <span class="nf">test_lays_out_a_grid_of_rows_of_columns</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span>
        <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">==</span> <span class="mi">14</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">==</span> <span class="mi">22</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_easy_mode.out">
<div class="highlight"><pre><span></span><code>========================= test session starts ==========================
platform darwin -- Python 3.10.6, pytest-7.1.2, pluggy-1.0.0
rootdir: /u/sdxpy/layout
plugins: pyfakefs-4.6.3
collected 5 items

test_easy_mode.py .....                                          [100%]

========================== 5 passed in 0.02s ===========================
</code></pre></div>
</div>
<h2 id="layout-position">Section 10.3: Positioning</h2>
<p>Once we know how big cells are we can figure out where to put them.
Suppose we start with the upper left corner of the browser:
upper because we lay out the page top-to-bottom
and left because we are doing left-to-right layout.
If the cell is a block, we place it there.
If the cell is a row, on the other hand,
we get its height
and then calculate its lower edge as y1 = y0 + height.
We then place the first child’s lower-left corner at (x0, y1),
the second child’s at (x0 + width0, y1), and so on
(<a class="fig-ref" href="../layout/#layout-layout">Figure 10.3</a>).
Similarly,
if the cell is a column
we place the first child at (x0, y0),
the next at (x0, y0 + height0),
and so on.</p>
<figure id="layout-layout">
<img alt="Laying out rows and columns" src="./layout/layout_layout.svg"/>
<figcaption markdown="1">Figure 10.3: Laying out rows and columns of fixed-size blocks.</figcaption>
</figure>
<p>To save ourselves some work we will derive the classes that know how to do layout
from the classes we wrote before.
Our blocks are:</p>
<div class="code-sample lang-py" title="placed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PlacedBlock</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">while our columns are:</p>
<div class="code-sample lang-py" title="placed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PlacedCol</span><span class="p">(</span><span class="n">Col</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="n">y_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y_current</span><span class="p">)</span>
            <span class="n">y_current</span> <span class="o">+=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">"col"</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">and our rows are:</p>
<div class="code-sample lang-py" title="placed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PlacedRow</span><span class="p">(</span><span class="n">Row</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">x_current</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child_y</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
            <span class="n">child</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x_current</span><span class="p">,</span> <span class="n">child_y</span><span class="p">)</span>
            <span class="n">x_current</span> <span class="o">+=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">"row"</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
</code></pre></div>
</div>
<p>Once again,
we write and run some tests to check that everything is doing what it’s supposed to:</p>
<div class="code-sample lang-py" title="test_placed.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedBlock</span> <span class="k">as</span> <span class="n">Block</span>
<span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedCol</span> <span class="k">as</span> <span class="n">Col</span>
<span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedRow</span> <span class="k">as</span> <span class="n">Row</span>

<span class="k">def</span> <span class="nf">test_places_a_single_unit_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_places_a_large_block</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_places_a_row_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">"row"</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">test_places_a_column_of_two_blocks</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">"col"</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_placed.out">
<div class="highlight"><pre><span></span><code>========================= test session starts ==========================
platform darwin -- Python 3.10.6, pytest-7.1.2, pluggy-1.0.0
rootdir: /u/sdxpy/layout
plugins: pyfakefs-4.6.3
collected 5 items

test_placed.py .....                                             [100%]

========================== 5 passed in 0.02s ===========================
</code></pre></div>
</div>
<h2 id="layout-render">Section 10.4: Rendering</h2>
<p>We drew blocks on graph paper
to figure out the expected answers for the tests shown above.
We can do something similar in software by creating a “screen” of space characters
and then having each block draw itself in the right place.
If we do this starting at the root of the tree,
child blocks will overwrite the markings made by their parents,
which will automatically produce the right appearance
(<a class="fig-ref" href="../layout/#layout-draw-over">Figure 10.4</a>).
(A more sophisticated version of this called <a class="gl-ref" href="../glossary/#z_buffering" markdown="1">z-buffering</a>
keeps track of the visual depth of each pixel
in order to draw things in three dimensions.)</p>
<figure id="layout-draw-over">
<img alt="Children drawing over their parents" src="./layout/layout_draw_over.svg"/>
<figcaption markdown="1">Figure 10.4: Render blocks by drawing child nodes on top of parent nodes.</figcaption>
</figure>
<p>Our pretended screen is just an array of arrays of characters:</p>
<div class="code-sample lang-py" title="render.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_screen</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">" "</span><span class="p">]</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">screen</span>
</code></pre></div>
</div>
<p class="continue">We will use successive lower-case characters to show each block,
i.e.,
the root block will draw itself using ‘a’,
while its children will be ‘b’, ‘c’, and so on.</p>
<div class="code-sample lang-py" title="render.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="n">next_fill</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">"children"</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fill</span>

<span class="k">def</span> <span class="nf">next_fill</span><span class="p">(</span><span class="n">fill</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"a"</span> <span class="k">if</span> <span class="n">fill</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To teach each kind of cell how to render itself,
we have to derive a new class from each of the ones we have
and give the new class a <code>render</code> method with the same
<span class="ix-entry" ix-key="signature!of function;function signature" markdown="1"><a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a></span>.
Since Python supports <span class="ix-entry" ix-key="multiple inheritance" markdown="1"><a class="gl-ref" href="../glossary/#multiple_inheritance" markdown="1">multiple inheritance</a></span>,
we can do this with a <span class="ix-entry" ix-key="mixin class" markdown="1"><a class="gl-ref" href="../glossary/#mixin" markdown="1">mixin</a></span> class
(<a class="fig-ref" href="../layout/#layout-mixin">Figure 10.5</a>):</p>
<div class="code-sample lang-py" title="rendered.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">placed</span> <span class="kn">import</span> <span class="n">PlacedBlock</span><span class="p">,</span> <span class="n">PlacedCol</span><span class="p">,</span> <span class="n">PlacedRow</span>

<span class="k">class</span> <span class="nc">Renderable</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">fill</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()):</span>
                <span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">iy</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>

<span class="k">class</span> <span class="nc">RenderedBlock</span><span class="p">(</span><span class="n">PlacedBlock</span><span class="p">,</span> <span class="n">Renderable</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RenderedCol</span><span class="p">(</span><span class="n">PlacedCol</span><span class="p">,</span> <span class="n">Renderable</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RenderedRow</span><span class="p">(</span><span class="n">PlacedRow</span><span class="p">,</span> <span class="n">Renderable</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</div>
<figure id="layout-mixin">
<img alt="Adding methods with a mixin class" src="./layout/layout_mixin.svg"/>
<figcaption markdown="1">Figure 10.5: Using multiple inheritance and a mixin class to add methods.</figcaption>
</figure>
<div class="callout">
<h3>(Not) The Right Way to Do It</h3>
<p>If we were building a real layout engine,
a cleaner solution would be to go back and create a class called <code>Cell</code> with this <code>render</code> method,
then derive our <code>Block</code>, <code>Row</code>, and <code>Col</code> classes from that.
In general,
if two or more classes need to be able to do something,
we should add a method to do that to their lowest common ancestor.</p>
</div>
<p>Our simpler tests are a little easier to read using rendering,
though we still had to draw things on paper to figure out our complex ones:</p>
<div class="code-sample lang-py" title="test_rendered.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_renders_a_grid_of_rows_of_columns</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Col</span><span class="p">(</span>
        <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">Row</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Col</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="n">fixture</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">render</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">"bddd"</span><span class="p">,</span>
            <span class="s2">"bddd"</span><span class="p">,</span>
            <span class="s2">"cddd"</span><span class="p">,</span>
            <span class="s2">"cddd"</span><span class="p">,</span>
            <span class="s2">"ehhh"</span><span class="p">,</span>
            <span class="s2">"ehhh"</span><span class="p">,</span>
            <span class="s2">"ehhh"</span><span class="p">,</span>
            <span class="s2">"ehhh"</span><span class="p">,</span>
            <span class="s2">"eiig"</span><span class="p">,</span>
            <span class="s2">"fiig"</span><span class="p">,</span>
            <span class="s2">"fiig"</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The fact that our tests are difficult to understand
is a sign that we should do more testing
It would be very easy for us to get a wrong result
and convince ourselves that it was actually correct;
<span class="ix-entry" ix-key="confirmation bias" markdown="1"><a class="gl-ref" href="../glossary/#confirmation_bias" markdown="1">confirmation bias</a></span> of this kind
is very common in software development.</p>
<h2 id="layout-fit">Section 10.5: Wrapping</h2>
<p>One of the biggest differences between a browser and a printed page
is that the text in the browser wraps automatically as the window is resized.
(The other, these days, is that the printed page doesn’t spy on us,
though someone is undoubtedly working on that.)</p>
<p>To add wrapping to our layout engine,
suppose we fix the width of a row.
If the total width of the children is greater than the row’s width,
the layout engine needs to wrap the children around.
This assumes that columns can be made as tall as they need to be,
i.e.,
that we can grow vertically to make up for limited space horizontally.
It also assumes that none of a row’s children is wider than the width of the row
so that each can fit in a row of its own if necessary.
We will look at what happens when this isn’t true in the exercises.</p>
<p>Our layout engine manages wrapping by transforming the tree.
The height and width of blocks are fixed,
so they become themselves.
Columns become themselves as well,
but since they have children that might need to wrap,
the class representing columns needs a new method:</p>
<div class="code-sample lang-py" title="wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WrappedBlock</span><span class="p">(</span><span class="n">PlacedBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">WrappedCol</span><span class="p">(</span><span class="n">PlacedCol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PlacedCol</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>  <span class="c1"># FIXME explain generator</span>
</code></pre></div>
</div>
<p>Rows do all the hard work.
Each original row is replaced with a new row that contains a single column with one or more rows,
each of which is one “line” of wrapped cells
(<a class="fig-ref" href="../layout/#layout-wrap">Figure 10.6</a>).
This replacement is unnecessary when everything will fit on a single row,
but it’s easiest to write the code that does it every time;
we will look at making this more efficient in the exercises.</p>
<figure id="layout-wrap">
<img alt="Wrapping rows" src="./layout/layout_wrap.svg"/>
<figcaption markdown="1">Figure 10.6: Wrapping rows by introducing a new row and column.</figcaption>
</figure>
<p>Our new wrappable row’s constructor takes a fixed width followed by the children
and returns that fixed width when asked for its size:</p>
<div class="code-sample lang-py" title="wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WrappedRow</span><span class="p">(</span><span class="n">PlacedRow</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"Need non-negative width"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>

    <span class="k">def</span> <span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
</code></pre></div>
</div>
<p class="continue">Wrapping puts the row’s children into buckets,
then converts the buckets to a row of a column of rows:</p>
<div class="code-sample lang-py" title="wrapped.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">child_width</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">current_x</span> <span class="o">+</span> <span class="n">child_width</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                <span class="n">current_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">current_x</span> <span class="o">+=</span> <span class="n">child_width</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_row</span><span class="p">)</span>
                <span class="n">current_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="p">]</span>
                <span class="n">current_x</span> <span class="o">=</span> <span class="n">child_width</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_row</span><span class="p">)</span>

        <span class="n">new_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">PlacedRow</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="n">PlacedCol</span><span class="p">(</span><span class="o">*</span><span class="n">new_rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PlacedRow</span><span class="p">(</span><span class="n">new_col</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Once again we bring forward all the previous tests
and write some new ones to test the functionality we’ve added:</p>
<div class="code-sample lang-py" title="test_wrapped.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_wrap_a_row_of_two_blocks_that_do_not_fit_on_one_row</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Block</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">fixture</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
    <span class="n">wrapped</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">"row"</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">"col"</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">"row"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">"row"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="s2">"block"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
        <span class="p">],</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_wrapped.out">
<div class="highlight"><pre><span></span><code>========================= test session starts ==========================
platform darwin -- Python 3.10.6, pytest-7.1.2, pluggy-1.0.0
rootdir: /u/sdxpy/layout
plugins: pyfakefs-4.6.3
collected 7 items

test_wrapped.py .......                                          [100%]

========================== 7 passed in 0.02s ===========================
</code></pre></div>
</div>
<p>Note that we could have had columns handle resizing rather than rows,
but we (probably) don’t need to make both resizeable.
This is an example of <a class="gl-ref" href="../glossary/#intrinsic_complexity" markdown="1">intrinsic complexity</a>:
the problem really is this hard,
so something, somewhere, has to deal with it.</p>
<div class="callout">
<h3>The Liskov Substitution Principle</h3>
<p>We are able to re-use tests as our code evolved
because of the <span class="ix-entry" ix-key="Liskov Substitution Principle;software design!Liskov Substitution Principle" markdown="1"><a class="gl-ref" href="../glossary/#liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a></span>,
which states that
it should be possible to replace objects in a program
with objects of derived classes
without breaking anything.
In order to satisfy this principle,
new code must handle the same set of inputs as the old code,
though it may be able to process more inputs as well.
Conversely,
its output must be a subset of what the old code produced
so that whatever is downstream from it won’t be surprised.
Thinking in these terms leads to a methodology called
<span class="ix-entry" ix-key="design by contract;software design!design by contract" markdown="1"><a class="gl-ref" href="../glossary/#design_by_contract" markdown="1">design by contract</a></span>.</p>
</div>
<h2 id="layout-summary">Section 10.6: Summary</h2>
<figure id="layout-concept-map">
<img alt="Concept map for page layout" src="./layout/layout_concept_map.svg"/>
<figcaption markdown="1">Figure 10.7: Page layout concept map.</figcaption>
</figure>
<h2 id="layout-exercises">Section 10.7: Exercises</h2>
<h3 class="exercise">Refactoring the node classes</h3>
<p>Refactor the classes used to represent blocks, rows, and columns so that:</p>
<ol>
<li>
<p>They all derive from a common parent.</p>
</li>
<li>
<p>All common behavior is defined in that parent (if only with placeholder methods).</p>
</li>
</ol>
<h3 class="exercise">Recycling nodes</h3>
<p>Modify the wrapping code so that new rows and columns are only created if needed.
For example,
if a row of width 10 contains a text node that is only 4 characters wide,
a new row and column are <em>not</em> inserted.</p>
<h3 class="exercise">Rendering a clear background</h3>
<p>Modify the rendering code so that only the text in block nodes is shown,
i.e.,
so that the empty space in rows and columns is rendered as spaces.</p>
<h3 class="exercise">Clipping text</h3>
<ol>
<li>
<p>Modify the wrapping and rendering so that
    if a block of text is too wide for the available space
    the extra characters are clipped.
    For example,
    if a column of width 5 contains a line “unfittable”,
    only “unfit” appears.</p>
</li>
<li>
<p>Extend your solution to break lines on spaces as needed
    in order to avoid clipping.</p>
</li>
</ol>
<h3 class="exercise">Bidirectional rendering</h3>
<p>Modify the existing software to do either left-to-right or right-to-left rendering
upon request.</p>
<h3 class="exercise">Equal sizing</h3>
<p>Modify the existing code to support elastic columns,
i.e.,
so that all of the columns in a row are automatically sized to have the same width.
If the number of columns does not divide evenly into the width of the row,
allocate the extra space as equally as possible from left to right.</p>
<h3 class="exercise">Drawing borders</h3>
<ol>
<li>
<p>Modify the existing code so that elements are drawn with borders like this:</p>
<div class="highlight"><pre><span></span><code>+----+
|text|
+----+
</code></pre></div>
</li>
</ol>
<h3 class="exercise">Padding elements</h3>
<p>Modify the existing code so that:</p>
<ol>
<li>
<p>Authors can define a <code>padding</code> attribute for row and column elements.</p>
</li>
<li>
<p>When the node is rendered, that many blank spaces are added on all four sides of the contents.</p>
</li>
</ol>
<p class="continue">For example, string <code>"text"</code> with a padding of 1 would render as:</p>
<div class="highlight"><pre><span></span><code>+------+
|      |
| text |
|      |
+------+
</code></pre></div>
<p class="continue">where the lines show the outer border of the rendering.</p>
<h3 class="exercise">Properties</h3>
<p>Look at the documentation for Python’s <a href="https://docs.python.org/3/library/functions.html#property"><code>@property</code></a> decorator
and modify the block classes to replace the <code>get_width</code> and <code>get_height</code> methods
with properties called <code>width</code> and <code>height</code>.</p>
<h3 class="exercise">Tables</h3>
<p>Add another node type <code>Table</code> such that:</p>
<ol>
<li>
<p>All the children of a table must be rows.</p>
</li>
<li>
<p>Every row must contain exactly the same number of columns.</p>
</li>
<li>
<p>When the table is rendered, every column has the same width in every row.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="server">Chapter: Chapter 11: A Web Server</h1>

<ul class="syllabus">
<li markdown="1">Every computer on a network has a unique IP address.</li>
<li markdown="1">The Domain Name System (DNS) translates human-readable names into IP addresses.</li>
<li markdown="1">The programs on each computer send and receive messages through numbered sockets.</li>
<li markdown="1">The program that receives a message must interpret the bytes in the message.</li>
<li markdown="1">The HyperText Transfer Protocol (HTTP) specifies one way to interact via messages over sockets.</li>
<li markdown="1">A minimal HTTP request has a method, a URL, and a protocol version.</li>
<li markdown="1">A complete HTTP request may also have headers and a body.</li>
<li markdown="1">An HTTP response has a status code, a status phrase, and optionally some headers and a body.</li>
<li markdown="1">HTTP is a stateless protocol: the application is responsible for remembering things between requests.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#http_body" markdown="1">body (of HTTP request or response)</a>, <a class="gl-ref" href="../glossary/#client" markdown="1">client</a>, <a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System</a>, <a class="gl-ref" href="../glossary/#http_header" markdown="1">header (of HTTP request or response)</a>, <a class="gl-ref" href="../glossary/#http_method" markdown="1">HTTP method</a>, <a class="gl-ref" href="../glossary/#http_protocol_version" markdown="1">HTTP protocol version</a>, <a class="gl-ref" href="../glossary/#http_request" markdown="1">HTTP request</a>, <a class="gl-ref" href="../glossary/#http_response" markdown="1">HTTP response</a>, <a class="gl-ref" href="../glossary/#http_status_code" markdown="1">HTTP status code</a>, <a class="gl-ref" href="../glossary/#http" markdown="1">HypterText Transfer Protocol</a>, <a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol</a>, <a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a>, <a class="gl-ref" href="../glossary/#path_resolution" markdown="1">path resolution</a>, <a class="gl-ref" href="../glossary/#port" markdown="1">port</a>, <a class="gl-ref" href="../glossary/#query_parameter" markdown="1">query parameter</a>, <a class="gl-ref" href="../glossary/#server" markdown="1">server</a>, <a class="gl-ref" href="../glossary/#socket" markdown="1">socket</a>, <a class="gl-ref" href="../glossary/#test_fidelity" markdown="1">test fidelity</a>, <a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol</a>, <a class="gl-ref" href="../glossary/#url" markdown="1">Universal Resource Locator</a>, <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a>
</p>
<div class="page-toc"></div>
<p>The Internet is simpler than most people realize
(as well as being more complex than anyone could possibly comprehend).
Most systems still follow the rules they did thirty years ago;
in particular,
most web servers still handle the same kinds of messages in the same way.</p>
<h2 id="server-tcpip">Section 11.1: Using TCP/IP</h2>
<p>Pretty much every program on the web
runs on a family of communication standards called
<span class="ix-entry" ix-key="Internet Protocol (IP);IP (Internet Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol (IP)</a></span>.
The one that concerns us is the
<span class="ix-entry" ix-key="Transmission Control Protocol (TCP/IP);TCP/IP (Transmission Control Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol (TCP/IP)</a></span>,
which makes communication between computers look like reading and writing files.</p>
<p>Programs using IP communicate through <span class="ix-entry" ix-key="socket" markdown="1"><a class="gl-ref" href="../glossary/#socket" markdown="1">sockets</a></span>
(<a class="fig-ref" href="../server/#server-sockets">Figure 11.1</a>).
Each socket is one end of a point-to-point communication channel,
just like a phone is one end of a phone call.
A socket consists of an <span class="ix-entry" ix-key="IP address" markdown="1"><a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a></span> that identifies a particular machine
and a <span class="ix-entry" ix-key="port" markdown="1"><a class="gl-ref" href="../glossary/#port" markdown="1">port</a></span> on that machine
The IP address consists of four 8-bit numbers,
which are usually written as <code>93.184.216.34</code>;
the <span class="ix-entry" ix-key="Domain Name System (DNS);DNS (Domain Name System)" markdown="1"><a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System (DNS)</a></span>
matches these numbers to symbolic names like <code>example.com</code>
that are easier for human beings to remember.</p>
<p>A port is a number in the range 0-65535
that uniquely identifies the socket on the host machine.
(If an IP address is like a company’s phone number,
then a port number is like an extension.)
Ports 0-1023 are reserved for well-known TCP/IP applications like web servers;
custom applications should use the remaining ports
(and should allow users to decide <em>which</em> port,
since there’s always the chance that two different people will pick 1234 or 6789).</p>
<figure id="server-sockets">
<img alt="Sockets, IP addresses, and DNS" src="./server/server_sockets.svg"/>
<figcaption markdown="1">Figure 11.1: How sockets, IP addresses, and DNS work together.</figcaption>
</figure>
<p>Most web applications consists of <span class="ix-entry" ix-key="client (web application)" markdown="1"><a class="gl-ref" href="../glossary/#client" markdown="1">clients</a></span>
and <span class="ix-entry" ix-key="server (web application)" markdown="1"><a class="gl-ref" href="../glossary/#server" markdown="1">servers</a></span>.
A client program initiates communication by sending a message and waiting for a response;
a server,
on the other hand,
waits for requests and the replies to them.
There are typically many more clients than servers:
for example,
there may be hundreds or thousands of browsers fetching pages from this book’s website right now,
but there is only one server handling those requests.</p>
<p>Here’s a simple socket client:</p>
<div class="code-sample lang-py" title="socket_client.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="n">message</span> <span class="o">=</span> <span class="s2">"message text"</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"client sent </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes"</span><span class="p">)</span>

<span class="n">received</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">)</span>
<span class="n">received_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"client received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">received</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes: '</span><span class="si">{</span><span class="n">received_str</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>From top to bottom, this code:</p>
<ol>
<li>Imports some modules and defines some constants.
    The most interesting of these is <code>SERVER_ADDRESS</code> consisting of a host identifier and a port.
    The empty string <code>""</code> for the host means “the current machine”;
    we could also use the string <code>"localhost"</code>.</li>
<li>We use <code>socket.socket</code> to create a new socket.
    The values <code>AF_INET</code> and <code>SOCK_STREAM</code> specify the protocols we’re using;
    we’ll always use those in our examples,
    so we won’t go into details about them.</li>
<li>We connect to the server…</li>
<li>…send our message as a bunch of bytes with <code>sock.sendall</code>…</li>
<li>…and print a message saying the data’s been sent.</li>
<li>We then read up to a kilobyte from the socket with <code>sock.recv</code>.
    If we were expecting longer messages,
    we’d keep reading from the socket until there was no more data.</li>
<li>Finally, we print another message.</li>
</ol>
<p>The corresponding server is only a little more complicated:</p>
<div class="code-sample lang-py" title="socket_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socketserver</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Handle a single request."""</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"got request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Python’s <code>socketserver</code> library provides two things:
a class called <code>TCPServer</code> that listens for incoming connections
and then manages them for us,
and another class called <code>BaseRequestHandler</code>
that does everything <em>except</em> process the incoming data.
In order to do that,
we derive a class of our own from <code>BaseRequestHandler</code> that provides a <code>handle</code> method.
Every time <code>TCPServer</code> gets a new connection
it creates a new object of our class
and calls that object’s <code>handle</code> method.
This method is the inverse of the code that sends request.
It:</p>
<ol>
<li>Reads up to a kilobyte from <code>self.request</code>
    (which is set up automatically for us in the base class <code>BaseRequestHandler</code>).</li>
<li>Prints a diagnostic message.</li>
<li>Use <code>self.request</code> again to send data back to whoever we received the message from.</li>
</ol>
<p>The easiest way to test this is to open two terminal windows side by side.
<a class="tbl-ref" href="../server/#server-transcript">Table 11.1</a> shows the sequence of commands and their output:</p>
<div class="table"><table id="server-transcript"><caption>Table 11.1: Sequence of operations in socket client/server interaction</caption>
<thead>
<tr>
<th>Server</th>
<th>Client</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$ python socket_server.py</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>$ python socket_client.py</code></td>
</tr>
<tr>
<td></td>
<td><code>client sent 12 bytes</code></td>
</tr>
<tr>
<td><code>got request from 127.0.0.1: 12</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>client received 30 bytes: 'got request from 127.0.0.1: 12</code></td>
</tr>
</tbody>
</table>
</div>
<div class="callout">
<h3>Testing Multiprocess Applications</h3>
<p>Testing single-process command-line applications is straightforward:
we just run a single command (either directly or via <span class="ix-entry" ix-key="Make" markdown="1"><a href="https://www.gnu.org/software/make/">Make</a></span>).
To test a client-server application,
on the other hand,
we have to start the server,
wait for it to be ready,
then run the client,
and then shut down the server.
It’s easy to do this interactively,
but automating it is difficult,
since there’s no way to tell how long to wait before trying to talk to the server,
and no easy way to shut the server down.
We will explore some possible approaches once we have a larger application to test.</p>
</div>
<h2 id="server-http">Section 11.2: HTTP</h2>
<p>The <span class="ix-entry" ix-key="Hypertext Transfer Protocol (HTTP);HTTP (Hypertext Transfer Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#http" markdown="1">Hypertext Transfer Protocol (HTTP)</a></span>
specifies one way programs can exchange data over IP.
HTTP is deliberately simple:
the client sends a <span class="ix-entry" ix-key="HTTP request" markdown="1"><a class="gl-ref" href="../glossary/#http_request" markdown="1">request</a></span>
specifying what it wants over a socket connection,
and the server sends a <span class="ix-entry" ix-key="HTTP response" markdown="1"><a class="gl-ref" href="../glossary/#http_response" markdown="1">response</a></span> containing some data.
That data may be copied from a file on disk,
generated dynamically by a program,
or some mix of the two.</p>
<p>The most important thing about an HTTP request is that it’s just text:
any program that wants to can create one or parse one.
An absolutely minimal HTTP request has just
a <a class="gl-ref" href="../glossary/#http_method" markdown="1">method</a>,
a <a class="gl-ref" href="../glossary/#url" markdown="1">URL</a>,
and a <a class="gl-ref" href="../glossary/#http_protocol_version" markdown="1">protocol version</a>
on a single line separated by spaces:</p>
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
</code></pre></div>
<p>The HTTP method is almost always either <code>GET</code> (to fetch information)
or <code>POST</code> (to submit form data or upload files).
The URL specifies what the client wants:
it is often a path to a file on disk,
such as <code>/index.html</code>,
but (and this is the crucial part)
it’s completely up to the server to decide what to do with it.
The HTTP version is usually “HTTP/1.0” or “HTTP/1.1”;
the differences between the two don’t matter to us.</p>
<p>Most real requests have a few extra lines called
<span class="ix-entry" ix-key="HTTP header;header (HTTP)" markdown="1"><a class="gl-ref" href="../glossary/#http_header" markdown="1">headers</a></span>,
which are key value pairs like the three shown below:</p>
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
Accept: text/html
Accept-Language: en, fr
If-Modified-Since: 16-May-2022
</code></pre></div>
<p>Unlike the keys in hash tables,
keys may appear any number of times in HTTP headers,
so that (for example)
a request can specify that it’s willing to accept several types of content.</p>
<p>Finally,
the <a class="gl-ref" href="../glossary/#http_body" markdown="1">body</a> of the request is any extra data associated with it,
such as form data or uploaded files.
There must be a blank line between the last header and the start of the body
to signal the end of the headers,
and if there is a body,
the request must have a header called <code>Content-Length</code>
that tells the server how many bytes to read.</p>
<p>An HTTP response is formatted like an HTTP request.
Its first line has the protocol,
a <span class="ix-entry" ix-key="HTTP status code;status code (HTTP)" markdown="1"><a class="gl-ref" href="../glossary/#http_status_code" markdown="1">status code</a></span>
like 200 for “OK” or 404 for “Not Found”,
and a status phrase (e.g., the word “OK”).
There are then some headers,
a blank line,
and the body of the response:</p>
<div class="highlight"><pre><span></span><code>HTTP/1.1 200 OK
Date: Thu, 16 June 2022 12:28:53 GMT
Server: minserve/2.2.14 (Linux)
Last-Modified: Wed, 15 Jun 2022 19:15:56 GMT
Content-Type: text/html
Content-Length: 53

&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Hello, World!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
<p>Constructing HTTP requests is tedious,
so most people use libraries to do most of the work.
The most popular such library in Python is called <a href="https://requests.readthedocs.io/">requests</a>.</p>
<div class="code-sample lang-py" title="requests_example.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"http://third-bit.com/sdxpy/test.html"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"status code:"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"content length:"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"content-length"</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="requests_example.out">
<div class="highlight"><pre><span></span><code>status code: 200
content length: 103
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Test Page&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;test page&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p><code>request.get</code> sends an HTTP GET request to a server
and returns an object containing the response (<a class="fig-ref" href="../server/#server-http-lifecycle">Figure 11.2</a>).
That object’s <code>status_code</code> member is the response’s status code;
its <code>content_length</code> member  is the number of bytes in the response data,
and <code>text</code> is the actual data—in this case, an HTML page
that we can analyze or render.</p>
<figure id="server-http-lifecycle">
<img alt="HTTP request/response lifecycle" src="./server/server_http_lifecycle.svg"/>
<figcaption markdown="1">Figure 11.2: Lifecycle of an HTTP request and response.</figcaption>
</figure>
<h2 id="server-static">Section 11.3: Hello, Web</h2>
<p>We’re now ready to write a simple HTTP server that will:</p>
<ol>
<li>wait for someone to connect and send an HTTP request;</li>
<li>parse that request;</li>
<li>figure out what it’s asking for;</li>
<li>send back an HTML page.</li>
</ol>
<p>Steps 1, 2, and 4 are the same from one application to another,
so the Python standard library has a module called <code>http.server</code>
that contains tools to do that for us.
Here’s the entire server:</p>
<div class="code-sample lang-py" title="basic_http_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>

<span class="c1"># Page to send back.</span>
<span class="n">PAGE</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">  &lt;head&gt;&lt;title&gt;Test Page&lt;/title&gt;&lt;/head&gt;</span>
<span class="s2">  &lt;body&gt;&lt;p&gt;test page&lt;/p&gt;&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">"""</span>

<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">PAGE</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/html; charset=utf-8"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">"Content-Length"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Let’s start at the bottom and work our way up.</p>
<ol>
<li>Again, <code>SERVER_ADDRESS</code> specifies the server’s host and port.</li>
<li>The <code>HTTPServer</code> class takes care of parsing requests and sending back responses.
    When we construct it,
    we give it the server address and the name of the class we’ve written
    that handles requests the way we want—in this case, <code>RequestHandler</code>.</li>
<li>Finally, we call the server’s <code>serve_forever</code> method,
    which runs until it crashes or we stop it with Ctrl-C.</li>
</ol>
<p>So what does <code>RequestHandler</code> do?</p>
<ol>
<li>When the server receives a <code>GET</code> request,
    it looks in the request handler for a method called <code>do_GET</code>.
    (If it gets a <code>POST</code>, it looks for <code>do_POST</code> and so on.)</li>
<li><code>do_GET</code> converts the text of the page we want to send back
    from characters to bytes—we’ll talk about this below.</li>
<li>It then sends a response code (200),
    a couple of headers to say what the content type is
    and how many bytes the receiver should expect,
    and a blank line (produced by the <code>end_headers</code> method).</li>
<li>Finally, <code>do_GET</code> sends the content of the response
    by calling <code>self.wfile.write</code>.
    <code>self.wfile</code> is something that looks and acts like a write-only file,
    but is actually sending bytes to the socket connection.</li>
</ol>
<p>If we run this program from the command line,
it doesn’t display anything:</p>
<div class="code-sample lang-sh" title="basic_http_server.sh">
<div class="highlight"><pre><span></span><code>python basic_http_server.py
</code></pre></div>
</div>
<p>If we then go to <code>http://localhost:8080</code> with our browser,
though,
we get this in our browser:</p>
<div class="highlight"><pre><span></span><code>Hello, web!
</code></pre></div>
<p>and this in our shell:</p>
<div class="highlight"><pre><span></span><code>127.0.0.1 - - [16/Sep/2022 06:34:59] "GET / HTTP/1.1" 200 -
127.0.0.1 - - [16/Sep/2022 06:35:00] "GET /favicon.ico HTTP/1.1" 200 -
</code></pre></div>
<p>The first line is straightforward:
since we didn’t ask for a particular file,
our browser has asked for ‘/’ (the root directory of whatever the server is serving).
The second line appears because
our browser automatically sends a second request
for an image file called <code>/favicon.ico</code>,
which it will display as an icon in the address bar if it exists.</p>
<h2 id="server-files">Section 11.4: Serving Files</h2>
<p>Serving the same page for every request isn’t particularly useful,
so let’s rewrite our simple server to return files.
The basic logic looks like this:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">' not found"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown object '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We first turn the path in the URL into a local file path.
(We assume that all paths are <a class="gl-ref" href="../glossary/#path_resolution" markdown="1">resolved</a>
relative to the directory that the server is running in.)
If that path corresponds to a file, we send it back to the client.
If nothing is there,
or if what’s there is not a file,
we send an error message.</p>
<p>It might seem simpler to rewrite <code>do_GET</code> to use <code>if</code>/<code>else</code> instead of <code>try</code>/<code>except</code>,
but the latter has an advantage:
we can handle errors that occur inside methods we’re calling (like <code>handle_file</code>)
in the same place and in the same way as we handle errors that occur here.
This approach is sometimes called “throw low, catch high”,
which means that errors should be flagged in many places
but handled in a few places high up in the code.
The method that handles files is an example of this:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">given_path</span><span class="si">}</span><span class="s2">' cannot be read"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>If there’s an error at any point in the processing cycle
we send a page with an error message
<em>and</em> an error status code:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">ERROR_PAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The error page is just HTML with some placeholders for the path and message:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code><span class="n">ERROR_PAGE</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">  &lt;head&gt;</span>
<span class="s2">    &lt;title&gt;Error accessing </span><span class="si">{path}</span><span class="s2">&lt;/title&gt;</span>
<span class="s2">  &lt;/head&gt;</span>
<span class="s2">  &lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Error accessing </span><span class="si">{path}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">    &lt;p&gt;</span><span class="si">{msg}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">  &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">"""</span>
</code></pre></div>
</div>
<p class="continue">The code that actually sends the response is similar to what we’ve seen before:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">send_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/html; charset=utf-8"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">"Content-Length"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>
</div>
<p>This server works, but only for a very forgiving definition of “works”.
We are careful not to show clients the actual paths to files on the server
in our error messages,
but if someone asked for <code>http://localhost:8080/../../passwords.txt</code>,
this server will happily look two levels up from the directory where it’s running
and try to return that file.
The server machine’s passwords probably aren’t stored there,
but with enough <code>..</code>‘s and some patience,
an attacker could poke around large parts of our filesystem.
We will tackle this security hole in the exercises.</p>
<p>Another problem is that <code>send_content</code> always tells clients that
it is returning an HTML file with the <code>Content-Type</code> header.
It should instead look at the extension on the file’s name
and set the content type appropriately,
e.g.,
return <code>image/png</code> for a PNG-formatted image.</p>
<p>One thing the server is doing right is character encoding.
The <code>send_content</code> method expects <code>content</code> to be a <code>bytes</code> object,
not a string,
because the HTTP protocol requires the content length to be the number of bytes.
The server reads files in binary mode
by using <code>"rb"</code> instead of just <code>"r"</code> when it opens files in <code>handle_file</code>,
converts the internally-generated error page from characters to bytes
using the <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a> encoding,
and specifies <code>charset=utf-8</code> as part of the content type.</p>
<h2 id="server-testing">Section 11.5: Testing</h2>
<p>At this point we really need to figure out how to test the servers we’re building.
The key to our approach is the notion of <span class="ix-entry" ix-key="fidelity (in testing)" markdown="1"><a class="gl-ref" href="../glossary/#test_fidelity" markdown="1">fidelity</a></span>:
how close is what we test to what we use in production?
In an ideal world they are exactly the same,
but in cases like this it makes sense to sacrifice a little fidelity for testability’s sake.</p>
<p>Let’s work backward from a test we want to be able to write.
We would like to create a file,
simulate an HTTP GET request,
and check that the status, headers, and content are correct.
In the code below,
the <code>CombinedHandler</code> class does double duty:
it handles the simulated request,
and also stores the values that the client would receive.</p>
<div class="code-sample lang-py" title="test_testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_existing_path</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">content_str</span> <span class="o">=</span> <span class="s2">"actual"</span>
    <span class="n">content_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content_str</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"/actual.txt"</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">content_str</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">CombinedHandler</span><span class="p">(</span><span class="s2">"/actual.txt"</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"text/html; charset=utf-8"</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Length"</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content_bytes</span><span class="p">))]</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="o">==</span> <span class="n">content_bytes</span>
</code></pre></div>
</div>
<p>The class we are testing is called <code>CombinedHandler</code>
because it is derived from two things:
a class that implements our application’s <code>do_GET</code>
and another class that provides replacements for
the <code>BaseHTTPRequestHandler</code> properties and methods
that our application actually uses.
The latter is just a few lines long,
though it would be larger if our application used
more of <code>BaseHTTPRequestHandler</code>‘s functionality:</p>
<div class="code-sample lang-py" title="mock_handler.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="k">class</span> <span class="nc">MockRequestHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">send_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">end_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p>The application-specific class contains the code we’ve already seen:</p>
<div class="code-sample lang-py" title="testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ApplicationRequestHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">' not found"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown object '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ...etc...</span>
</code></pre></div>
</div>
<p class="continue">However,
<code>ApplicationRequestHandler</code> <em>doesn’t</em> inherit from <code>BaseHTTPRequestHandler</code>.
Instead,
we create a class that combines the two when we need it:</p>
<div class="code-sample lang-py" title="testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">ApplicationRequestHandler</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">and create another class for testing that combines
the application-specific class with <code>MockHandler</code>.
This class is the <code>CombinedClass</code> that our test uses:</p>
<div class="code-sample lang-py" title="test_testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CombinedHandler</span><span class="p">(</span><span class="n">MockRequestHandler</span><span class="p">,</span> <span class="n">ApplicationRequestHandler</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</div>
<p><a class="fig-ref" href="../server/#server-inheritance">Figure 11.3</a> shows the final inheritance hierarchy.
It’s a lot of work to test a GET request for one file,
but we can re-use <code>MockRequestHandler</code> to test
the application-specific code for other servers.
Most libraries don’t provide helper classes like this to support testing,
but programmers appreciate those that do.</p>
<figure id="server-inheritance">
<img alt="Testing class hierarchy" src="./server/server_inheritance.svg"/>
<figcaption markdown="1">Figure 11.3: Class hierarchy for a testable server.</figcaption>
</figure>
<h2 id="server-summary">Section 11.6: Summary</h2>
<figure id="server-concept-map">
<img alt="HTTP server concept map" src="./server/server_concept_map.svg"/>
<figcaption markdown="1">Figure 11.4: HTTP server concept map.</figcaption>
</figure>
<h2 id="server-exercises">Section 11.7: Exercises</h2>
<h3 class="exercise">Reading and writing chunks</h3>
<p>Modify the socket client and socket server so that:</p>
<ol>
<li>
<p>the client reads any amount of data from standard input
    (including none at all)
    and sends it to the server in kilobyte-sized chunks;
    and</p>
</li>
<li>
<p>the server reads any amount of data from the socket
    in chunks of four kilobytes
    and sends a message with a byte count back to the client.</p>
</li>
</ol>
<h3 class="exercise">Parsing HTTP requests</h3>
<p>Write a function that takes a list of lines of text as input
and parses them as if they were an HTTP request.
The result should be a dictionary with the request’s method,
URL,
protocol version,
and headers.</p>
<h3 class="exercise">Query parameters</h3>
<p>A URL can contain <span class="ix-entry" ix-key="query parameter" markdown="1"><a class="gl-ref" href="../glossary/#query_parameter" markdown="1">query parameters</a></span>.
Read the documentation for the <a href="https://docs.python.org/3/library/urllib.parse.html">urlparse</a> module
and then modify the file server example so that
a URL containing a query parameter <code>bytes=N</code>
(for a positive integer N)
returns the first N bytes of the requested file.</p>
<h3 class="exercise">Better path resolution</h3>
<p>Modify the file server so that:</p>
<ol>
<li>
<p>it must be given the absolute path to a directory
    as a command-line argument
    when started; and</p>
</li>
<li>
<p>it only serves files in or below that directory
    (so that paths containing <code>..</code> and other tricks
    can’t be used to retrieve arbitrary files).</p>
</li>
</ol>
<h3 class="exercise">Better content types</h3>
<p>Read the documentation for the <a href="https://docs.python.org/3/library/mimetypes.html">mimetypes</a> module
and then modify the file server to return the correct content type
for files that aren’t HTML (such as images).</p>
<h3 class="exercise">Uploading files</h3>
<p>Modify the file server to handle POST requests.</p>
<ol>
<li>
<p>The URL must specify the name of the file being uploaded.</p>
</li>
<li>
<p>The body of the request must be the bytes of the file.</p>
</li>
<li>
<p>All uploaded files are saved in a single directory,
    i.e.,
    upload paths cannot contain directory components.</p>
</li>
</ol>
<h3 class="exercise">Checking content length</h3>
<p>Modify the file server so that:</p>
<ol>
<li>
<p>if the client sends more content than indicated in the <code>Content-Length</code> header,
    the extra bytes are read but ignored; and</p>
</li>
<li>
<p>if the client sends less content,
    the server doesn’t wait indefinitely for the missing bytes.</p>
</li>
</ol>
<p>What status code should the server return to the client in each case?</p>
<h3 class="exercise">Directory listing</h3>
<ol>
<li>
<p>Modify the file server so that
    if the path portion of the URL identifies a directory,
    the server returns a plain text list of the directory’s contents.</p>
</li>
<li>
<p>Write tests for this using the <a href="https://pytest-pyfakefs.readthedocs.io/">pyfakefs</a> module.</p>
</li>
</ol>
<h3 class="exercise">Dynamic results</h3>
<p>Modify the file server so that if the client requests the “file” <code>/time</code>,
the server returns an HTML page that reports the current time on the server’s machine.</p>
<h3 class="exercise">Templated results</h3>
<p>Modify the file server to:</p>
<ol>
<li>
<p>turn the query parameter’s in the URL into a dictionary;</p>
</li>
<li>
<p>use that dictionary to fill in a template page (<a class="x-ref" href="#templating">Chapter 9</a>); and</p>
</li>
<li>
<p>return the resulting HTML page to the client.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="matching">Chapter: Chapter 12: Matching Patterns</h1>

<ul class="syllabus">
<li markdown="1">Use regular expressions to match patterns in text and extra data.</li>
<li markdown="1">Use inheritance to make matchers composable and extensible.</li>
<li markdown="1">Objects can delegate work to other objects using the Chain of Responsibility pattern.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#base_class" markdown="1">base class</a>, <a class="gl-ref" href="../glossary/#chain_of_responsibility_pattern" markdown="1">Chain of Responsibility pattern</a>, <a class="gl-ref" href="../glossary/#eager_matching" markdown="1">eager matching</a>, <a class="gl-ref" href="../glossary/#greedy_algorithm" markdown="1">greedy algorithm</a>, <a class="gl-ref" href="../glossary/#lazy_matching" markdown="1">lazy matching</a>, <a class="gl-ref" href="../glossary/#polymorphism" markdown="1">polymorphism</a>
</p>
<div class="page-toc"></div>
<p>Sooner or later everyone needs to scrape data out of text files.
Regular expressions are the best tool for the job,
so this chapter explores how they work by building a simple but extensible pattern matcher.
Our approach is inspired by <span class="ix-entry" ix-key="Kernighan, Brian" markdown="1">Brian Kernighan’s</span> entry
in <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Oram2007">Oram2007</a>]</span>.</p>
<h2 id="matching-simple">Section 12.1: Simple Patterns</h2>
<p>Our matcher will initially handle just the five cases shown in
<a class="tbl-ref" href="../matching/#pattern-matching-cases">Table 12.1</a>.
These cases are a small subset of what Python’s <code>re</code> module provides,
but as <span class="ix-entry" ix-key="Kernighan, Brian" markdown="1">Kernighan</span> wrote,
“This is quite a useful class;
in my own experience of using regular expressions on a day-to-day basis,
it easily accounts for 95 percent of all instances.”</p>
<div class="table"><table id="pattern-matching-cases"><caption>Table 12.1: Pattern matching cases</caption>
<thead>
<tr>
<th>Meaning</th>
<th>Character</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any literal character <em>c</em></td>
<td><em>c</em></td>
</tr>
<tr>
<td>Any single character</td>
<td>.</td>
</tr>
<tr>
<td>Beginning of input</td>
<td>^</td>
</tr>
<tr>
<td>End of input</td>
<td>$</td>
</tr>
<tr>
<td>Zero or more of something</td>
<td>*</td>
</tr>
</tbody>
</table>
</div>
<p>Matching is conceptually simple.
If the first element of the pattern matches where we are,
we see if the rest of the pattern matches what’s left;
otherwise,
we see if the the pattern will match further along.</p>
<p>The function <code>match</code> handles the special case of <code>^</code> at the start of a pattern.
It then tries the pattern against each successive substring of the target string
until it finds a match or runs out of characters:</p>
<div class="code-sample lang-py" title="simple_regexp.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="c1"># Empty pattern matches any string.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Start of string.</span>
    <span class="k">if</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"^"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">match_here</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Need 'do-while' to handle zero characters matching.</span>
    <span class="n">i_text</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">match_here</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">i_text</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">i_text</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i_text</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="c1"># Nothing worked.</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
</div>
<p><code>match_here</code> does the matching and recursing:</p>
<div class="code-sample lang-py" title="simple_regexp.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">match_here</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">i_text</span><span class="p">):</span>
    <span class="c1"># No more pattern to match.</span>
    <span class="k">if</span> <span class="n">i_pattern</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># "$" at end of pattern matches end of text.</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">i_pattern</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="n">i_pattern</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"$"</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">i_text</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># "*" following current character means match many.</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="n">i_pattern</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="n">i_pattern</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"*"</span><span class="p">):</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i_text</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">i_text</span><span class="p">]</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i_pattern</span><span class="p">]):</span>
            <span class="n">i_text</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">match_here</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i_pattern</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">i_text</span><span class="p">)</span>

    <span class="c1"># There is no more text to match.</span>
    <span class="k">if</span> <span class="n">i_text</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Match a single character.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="n">i_pattern</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"."</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="n">i_pattern</span><span class="p">]</span> <span class="o">==</span> <span class="n">text</span><span class="p">[</span><span class="n">i_text</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">match_here</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i_pattern</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">i_text</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Nothing worked.</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
</div>
<p>We use a table of test cases and expected results to test it:</p>
<div class="code-sample lang-py" title="test_simple_regexp.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">simple_regexp</span> <span class="kn">import</span> <span class="n">match</span>

<span class="k">def</span> <span class="nf">test_simple_regexp</span><span class="p">():</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"ab"</span><span class="p">,</span> <span class="s2">"ba"</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"^a"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"^b"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"a$"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"a$"</span><span class="p">,</span> <span class="s2">"ba"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"a*"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"a*"</span><span class="p">,</span> <span class="s2">"baac"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"ac"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"abc"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"abbbc"</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"abxc"</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>
</div>
<p>This program seems to work,
but it actually contains an error that we will correct in the exercises.
(Think about what happens if we match the pattern <code>a*ab</code> against the string <code>'aab'</code>.)
It is also hard to extend:
<code>match_here</code> is already very complicated,
and handling parentheses in patterns like <code>a(bc)*d</code> will make it more complicated still.</p>
<h2 id="matching-responsible">Section 12.2: Matching Responsibly</h2>
<p>Instead of packing all our code into one function,
we can implement each kind of match separately.
Doing this makes it easier to add more matchers:
we just define something we can mix in with the matchers we already have.</p>
<p>Rather than matching text immediately,
though,
we will create objects that know how to do matches
so that we can build a complex matcher once and re-use it many times.
This is a common practice in text processing:
if we want to apply a regular expression to each line in a large set of files,
recycling matchers makes programs more efficient.</p>
<p>Each matching object has a method
that takes the target string and the index to start matching at as inputs.
Its output is the index to continue matching at
or <code>None</code> indicating that matching failed
(<a class="fig-ref" href="../matching/#matching-direct">Figure 12.1</a>).</p>
<figure id="matching-direct">
<img alt="Implementing regular expressions with objects" src="./matching/matching_direct.svg"/>
<figcaption markdown="1">Figure 12.1: Using nested objects to match regular expressions.</figcaption>
</figure>
<p>Our matching classes will be:</p>
<ul>
<li><code>Alt</code> (for “alternative”) to match either of two possibilities;</li>
<li><code>Any</code> to match any single character;</li>
<li><code>End</code> to match the end of a string;</li>
<li><code>Lit</code> to match a literal character;</li>
<li><code>Seq</code> to match a sequence of patterns; and</li>
<li><code>Start</code> to match the start of a string.</li>
</ul>
<p>Our first step is to write test cases.
Instead of looping over them ourselves
we will use <code>pytest</code>‘s <code>parametrize</code> decorator:</p>
<div class="code-sample lang-py" title="test_direct.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">direct</span> <span class="kn">import</span> <span class="n">Alt</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">End</span><span class="p">,</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Seq</span><span class="p">,</span> <span class="n">Start</span>

<span class="n">TESTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"ab"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ba"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ab"</span><span class="p">,</span> <span class="s2">"ba"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"ab"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"^a"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Start</span><span class="p">(),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"^b"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Start</span><span class="p">(),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"a$"</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">End</span><span class="p">())],</span>
    <span class="p">[</span><span class="s2">"a$"</span><span class="p">,</span> <span class="s2">"ba"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">End</span><span class="p">())],</span>
    <span class="p">[</span><span class="s2">"a*"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Any</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"a*"</span><span class="p">,</span> <span class="s2">"baac"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Any</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)],</span>
    <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"ac"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Any</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"abc"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Any</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"abbbc"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Any</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ab*c"</span><span class="p">,</span> <span class="s2">"abxc"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Any</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ab|cd"</span><span class="p">,</span> <span class="s2">"xaby"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Alt</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"ab"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"cd"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"ab|cd"</span><span class="p">,</span> <span class="s2">"acdc"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Alt</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"ab"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"cd"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"a(b|c)d"</span><span class="p">,</span> <span class="s2">"xabdy"</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Alt</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">)),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"d"</span><span class="p">))],</span>
    <span class="p">[</span><span class="s2">"a(b|c)d"</span><span class="p">,</span> <span class="s2">"xabady"</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Seq</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span> <span class="n">Alt</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">)),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"d"</span><span class="p">))],</span>
<span class="p">]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">"params"</span><span class="p">,</span> <span class="n">TESTS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_direct</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p class="continue">Notice that we have provided a message with the <code>assert</code> in our test
so that we can tell which tests failed (if any).</p>
<p>Next,
we define a <a class="gl-ref" href="../glossary/#base_class" markdown="1">base class</a> that all matchers will inherit from.
This class contains the <code>match</code> method that users will call
so that we can start matching right away
no matter what kind of matcher we have at the top level of our pattern:</p>
<div class="code-sample lang-py" title="direct.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MatchBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p>We can now define each matching class,
like this one for literal characters:</p>
<div class="code-sample lang-py" title="direct.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Lit</span><span class="p">(</span><span class="n">MatchBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">chars</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">nextIndex</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nextIndex</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">nextIndex</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chars</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">nextIndex</span>
</code></pre></div>
</div>
<p class="continue">Our tests now run, but most of them fail:
“most” because we expect that some patterns <em>won’t</em> match the text provided.
This output tells us how much work we have left to do:
when all of these tests pass,
we’re finished.</p>
<div class="code-sample lang-out" title="test_direct.out">
<div class="highlight"><pre><span></span><code>FAILED test_direct.py::test_direct[params1] - AssertionError: b vs a
FAILED test_direct.py::test_direct[params3] - AssertionError: b vs ab
FAILED test_direct.py::test_direct[params4] - AssertionError: ab vs ab
FAILED test_direct.py::test_direct[params5] - AssertionError: ba vs ab
FAILED test_direct.py::test_direct[params6] - AssertionError: ab vs ba
FAILED test_direct.py::test_direct[params7] - AssertionError: ^a vs ab
FAILED test_direct.py::test_direct[params8] - AssertionError: ^b vs ab
FAILED test_direct.py::test_direct[params9] - AssertionError: a$ vs ab
FAILED test_direct.py::test_direct[params10] - AssertionError: a$ vs ba
FAILED test_direct.py::test_direct[params11] - AssertionError: a* vs
FAILED test_direct.py::test_direct[params12] - AssertionError: a* vs baac
FAILED test_direct.py::test_direct[params13] - AssertionError: ab*c vs ac
FAILED test_direct.py::test_direct[params14] - AssertionError: ab*c vs abc
FAILED test_direct.py::test_direct[params15] - AssertionError: ab*c vs abbbc
FAILED test_direct.py::test_direct[params16] - AssertionError: ab*c vs abxc
FAILED test_direct.py::test_direct[params17] - AssertionError: ab|cd vs xaby
FAILED test_direct.py::test_direct[params18] - AssertionError: ab|cd vs acdc
FAILED test_direct.py::test_direct[params19] - AssertionError: a(b|c)d vs xabdy
FAILED test_direct.py::test_direct[params20] - AssertionError: a(b|c)d vs xabady
</code></pre></div>
</div>
<p>What about repetition?
It can just apply a pattern over and over to consume as many matches as possible—or can it?
Suppose we have the pattern <code>a*ab</code>.
This ought to match the text <code>"ab"</code>, but will it?
<code>*</code> is <span class="ix-entry" ix-key="greedy algorithm;algorithm!greedy" markdown="1"><a class="gl-ref" href="../glossary/#greedy_algorithm" markdown="1">greedy</a></span>:
it matches as much as it can.
(This is also called <span class="ix-entry" ix-key="eager matching;matching!eager" markdown="1"><a class="gl-ref" href="../glossary/#eager_matching" markdown="1">eager matching</a></span>.)
As a result,
<code>a*</code> will match the leading <code>"a"</code>, leaving nothing for the literal <code>a</code> to match
(<a class="fig-ref" href="../matching/#matching-greedy">Figure 12.2</a>).
Our current implementation doesn’t give us a way to try other possible matches when this happens.</p>
<figure id="matching-greedy">
<img alt="Overly-greedy matching fails" src="./matching/matching_greedy.svg"/>
<figcaption markdown="1">Figure 12.2: Why overly greedy matching doesn’t work.</figcaption>
</figure>
<h2 id="matching-alternative">Section 12.3: An Alternative Design</h2>
<p>Let’s re-think our design
and have each matcher take its own arguments and a <code>rest</code> parameter containing the rest of the matchers
(<a class="fig-ref" href="../matching/#matching-rest">Figure 12.3</a>).
(We will provide a default of <code>None</code> in the creation function
so we don’t have to type <code>None</code> over and over again.)
Each matcher will try each of its possibilities and then see if the rest will also match:</p>
<div class="code-sample lang-py" title="re_base.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RegexBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"derived classes must override '_match'"</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="matching-rest">
<img alt="Matching using a chain of responsibility" src="./matching/matching_rest.svg"/>
<figcaption markdown="1">Figure 12.3: Using Chain of Responsibility for matching.</figcaption>
</figure>
<p>This design means we can get rid of <code>Seq</code>,
but it does mean our expressions become deeply nested.
For example, the expression to match <code>ab*c</code> is:</p>
<div class="highlight"><pre><span></span><code><span class="n">Lit</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="n">Any</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="s2">"b"</span><span class="p">),</span> <span class="n">Lit</span><span class="p">(</span><span class="s2">"c"</span><span class="p">)))</span>
</code></pre></div>
<p>Here’s how this strategy works for matching a literal expression:</p>
<div class="code-sample lang-py" title="re_lit.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">re_base</span> <span class="kn">import</span> <span class="n">RegexBase</span>

<span class="k">class</span> <span class="nc">Lit</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">chars</span>

    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="n">next_index</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">next_index</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chars</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">next_index</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">next_index</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <code>_match</code> method checks whether all of the pattern matches the target text
starting at the current location.
If so,
it checks whether the rest of the overall pattern matches what’s left.
Matching the start <code>^</code> and end <code>$</code> anchors is just as straightforward:</p>
<div class="code-sample lang-py" title="re_start.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">re_base</span> <span class="kn">import</span> <span class="n">RegexBase</span>

<span class="k">class</span> <span class="nc">Start</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and:</p>
<div class="code-sample lang-py" title="re_end.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">re_base</span> <span class="kn">import</span> <span class="n">RegexBase</span>

<span class="k">class</span> <span class="nc">End</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Matching either/or is done by trying the first pattern and the rest,
and if that fails,
trying the second pattern and the rest:</p>
<div class="code-sample lang-py" title="re_alt.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">re_base</span> <span class="kn">import</span> <span class="n">RegexBase</span>

<span class="k">class</span> <span class="nc">Alt</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>

    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">):</span>
            <span class="n">after_pat</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">after_pat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">after_pat</span>
                <span class="n">after_rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">after_pat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">after_rest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">after_rest</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p>To match a repetition,
we figure out the maximum number of matches that might be left,
then count down until something succeeds.
(We start with the maximum because matching is supposed to be greedy.)
Each non-empty repetition matches at least one character,
so the number of remaining characters is the maximum number of matches worth trying.</p>
<div class="code-sample lang-py" title="re_any.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">re_base</span> <span class="kn">import</span> <span class="n">RegexBase</span>

<span class="k">class</span> <span class="nc">Any</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="n">max_possible</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_possible</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">after_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_many</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">after_many</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">after_many</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_match_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start</span>
</code></pre></div>
</div>
<p>With these classes in place,
our tests all pass:</p>
<div class="code-sample lang-out" title="test_re.out">
<div class="highlight"><pre><span></span><code>============================= test session starts ==============================
platform darwin -- Python 3.10.6, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/gregwilson/sdxpy/en/src/matching
plugins: pyfakefs-4.6.3
collected 21 items

test_re.py .....................                                         [100%]

============================== 21 passed in 0.02s ==============================
</code></pre></div>
</div>
<p>The most important thing about this design is how extensible it is.
If we want to add other kinds of matching,
all we have to do is add more classes.
That extensibility comes from the lack of centralized decision-making,
which in turn comes from our use of <span class="ix-entry" ix-key="polymorphism" markdown="1"><a class="gl-ref" href="../glossary/#polymorphism" markdown="1">polymorphism</a></span>
and the <span class="ix-entry" ix-key="Chain of Responsibility pattern;design pattern!Chain of Responsibility" markdown="1"><a class="gl-ref" href="../glossary/#chain_of_responsibility_pattern" markdown="1">Chain of Responsibility</a></span> design pattern.
Each component does its part and asks something else to handle the remaining work;
so long as each component takes the same inputs,
we can put them together however we want.</p>
<h2 id="templating-summary">Section 13.4: Summary</h2>
<figure id="matching-concept-map">
<img alt="Concept map for regular expression matching" src="./matching/matching_concept_map.svg"/>
<figcaption markdown="1">Figure 12.4: Regular expression matching concept map.</figcaption>
</figure>
<h2 id="matching-exercises">Section 12.5: Exercises</h2>
<h3 class="exercise">Find and fix the error</h3>
<p>The first regular expression matcher contains an error:
the pattern <code>'a*ab'</code> should match the string <code>'aab'</code> but doesn’t.
Figure out why it fails and fix it.</p>
<h3 class="exercise">One more than length</h3>
<p>The main loop in <code>RegexBase.match</code> has <code>+1</code> inside the <code>range</code> call.
Which test(s) break when this is removed and why?</p>
<h3 class="exercise">Find all</h3>
<p>Modify the regular expression matcher to return <em>all</em> matches rather than just the first one.</p>
<h3 class="exercise">Find one or more</h3>
<p>Extend the regular expression matcher to support <code>+</code>, meaning “one or more”.</p>
<h3 class="exercise">Match sets of characters</h3>
<p>Add a new regular expression matching class that matches any character from a set,
so that <code>Charset('aeiou')</code> matches any lower-case vowel.</p>
<h3 class="exercise">Make repetition more efficient</h3>
<p>Rewrite <code>Any</code> so that it does not repeatedly re-match text.</p>
<h3 class="exercise">Lazy matching</h3>
<p>The regular expressions we have seen so far are <a class="gl-ref" href="../glossary/#eager_matching" markdown="1">eager</a>:
they match as much as they can, as early as they can.
An alternative is <span class="ix-entry" ix-key="lazy algorithm;algorithm!lazy" markdown="1"><a class="gl-ref" href="../glossary/#lazy_matching" markdown="1">lazy matching</a></span>,
in which expressions match as little as they need to.
For example,
given the string <code>"ab"</code>,
an eager match with the expression <code>ab*</code> will match both letters
(because <code>b*</code> matches a ‘b’ if one is available)
but a lazy match will only match the first letter
(because <code>b*</code> can match no letters at all).
Implement lazy matching for the <code>*</code> operator.</p>
<h3 class="exercise">Optional matching</h3>
<p>The <code>?</code> operator means “optional”,
so that <code>a?</code> matches either zero or one occurrences of the letter ‘a’.
Implement this operator.</p>
<h3 class="exercise">Performance</h3>
<p>Our matcher is slower than the one in Python’s <code>re</code> module.</p>
<ol>
<li>
<p>Write some tests to find out how much slower.</p>
</li>
<li>
<p>How does your choice of test cases affect your answer?</p>
</li>
</ol>
<h3 class="exercise">DOM Selectors</h3>
<p>Write a recursive function that finds nodes in a <span class="ix-entry" ix-key="DOM" markdown="1">DOM</span> tree
so that (for example) <code>match(dom, ['div', 'p', 'a'])</code>
finds all of the hyperlinks (with tag <code>a</code>)
in paragraphs (with tag <code>p</code>)
in divs (with tag <code>div</code>).</p>
</section>
<section class="new-chapter"><h1 id="parser">Chapter: Chapter 13: Parsing Text</h1>

<ul class="syllabus">
<li markdown="1">Use existing file formats rather than creating new ones.</li>
<li markdown="1">Parsing in two or more passes is often simpler than parsing in a single pass.</li>
<li markdown="1">Tokenize input text and then analyze the tokens.</li>
<li markdown="1">Every formal language corresponds to an abstract machine and vice versa.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#fsm" markdown="1">finite state machine</a>, <a class="gl-ref" href="../glossary/#greedy_algorithm" markdown="1">greedy algorithm</a>, <a class="gl-ref" href="../glossary/#lazy_matching" markdown="1">lazy matching</a>, <a class="gl-ref" href="../glossary/#literal" markdown="1">literal</a>, <a class="gl-ref" href="../glossary/#parser" markdown="1">parser</a>, <a class="gl-ref" href="../glossary/#precedence" markdown="1">precedence</a>, <a class="gl-ref" href="../glossary/#token" markdown="1">token</a>, <a class="gl-ref" href="../glossary/#turing_machine" markdown="1">Turing Machine</a>, <a class="gl-ref" href="../glossary/#well_formed" markdown="1">well-formed</a>, <a class="gl-ref" href="../glossary/#yaml" markdown="1">Yet Another Markup Language</a>
</p>
<div class="page-toc"></div>
<p>We constructed objects to create regular expressions in <a class="x-ref" href="#matching">Chapter 12</a>.
It takes a lot less typing to write them as strings,
but if we do that we need to a <span class="ix-entry" ix-key="parser" markdown="1"><a class="gl-ref" href="../glossary/#parser" markdown="1">parser</a></span>
to convert those strings to objects.</p>
<div class="table"><table id="parser-grammar"><caption>Table 13.1: Regular expression grammar.</caption>
<thead>
<tr>
<th>Meaning</th>
<th>Character</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any literal character <em>c</em></td>
<td><em>c</em></td>
</tr>
<tr>
<td>Beginning of input</td>
<td>^</td>
</tr>
<tr>
<td>End of input</td>
<td>$</td>
</tr>
<tr>
<td>Zero or more of something</td>
<td>*</td>
</tr>
<tr>
<td>Either/or</td>
<td>|</td>
</tr>
<tr>
<td>Grouping</td>
<td>(…)</td>
</tr>
</tbody>
</table>
</div>
<p><a class="tbl-ref" href="../parser/#parser-grammar">Table 13.1</a> shows the grammar our parser will handle.
When our parser is done
it should be able to parse <code>^(a|b|$)*z$</code> as
“start of text”,
“any number of ‘a’, ‘b’, or ‘$’“,
“a single ‘z’,
and “end of text”.
To keep our discussion focused on parsing
we will create a tree of objects (<a class="fig-ref" href="../parser/#parser-expression-tree">Figure 13.1</a>)
rather than instances of the regular expression classes from <a class="x-ref" href="#matching">Chapter 12</a>;
the exercises will tackle the problem of converting the former to the latter.</p>
<figure id="parser-expression-tree">
<img alt="Expression tree for regular expression" src="./parser/parser_expression_tree.svg"/>
<figcaption markdown="1">Figure 13.1: Representing the result of parsing a regular expression as an tree.</figcaption>
</figure>
<div class="callout">
<h3>Please don’t write parsers</h3>
<p>Languages that are comfortable for people to read and write
are usually difficult for computers to understand
and vice versa,
so we need parsers to translate the former into the latter.
However,
the world doesn’t need more file formats:
if you need a configuration file or lookup table,
please use CSV, JSON, <a class="gl-ref" href="../glossary/#yaml" markdown="1">YAML</a>,
or something else that already has an acronym
rather than inventing something of your own.</p>
</div>
<h2 id="parser-tokenize">Section 13.2: Tokenization</h2>
<p>A <span class="ix-entry" ix-key="token (in parsing)" markdown="1"><a class="gl-ref" href="../glossary/#token" markdown="1">token</a></span> is an atom of text,
such as the digits making up a number or the letters making up a variable name.
Our grammar’s tokens are the special characters <code>*</code>, <code>|</code>, <code>(</code>, <code>)</code>, <code>^</code>, and <code>$</code>;
any sequence of one or more other characters is a single multi-letter token.
This classification guides the design of our parser:</p>
<ol>
<li>
<p>If a character is special, create a token for it.</p>
</li>
<li>
<p>If it is a <span class="ix-entry" ix-key="literal (in parsing)" markdown="1"><a class="gl-ref" href="../glossary/#literal" markdown="1">literal</a></span> then
    combine it with the current literal if there is one
    or start a new literal.</p>
</li>
<li>
<p>Since <code>^</code> and <code>$</code> are either special or regular depending on position,
    we must treat them as separate tokens or as part of a literal
    based on where they appear.</p>
</li>
</ol>
<p>We can translate these rules almost directly into code
to create a list of dictionaries whose keys are <code>"kind"</code> and <code>"loc"</code> (short for location),
with the extra key <code>"value"</code> for literal values:</p>
<div class="code-sample lang-py" title="tokenizer_collapse.py">
<div class="highlight"><pre><span></span><code><span class="n">SIMPLE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"*"</span><span class="p">:</span> <span class="s2">"Any"</span><span class="p">,</span> <span class="s2">"|"</span><span class="p">:</span> <span class="s2">"Alt"</span><span class="p">,</span> <span class="s2">"("</span><span class="p">:</span> <span class="s2">"GroupStart"</span><span class="p">,</span> <span class="s2">")"</span><span class="p">:</span> <span class="s2">"GroupEnd"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">SIMPLE</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="n">SIMPLE</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">"^"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Start"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">"$"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"End"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combine_or_push</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>The helper function <code>combine_or_push</code> does exactly what its name says.
If the thing most recently added to the list of tokens isn’t a literal,
the new character becomes a new token;
otherwise,
it appends the new character to the literal:</p>
<div class="code-sample lang-py" title="tokenizer_collapse.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">combine_or_push</span><span class="p">(</span><span class="n">so_far</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">so_far</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">so_far</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"Lit"</span><span class="p">):</span>
        <span class="n">so_far</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="n">character</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">location</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">so_far</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"value"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">character</span>
</code></pre></div>
</div>
<p>We can try this out with a three-line test program:</p>
<div class="code-sample lang-py" title="tokenizer_collapse_example.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">tokenizer_collapse</span> <span class="kn">import</span> <span class="n">tokenize</span>

<span class="n">test</span> <span class="o">=</span> <span class="s2">"^a^b*"</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">"=&gt;"</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="tokenizer_collapse_example.out">
<div class="highlight"><pre><span></span><code>^a^b* =&gt; [
  {
    "kind": "Start",
    "loc": 0
  },
  {
    "kind": "Lit",
    "value": "a^b",
    "loc": 1
  },
  {
    "kind": "Any",
    "loc": 4
  }
]
</code></pre></div>
</div>
<p>This simple tokenizer is readable, efficient, and wrong.
The problem is that the expression <code>ab*</code> is supposed to mean
“a single <code>a</code> followed by zero or more <code>b</code>”.
If we combine the letters <code>a</code> and <code>b</code> as we read them,
though,
we wind up with “zero or more repetitions of <code>ab</code>”.
In jargon terms,
our parser is <span class="ix-entry" ix-key="greedy algorithm;algorithm!greedy" markdown="1"><a class="gl-ref" href="../glossary/#greedy_algorithm" markdown="1">greedy</a></span>,
but we need it to be <span class="ix-entry" ix-key="lazy algorithm;algorithm!lazy" markdown="1"><a class="gl-ref" href="../glossary/#lazy_matching" markdown="1">lazy</a></span>:</p>
<div class="code-sample lang-py" title="tokenizer_collapse_error.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">tokenizer_collapse</span> <span class="kn">import</span> <span class="n">tokenize</span>

<span class="n">test</span> <span class="o">=</span> <span class="s2">"ab*"</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">"=&gt;"</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="tokenizer_collapse_error.out">
<div class="highlight"><pre><span></span><code>ab* =&gt; [
  {
    "kind": "Lit",
    "value": "ab",
    "loc": 0
  },
  {
    "kind": "Any",
    "loc": 2
  }
]
</code></pre></div>
</div>
<p>The solution is to treat each regular character as its own literal in this stage
and combine them later.
Doing this lets us get rid of the nested <code>if</code> for handling <code>^</code> and <code>$</code> as well:</p>
<div class="code-sample lang-py" title="tokenizer.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">SIMPLE</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="n">SIMPLE</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">"^"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Start"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">"$"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"End"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="n">c</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>Software isn’t done until it’s tested,
so let’s build some tests.
The listing below shows a few of these
along with the output for the full set:</p>
<div class="code-sample lang-py" title="test_tokenizer.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tokenizer</span> <span class="kn">import</span> <span class="n">tokenize</span>

<span class="k">def</span> <span class="nf">test_tokenize_single_character</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">tokenize</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}]</span>

<span class="k">def</span> <span class="nf">test_tokenize_char_sequence</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">tokenize</span><span class="p">(</span><span class="s2">"ab"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">test_tokenize_start_anchor_alone</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">tokenize</span><span class="p">(</span><span class="s2">"^"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Start"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}]</span>

<span class="k">def</span> <span class="nf">test_tokenize_start_anchor_followed_by_characters</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">tokenize</span><span class="p">(</span><span class="s2">"^a"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Start"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">]</span>


<span class="k">def</span> <span class="nf">test_tokenize_complex_expression</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">tokenize</span><span class="p">(</span><span class="s2">"^a*(bcd|e^)*f$gh$"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Start"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Any"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"GroupStart"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"b"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"c"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"d"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Alt"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"e"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"^"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"GroupEnd"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Any"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">11</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"f"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"$"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"g"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"h"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"End"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">16</span><span class="p">},</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_tokenizer.out">
<div class="highlight"><pre><span></span><code>========================= test session starts ==========================
platform darwin -- Python 3.10.4, pytest-7.1.2, pluggy-1.0.0
rootdir: /u/sdxpy/parser
plugins: pyfakefs-4.6.3
collected 18 items

test_tokenizer.py ..................                             [100%]

========================== 18 passed in 0.02s ==========================
</code></pre></div>
</div>
<h2 id="parser-tree">Section 13.3: Assembling the Tree</h2>
<p>We now have a list of tokens,
but we need a tree that represents the nesting introduced by parentheses
and the way that <code>*</code> applies to whatever comes before it.
Let’s trace a few cases:</p>
<ol>
<li>
<p>If the regular expression is <code>a</code>,
    we create a <code>Lit</code> token for the letter <code>"a"</code>.</p>
</li>
<li>
<p>If the regular expression is <code>a*</code>,
    we create a <code>Lit</code> token for the <code>"a"</code> and append it to the output list.
    When we see the <code>*</code>,
    we take that <code>Lit</code> token off the tail of the output list
    and replace it with an <code>Any</code> token that has the <code>Lit</code> token as its child.</p>
</li>
<li>
<p>What about the regular expression <code>(ab)</code>?
    We don’t know how long the group is going to be when we see the opening <code>(</code>,
    so we add the parenthesis to the output as a marker.
    We then add the <code>Lit</code> tokens for the <code>"a"</code> and <code>"b"</code> until we see the <code>)</code>,
    at which point we pull tokens off the end of the output list
    until we get back to the <code>(</code> marker.
    When we find it,
    we put everything we have temporarily collected into a <code>Group</code> token and append it to the output list.
    This algorithm automatically handles patterns like <code>(a*)</code> and <code>(a(b*)c)</code>.</p>
</li>
<li>
<p>What about <code>a|b</code>?
    We append a <code>Lit</code> token for <code>"a"</code>, get the <code>|</code> and—we’re stuck,
    because we don’t yet have the next token we need to finish building the <code>Alt</code>.</p>
</li>
</ol>
<p>One way to solve this problem is to check to see if the thing on the top of the stack is combinable
each time we append a new token.
However,
that still doesn’t handle <code>a|b*</code> properly:
the pattern is supposed to mean “one <code>"a"</code> or any number of <code>"b"</code>”,
but the check-and-combine strategy will turn it into the equivalent of <code>(a|b)*</code>.</p>
<p>A better solution is to leave some partially-completed tokens in the output
and compress them later (<a class="fig-ref" href="../parser/#parser-mechanics">Figure 13.2</a>).
If our input is <code>a|b</code> we can:</p>
<ol>
<li>
<p>Append a <code>Lit</code> token for <code>"a"</code>.</p>
</li>
<li>
<p>When we see <code>|</code>,
    make that <code>Lit</code> token the left child of the <code>Alt</code>
    and append that to the output without filling in the right child.</p>
</li>
<li>
<p>Append the <code>Lit</code> token for <code>"b"</code>.</p>
</li>
<li>
<p>After all tokens have been handled,
    look for partially-completed <code>Alt</code> tokens and make whatever comes after them their right child.</p>
</li>
</ol>
<p class="continue">Again, this automatically handles patterns like <code>(ab)|c*|(de)</code>.</p>
<figure id="parser-mechanics">
<img alt="Mechanics of combining tokens" src="./parser/parser_mechanics.svg"/>
<figcaption markdown="1">Figure 13.2: Mechanics of combining tokens while parsing regular expressions.</figcaption>
</figure>
<p>Let’s turn this idea into code.
The main structure of our parser is:</p>
<div class="code-sample lang-py" title="parser.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tokenizer</span> <span class="kn">import</span> <span class="n">tokenize</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_tokens</span><span class="p">):</span>
        <span class="n">is_last</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">handle</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compress</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We handle tokens case by case
(with a few assertions to check that patterns are <a class="gl-ref" href="../glossary/#well_formed" markdown="1">well formed</a>):</p>
<div class="code-sample lang-py" title="parser.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">is_last</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Lit"</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Start"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"Should not have start token after other tokens"</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"End"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">is_last</span><span class="p">,</span> <span class="s2">"Should not have end token before other tokens"</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"GroupStart"</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"GroupEnd"</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_end</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Any"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'No operand for "*" (</span><span class="si">{</span><span class="n">token</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span><span class="si">}</span><span class="s1">)'</span>
        <span class="n">token</span><span class="p">[</span><span class="s2">"child"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Alt"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'No operand for "*" (</span><span class="si">{</span><span class="n">token</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span><span class="si">}</span><span class="s1">)'</span>
        <span class="n">token</span><span class="p">[</span><span class="s2">"left"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">token</span><span class="p">[</span><span class="s2">"right"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'UNIMPLEMENTED </span><span class="si">{</span><span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
</code></pre></div>
</div>
<p>When we find the <code>)</code> that marks the end of a group,
we take items from the end of the output list
until we find the matching start
and use them to create a group:</p>
<div class="code-sample lang-py" title="parser.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">group_end</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">group</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Group"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"end"</span><span class="p">:</span> <span class="n">token</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">],</span> <span class="s2">"children"</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'Unmatched end parenthesis (</span><span class="si">{</span><span class="n">token</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span><span class="si">}</span><span class="s1">)'</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">child</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"GroupStart"</span><span class="p">:</span>
            <span class="n">group</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="n">group</span><span class="p">[</span><span class="s2">"children"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">group</span>
</code></pre></div>
</div>
<p>Finally,
when we have finished with the input,
we go through the output list one last time to fill in the right side of <code>Alt</code>s:</p>
<div class="code-sample lang-py" title="parser.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">raw</span><span class="p">):</span>
    <span class="n">cooked</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="s2">"kind"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Alt"</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cooked</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'No right operand for alt (</span><span class="si">{</span><span class="n">token</span><span class="p">[</span><span class="s2">"loc"</span><span class="p">]</span><span class="si">}</span><span class="s1">)'</span>
            <span class="n">token</span><span class="p">[</span><span class="s2">"right"</span><span class="p">]</span> <span class="o">=</span> <span class="n">cooked</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cooked</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cooked</span>
</code></pre></div>
</div>
<p>Once again,
it’s not done until we’ve tested it:</p>
<div class="code-sample lang-py" title="test_parser.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">parser</span> <span class="kn">import</span> <span class="n">parse</span>

<span class="k">def</span> <span class="nf">test_parse_empty_string</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">test_parse_single_literal</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">}]</span>

<span class="k">def</span> <span class="nf">test_parse_multiple_literals</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse</span><span class="p">(</span><span class="s2">"ab"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"b"</span><span class="p">},</span>
    <span class="p">]</span>


<span class="k">def</span> <span class="nf">test_parse_alt_of_groups</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">parse</span><span class="p">(</span><span class="s2">"a|(bc)"</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Alt"</span><span class="p">,</span>
            <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">"left"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"a"</span><span class="p">},</span>
            <span class="s2">"right"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Group"</span><span class="p">,</span>
                <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">"end"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">"children"</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"b"</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"Lit"</span><span class="p">,</span> <span class="s2">"loc"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"c"</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test_parser.out">
<div class="highlight"><pre><span></span><code>========================= test session starts ==========================
platform darwin -- Python 3.10.4, pytest-7.1.2, pluggy-1.0.0
rootdir: /u/sdxpy/parser
plugins: pyfakefs-4.6.3
collected 15 items

test_parser.py ...............                                   [100%]

========================== 15 passed in 0.01s ==========================
</code></pre></div>
</div>
<p>Our tokenizer and parser are doing some complex things,
but are still less than 100 lines of code.
Compared to parsers for formats like JSON and YAML,
though,
they are still quite simple.
If we have more operators with different
<span class="ix-entry" ix-key="operator precedence!implementing" markdown="1"><a class="gl-ref" href="../glossary/#precedence" markdown="1">precedences</a></span>
we should switch to the
<span class="ix-entry" ix-key="shunting-yard algorithm;parser!shunting-yard algorithm" markdown="1"><a href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">shunting-yard algorithm</a></span>,
and if we need to parse something as complex as Python
we should explore tools like <span class="ix-entry" ix-key="ANTLR" markdown="1"><a href="https://www.antlr.org/">ANTLR</a></span>
that can generate a parser automatically from a description of the language to be parsed.
As we said at the start,
though,
if our design requires us to write a parser we should come up with a better design.</p>
<div class="callout">
<h3>The limits of computing</h3>
<p>One of the most important theoretical results in computer science is that
every formal language corresponds to a type of abstract machine and vice versa,
and that some languages (or machines) are more or less powerful than others.
For example,
every regular expression corresponds to
a <span class="ix-entry" ix-key="finite state machine!correspondence with regular expressions" markdown="1"><a class="gl-ref" href="../glossary/#fsm" markdown="1">finite state machine</a></span> (FSM)
like the one in <a class="fig-ref" href="../parser/#parser-fsm">Figure 13.3</a>.
As powerful as FSMs are,
they cannot match things like nested parentheses or HTML tags;
<span class="ix-entry" ix-key="sin!using regular expressions to parse HTML" markdown="1"><a href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">attempting to do so is a sin</a></span>.
If you add a stack to the system you can process a much richer set of languages,
and if you add two stacks you have something equivalent to a <span class="ix-entry" ix-key="Turing Machine" markdown="1"><a class="gl-ref" href="../glossary/#turing_machine" markdown="1">Turing Machine</a></span>
that can do any conceivable computation.
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Conery2021">Conery2021</a>]</span> is a good introduction to this idea
(and others)
for self-taught developers.</p>
</div>
<figure id="parser-fsm">
<img alt="Finite state machine" src="./parser/parser_fsm.svg"/>
<figcaption markdown="1">Figure 13.3: A finite state machine equivalent to a regular expression.</figcaption>
</figure>
<h2 id="templating-summary">Section 13.4: Summary</h2>
<figure id="parser-concept-map">
<img alt="Concept map for parser" src="./parser/parser_concept_map.svg"/>
<figcaption markdown="1">Figure 13.4: Parser concept map.</figcaption>
</figure>
<h2 id="parser-exercises">Section 13.5: Exercises</h2>
<h3 class="exercise">Create objects</h3>
<p>Modify the parser to return instances of classes derived from
the <code>RegexBase</code> class of <a class="x-ref" href="#matching">Chapter 12</a>.</p>
<h3 class="exercise">Escape characters</h3>
<p>Modify the parser to handle escape characters,
so that (for example) <code>\*</code> is interpreted as a literal ‘*’ character
and <code>\\</code> is interpreted as a literal backslash.</p>
<h3 class="exercise">Lazy matching</h3>
<p>Modify the parser so that <code>*?</code> is interpreted as a single token
meaning “lazy match zero or more”.</p>
<h3 class="exercise">Character sets</h3>
<p>Modify the parser so that expressions like <code>[xyz]</code> are interpreted to mean
“match any one of the characters ‘x’, ‘y’, or ‘z’“.</p>
<h3 class="exercise">Back reference</h3>
<p>Modify the tokenizer so that it recognizes <code>\1</code>, <code>\2</code>, and so on to mean “back reference”.
The number may contain any number of digits.</p>
<h3 class="exercise">Tokenize HTML</h3>
<ol>
<li>
<p>Write a tokenizer for a subset of HTML that consists of:</p>
<ul>
<li>Opening tags without attributes, such as <code>&lt;div&gt;</code> and <code>&lt;p&gt;</code></li>
<li>Closing tags, such as <code>&lt;/p&gt;</code> and <code>&lt;/div&gt;</code></li>
<li>Plain text between tags that does <em>not</em> contain ‘&lt;’ or ‘&gt;’ characters</li>
</ul>
</li>
<li>
<p>Modify the tokenizer to handle <code>key="value"</code> attributes in opening tags.</p>
</li>
<li>
<p>Write tests for your tokenizer.</p>
</li>
</ol>
<p>You may use Python’s own <a href="https://docs.python.org/3/library/re.html">re</a> module for tokenization.</p>
<h3 class="exercise">Efficiency</h3>
<p>The parser developed in this chapter creates and discards a lot of objects.
How can you make it more efficient?</p>
<h3 class="exercise">Nested lists</h3>
<p>Write a function that accepts a string representing nested lists containing numbers
and returns the actual list.
For example, the input <code>[1, [2, [3, 4], 5]]</code>
should produce the corresponding Python list.</p>
<h3 class="exercise">The Shunting Yard Algorithm</h3>
<ol>
<li>
<p>Use the <a href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">shunting-yard algorithm</a>
    to implement a tokenizer for a simple subset of arithmetic that includes:</p>
<ul>
<li>single-letter variable names</li>
<li>single-digit numbers</li>
<li>the <code>+</code>, <code>*</code>, and <code>^</code> operators, where <code>+</code> has the lowest precedence and <code>^</code> has the highest</li>
</ul>
</li>
<li>
<p>Write tests for your tokenizer.</p>
</li>
</ol>
<h3 class="exercise">Using the right tools</h3>
<ol>
<li>
<p>Rewrite the regular expression parser from this chapter
    using the <a href="https://pyparsing-docs.readthedocs.io/">pyparsing</a> module.</p>
</li>
<li>
<p>Did learning this module take more or less time
    than solving the problem without it?
    How many times would you have to use the module to amortize its learning overhead?</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="linter">Chapter: Chapter 14: A Style Checker</h1>

<ul class="syllabus">
<li markdown="1">An abstract syntax tree (AST) represents the elements of a program as a data structure.</li>
<li markdown="1">A linter checks that a program conforms to a set of style and usage rules.</li>
<li markdown="1">Linters typically use the Visitor design pattern to find nodes of interest in an AST.</li>
<li markdown="1">Programs can modify a program's AST and then unparse it to create modified versions of the original program.</li>
<li markdown="1">Dynamic code modification is very powerful, but the technique can produce insecure and unmaintainable code.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#abstract_syntax_tree" markdown="1">abstract syntax tree</a>, <a class="gl-ref" href="../glossary/#bytecode" markdown="1">bytecode</a>, <a class="gl-ref" href="../glossary/#decorator" markdown="1">decorator</a>, <a class="gl-ref" href="../glossary/#false_negative" markdown="1">false negative</a>, <a class="gl-ref" href="../glossary/#linter" markdown="1">linter</a>, <a class="gl-ref" href="../glossary/#method_injection" markdown="1">method injection</a>, <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>, <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological order</a>, <a class="gl-ref" href="../glossary/#unparsing" markdown="1">unparsing</a>, <a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor pattern</a>
</p>
<div class="page-toc"></div>
<p>This book relies on about 2500 lines of Python to turn Markdown into HTML,
fill in cross-references,
and so on.
To keep that code readable,
we use <a href="https://black.readthedocs.io/">black</a>, <a href="https://flake8.pycqa.org/">flake8</a>, and <a href="https://pycqa.github.io/isort/">isort</a>
to check that lines aren’t too long,
that classes and functions have consistent names,
that modules are imported in a consistent order,
and dozens of other things.</p>
<p>Checking tools are often called <a class="gl-ref" href="../glossary/#linter" markdown="1">linters</a>
because an early tool like this for the C programming language was called <code>lint</code>.
Many projects insist that code pass checks like these
before being committed to version control.
To show how they work,
this chapter builds a trio of simple linting tools
that find duplicate keys in dictionaries,
look for unused variables,
and create a table showing which classes in a hierarchy define which methods.
As a bonus,
we then show how these tools can be used to extract documentation
and to create code as well as check it.</p>
<h2 id="linter-machinery">Section 14.1: Machinery</h2>
<p>Our starting point is Python’s <a href="https://docs.python.org/3/library/ast.html">ast</a> module,
which parses Python code and produces an <a class="gl-ref" href="../glossary/#abstract_syntax_tree" markdown="1">abstract syntax tree</a>
that represents the structure of the code.
For example,
suppose we have this short program:</p>
<div class="code-sample lang-py" title="simple.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue"><a class="fig-ref" href="../linter/#linter-ast-simple">Figure 14.1</a> shows the main parts of this program’s AST.
Each node represents one element of the program,
and each node’s children are the element nested within it.</p>
<figure id="linter-ast-simple">
<img alt="Simple AST" src="./linter/linter_ast_simple.svg"/>
<figcaption markdown="1">Figure 14.1: The abstract syntax tree for a simple Python program.</figcaption>
</figure>
<p>We say “main parts of the AST” because
the full structure includes placeholders for elements
that aren’t present in this program.
To see the full thing,
we can use <code>ast.parse</code> to turn our short program into an AST
and <code>ast.dump</code> to display it:</p>
<div class="code-sample lang-py" title="dump_ast.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="dump_ast_simple.sh">
<div class="highlight"><pre><span></span><code>python dump_ast.py simple.py
</code></pre></div>
</div>
<div class="code-sample lang-out" title="dump_ast_simple.out">
<div class="highlight"><pre><span></span><code>Module(
    body=[
        FunctionDef(
            name='double',
            args=arguments(
                posonlyargs=[],
                args=[
                    arg(arg='x')],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[]),
            body=[
                Return(
                    value=BinOp(
                        left=Constant(value=2),
                        op=Mult(),
                        right=Name(id='x', ctx=Load())))],
            decorator_list=[]),
        Assign(
            targets=[
                Name(id='result', ctx=Store())],
            value=Call(
                func=Name(id='double', ctx=Load()),
                args=[
                    Constant(value=3)],
                keywords=[])),
        Expr(
            value=Call(
                func=Name(id='print', ctx=Load()),
                args=[
                    Name(id='result', ctx=Load())],
                keywords=[]))],
    type_ignores=[])
</code></pre></div>
</div>
<p class="continue">Looking at the node representing the definition of the function <code>double</code>,
it has:</p>
<ul>
<li>a <code>name</code>;</li>
<li>an <code>arguments</code> node that stores information about the function’s arguments;</li>
<li>a <code>body</code> that holds a list of the statements making up the function; and</li>
<li>a list of decorators applied to the function (which is empty).</li>
</ul>
<p>If we want a list of all the functions defined in this module,
we can walk through this tree to find all the <code>FunctionDef</code> nodes
and record their <code>name</code> properties.
Since each node’s structure is a little different,
we would have to write one function for each type of node
that knew which fields of that node were worth exploring.</p>
<p>Luckily for us,
the <a href="https://docs.python.org/3/library/ast.html">ast</a> module comes with tools that can do this for us.
The class <code>ast.NodeVisitor</code> uses
the <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1"><a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor</a></span> design pattern
to recurse through an AST.
Each time it reaches a new node of type <code>Thing</code>,
it looks for a method called <code>visit_Thing</code>;
for example,
when it reaches a <code>FunctionDef</code> node it looks for <code>visit_FunctionDef</code>.
If that method has been defined,
<code>NodeVisitor</code> calls it with the node as an argument.
The class <code>CollectNames</code> uses this machinery
to create a list of all the function and variable names
defined in a program:</p>
<div class="code-sample lang-py" title="walk_ast.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CollectNames</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">},</span> <span class="p">{</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">})</span>
</code></pre></div>
</div>
<p class="continue">A few things worth noting about this class are:</p>
<ol>
<li>
<p>The constructor of <code>CollectNames</code> invokes
    the constructor of <code>NodeVisitor</code>
    using <code>super().__init__()</code>
    before doing anything else.</p>
</li>
<li>
<p>The methods <code>visit_Assign</code> and <code>visit_FunctionDef</code>
    must call explicitly <code>self.generic_visit(node)</code> explicitly
    to recurse down through their children.
    By requiring this to be explicit,
    <code>NodeVisitor</code> gives programmers control on whether and when recursion takes place.</p>
</li>
<li>
<p>The method <code>position</code> relies on the fact that
    every node in the ATS keeps track of
    where in the source code it came from.</p>
</li>
</ol>
<p>To use this class,
we read in a source program that we want to analyze,
parse it,
and then call the <code>visit</code> method of our class to trigger recursion:</p>
<div class="code-sample lang-py" title="walk_ast.py">
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">collector</span> <span class="o">=</span> <span class="n">CollectNames</span><span class="p">()</span>
<span class="n">collector</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Here’s its output for our simple test program:</p>
<div class="code-sample lang-sh" title="walk_ast.sh">
<div class="highlight"><pre><span></span><code>python walk_ast.py simple.py
</code></pre></div>
</div>
<div class="code-sample lang-out" title="walk_ast.out">
<div class="highlight"><pre><span></span><code>{'double': {(1, 0)}, 'result': {(4, 0)}}
</code></pre></div>
</div>
<p>With a little more work we could record class names as well,
and then check that (for example)
class names use CamelCase
while function and variable names use pothole_case.
We’ll tackle this in the exercises.</p>
<h2 id="linter-find">Section 14.2: Finding Things</h2>
<p>Many programs store their configuration in dictionaries.
As those dictionaries grow larger,
it’s easy for programmer to redefine values by accident.
Python doesn’t consider this an error—for example,
both <code>no_duplicates</code> and <code>has_duplicates</code> are valid two-element dictionaries:</p>
<div class="code-sample lang-py" title="has_duplicate_keys.py">
<div class="highlight"><pre><span></span><code><span class="n">no_duplicates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"first"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"second"</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="n">has_duplicates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"third"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"fourth"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"fourth"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"third"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Overwriting, not Appending</h3>
<p>Programmers who are new to Python sometimes believe that
the “extra” values in the dictionary <code>has_duplicates</code>
should be put in a list,
so that (for example) the key <code>"third"</code> has the value <code>[3, 6]</code>.
This behavior would be perfectly reasonable,
but it isn’t what Python does.</p>
</div>
<p>We can built a linter that finds dictionaries like <code>has_duplicates</code>
in just 17 lines of code.
We define a <code>visit_Dict</code> method for <code>NodeVisitor</code> to call;
in it,
we add each constant key to an instance of <code>Counter</code>
(a specialized <code>dict</code> that counts entries`)
and then look for keys that have been seen more than once:</p>
<div class="code-sample lang-py" title="find_duplicate_keys.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FindDuplicateKeys</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visit_Dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">problems</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">problems</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">problems</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">problems</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">problems</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"duplicate key(s) </span><span class="se">{{</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">}}</span><span class="s2"> at line </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Its output for the file containing our two example dictionaries is:</p>
<div class="code-sample lang-out" title="has_duplicate_keys_ast.out">
<div class="highlight"><pre><span></span><code>Module(
    body=[
        Assign(
            targets=[
                Name(id='no_duplicates', ctx=Store())],
            value=Dict(
                keys=[
                    Constant(value='first'),
                    Constant(value='second')],
                values=[
                    Constant(value=1),
                    Constant(value=2)])),
        Assign(
            targets=[
                Name(id='has_duplicates', ctx=Store())],
            value=Dict(
                keys=[
                    Constant(value='third'),
                    Constant(value='fourth'),
                    Constant(value='fourth'),
                    Constant(value='third')],
                values=[
                    Constant(value=3),
                    Constant(value=4),
                    Constant(value=5),
                    Constant(value=6)]))],
    type_ignores=[])
</code></pre></div>
</div>
<div class="callout">
<h3>As Far as We Can Go</h3>
<p><code>FindDuplicateKeys</code> only considers constant keys,
so it won’t find duplicate keys that are created on the fly:</p>
<div class="code-sample lang-py" title="function_keys.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">label</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"label"</span>

<span class="n">actually_has_duplicate_keys</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"label"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"la"</span> <span class="o">+</span> <span class="s2">"bel"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="p">():</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"l"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"e"</span><span class="p">,</span> <span class="s2">"l"</span><span class="p">]):</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>We could try adding logic to handle this,
but one of the fundamental theorems of computer science is that
it’s impossible to create a program that can predict the output of arbitrary other programs.
Our linter can therefore produce <a class="gl-ref" href="../glossary/#false_negative" markdown="1">false negatives</a>,
i.e.,
tell us there aren’t problems when there actually are.</p>
</div>
<p>Finding unused variables—ones that are assigned values but never used—is
more challenging than our previous examples.
The problem is <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>:
a variable defined in a function or method might have the same name
as one defined elsewhere,
but they are different variables.</p>
<p>Let’s start by defining a class that handles modules and functions.
Since functions can be defined inside modules,
and inside other functions,
our class’s constructor creates a list that we will use as a stack
to keep track of what scopes we’re currently in:</p>
<div class="code-sample lang-py" title="find_unused_variables.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FindUnusedVariables</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">visit_Module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">"global"</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Each time we encounter a new scope
we push a triple onto the stack with a name,
a set to hold the variables that are used in the scope,
and another set to hold the variables that are defined in the scope.
We then call <code>NodeVisitor.generic_visitor</code> to trigger recursion,
pop the record we just pushed off the stack,
and report any problems:</p>
<div class="code-sample lang-py" title="find_unused_variables.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Scope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="n">unused</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">store</span> <span class="o">-</span> <span class="n">scope</span><span class="o">.</span><span class="n">load</span>
        <span class="k">if</span> <span class="n">unused</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unused</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"unused in </span><span class="si">{</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We could just use a list of three values to record information for each scope,
but it’s a little cleaner to use <code>namedtuple</code>
from Python’s standard library:</p>
<div class="code-sample lang-py" title="find_unused_variables.py">
<div class="highlight"><pre><span></span><code><span class="n">Scope</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Scope"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"load"</span><span class="p">,</span> <span class="s2">"store"</span><span class="p">])</span>
</code></pre></div>
</div>
<p>The last part of the puzzle is <code>visit_Name</code>.
If the variable’s value is being read,
the node will have a property <code>.ctx</code> (short for “context”) of type <code>Load</code>.
If the variable is being written to,
the node’s <code>.ctx</code> property will be an instance of <code>Store</code>.
Checking this property allows us to put the name in the right set
in the scope that’s at the top of the stack:</p>
<div class="code-sample lang-py" title="find_unused_variables.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown context"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Once again,
we can run this by reading the source of a program,
converting it to an AST,
constructing an instance of <code>FindUnusedVariables</code>,
and running its <code>visit</code> method:</p>
<div class="code-sample lang-py" title="find_unused_variables.py">
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">finder</span> <span class="o">=</span> <span class="n">FindUnusedVariables</span><span class="p">()</span>
<span class="n">finder</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To test our code,
let’s create a program that has some unused variables:</p>
<div class="code-sample lang-py" title="has_unused_variables.py">
<div class="highlight"><pre><span></span><code><span class="n">used</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">distractor</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">not_used</span> <span class="o">=</span> <span class="n">used</span> <span class="o">+</span> <span class="n">distractor</span>


<span class="k">def</span> <span class="nf">no_unused</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">param</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">has_unused</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">used</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">param</span>
    <span class="n">not_used</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">param</span>
    <span class="n">distractor</span> <span class="o">=</span> <span class="s2">"distraction"</span>
    <span class="k">return</span> <span class="n">used</span>
</code></pre></div>
</div>
<p>When we run our linter we get:</p>
<div class="code-sample lang-out" title="find_unused_variables.out">
<div class="highlight"><pre><span></span><code>unused in has_unused: distractor, not_used
unused in global: not_used
</code></pre></div>
</div>
<p>For our last example of finding things,
let’s build a tool that tells us which methods are defined in which classes.
(We used a tool like this when writing this book
to keep track of examples that evolved step by step.)
Here’s a test file that defines four classes,
each of which defines or redefines some methods:</p>
<div class="code-sample lang-py" title="inheritance_example.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">LeftChild</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RightChild</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">GrandChild</span><span class="p">(</span><span class="n">LeftChild</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">orange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p>As before,
our class’s constructor creates a stack to keep track of where we are.
It also creates a couple of dictionaries to keep track of
how classes inherit from each other
and the methods each class defines:</p>
<div class="code-sample lang-py" title="inheritance.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FindClassesAndMethods</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>
</div>
<p>When we encounter a new class definition,
we push its name on the stack,
record its parents,
and create an empty set to hold its methods:</p>
<div class="code-sample lang-py" title="inheritance.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="k">assert</span> <span class="n">class_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>
</div>
<p>When we encounter a function definition,
the first thing we do is check the stack.
If it’s empty,
we’re looking at a top-level function rather than a method,
so there’s nothing for us to do.
(We actually should recurse through the function’s children,
since it’s possible to define classes inside functions,
but we’ll leave as an exercise.)
If this function definition is inside a class,
on the other hand,
we add its name to our records:</p>
<div class="code-sample lang-py" title="inheritance.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="k">assert</span> <span class="n">method_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Once we’re done searching the AST we print out a table
of the classes and methods we’ve seen (<a class="tbl-ref" href="../linter/#linter-inheritance">Table 14.1</a>).
We could make this display easier to read—for example,
we could sort the classes from parent to child
and display methods in the order in which they were first defined—but
none of that requires us to inspect the AST.</p>
<div class="table"><table id="linter-inheritance"><caption>Table 14.1: Inheritance and methods</caption>
<thead>
<tr>
<th></th>
<th>GrandChild</th>
<th>LeftChild</th>
<th>Parent</th>
<th>RightChild</th>
</tr>
</thead>
<tbody>
<tr>
<td>blue</td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>green</td>
<td></td>
<td>X</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>orange</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>red</td>
<td>X</td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
</tbody>
</table>
</div>
<h2 id="linter-extension">Section 14.3: Extension</h2>
<p>It’s easy to check a single style rule by extending <code>NodeVisitor</code>,
but what if we want to check dozens of rules?
Traversing the AST dozens of times would be inefficient.
And what if we want people to be able to add their own rules?
Inheritance is the wrong tool for this:
if several people each create their own <code>NodeVisitor</code> with a <code>visit_Name</code> method,
we’d have to inherit from all those classes
and then have the new class’s <code>visit_Name</code> call up to all of its parents’ equivalent methods.</p>
<p>One way around this is to <a class="gl-ref" href="../glossary/#method_injection" markdown="1">inject</a> methods into classes
after they have been defined.
The code fragment below creates a new class called <code>BlankNodeVisitor</code>
that doesn’t add anything to <code>NodeVisitor</code>,
then uses <code>setattr</code> to add a method to it after it has been defined:</p>
<div class="code-sample lang-py" title="injection.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BlankNodeVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">print_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>


<span class="nb">setattr</span><span class="p">(</span><span class="n">BlankNodeVisitor</span><span class="p">,</span> <span class="s2">"visit_Name"</span><span class="p">,</span> <span class="n">print_name</span><span class="p">)</span>
</code></pre></div>
</div>
<p>This trick works because classes and objects are just specialized dictionaries
(for some large value of “just”).
If we create an object of <code>BlankNodeVisitor</code> and call its <code>visit</code> method:</p>
<div class="code-sample lang-py" title="injection.py">
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">finder</span> <span class="o">=</span> <span class="n">BlankNodeVisitor</span><span class="p">()</span>
<span class="n">finder</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</code></pre></div>
</div>
<p>then the inherited <code>generic_visit</code> method does what it always does.
When it encounters a <code>Name</code> node,
it looks in the object for something called <code>visit_Name</code>.
Since it doesn’t find anything,
it looks in the object’s class for something with that name,
finds our injected method,
and calls it.</p>
<p>With a bit more work we could have our injected method save and then call
whatever <code>visit_Name</code> method was there when it was added to the class,
but we would quickly run into a problem.
As we’ve seen in earlier examples,
the methods that handle nodes are responsible for deciding
whether and when to recurse into those nodes’ children.
If we pile method on top of one another,
then either each one is going to trigger recursion
(so we recurse many times)
or there will have to be some way for each one to signal
whether it did that
so that other methods don’t.</p>
<p>To avoid this complication,
most systems use a different approach.
Consider this class:</p>
<div class="code-sample lang-py" title="register.py">
<div class="highlight"><pre><span></span><code><span class="n">Handler</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Handler"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"func"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">RegisterNodeVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeType</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">Handler</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nodeType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">nodeType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">nodeType</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <code>add_handler</code> method takes three parameters:
the type of node a callback function is meant to handel,
the function itself,
and an optional extra piece of data to pass to the function
along with an AST node.
It saves the handler function and the data in a lookup table
indexed by the type of node the function is meant to handle.
Each of the methods inherited from <code>NodeVisitor</code>
then looks up handlers for its node type and runs them.</p>
<p>So what do handlers look like?
Each one is a function that takes a node and some data as input
and does whatever it’s supposed to do:</p>
<div class="code-sample lang-py" title="register.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">count_names</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
    <span class="n">counter</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>Setting up the visitor is a bit more complicated,
since we have to create and register the handler:</p>
<div class="code-sample lang-py" title="register.py">
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

<span class="n">finder</span> <span class="o">=</span> <span class="n">RegisterNodeVisitor</span><span class="p">()</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="n">finder</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">count_names</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>

<span class="n">finder</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">However,
we can now register as many handlers as we want
for each kind of node.</p>
<h2 id="linter-docs">Section 14.4: Generating Documentation</h2>
<p>Many programmers believe they’re more likely to write documentation and keep it up to date
if it is close to the code.
Tools that extract specially-formatted comments from code and turn them into documentation
have been around since at least the 1980s;
both <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a href="https://www.mkdocs.org/">MkDocs</a> are popular ones for Python.</p>
<p>Generating documentation isn’t the same as checking code style,
but they share some tooling.
Let’s start by building a <code>NodeVisitor</code> that extracts and saves docstrings:</p>
<div class="code-sample lang-py" title="doc_extract.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Extract</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="sd">"""Extraction class."""</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="sd">"""Entry-level method."""</span>
        <span class="n">extracter</span> <span class="o">=</span> <span class="n">Extract</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
                <span class="n">extracter</span><span class="o">.</span><span class="n">extract_from</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">extracter</span><span class="o">.</span><span class="n">seen</span>
</code></pre></div>
</div>
<p>The code to create a stack,
extract docstrings,
and save them in a dictionary should look familiar by now:</p>
<div class="code-sample lang-py" title="doc_extract.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Constructor."""</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">"""Get docstring from class."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">extract_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="sd">"""Start extraction for a module."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"module"</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">"""Save information about a docstring."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="s2">"."</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">docstring</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To format the docstrings,
we create a Markdown page with module, class, and function names as headers:</p>
<div class="code-sample lang-py" title="doc_format.py">
<div class="highlight"><pre><span></span><code><span class="n">HEADING</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"module"</span><span class="p">:</span> <span class="s2">"#"</span><span class="p">,</span> <span class="s2">"class"</span><span class="p">:</span> <span class="s2">"##"</span><span class="p">,</span> <span class="s2">"function"</span><span class="p">:</span> <span class="s2">"##"</span><span class="p">}</span>

<span class="n">MISSING</span> <span class="o">=</span> <span class="s2">"**No documentation.**"</span>


<span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">docstrings</span><span class="p">):</span>
    <span class="sd">"""Convert dictionary of docstrings to HTML page."""</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">docstring</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_heading</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">docstring</span> <span class="k">if</span> <span class="n">docstring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">MISSING</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s2">"markdown.extensions.extra"</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">format_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\_"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_heading</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">HEADING</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="si">}</span><span class="s2"> `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">` </span><span class="se">{{</span><span class="s2">: #</span><span class="si">{</span><span class="n">format_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p>If our input file looks like this:</p>
<div class="code-sample lang-py" title="doc_sample.py">
<div class="highlight"><pre><span></span><code><span class="sd">"""Docstring for module."""</span>


<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="sd">"""Docstring for function."""</span>


<span class="k">def</span> <span class="nf">undocumented</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Sample</span><span class="p">:</span>
    <span class="sd">"""Docstring for class."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">"""Docstring for constructor."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
        <span class="sd">"""Docstring for method."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
</code></pre></div>
</div>
<p class="continue">then our output is:</p>
<div class="code-sample lang-out" title="doc_sample.out">
<div class="highlight"><pre><span></span><code>&lt;h1 id="doc_sample"&gt;&lt;code&gt;doc_sample&lt;/code&gt;&lt;/h1&gt;
&lt;p&gt;Docstring for module.&lt;/p&gt;
&lt;h2 id="doc_sample-Sample"&gt;&lt;code&gt;doc_sample.Sample&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;Docstring for class.&lt;/p&gt;
&lt;h2 id="doc_sample-Sample-__init__"&gt;&lt;code&gt;doc_sample.Sample.__init__&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;Docstring for constructor.&lt;/p&gt;
&lt;h2 id="doc_sample-Sample-rename"&gt;&lt;code&gt;doc_sample.Sample.rename&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;Docstring for method.&lt;/p&gt;
&lt;h2 id="doc_sample-function"&gt;&lt;code&gt;doc_sample.function&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;Docstring for function.&lt;/p&gt;
&lt;h2 id="doc_sample-undocumented"&gt;&lt;code&gt;doc_sample.undocumented&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;No documentation.&lt;/strong&gt;&lt;/p&gt;
</code></pre></div>
</div>
<h2 id="codegen-modify">Section 14.5: Modifying Code</h2>
<p>An AST is a data structure like any other,
which means we can modify it as well as inspecting it.
Let’s start with this short program:</p>
<div class="code-sample lang-py" title="double_and_print.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>
</div>
<p>Its AST has two top-level nodes:
one for the function definition and one for the <code>print</code> statement.
We can duplicate the second of these and then <a class="gl-ref" href="../glossary/#unparsing" markdown="1">unparse</a> the AST
to produce a new program:</p>
<div class="code-sample lang-py" title="unparse.py">
<div class="highlight"><pre><span></span><code><span class="n">code</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
<span class="n">print_stmt</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">print_stmt</span><span class="p">)</span>
<span class="n">modified</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="unparse_modified.out">
<div class="highlight"><pre><span></span><code>def double(x):
    return 2 * x
print(double(3))
print(double(3))
</code></pre></div>
</div>
<p>To run our machine-generated program,
we have to compile the AST to <a class="gl-ref" href="../glossary/#bytecode" markdown="1">bytecode</a>
and tell Python to evaluate the result:</p>
<div class="code-sample lang-py" title="unparse.py">
<div class="highlight"><pre><span></span><code><span class="n">bytecode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">"example"</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"exec"</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">bytecode</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="unparse_exec.out">
<div class="highlight"><pre><span></span><code>6
6
</code></pre></div>
</div>
<p>Duplicating a <code>print</code> statement isn’t particularly useful,
but other applications of this technique let us do some powerful things.
Let’s have another look at how Python represents a function call.
Our example is:</p>
<div class="code-sample lang-py" title="call.py">
<div class="highlight"><pre><span></span><code><span class="n">count</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We parse it like this:</p>
<div class="code-sample lang-py" title="inject.py">
<div class="highlight"><pre><span></span><code><span class="n">call_code</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and get this AST:</p>
<div class="code-sample lang-out" title="inject_parse.out">
<div class="highlight"><pre><span></span><code>Module(
  body=[
    Expr(
      value=Call(
        func=Name(id='count', ctx=Load()),
        args=[
          Constant(value='name')],
        keywords=[]))],
  type_ignores=[])
</code></pre></div>
</div>
<p>But we don’t have to parse text to create an AST:
it’s just a bunch of objects,
so we can construct one by hand
that mirrors the structure shown above:</p>
<div class="code-sample lang-py" title="inject.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_count</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"count"</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
            <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">name</span><span class="p">)],</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="n">constructed</span> <span class="o">=</span> <span class="n">make_count</span><span class="p">(</span><span class="s2">"test"</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="inject_make.out">
<div class="highlight"><pre><span></span><code>Expr(
  value=Call(
    func=Name(id='count', ctx=Load()),
    args=[
      Constant(value='test')],
    keywords=[]))
</code></pre></div>
</div>
<p>Alternatively,
we can find existing function definitions
and modify them programmatically:</p>
<div class="code-sample lang-py" title="inject.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_count</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To try this out,
here’s a program that adds and doubles numbers:</p>
<div class="code-sample lang-py" title="add_double.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span>

<span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">double</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The modified version is:</p>
<div class="code-sample lang-out" title="inject_modified.out">
<div class="highlight"><pre><span></span><code>def add(left, right):
    count('add')
    return left + right

def double(x):
    count('double')
    return add(x, x)
add(1, 2)
double(3)
</code></pre></div>
</div>
<p>So what exactly is <code>call</code>?
We want a “function” that keeps track of
how many times it has been passed different strings,
so we define a class with a <code>__call__</code> method
so that its instances can be used like functions:</p>
<div class="code-sample lang-py" title="inject.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CountCalls</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>Finally,
when we’re evaluating the bytecode generated from our modified AST,
we pass in a dictionary of variable names and values
that we want to have in scope.
The result is exactly what we would get if we had defined all of this in the usual way:</p>
<div class="code-sample lang-py" title="inject.py">
<div class="highlight"><pre><span></span><code><span class="n">call_counter</span> <span class="o">=</span> <span class="n">CountCalls</span><span class="p">()</span>
<span class="n">bytecode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">modified</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">"example"</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"exec"</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">bytecode</span><span class="p">,</span> <span class="p">{</span><span class="s2">"count"</span><span class="p">:</span> <span class="n">call_counter</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">call_counter</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="inject_exec.out">
<div class="highlight"><pre><span></span><code>Counter({'add': 2, 'double': 1})
</code></pre></div>
</div>
<div class="callout">
<h3>There’s Such a Thing as “Too Clever”</h3>
<p>Modifying code dynamically is the most powerful technique shown in this book.
It is also the least comprehensible:
as soon as the code you read and the code that’s run can differ in arbitrary ways,
you have a maintenance headache and a security nightmare.
Limited forms of program modification,
such as Python’s <a href="https://docs.python.org/3/reference/datamodel.html#metaclasses">metaclasses</a> or <a class="gl-ref" href="../glossary/#decorator" markdown="1">decorators</a>
give most of the power with only some of the headaches;
please use those rather than the magic shown above.</p>
</div>
<h2 id="linter-summary">Section 14.6: Summary</h2>
<figure id="linter-concept-map">
<img alt="Concept map for code manipulation" src="./linter/linter_concept_map.svg"/>
<figcaption markdown="1">Figure 14.2: Concepts for code manipulation.</figcaption>
</figure>
<h2 id="linter-exercises">Section 14.7: Exercises</h2>
<h3 class="exercise">Finding unused parameters</h3>
<p>Modify the code that finds unused variables
to report unused function parameters as well.</p>
<h3 class="exercise">Finding redundant assignments</h3>
<p>Write a linter that looks for redundant assignments to variables,
i.e.,
assignments that are immediately overwritten:</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># redundant</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>
<p class="continue">(Redundant assignments are a common result of copying and pasting.)</p>
<h3 class="exercise">Checking names</h3>
<p>Write a linter that checks that
class names are written in CamelCase
but function and variable names are pothole_case.</p>
<h3 class="exercise">Missing documentation</h3>
<p>Write a linter that complains about modules, classes, methods, and functions
that don’t have docstrings.</p>
<h3 class="exercise">Missing tests</h3>
<p>Write a linter that takes two files as input:
one that defines one or more functions
and another that defines one or more tests of those functions.
The linter looks through the tests to see what functions are being called,
then reports any functions from the first file that it hasn’t seen.</p>
<h3 class="exercise">Nested functions</h3>
<p>Modify the inheritance table code
so that class names are shown in parent-to-child order
and methods are shown in the order in which they are first defined.
(You may find the discussion of
<span class="ix-entry" ix-key="topological order" markdown="1"><a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological ordering</a></span>
in <a class="x-ref" href="#builder">Chapter 8</a> useful.)</p>
<h3 class="exercise">Chaining methods</h3>
<ol>
<li>
<p>Modify the code that injects methods into <code>NodeVisitor</code>
    so that any previously-injected methods are also called.</p>
</li>
<li>
<p>Modify the methods again so that each one signals
    whether or not it has handled recursion
    (either directly or indirectly).</p>
</li>
</ol>
<h3 class="exercise">Decorating</h3>
<p>Create a <code>@count</code> decorator that causes a function to count
how many times it has been called.</p>
<h3 class="exercise">Name conversion</h3>
<p>Write a tool that find functions with pothole_case names
and replaces them with CamelCase names,
then saves the resulting program as a legal Python file.</p>
<h3 class="exercise">Sorting imports</h3>
<p><a href="https://pycqa.github.io/isort/">isort</a> checks that the imports in a file are sorted correctly:
modules from Python’s standard library come first (in alphabetical order),
then installed modules (also in alphabetical order)
and finally local imports (ditto).
Write a linter that reports violations of these rules.
How did you distinguish between the three cases?</p>
</section>
<section class="new-chapter"><h1 id="vm">Chapter: Chapter 15: A Virtual Machine</h1>

<ul class="syllabus">
<li markdown="1">Every computer has a processor with a particular instruction set, some registers, and memory.</li>
<li markdown="1">Instructions are just numbers, but may be represented as assembly code.</li>
<li markdown="1">Instructions may refer to registers, memory, both, or neither.</li>
<li markdown="1">A processor usually executes instructions in order, but may jump to another location based if a conditional is true or false.</li>
<li markdown="1">An array is a block of adjacent locations in memory that can be indexed using an offset from its base address.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#abi" markdown="1">Application Binary Interface</a>, <a class="gl-ref" href="../glossary/#assembler" markdown="1">assembler</a>, <a class="gl-ref" href="../glossary/#assembly_code" markdown="1">assembly code</a>, <a class="gl-ref" href="../glossary/#bitwise_operation" markdown="1">bitwise operation</a>, <a class="gl-ref" href="../glossary/#conditional_jump" markdown="1">conditional jump</a>, <a class="gl-ref" href="../glossary/#disassembler" markdown="1">disassembler</a>, <a class="gl-ref" href="../glossary/#instruction_pointer" markdown="1">instruction pointer</a>, <a class="gl-ref" href="../glossary/#instruction_set" markdown="1">instruction set</a>, <a class="gl-ref" href="../glossary/#label_address" markdown="1">label (address in memory)</a>, <a class="gl-ref" href="../glossary/#op_code" markdown="1">op code</a>, <a class="gl-ref" href="../glossary/#register" markdown="1">register</a>, <a class="gl-ref" href="../glossary/#virtual_machine" markdown="1">virtual machine</a>, <a class="gl-ref" href="../glossary/#word_memory" markdown="1">word (of memory)</a>
</p>
<div class="page-toc"></div>
<p>You might have felt that there was still a lot of magic in our interpreter in <a class="x-ref" href="#interpreter">Chapter 3</a>,
so this chapter builds something that mimics real hardware more closely.
If you want to dive deeper,
have a look at <span class="ix-entry" ix-key="Nystrom, Bob" markdown="1"><a href="http://journal.stuffwithstuff.com/">Bob Nystrom’s</a></span>
<em><a href="https://craftinginterpreters.com/">Crafting Interpreters</a></em> <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Nystrom2021">Nystrom2021</a>]</span>,
or at the game <span class="ix-entry" ix-key="Human Resource Machine" markdown="1"><a href="https://tomorrowcorporation.com/humanresourcemachine">Human Resource Machine</a></span>.</p>
<h2 id="vm-arch">Section 15.1: Architecture</h2>
<p>Our <span class="ix-entry" ix-key="virtual machine" markdown="1"><a class="gl-ref" href="../glossary/#virtual_machine" markdown="1">virtual machine</a></span>
simulates a computer with three parts,
which are shown in <a class="fig-ref" href="../vm/#vm-architecture">Figure 15.1</a>:</p>
<ol>
<li>
<p>An <span class="ix-entry" ix-key="instruction pointer" markdown="1"><a class="gl-ref" href="../glossary/#instruction_pointer" markdown="1">instruction pointer</a></span> (IP)
    holds the memory address of the next instruction to execute.
    It is automatically initialized to point at address 0,
    which is where every program must start.
    This rule is part of the <span class="ix-entry" ix-key="Application Binary Interface" markdown="1"><a class="gl-ref" href="../glossary/#abi" markdown="1">Application Binary Interface</a></span> (ABI)
    for our virtual machine.</p>
</li>
<li>
<p>Four <span class="ix-entry" ix-key="register (in computer)" markdown="1"><a class="gl-ref" href="../glossary/#register" markdown="1">registers</a></span> named R0 to R3
    that instructions can access directly.
    There are no memory-to-memory operations in our VM:
    everything  happens in or through registers.</p>
</li>
<li>
<p>256 <a class="gl-ref" href="../glossary/#word_memory" markdown="1">words</a> of memory, each of which can store a single value.
    Both the program and its data live in this single block of memory;
    we chose the size 256 so that the address of each word will fit in a single byte.</p>
</li>
</ol>
<figure id="vm-architecture">
<img alt="Virtual machine architecture" src="./vm/vm_architecture.svg"/>
<figcaption markdown="1">Figure 15.1: Architecture of the virtual machine.</figcaption>
</figure>
<p>Our processor’s <span class="ix-entry" ix-key="instruction set" markdown="1"><a class="gl-ref" href="../glossary/#instruction_set" markdown="1">instruction set</a></span>
defines what it can do.
Instructions are just numbers,
but we will write them in a simple text format called
<span class="ix-entry" ix-key="assembly code" markdown="1"><a class="gl-ref" href="../glossary/#assembly_code" markdown="1">assembly code</a></span>
that gives those number human-readable names.</p>
<p>The instructions for our VM are 3 bytes long.
The <span class="ix-entry" ix-key="op code;virtual machine!op code" markdown="1"><a class="gl-ref" href="../glossary/#op_code" markdown="1">op code</a></span> fits in one byte,
and each instruction may optionally include one or two single-byte operands.
Each operand is a register identifier,
a constant,
or an address
(which is just a constant that identifies a location in memory).
Since constants have to fit in one byte,
this means that the largest number we can represent directly is 256.
<a class="tbl-ref" href="../vm/#vm-op-codes">Table 15.1</a> uses the letters <code>r</code>, <code>c</code>, and <code>a</code>
to indicate instruction format,
where <code>r</code> indicates a register identifier,
<code>c</code> indicates a constant,
and <code>a</code> indicates an address.</p>
<div class="table"><table id="vm-op-codes"><caption>Table 15.1: Virtual machine op codes</caption>
<thead>
<tr>
<th>Instruction</th>
<th>Code</th>
<th>Format</th>
<th>Action</th>
<th>Example</th>
<th>Equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hlt</code></td>
<td>1</td>
<td><code>--</code></td>
<td>Halt program</td>
<td><code>hlt</code></td>
<td><code>process.exit(0)</code></td>
</tr>
<tr>
<td><code>ldc</code></td>
<td>2</td>
<td><code>rc</code></td>
<td>Load immediate</td>
<td><code>ldc R0 123</code></td>
<td><code>R0 := 123</code></td>
</tr>
<tr>
<td><code>ldr</code></td>
<td>3</td>
<td><code>rr</code></td>
<td>Load register</td>
<td><code>ldr R0 R1</code></td>
<td><code>R0 := RAM[R1]</code></td>
</tr>
<tr>
<td><code>cpy</code></td>
<td>4</td>
<td><code>rr</code></td>
<td>Copy register</td>
<td><code>cpy R0 R1</code></td>
<td><code>R0 := R1</code></td>
</tr>
<tr>
<td><code>str</code></td>
<td>5</td>
<td><code>rr</code></td>
<td>Store register</td>
<td><code>str R0 R1</code></td>
<td><code>RAM[R1] := R0</code></td>
</tr>
<tr>
<td><code>add</code></td>
<td>6</td>
<td><code>rr</code></td>
<td>Add</td>
<td><code>add R0 R1</code></td>
<td><code>R0 := R0 + R1</code></td>
</tr>
<tr>
<td><code>sub</code></td>
<td>7</td>
<td><code>rr</code></td>
<td>Subtract</td>
<td><code>sub R0 R1</code></td>
<td><code>R0 := R0 - R1</code></td>
</tr>
<tr>
<td><code>beq</code></td>
<td>8</td>
<td><code>ra</code></td>
<td>Branch if equal</td>
<td><code>beq R0 123</code></td>
<td><code>if (R0 === 0) PC := 123</code></td>
</tr>
<tr>
<td><code>bne</code></td>
<td>9</td>
<td><code>ra</code></td>
<td>Branch if not equal</td>
<td><code>bne R0 123</code></td>
<td><code>if (R0 !== 0) PC := 123</code></td>
</tr>
<tr>
<td><code>prr</code></td>
<td>10</td>
<td><code>r-</code></td>
<td>Print register</td>
<td><code>prr R0</code></td>
<td><code>console.log(R0)</code></td>
</tr>
<tr>
<td><code>prm</code></td>
<td>11</td>
<td><code>r-</code></td>
<td>Print memory</td>
<td><code>prm R0</code></td>
<td><code>console.log(RAM[R0])</code></td>
</tr>
</tbody>
</table>
</div>
<p>To start building our virtual machine,
we put the VM’s details in a file
that can be loaded by other modules:</p>
<div class="code-sample lang-py" title="architecture.py">
<div class="highlight"><pre><span></span><code><span class="n">OPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"hlt"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"--"</span><span class="p">},</span>  <span class="c1"># Halt program</span>
    <span class="s2">"ldc"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rv"</span><span class="p">},</span>  <span class="c1"># Load immediate</span>
    <span class="s2">"ldr"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rr"</span><span class="p">},</span>  <span class="c1"># Load register</span>
    <span class="s2">"cpy"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rr"</span><span class="p">},</span>  <span class="c1"># Copy register</span>
    <span class="s2">"str"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rr"</span><span class="p">},</span>  <span class="c1"># Store register</span>
    <span class="s2">"add"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rr"</span><span class="p">},</span>  <span class="c1"># Add</span>
    <span class="s2">"sub"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rr"</span><span class="p">},</span>  <span class="c1"># Subtract</span>
    <span class="s2">"beq"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rv"</span><span class="p">},</span>  <span class="c1"># Branch if equal</span>
    <span class="s2">"bne"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"rv"</span><span class="p">},</span>  <span class="c1"># Branch if not equal</span>
    <span class="s2">"prr"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"r-"</span><span class="p">},</span>  <span class="c1"># Print register</span>
    <span class="s2">"prm"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">"fmt"</span><span class="p">:</span> <span class="s2">"r-"</span><span class="p">},</span>  <span class="c1"># Print memory</span>
<span class="p">}</span>

<span class="n">OP_MASK</span> <span class="o">=</span> <span class="mh">0xFF</span>  <span class="c1"># select a single byte</span>
<span class="n">OP_SHIFT</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># shift up by one byte</span>
<span class="n">OP_WIDTH</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># op width in characters when printing</span>

<span class="n">NUM_REG</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of registers</span>
<span class="n">RAM_LEN</span> <span class="o">=</span> <span class="mi">256</span>  <span class="c1"># number of words in RAM</span>
</code></pre></div>
</div>
<p class="continue">There isn’t a name for this design pattern,
but putting all the constants that define a system in one file
instead of scattering them across multiple files
makes them easier to find as well as ensuring consistency.</p>
<h2 id="vm-execute">Section 15.2: Execution</h2>
<p>As in previous chapters,
we will split a class that would normally be written in one piece into several parts for exposition.
We start by defining a class with an instruction pointer, some registers, and some memory
along with a prompt for output:</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">architecture</span> <span class="kn">import</span> <span class="n">NUM_REG</span><span class="p">,</span> <span class="n">OP_MASK</span><span class="p">,</span> <span class="n">OP_SHIFT</span><span class="p">,</span> <span class="n">RAM_LEN</span>

<span class="n">COLUMNS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">DIGITS</span> <span class="o">=</span> <span class="mi">8</span>


<span class="k">class</span> <span class="nc">VirtualMachineBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">"&gt;&gt;"</span>



<span class="c1"># [main]</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">VirtualMachineBase</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="c1"># [/main]</span>
</code></pre></div>
</div>
<p>A program is just an array of numbers representing instructions.
To load one,
we copy those numbers into memory and reset the instruction pointer and registers:</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">program</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">RAM_LEN</span><span class="p">,</span> <span class="s2">"Program is too long for memory"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ram</span> <span class="o">=</span> <span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">program</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RAM_LEN</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">NUM_REG</span>
</code></pre></div>
</div>
<p>To handle the next instruction,
the VM gets the value in memory that the instruction pointer currently refers to
and moves the instruction pointer on by one address.
It then uses <span class="ix-entry" ix-key="bitwise operation" markdown="1"><a class="gl-ref" href="../glossary/#bitwise_operation" markdown="1">bitwise operations</a></span>
(<a class="x-ref" href="#binary">Chapter 7</a>)
to extract the op code and operands from the instruction
(<a class="fig-ref" href="../vm/#vm-unpacking">Figure 15.2</a>):</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">)</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">"Program counter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2"> out of range 0..</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">)</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">instruction</span> <span class="o">&amp;</span> <span class="n">OP_MASK</span>
        <span class="n">instruction</span> <span class="o">&gt;&gt;=</span> <span class="n">OP_SHIFT</span>
        <span class="n">arg0</span> <span class="o">=</span> <span class="n">instruction</span> <span class="o">&amp;</span> <span class="n">OP_MASK</span>
        <span class="n">instruction</span> <span class="o">&gt;&gt;=</span> <span class="n">OP_SHIFT</span>
        <span class="n">arg1</span> <span class="o">=</span> <span class="n">instruction</span> <span class="o">&amp;</span> <span class="n">OP_MASK</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">]</span>
</code></pre></div>
</div>
<figure id="vm-unpacking">
<img alt="Unpacking instructions" src="./vm/vm_unpacking.svg"/>
<figcaption markdown="1">Figure 15.2: Using bitwise operations to unpack instructions.</figcaption>
</figure>
<div class="callout">
<h3>Semi-realistic</h3>
<p>We always unpack two operands regardless of whether the instructions has them or not,
since this is what a hardware implementation would be.
We have also included assertions in our VM
to simulate the way that real hardware includes logic
to detect illegal instructions and out-of-bound memory addresses.</p>
</div>
<p>The next step is to add a <code>run</code> method to our VM.
This method runs the program by fetching instructions and executing them until told to stop:</p>
<div class="code-sample lang-py" title="vm.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">architecture</span> <span class="kn">import</span> <span class="n">OPS</span>
<span class="kn">from</span> <span class="nn">vm_base</span> <span class="kn">import</span> <span class="n">VirtualMachineBase</span>


<span class="k">class</span> <span class="nc">VirtualMachine</span><span class="p">(</span><span class="n">VirtualMachineBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
            <span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"hlt"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"ldc"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg1</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown op </span><span class="si">{</span><span class="n">op</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">assert_is_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Invalid register </span><span class="si">{</span><span class="n">reg</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">assert_is_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Invalid register </span><span class="si">{</span><span class="n">addr</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">"</span>


<span class="c1"># [main]</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">VirtualMachine</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="c1"># [/main]</span>
</code></pre></div>
</div>
<p>Some instructions are very similar to others,
so we will only look at three here.
The first, <code>str</code>, stores the value of one register in the address held by another register:</p>
<div class="code-sample lang-py" title="vm.py">
<div class="highlight"><pre><span></span><code>            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"str"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg0</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">Its first three lines check that the operation is legal;
the fourth one uses the value in one register as an address,
which is why it has nested array indexing.</p>
<p>Adding the value in one register to the value in another register is simpler:</p>
<div class="code-sample lang-py" title="vm.py">
<div class="highlight"><pre><span></span><code>            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"add"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg1</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">as is jumping to a fixed address if the value in a register is zero:</p>
<div class="code-sample lang-py" title="vm.py">
<div class="highlight"><pre><span></span><code>            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"beq"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_address</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">arg1</span>
</code></pre></div>
</div>
<p class="continue">This <a class="gl-ref" href="../glossary/#conditional_jump" markdown="1">conditional jump</a> instruction is how
we will implement <code>if</code>.</p>
<h2 id="vm-assembly">Section 15.3: Assembly Code</h2>
<p>We could write out numerical op codes by hand,
just like <a href="http://eniacprogrammers.org/">the first programmers</a> did.
However,
it is much easier to use an <span class="ix-entry" ix-key="assembler" markdown="1"><a class="gl-ref" href="../glossary/#assembler" markdown="1">assembler</a></span>,
which is just a small compiler for a language
that very closely represents actual machine instructions.</p>
<p>Each command in our assembly languages matches an instruction in the VM.
Here’s an assembly language program to print the value stored in R1 and then halt:</p>
<div class="code-sample lang-as" title="print_r1.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Print</span><span class="w"> </span><span class="nx">initial</span><span class="w"> </span><span class="nx">contents</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">R1</span><span class="p">.</span><span class="w"></span>
<span class="nx">prr</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Its numeric representation (in hexadecimal) is:</p>
<div class="code-sample lang-mx" title="print_r1.mx">
<div class="highlight"><pre><span></span><code>00010a
000001
</code></pre></div>
</div>
<p>One thing the assembly language has that the instruction set doesn’t
is <span class="ix-entry" ix-key="label (on address)" markdown="1"><a class="gl-ref" href="../glossary/#label_address" markdown="1">labels on addresses</a></span>.
A label like <code>loop</code> doesn’t take up any space;
instead,
it tells the assembler to give the address of the next instruction a name
so that we can refer to that address as <code>@loop</code> in jump instructions.
For example,
this program prints the numbers from 0 to 2
(<a class="fig-ref" href="../vm/#vm-count-up">Figure 15.3</a>):</p>
<div class="code-sample lang-as" title="count_up.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Count</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R0</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R1</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">limit</span><span class="p">.</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nx">loop</span><span class="o">:</span><span class="w"></span>
<span class="nx">prr</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R2</span><span class="w"></span>
<span class="nx">cpy</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">sub</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">bne</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="err">@</span><span class="nx">loop</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-mx" title="count_up.mx">
<div class="highlight"><pre><span></span><code>000002
030102
00000a
010202
020006
010204
000207
020209
000001
</code></pre></div>
</div>
<figure id="vm-count-up">
<img alt="Counting from 0 to 2" src="./vm/vm_count_up.svg"/>
<figcaption markdown="1">Figure 15.3: Flowchart of assembly language program to count up from 0 to 2.</figcaption>
</figure>
<p>Let’s trace this program’s execution
(<a class="fig-ref" href="../vm/#vm-count-trace">Figure 15.4</a>):</p>
<ol>
<li>R0 holds the current loop index.</li>
<li>R1 holds the loop’s upper bound (in this case 3).</li>
<li>The loop prints the value of R0 (one instruction).</li>
<li>The program adds 1 to R0.
    This takes two instructions because we can only add register-to-register.</li>
<li>It checks to see if we should loop again,
    which takes three instructions.</li>
<li>If the program <em>doesn’t</em> jump back, it halts.</li>
</ol>
<figure id="vm-count-trace">
<img alt="Trace counting program" src="./vm/vm_count_trace.svg"/>
<figcaption markdown="1">Figure 15.4: Tracing registers and memory values for a simple counting program.</figcaption>
</figure>
<p>The implementation of the assembler mirrors the simplicity of assembly language.
The main method gets interesting lines,
finds the addresses of labels,
and turns each remaining line into an instruction:</p>
<div class="code-sample lang-py" title="assembler.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_labels</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_label</span><span class="p">(</span><span class="n">ln</span><span class="p">)]</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">]</span>
        <span class="n">program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions_to_text</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">program</span>

    <span class="k">def</span> <span class="nf">clean_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_comment</span><span class="p">(</span><span class="n">ln</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">is_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To find labels,
we go through the lines one by one
and either save the label <em>or</em> increment the current address
(because labels don’t take up space):</p>
<div class="code-sample lang-py" title="assembler.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">find_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_label</span><span class="p">(</span><span class="n">ln</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">ln</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Duplicate label </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">"</span>
                <span class="n">result</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loc</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">is_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To compile a single instruction we break the line into tokens,
look up the format for the operands,
and pack the values:</p>
<div class="code-sample lang-py" title="assembler.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">op</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">assert</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPS</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown operation </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">"</span>

        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"fmt"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"--"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"code"</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"fmt"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"r-"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"code"</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"fmt"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"rr"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"fmt"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"rv"</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown instruction format </span><span class="si">{</span><span class="n">OPS</span><span class="p">[</span><span class="n">op</span><span class="p">][</span><span class="s1">'fmt'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p class="continue">Combining op codes and operands into a single value
is the reverse of the unpacking done by the virtual machine:</p>
<div class="code-sample lang-py" title="assembler.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"Cannot combine no arguments"</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="n">OP_SHIFT</span>
            <span class="n">result</span> <span class="o">|=</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>Finally, we need few utility functions:</p>
<div class="code-sample lang-py" title="assembler.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">instructions_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">op</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">program</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"R"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Register '</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">' does not start with 'R'"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">NUM_REG</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Illegal register </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"@"</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="n">lbl</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">assert</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown label '</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">'"</span>
        <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">lbl</span><span class="p">]</span>
</code></pre></div>
</div>
<p>Let’s try assembling a program and display its output,
the registers,
and the interesting contents of memory.
As a test,
this program counts up to three:</p>
<div class="code-sample lang-as" title="count_up.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Count</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R0</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R1</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">limit</span><span class="p">.</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nx">loop</span><span class="o">:</span><span class="w"></span>
<span class="nx">prr</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R2</span><span class="w"></span>
<span class="nx">cpy</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">sub</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">bne</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="err">@</span><span class="nx">loop</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="count_up.out">
<div class="highlight"><pre><span></span><code>&gt;&gt; 0
&gt;&gt; 1
&gt;&gt; 2
R000000 = 000003
R000001 = 000003
R000002 = 000000
R000003 = 000000
000000:   000002  030102  00000a  010202
000004:   020006  010204  000207  020209
000008:   000001  000000  000000  000000
</code></pre></div>
</div>
<h2>Arrays</h2>
<p>It is tedious to write interesting programs when each value needs a unique name.
We can do a lot more once we have collections like <span class="ix-entry" ix-key="array!implementation of" markdown="1">arrays</span>,
so let’s add those to our assembler.
We don’t have to make any changes to the virtual machine,
which doesn’t care if we think of a bunch of numbers as individuals or elements of an array,
but we do need a way to create arrays and refer to them.</p>
<p>We will allocate storage for arrays at the end of the program
by using <code>.data</code> on a line of its own to mark the start of the data section
and then <code>label: number</code> to give a region a name and allocate some storage space
(<a class="fig-ref" href="../vm/#vm-array">Figure 15.5</a>).</p>
<figure id="vm-array">
<img alt="Array storage allocation" src="./vm/vm_array.svg"/>
<figcaption markdown="1">Figure 15.5: Allocating storage for arrays in the virtual machine.</figcaption>
</figure>
<p>This enhancement only requires a few changes to the assembler.
First,
we need to split the lines into instructions and data allocations:</p>
<div class="code-sample lang-py" title="data_allocator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">to_compile</span><span class="p">,</span> <span class="n">to_allocate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_allocations</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_labels</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">to_compile</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_label</span><span class="p">(</span><span class="n">ln</span><span class="p">)]</span>
        <span class="n">base_of_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_allocations</span><span class="p">(</span><span class="n">base_of_data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">to_allocate</span><span class="p">)</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">]</span>
        <span class="n">program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions_to_text</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">program</span>

    <span class="k">def</span> <span class="nf">split_allocations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">DIVIDER</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">split</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="n">split</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="p">[]</span>
</code></pre></div>
</div>
<p>Second,
we need to figure out where each allocation lies and create a label accordingly:</p>
<div class="code-sample lang-py" title="data_allocator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">add_allocations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_of_data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">to_allocate</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">alloc</span> <span class="ow">in</span> <span class="n">to_allocate</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Invalid allocation directive '</span><span class="si">{</span><span class="n">alloc</span><span class="si">}</span><span class="s2">'"</span>
            <span class="n">lbl</span><span class="p">,</span> <span class="n">num_words_text</span> <span class="o">=</span> <span class="n">fields</span>
            <span class="k">assert</span> <span class="n">lbl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Duplicate label '</span><span class="si">{</span><span class="n">lbl</span><span class="si">}</span><span class="s2">' in allocation"</span>
            <span class="n">num_words</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_words_text</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">base_of_data</span> <span class="o">+</span> <span class="n">num_words</span>
            <span class="p">)</span> <span class="o">&lt;</span> <span class="n">RAM_LEN</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Allocation '</span><span class="si">{</span><span class="n">lbl</span><span class="si">}</span><span class="s2">' requires too much memory"</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">lbl</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_of_data</span>
            <span class="n">base_of_data</span> <span class="o">+=</span> <span class="n">num_words</span>
</code></pre></div>
</div>
<p>And that’s it:
no other changes are needed to either compilation or execution.
To test it,
let’s fill an array with the numbers from 0 to 3:</p>
<div class="code-sample lang-as" title="fill_array.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Count</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R0</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R1</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">limit</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R2</span><span class="o">:</span><span class="w"> </span><span class="nx">array</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R3</span><span class="o">:</span><span class="w"> </span><span class="nx">temporary</span><span class="p">.</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="err">@</span><span class="nx">array</span><span class="w"></span>
<span class="nx">loop</span><span class="o">:</span><span class="w"></span>
<span class="nx">str</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R2</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R3</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R3</span><span class="w"></span>
<span class="nx">cpy</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">sub</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">bne</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="err">@</span><span class="nx">loop</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
<span class="p">.</span><span class="nx">data</span><span class="w"></span>
<span class="nx">array</span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="fill_array.out">
<div class="highlight"><pre><span></span><code>R000000 = 000003
R000001 = 000003
R000002 = 00000e
R000003 = 000000
000000:   000002  030102  0b0202  020005
000004:   010302  030006  030206  010304
000008:   000307  030309  000001  000000
00000c:   000001  000002  000000  000000
</code></pre></div>
</div>
<div class="callout">
<h3>How does it actually work?</h3>
<p>Our VM is just another program.
If you’d like to know what happens when instructions finally meet hardware,
and how electrical circuits are able to do arithmetic,
make decisions,
and talk to the world,
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Patterson2017">Patterson2017</a>]</span> has everything you want to know and more.</p>
</div>
<h2 id="vm-summary">Section 15.5: Summary</h2>
<figure id="vm-concept-map">
<img alt="Concept map for virtual machine and assembler" src="./vm/vm_concept_map.svg"/>
<figcaption markdown="1">Figure 15.6: Concept map for virtual machine and assembler.</figcaption>
</figure>
<h2 id="vm-exercises">Section 15.6: Exercises</h2>
<h3 class="exercise">Swapping values</h3>
<p>Write an assembly language program that swaps the values in R1 and R2
without affecting the values in other registers.</p>
<h3 class="exercise">Reversing an array</h3>
<p>Write an assembly language program that starts with:</p>
<ul>
<li>the base address of an array in one word</li>
<li>the length of the array N in the next word</li>
<li>N values immediately thereafter</li>
</ul>
<p class="continue">and reverses the array in place.</p>
<h3 class="exercise">Increment and decrement</h3>
<ol>
<li>
<p>Add instructions <code>inc</code> and <code>dec</code> that add one to the value of a register
    and subtract one from the value of a register respectively.</p>
</li>
<li>
<p>Rewrite the examples to use these instructions.
    How much shorter do they make the programs?
    How much easier to read?</p>
</li>
</ol>
<h3 class="exercise">Using long addresses</h3>
<ol>
<li>
<p>Modify the virtual machine so that the <code>ldr</code> and <code>str</code> instructions
    contain 16-bit addresses rather than 8-bit addresses
    and increase the virtual machine’s memory to 64K words to match.</p>
</li>
<li>
<p>How does this complicate instruction interpretation?</p>
</li>
</ol>
<h3 class="exercise">Operating on strings</h3>
<p>The C programming language stored character strings as non-zero bytes terminated by a byte containing zero.</p>
<ol>
<li>
<p>Write a program that starts with the base address of a string in R1
    and finishes with the length of the string (not including the terminator) in the same register.</p>
</li>
<li>
<p>Write a program that starts with the base address of a string in R1
    and the base address of some other block of memory in R2
    and copies the string to that new location (including the terminator).</p>
</li>
<li>
<p>What happens in each case if the terminator is missing?</p>
</li>
</ol>
<h3 class="exercise">Call and return</h3>
<ol>
<li>
<p>Add another register to the virtual machine called SP (for “stack pointer”)
    that is automatically initialized to the <em>last</em> address in memory.</p>
</li>
<li>
<p>Add an instruction <code>psh</code> (short for “push”) that copies a value from a register
    to the address stored in SP and then subtracts one from SP.</p>
</li>
<li>
<p>Add an instruction <code>pop</code> (short for “pop”) that adds one to SP
    and then copies a value from that address into a register.</p>
</li>
<li>
<p>Using these instructions,
    write a subroutine that evaluates <code>2x+1</code> for every value in an array.</p>
</li>
</ol>
<h3 class="exercise">Disassembling instructions</h3>
<p>A <a class="gl-ref" href="../glossary/#disassembler" markdown="1">“disassembler</a> turns machine instructions into assembly code.
Write a disassembler for the instruction set used by our virtual machine.
(Since the labels for addresses are not stored in machine instructions,
disassemblers typically generate labels like <code>@L001</code> and <code>@L002</code>.)</p>
<h3 class="exercise">Linking multiple files</h3>
<ol>
<li>
<p>Modify the assembler to handle <code>.include filename</code> directives.</p>
</li>
<li>
<p>What does your modified assembler do about duplicate label names?
    How does it prevent infinite includes
    (i.e., <code>A.as</code> includes <code>B.as</code> which includes <code>A.as</code> again)?</p>
</li>
</ol>
<h3 class="exercise">Providing system calls</h3>
<p>Modify the virtual machine so that developers can add “system calls” to it.</p>
<ol>
<li>
<p>On startup,
    the virtual machine loads an array of functions defined in a file called <code>syscalls.py</code>.</p>
</li>
<li>
<p>The <code>sys</code> instruction takes a one-byte constant argument.
    It looks up the corresponding function and calls it with the values of R0-R3 as parameters
    and places the result in R0.</p>
</li>
</ol>
<h3 class="exercise">Unit testing</h3>
<ol>
<li>
<p>Write unit tests for the assembler.</p>
</li>
<li>
<p>Once they are working,
    write unit tests for the virtual machine.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="debugger">Chapter: Chapter 16: A Debugger</h1>

<ul class="syllabus">
<li markdown="1">Interactive programs can be tested by simulating input and recording output.</li>
<li markdown="1">Testing interactive programs is easier if their inputs and outputs can easily be replaced with mock objects.</li>
<li markdown="1">Debuggers usually implement breakpoints by temporarily replacing actual instructions with special ones.</li>
<li markdown="1">Using lookup tables for function or method dispatch makes programs easier to extend.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#breakpoint" markdown="1">breakpoint</a>, <a class="gl-ref" href="../glossary/#clear_breakpoint" markdown="1">clear a breakpoint</a>, <a class="gl-ref" href="../glossary/#conditional_breakpoint" markdown="1">conditional breakpoint</a>, <a class="gl-ref" href="../glossary/#disassemble" markdown="1">disassemble</a>, <a class="gl-ref" href="../glossary/#enumeration" markdown="1">enumeration</a>, <a class="gl-ref" href="../glossary/#reverse_lookup" markdown="1">reverse lookup</a>, <a class="gl-ref" href="../glossary/#upcall" markdown="1">upcall</a>, <a class="gl-ref" href="../glossary/#watchpoint" markdown="1">watchpoint</a>
</p>
<div class="page-toc"></div>
<p>We have finally come to another of the questions that sparked this book:
how does a <span class="ix-entry" ix-key="debugger" markdown="1">debugger</span> work?
Debuggers are as much a part of good programmers’ lives as version control
but are taught far less often
(in part, we believe, because it’s harder to create homework questions for them).
This chapter builds a simple single-stepping debugger
for the virtual machine in <a class="x-ref" href="#vm">Chapter 15</a>
and shows how we can test interactive applications.</p>
<p>Before we start work,
let’s consolidate and reorganize the code in our virtual machine.
The methods all work as they did before,
but we’ve made a few changes to allow for future growth.
The first is to pass an output stream to the constructor,
which by default will be <code>sys.stdout</code>:</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">"""Set up memory."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">([])</span>
</code></pre></div>
</div>
<p>We then replace every <code>print</code> statement with
a call to new method called <code>write</code>.
For example,
the “print register” instruction calls <code>self.write</code>:</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code>        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"prr"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_is_register</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">[</span><span class="n">arg0</span><span class="p">]</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>For now,
<code>write</code> just prints things to whatever output stream the VM was given:</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="debugger-step">Section 16.1: One Step at a Time</h2>
<p>The virtual machine we’re starting from loads a program and runs it to completion,
so it’s either running or finished.
We want to add a third state for single-step execution,
so let’s start by adding an <a class="gl-ref" href="../glossary/#enumeration" markdown="1">enumeration</a> to <code>architecture.py</code>:</p>
<div class="code-sample lang-py" title="architecture.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VMState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">"""Virtual machine states."""</span>
    <span class="n">FINISHED</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">STEPPING</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>
</div>
<p class="continue">We could use strings to keep track of states,
but as soon as there are more than two there are likely to be many,
and having them spelled out makes it easier for the next person
to find out what they can be.</p>
<p>The old <code>run</code> method kept going until the program finished.
The new <code>run</code> method is necessarily more complicated.
The VM is initially in the <code>STEPPING</code> state
(because if we start it in the <code>RUNNING</code> state
we would never have an opportunity to interact with it
to change its state).
As long as the program isn’t finished
we fetch, decode, and execute the next instruction as usual,
but stop after each one if we’re single-stepping:</p>
<div class="code-sample lang-py" title="vm_step.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VMState</span><span class="o">.</span><span class="n">STEPPING</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">VMState</span><span class="o">.</span><span class="n">STEPPING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">VMState</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The interaction method needs to handle several cases:</p>
<ol>
<li>
<p>The user enters an empty line (i.e., presses return),
    in which case it loops around and waits for something else.</p>
</li>
<li>
<p>The user asks to <a class="gl-ref" href="../glossary/#disassemble" markdown="1">disassemble</a> the current instruction
    or show the contents of memory,
    in which case it does that and loops around.</p>
</li>
<li>
<p>The user wants to quit,
    so <code>interact</code> changes the VM’s state to <code>FINISHED</code>.</p>
</li>
<li>
<p>The user wants to run the rest of the program without stopping,
    so <code>interact</code> changes VM’s state to <code>RUNNING</code>.</p>
</li>
<li>
<p>The user wants to execute a single step,
    in which case the method breaks out of the loop
    without changing the VM’s state.
    <code>run</code> will then see that the VM is still in single-stepping mode
    and execute a single instruction.</p>
</li>
</ol>
<p>The method that disassembles an instruction to show us what we’re about to do
checks a <a class="gl-ref" href="../glossary/#reverse_lookup" markdown="1">reverse lookup table</a>
to create a printable representation of an instruction and its operands:</p>
<div class="code-sample lang-py" title="vm_step.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">disassemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPS_LOOKUP</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Unknown op code </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">OPS_LOOKUP</span><span class="p">[</span><span class="n">op</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">arg0</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">arg1</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>
</div>
<p class="continue">We build the reverse lookup table from the <code>OPS</code> table in <code>architecture.py</code>
so that it’s always in sync with the table we’re using to construct operations
(<a class="fig-ref" href="../debugger/#debugger-table">Figure 16.1</a>).
If we wrote the reverse lookup table ourselves,
sooner or later we’d forget to update it when updating the forward lookup table:</p>
<div class="code-sample lang-py" title="vm_step.py">
<div class="highlight"><pre><span></span><code><span class="n">OPS_LOOKUP</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">[</span><span class="s2">"code"</span><span class="p">]:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">OPS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div>
</div>
<figure id="debugger-table">
<img alt="Building a consistent lookup table" src="./debugger/debugger_table.svg"/>
<figcaption markdown="1">Figure 16.1: Building a consistent lookup table.</figcaption>
</figure>
<p>But there’s a more important change in this new virtual machine.
It doesn’t use Python’s built-in <code>input</code> function to get input from the user—or rather,
it does,
but only by default.
The constructor for our single-stepping VM is:</p>
<div class="code-sample lang-py" title="vm_step.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span>
</code></pre></div>
</div>
<p class="continue">and its <code>read</code> method is:</p>
<div class="code-sample lang-py" title="vm_step.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>
</div>
<p>As with the <code>write</code> method introduced in the previous section,
adding this wrapper method will help us with testing,
which is our next topic.</p>
<h2 id="debugger-test">Section 16.2: Testing</h2>
<p>Our debugger is an interactive application
that waits for input from the user,
does something that may or may not print output,
then waits again.
The waiting is a problem for tools like <a href="https://docs.pytest.org/">pytest</a>,
which expect the function being tested to run to completion after being launched.</p>
<p>To make our single-stepping VM testable,
we have to give it input when it wants some
and capture its output for later inspection.
We had a similar problem when testing the web server of <a class="x-ref" href="#server">Chapter 11</a>,
and our solution is the similar:
we will replace <code>input</code> and <code>print</code> with <span class="ix-entry" ix-key="mock object" markdown="1">mock objects</span>.</p>
<p>As shown earlier,
our VM uses an object with a <code>write</code> method to produce output:</p>
<div class="code-sample lang-py" title="vm_base.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We can define a class that provides this method,
but which saves messages in a list for later inspection
instead of printing them:</p>
<div class="code-sample lang-py" title="test_vm.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Writer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Similarly,
our VM gets input from a function that takes a prompt as an argument
and returns whatever the user typed.
We can define a class with a <code>__call__</code> method that acts like such a function,
but which returns strings from a list instead of waiting for the user:</p>
<div class="code-sample lang-py" title="test_vm.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Reader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div>
</div>
<p>With these in hand,
we can write a helper function that compiles a program,
creates a virtual machine,
and runs it with a mock reader and a mock writer:</p>
<div class="code-sample lang-py" title="test_vm.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
    <span class="n">program</span> <span class="o">=</span> <span class="n">Assembler</span><span class="p">()</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="n">VM</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We are now ready to start writing tests.
Here’s one that checks the debugger’s “disassemble” command:</p>
<div class="code-sample lang-py" title="test_vm.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_disassemble</span><span class="p">():</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    hlt</span>
<span class="s2">    """</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="s2">"q"</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">()</span>
    <span class="n">execute</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">writer</span><span class="o">.</span><span class="n">seen</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"hlt | 0 | 0</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">Line by line, it:</p>
<ol>
<li>
<p>Creates the program to test
    (which in this case consists of a single <code>htl</code> instruction).</p>
</li>
<li>
<p>Creates a <code>Reader</code> that will supply the commands <code>"d"</code> (for “disassemble”)
    and <code>"q"</code> (for “quit”) in that order.</p>
</li>
<li>
<p>Creates a <code>Writer</code> to capture the program’s output.</p>
</li>
<li>
<p>Runs the program in a fresh VM with that reader and writer.</p>
</li>
<li>
<p>Checks that the output captured in the writer is correct.</p>
</li>
</ol>
<p>Defining two classes and a helper function to test a one-line program
may seem like a lot of work,
but we’re not testing the one-line program or the VM:
we’re testing the debugger.
For example,
the reader in the test below
issues three <code>"s"</code> (single-step) commands and then a <code>"q"</code> command:</p>
<div class="code-sample lang-py" title="test_vm.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_print_two_values</span><span class="p">():</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    ldc R0 55</span>
<span class="s2">    prr R0</span>
<span class="s2">    ldc R0 65</span>
<span class="s2">    prr R0</span>
<span class="s2">    hlt</span>
<span class="s2">    """</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="s2">"s"</span><span class="p">,</span> <span class="s2">"s"</span><span class="p">,</span> <span class="s2">"s"</span><span class="p">,</span> <span class="s2">"q"</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">()</span>
    <span class="n">execute</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">writer</span><span class="o">.</span><span class="n">seen</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">"000037</span><span class="se">\n</span><span class="s2">"</span>
    <span class="p">]</span>
</code></pre></div>
</div>
<p>In response,
the debugger steps through the first three instructions
and then stops the VM before it can execute the second print instruction.
This test actually uncovered a bug in an earlier version of the debugger
in which it would always execute one more instruction when told to quit.
Interactive testing might have spotted that,
but it could easily reappear;
this test will warn us if it does.</p>
<p>Our <code>Reader</code> and <code>Writer</code> aren’t good for much beyond testing our VM,
but there are other tools that can simulate input and output
for a wider range of applications.
<a href="https://en.wikipedia.org/wiki/Expect">Expect</a> (which can be used through Python’s <a href="https://pexpect.readthedocs.io/">pexpect</a> module)
is often used to script command-line applications
as well as to test them.
<a href="https://www.selenium.dev/">Selenium</a> and <a href="https://www.cypress.io/">Cypress</a> do the same for browser-based applications:
programmers can use them to simulate mouse clicks,
window resizing,
and other events,
then check the contents of the page that the application produces in response.
They are all more difficult to set up and use than a simple test that 1+1 is 2,
but that’s because the things they do are genuinely complex.
Designing applications with testing in mind—for example,
routing all input and output through a single method each—helps
reduce that complexity.</p>
<h2 id="debugger-extensibility">Section 16.3: Extensibility</h2>
<p>We are going to add one more big feature to our debugger,
but before we do,
let’s do some <span class="ix-entry" ix-key="refactor" markdown="1">refactoring</span>.
First,
we move every interactive operation into a method of its own
that does something
and then returns <code>True</code> if the debugger is supposed to stay
in interactive mode
and <code>False</code> if interaction is over.
The method for showing the contents of memory is:</p>
<div class="code-sample lang-py" title="vm_extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_do_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p class="continue">while the one for advancing one step is:</p>
<div class="code-sample lang-py" title="vm_extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_do_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VMState</span><span class="o">.</span><span class="n">STEPPING</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
</div>
<p>and so on.
Once that’s done,
we modify <code>interact</code> to choose operations from a lookup table
called <code>self.handlers</code>.
Its keys are the commands typed by the user
and its values are the operation methods we just created:</p>
<div class="code-sample lang-py" title="vm_extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">({</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">}))</span>
        <span class="n">interacting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">interacting</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">addr</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">]&gt; "</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown command </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">interacting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VMState</span><span class="o">.</span><span class="n">FINISHED</span>
                <span class="n">interacting</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
</div>
<p>Finally,
we extend the virtual machine’s constructor
to build the required lookup table.
For convenience,
we register the methods under both single-letter keys
and longer command names:</p>
<div class="code-sample lang-py" title="vm_extend.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"d"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_disassemble</span><span class="p">,</span>
            <span class="s2">"dis"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_disassemble</span><span class="p">,</span>
            <span class="s2">"i"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_ip</span><span class="p">,</span>
            <span class="s2">"ip"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_ip</span><span class="p">,</span>
            <span class="s2">"m"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_memory</span><span class="p">,</span>
            <span class="s2">"memory"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_memory</span><span class="p">,</span>
            <span class="s2">"q"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_quit</span><span class="p">,</span>
            <span class="s2">"quit"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_quit</span><span class="p">,</span>
            <span class="s2">"r"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_run</span><span class="p">,</span>
            <span class="s2">"run"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_run</span><span class="p">,</span>
            <span class="s2">"s"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_step</span><span class="p">,</span>
            <span class="s2">"step"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_step</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div>
</div>
<p>As in previous chapters,
creating a lookup table like this makes the class easier to extend.
If we want to add another command
(which we will do in the next section)
we just add a method to perform the operation
and register it in the lookup table.
So long as new commands don’t need anything more than
the address of the current instruction,
we never need to modify <code>interact</code> again.</p>
<h2 id="debugger-breakpoints">Section 16.4: Breakpoints</h2>
<p>Suppose we suspect there’s a bug in our program
that only occurs after several thousand lines of code have been executed.
We would have to be pretty desperate to single-step through all of that even once,
much less dozens of times as we’re exploring new ideas or trying new fixes.
Instead,
we want to set a <span class="ix-entry" ix-key="breakpoint" markdown="1"><a class="gl-ref" href="../glossary/#breakpoint" markdown="1">breakpoint</a></span>
to tell the computer to stop at a particular location
and drop us into the debugger.
(We might even use
a <span class="ix-entry" ix-key="conditional breakpoint" markdown="1"><a class="gl-ref" href="../glossary/#conditional_breakpoint" markdown="1">conditional breakpoint</a></span>
that would only stop if (for example)
the variable <code>x</code> was zero at that point,
but we’ll leave that for the exercises.)</p>
<p>The easiest way to implement breakpoints would be
to have the VM store their addresses in a set.
We would then modify <code>run</code> to check that set
each time it was supposed to fetch a new instruction,
and stop if it was at one of those addresses
(<a class="fig-ref" href="../debugger/#debugger-beside">Figure 16.2</a>).</p>
<figure id="debugger-beside">
<img alt="Storing breakpoint addresses beside the program" src="./debugger/debugger_beside.svg"/>
<figcaption markdown="1">Figure 16.2: Storing breakpoints beside the program.</figcaption>
</figure>
<p>Instead of doing this,
we will add a new instruction to our architecture called <code>brk</code>.
When the user sets a breakpoint at some address,
we replace the instruction at that address with a breakpoint instruction
and store the original instruction in a lookup table.
If the user later
<span class="ix-entry" ix-key="clear (a breakpoint); breakpoint!clear" markdown="1"><a class="gl-ref" href="../glossary/#clear_breakpoint" markdown="1">clears</a></span>
the breakpoint,
we copy the original instruction back into place,
and if the VM encounters a breakpoint instruction while its running,
it drops into interactive mode
(<a class="fig-ref" href="../debugger/#debugger-break">Figure 16.3</a>).</p>
<figure id="debugger-break">
<img alt="Inserting breakpoint instructions" src="./debugger/debugger_break.svg"/>
<figcaption markdown="1">Figure 16.3: Inserting breakpoints into a program.</figcaption>
</figure>
<p>Putting breakpoints inline is more complicated than storing them beside the program,
but it is how debuggers for low-level languages like C actually work.
It also makes the virtual machine more efficient:
instead of spending a few (actual) instructions checking a breakpoint table
every time we execute an instruction,
we only pay a price when we actually encounter a breakpoint.
The difference isn’t important in our little toy,
but little savings like this add up quickly
in a real interpreter for a language like Python or JavaScript.</p>
<p>The first step in implementing breakpoints is
to add two more commands to the lookup table
we created in the previous section:</p>
<div class="code-sample lang-py" title="vm_break.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">|=</span> <span class="p">{</span>
            <span class="s2">"b"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_add_breakpoint</span><span class="p">,</span>
            <span class="s2">"break"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_add_breakpoint</span><span class="p">,</span>
            <span class="s2">"c"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_clear_breakpoint</span><span class="p">,</span>
            <span class="s2">"clear"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_clear_breakpoint</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div>
</div>
<p>To add a breakpoint,
we copy the instruction at the given address
into the dictionary <code>self.breaks</code>
and replace it with a breakpoint instruction:</p>
<div class="code-sample lang-py" title="vm_break.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_do_add_breakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"brk"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="n">addr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Inconsistent breakpoint state for </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"brk"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p class="continue">Notice that if there’s already a breakpoint in place,
we don’t do anything.
We also return <code>True</code> to tell <code>interact</code>
to wait for another command from the user.</p>
<p>Clearing a breakpoint is just as easy:</p>
<div class="code-sample lang-py" title="vm_break.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_do_clear_breakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"brk"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="n">addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Inconsistent breakpoint state for </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p>We also update <code>show</code> to display any breakpoints that have been set:</p>
<div class="code-sample lang-py" title="vm_break.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">06x</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">disassemble</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">instruction</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Notice how the implementation first calls the parent’s <code>show</code> method
to display everything we’ve been displaying so far,
then adds a few lines to display extra information.
Extending methods by <span class="ix-entry" ix-key="upcall" markdown="1"><a class="gl-ref" href="../glossary/#upcall" markdown="1">upcalling</a></span> this way
saves us typing,
and ensures that changes in the parent class
will automatically show up in the child class.</p>
<p>The final step is to change the <code>run</code> method
so that the VM actually stops at a breakpoint.
The whole method is:</p>
<div class="code-sample lang-py" title="vm_break.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VMState</span><span class="o">.</span><span class="n">STEPPING</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">VMState</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span>
            <span class="n">instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>
            <span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">OPS</span><span class="p">[</span><span class="s2">"brk"</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]:</span>
                <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>
                <span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">VMState</span><span class="o">.</span><span class="n">STEPPING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Given everything we’ve done so far,
the logic is relatively straightforward.
If the instruction is a breakpoint,
the VM fetches and decodes the original from the breakpoint lookup table.
It then gives the user a chance to interact
before executing that original instruction.
If the instruction <em>isn’t</em> a breakpoint,
on the other hand,
the VM interacts with the user if it is in single-stepping mode,
and then carries on as before.</p>
<p>We can test our new-and-improved VM
using the tools developed earlier in this chapter,
but even before we do that,
the changes to <code>run</code> tell us that we should re-think some of our design.
Using a lookup table for interactive commands
allowed us to add commands without modifying <code>interact</code>;
another lookup table would enable us to add new instructions
without having to modify <code>run</code>.
We will explore this in the exercises.</p>
<h2 id="debugger-summary">Section 16.5: Summary</h2>
<figure id="debugger-concept-map">
<img alt="Concept map for debugger" src="./debugger/debugger_concept_map.svg"/>
<figcaption markdown="1">Figure 16.4: Concepts for debugger.</figcaption>
</figure>
<h2 id="debugger-exercises">Section 16.6: Exercises</h2>
<h3 class="exercise">Show memory range</h3>
<p>Modify the debugger so that if the user provides a single address to the <code>"memory"</code> command,
the debugger shows the value at that address,
while if the user provides two addresses,
the debugger shows all the memory between those addresses.</p>
<ol>
<li>
<p>How did this change the way command lookup and execution work?</p>
</li>
<li>
<p>Is your solution general enough to handle likely future changes without rewriting?</p>
</li>
</ol>
<h3 class="exercise">Breakpoint addresses</h3>
<p>Modify the debugger so that if the user provides a single address to the <code>"break"</code> or <code>"clear"</code> command,
it sets or clears the breakpoint at that address.
Did this feature require any changes beyond those made for the previous exercise?</p>
<h3 class="exercise">Command completion</h3>
<p>Modify the debugger to recognize commands based on any number of distinct leading characters.
For example,
any of <code>"m"</code>, <code>"me"</code>, <code>"mem"</code>, and so on should trigger the <code>_do_memory</code> method.
Programmers should <em>not</em> have to specify all these options themselves;
instead,
they should be able to specify the full command name and the method it corresponds to,
and the VM’s constructor should take care of the rest.</p>
<h3 class="exercise">Conditional breakpoints</h3>
<p>Modify the debugger so that users can specify conditions for breakpoints,
i.e.,
can specify that the VM should only stop at a location
if R0 contains zero
or if the value at a particular location in memory is greater than 3.
(This exercise is potentially very large;
you may restrict the kinds of conditions the user can set to make it more manageable,
or explore ways of using <code>eval</code> to support the general case.)</p>
<h3 class="exercise">Watchpoints</h3>
<p>Modify the debugger and VM so that the user can create
<span class="ix-entry" ix-key="watchpoints" markdown="1"><a class="gl-ref" href="../glossary/#watchpoint" markdown="1">watchpoints</a></span>,
i.e.,
can specify that the debugger should halt the VM
when the value at a particular address changes.
For example,
if the user specifies a watchpoint for address 0x0010,
then the VM automatically halts whenever a new value is stored at that location.</p>
<h3 class="exercise">Instruction lookup</h3>
<p>Modify the virtual machine so that <code>execute</code> looks up instructions in a table
in the same way as debugger commands.</p>
<h3 class="exercise">Changing memory</h3>
<p>Modify the debugger so that users can change the values in registers
or at particular addresses in memory while the program is running.</p>
<h3 class="exercise">Displaying source</h3>
<ol>
<li>
<p>Modify the debugger so that when the debugger is displaying memory,
    it shows the assembly code instructions corresponding to particular addresses
    as well as the numeric codes.</p>
</li>
<li>
<p>How can the debugger distinguish between locations that contain instructions
    and locations that contain data?</p>
</li>
</ol>
<h3 class="exercise">Interleaving testing</h3>
<p>Modify the testing tools developed in this chapter
so that users can specify input and output as they would naturally occur,
i.e.,
can specify one or more commands,
then the output expected from those commands,
then some more input and the corresponding output,
and so on.</p>
<h3 class="exercise">Pattern matching in tests</h3>
<ol>
<li>
<p>Tools like <a href="https://en.wikipedia.org/wiki/Expect">Expect</a> allow programmers to match output with regular expressions.
    Modify the testing tools developed in this chapter to do that as well.</p>
</li>
<li>
<p>When is this useful?
    When is it potentially dangerous?</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="dataframe">Chapter: Chapter 17: A Dataframe</h1>

<ul class="syllabus">
<li markdown="1">Create abstract base classes to specify interfaces.</li>
<li markdown="1">Store two-dimensional data as rows or as columns.</li>
<li markdown="1">Use reflection to match data to function parameters.</li>
<li markdown="1">Measure performance to evaluate engineering tradeoffs.</li>
</ul>
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#abstract_class" markdown="1">abstract class</a>, <a class="gl-ref" href="../glossary/#batch_processing" markdown="1">batch processing</a>, <a class="gl-ref" href="../glossary/#benchmark" markdown="1">benchmark</a>, <a class="gl-ref" href="../glossary/#column_wise" markdown="1">column-wise storage</a>, <a class="gl-ref" href="../glossary/#concrete_class" markdown="1">concrete class</a>, <a class="gl-ref" href="../glossary/#data_engineer" markdown="1">data engineer</a>, <a class="gl-ref" href="../glossary/#dataframe" markdown="1">dataframe</a>, <a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a>, <a class="gl-ref" href="../glossary/#immutable" markdown="1">immutable</a>, <a class="gl-ref" href="../glossary/#index_database" markdown="1">index (a database)</a>, <a class="gl-ref" href="../glossary/#join" markdown="1">join (tables)</a>, <a class="gl-ref" href="../glossary/#olap" markdown="1">online analytical processing</a>, <a class="gl-ref" href="../glossary/#oltp" markdown="1">online transaction processing</a>, <a class="gl-ref" href="../glossary/#parameter_sweeping" markdown="1">parameter sweeping</a>, <a class="gl-ref" href="../glossary/#row_wise" markdown="1">row-wise storage</a>, <a class="gl-ref" href="../glossary/#spread" markdown="1">spread</a>
</p>
<div class="page-toc"></div>
<p>One of the drawbacks of publishing a book online is that
it gives you an excuse to obsess over analytics.
How many people visited the site today?
Which pages did they look at, and for how long?</p>
<p>Whether your analysis tool of choice is Python, R, SQL, or Excel,
you’re almost certainly working with tables
with named columns that have the same type of value in every row.
Tables of this kind are called <span class="ix-entry" ix-key="dataframe" markdown="1"><a class="gl-ref" href="../glossary/#dataframe" markdown="1">dataframes</a></span>,
and to explore how they work,
this chapter builds two implementations of them in Python:
one that stores values in columns,
the other that stores them in rows.
To help us decide which is better,
we’ll compare their performance in a reproducible way.</p>
<h2 id="dataframe-cols">Section 17.1: Storing Columns</h2>
<p>To start,
let’s create an <a class="gl-ref" href="../glossary/#abstract_class" markdown="1">abstract class</a>
that defines the methods our dataframe classes will support.
This class (unimaginatively called <code>DF</code>)
requires <a class="gl-ref" href="../glossary/#concrete_class" markdown="1">concrete classes</a> to implement eight methods:</p>
<ul>
<li><code>ncol</code>: report the number of columns.</li>
<li><code>nrow</code>: report the number of rows.</li>
<li><code>cols</code>: return the set of column names.</li>
<li><code>eq</code>: check whether this dataframe is equal to another.</li>
<li><code>get</code>: get a scalar value from a specified column and row.</li>
<li><code>set</code>: set the scalar value in a specified column and row.</li>
<li><code>select</code>: create a new dataframe containing some or all of the original’s columns.</li>
<li><code>filter</code>: create a new dataframe containing some or all of the original’s rows.</li>
</ul>
<div class="code-sample lang-py" title="df_base.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>

<span class="k">class</span> <span class="nc">DF</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">ncol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Report the number of columns."""</span>

    <span class="k">def</span> <span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Report the number of rows."""</span>

    <span class="k">def</span> <span class="nf">cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the set of column names."""</span>

    <span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">"""Check equality of two dataframes."""</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Get a scalar value."""</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="sd">"""Select a subset of columns."""</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">"""Select a subset of rows."""</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Docstrings are enough</h3>
<p>Every method in Python needs a body,
so many programmers will write <code>pass</code> (Python’s “do nothing” statement).
However,
a <span class="ix-entry" ix-key="docstring" markdown="1"><a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a></span> also counts as a body,
so if we write those (which we should)
there’s no need to write <code>pass</code>.</p>
</div>
<p>We then derive a class <code>DfCol</code> that uses <span class="ix-entry" ix-key="column-wise storage; storage!column-wise" markdown="1"><a class="gl-ref" href="../glossary/#column_wise" markdown="1">column-wise</a></span> storage
(<a class="fig-ref" href="../dataframe/#dataframe-colwise">Figure 17.1</a>).
Each column is stored as a list of values,
all of which are of the same type.
The dataframe itself is a dictionary of such lists,
all of which have the same length
so that there are no holes in any of the rows:</p>
<div class="code-sample lang-py" title="df_col.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">df_base</span> <span class="kn">import</span> <span class="n">DF</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">all_eq</span>

<span class="k">class</span> <span class="nc">DfCol</span><span class="p">(</span><span class="n">DF</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">all_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">all_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">kwargs</span>
</code></pre></div>
</div>
<figure id="dataframe-colwise">
<img alt="Column-wise storage" src="./dataframe/dataframe_colwise.svg"/>
<figcaption markdown="1">Figure 17.1: Storing a dataframe’s data in columns.</figcaption>
</figure>
<p>Some methods are almost trivial to implement on top of this storage mechanism;
others are more difficult.
Three of the easy ones return the number of rows and columns
and the set of column names.
To get the number of rows
we check the length of an arbitrary column:</p>
<div class="code-sample lang-py" title="df_col.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">ncol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div>
</div>
<p>Checking equality is also relatively simple.
Two dataframes are the same if they have exactly the same columns
and the same values in every column:</p>
<div class="code-sample lang-py" title="df_col.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DF</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">cols</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
</div>
<p class="continue">Notice that we use <code>other.cols()</code> and <code>other.get()</code>
rather than reaching into the other dataframe.
We defined the abstract base class because
we expect to implement dataframes in several different ways.
Those other ways will probably not use the same data structures,
so we can only rely on the interface defined in the base class.</p>
<p>Getting individual values is straightforward:</p>
<div class="code-sample lang-py" title="df_col.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">and so is selecting a subset of columns:</p>
<div class="code-sample lang-py" title="df_col.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DfCol</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">})</span>
</code></pre></div>
</div>
<p class="continue">Notice,
though,
that the dataframe created by <code>select</code>
re-uses the columns of the original dataframe.
This is safe and efficient so long as columns are <a class="gl-ref" href="../glossary/#immutable" markdown="1">immutable</a>,
i.e.,
so long as their contents are never changed in place.</p>
<p>Selecting columns was easy,
but filtering—i.e., selecting rows that pass some test—is not.
This is partly because the operation is intrinsically more complex:
we need to apply a user-defined function to each row
to see if we’re supposed to keep it,
which is much more complicated than selecting a few columns by name
out of a dictionary.</p>
<p>However,
our storage mechanism makes the task more complex still.
Since values are stored in columns,
we have to extract the ones belonging to each row
to pass them into the user-defined function
(<a class="fig-ref" href="../dataframe/#dataframe-col-to-row">Figure 17.2</a>).
And if that wasn’t enough,
we want to do this solely for the columns that the user’s function needs.</p>
<figure id="dataframe-col-to-row">
<img alt="Packing column values into rows" src="./dataframe/dataframe_col_to_row.svg"/>
<figcaption markdown="1">Figure 17.2: Extracting values from columns to create temporary rows.</figcaption>
</figure>
<p>Our solution makes use of the fact that
Python’s <a href="https://docs.python.org/3/library/inspect.html">inspect</a> module lets us examine objects in memory.
In particular, <code>inspect.signature</code> can tell us what parameters a function takes.
If, for example,
the user wants to compare the <code>red</code> and <code>blue</code> columns of a dataframe,
they can give us a function that has two parameters called <code>red</code> and <code>blue</code>.
We can then use those parameter names to figure out
which columns we need from the dataframe
(<a class="fig-ref" href="../dataframe/#dataframe-inspect">Figure 17.3</a>):</p>
<div class="code-sample lang-py" title="df_col.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">()):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">DfCol</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Once we have build a temporary dictionary with the values in a row,
we pass that dictionary to the user’s filter function using <code>**args</code>
to <span class="ix-entry" ix-key="spreading (arguments)" markdown="1"><a class="gl-ref" href="../glossary/#spread" markdown="1">spread</a></span> them,
i.e.,
to match them by name to the function’s parameters.</p>
<figure id="dataframe-inspect">
<img alt="Using inspection to identify columns" src="./dataframe/dataframe_inspect.svg"/>
<figcaption markdown="1">Figure 17.3: Using runtime inspection of parameter names to select columns.</figcaption>
</figure>
<div class="callout">
<h3>Would simpler be better?</h3>
<p>Packing values and matching them to the parameters of the user’s function
makes the code complex,
and probably slows filtering down.
We could instead just pass in the columns and the row index,
and require the user to refer to (for example) <code>red[i]</code> in their function
instead of just <code>red</code>.
However,
this would make those filtering functions a little harder to write,
and we’d have to trust the user to stick to our conventions
and only use element <code>i</code> of each row when filtering.
We will explore these tradeoffs in the exercises.</p>
</div>
<p>Time to write some tests.
This one checks that we can construct a dataframe with some values:</p>
<div class="code-sample lang-py" title="test_df_col.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_construct_with_two_pairs</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">DfCol</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
</code></pre></div>
</div>
<p class="continue">while this one checks that <code>filter</code> works correctly:</p>
<div class="code-sample lang-py" title="test_df_col.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_filter</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">odd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">DfCol</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">odd</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">DfCol</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
</code></pre></div>
</div>
<h2>Storing Rows</h2>
<p>Column-wise storage makes selecting columns easy but filtering rows hard.
If we expect to do more filtering than selecting
it might be more efficient to use <span class="ix-entry" ix-key="row-wise storage; storage!row-wise" markdown="1"><a class="gl-ref" href="../glossary/#row_wise" markdown="1">row-wise</a></span> storage
(<a class="fig-ref" href="../dataframe/#dataframe-rowwise">Figure 17.4</a>).</p>
<figure id="dataframe-rowwise">
<img alt="Row-wise storage" src="./dataframe/dataframe_rowwise.svg"/>
<figcaption markdown="1">Figure 17.4: Storing a dataframe’s data in rows.</figcaption>
</figure>
<p>The class <code>DfRow</code> is derived from the same abstract base class as <code>DfCol</code>
so that it has the same interface.
However,
it stores data as a single list of dictionaries,
each with the same keys and the same types of values:</p>
<div class="code-sample lang-py" title="df_row.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">df_base</span> <span class="kn">import</span> <span class="n">DF</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">dict_match</span>

<span class="k">class</span> <span class="nc">DfRow</span><span class="p">(</span><span class="n">DF</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">dict_match</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">rows</span>
</code></pre></div>
</div>
<p class="continue">Notice that <code>DfRow</code>‘s constructor <em>doesn’t</em> have the same signature as <code>DfCol</code>.
At some point in our code we have to decide which of the two classes to construct.
If we design our code well that decision will be made in exactly one place
and everything else will rely solely on the common interface defined by <code>DF</code>.
But since we have to type something different at the point of construction,
it’s OK for the constructors to be different.</p>
<p>The basic operations <code>ncol</code>, <code>nrow</code>, and <code>cols</code> are straightforward:</p>
<div class="code-sample lang-py" title="df_row.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">ncol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div>
</div>
<p class="continue">Whenever we need information about columns,
we look at the first row.
The assumption that there <em>is</em> a first row means we can’t represent
an empty dataframe;
we’ll explore this in the exercises.</p>
<p class="continue">Getting values and checking for equality are also straightforward.
Filtering is much easier than it was with column-wise storage—we
simply pass each row to the user-supplied filter function
and keep the ones that pass:</p>
<div class="code-sample lang-py" title="df_row.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">names</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">DfRow</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To select columns we must build a new list of dictionaries,
each of which has only some of the keys of the original:</p>
<div class="code-sample lang-py" title="df_row.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">names</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">DfRow</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">These operations are the inverses of their <code>DfCol</code> counterparts:
we have to rearrange data to select
but can use the existing data as-is to filter.</p>
<p>Since <code>DfCol</code> and <code>DfRow</code> have the same interface,
we can recycle the tests we wrote for the former.
We obviously need to change the objects we construct,
so let’s use this opportunity to write helper functions
to create the dataframes we use in multiple tests:</p>
<div class="code-sample lang-py" title="test_df_row.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">odd_even</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">DfRow</span><span class="p">([{</span><span class="s2">"a"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s2">"a"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}])</span>

<span class="k">def</span> <span class="nf">a_only</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">DfRow</span><span class="p">([{</span><span class="s2">"a"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">"a"</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>
</code></pre></div>
</div>
<p class="continue">With these functions in hand our tests look like:</p>
<div class="code-sample lang-py" title="test_df_row.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_construct_with_two_pairs</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">odd_even</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
</code></pre></div>
</div>
<h2 id="dataframe-performance">Section 17.3: Performance</h2>
<p>Our two implementations of dataframes have identical interfaces,
so how can we choose which to use?
Performance is one consideration,
particularly if we’re expecting to work with large datasets.</p>
<div class="callout">
<h3>Transactions versus analysis</h3>
<p>Regardless of data volumes,
different storage schemes are better (or worse) for different kinds of work.
<span class="ix-entry" ix-key="online transaction processing (OLTP); OLTP (online transaction processing)" markdown="1"><a class="gl-ref" href="../glossary/#oltp" markdown="1">Online transaction processing</a></span> (OLTP)
refers to adding or querying individual records,
such as online sales.
<span class="ix-entry" ix-key="online analytical processing (OLAP); OLAP (online analytical processing)" markdown="1"><a class="gl-ref" href="../glossary/#olap" markdown="1">online analytical processing</a></span> (OLAP),
on the other hand,
processes selected columns of a table in bulk to do things like find averages over time.
Row-wise storage is usually best for OLTP,
but column-wise storage is better suited for OLAP.
If data volumes are large,
<span class="ix-entry" ix-key="data engineer" markdown="1"><a class="gl-ref" href="../glossary/#data_engineer" markdown="1">data engineers</a></span> will sometimes run two databases in parallel,
using <span class="ix-entry" ix-key="batch processing" markdown="1"><a class="gl-ref" href="../glossary/#batch_processing" markdown="1">batch processing</a></span> jobs
to copy new or updated records from the OLTP databases over to the OLAP database.</p>
</div>
<p>To compare the speed of these classes,
let’s write a short program to create dataframes of each kind
and time how long it takes to select their columns and filter their rows.
To keep things simple
we will create dataframes whose columns are called <code>label_1</code>, <code>label_2</code>, and so on,
and whose values are all integers in the range 0–9.
A thorough set of <span class="ix-entry" ix-key="benchmarking" markdown="1"><a class="gl-ref" href="../glossary/#benchmark" markdown="1">benchmarks</a></span>
would create columns of other kinds as well,
but this is enough to illustrate the technique.</p>
<div class="code-sample lang-py" title="timing.py">
<div class="highlight"><pre><span></span><code><span class="n">SPREAD</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">def</span> <span class="nf">make_col</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_col</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[((</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">SPREAD</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="n">fill</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">"label_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">"</span><span class="p">:</span> <span class="n">_col</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">DfCol</span><span class="p">(</span><span class="o">**</span><span class="n">fill</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_row</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"label_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_row</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">SPREAD</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)}</span>

    <span class="n">fill</span> <span class="o">=</span> <span class="p">[</span><span class="n">_row</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">DfRow</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To time filtering,
we arbitrarily decide that we will keep rows with an even value in the first column:</p>
<div class="code-sample lang-py" title="timing.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">time_filter</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">label_0</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">label_0</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</code></pre></div>
</div>
<p class="continue">Again,
if we were doing this for real
we would look at some actual programs
to see what fraction of rows filtering usually kept,
and simulate that.
Notice that <code>time_filter</code> doesn’t know or care
whether it’s being given a <code>DfCol</code> or a <code>DfRow</code>.
That’s the whole point of deriving them from a base class:
we can use them interchangeably.</p>
<p>Timing <code>select</code> is similar to timing <code>filter</code>.
Again,
we make an arbitrary decision about how many columns to keep
(in this case one third):</p>
<div class="code-sample lang-py" title="timing.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">time_select</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ncol</span><span class="p">())</span> <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"label_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</code></pre></div>
</div>
<p>Finally,
we write a function that takes a list of strings like <code>3x3</code> or <code>100x20</code>,
creates dataframes of each size,
times operations,
and reports the results:</p>
<div class="code-sample lang-py" title="timing.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="n">sizes</span><span class="p">):</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"x"</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">]</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">]</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">"nrow"</span><span class="p">,</span> <span class="s2">"ncol"</span><span class="p">,</span> <span class="s2">"filter_col"</span><span class="p">,</span> <span class="s2">"select_col"</span><span class="p">,</span> <span class="s2">"filter_row"</span><span class="p">,</span> <span class="s2">"select_row"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
        <span class="n">df_col</span> <span class="o">=</span> <span class="n">make_col</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>
        <span class="n">df_row</span> <span class="o">=</span> <span class="n">make_row</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">time_filter</span><span class="p">(</span><span class="n">df_col</span><span class="p">),</span>
            <span class="n">time_select</span><span class="p">(</span><span class="n">df_col</span><span class="p">),</span>
            <span class="n">time_filter</span><span class="p">(</span><span class="n">df_row</span><span class="p">),</span>
            <span class="n">time_select</span><span class="p">(</span><span class="n">df_row</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">]</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="o">*</span><span class="n">times</span><span class="p">])</span>
</code></pre></div>
</div>
<p class="continue">This function is called <code>sweep</code> because
executing code multiple times with different parameters to measure performance
is called <span class="ix-entry" ix-key="parameter sweeping" markdown="1"><a class="gl-ref" href="../glossary/#parameter_sweeping" markdown="1">parameter sweeping</a></span>.</p>
<p>The results are shown in <a class="tbl-ref" href="../dataframe/#dataframe-timing">Table 17.1</a>.
For a 1000 by 1000 dataframe
selection is over 250 times faster with column-wise storage than with row-wise,
while filtering is 1.8 times slower.
<span class="fixme">FIXME do the math</span></p>
<div class="table"><table id="dataframe-timing"><caption>Table 17.1: Dataframe timings</caption>
<thead>
<tr>
<th>nrow</th>
<th>ncol</th>
<th>filter col</th>
<th>select col</th>
<th>filter row</th>
<th>select row</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>10</td>
<td>8.87e-05</td>
<td>7.70e-05</td>
<td>4.41e-05</td>
<td>2.50e-05</td>
</tr>
<tr>
<td>100</td>
<td>100</td>
<td>0.00275</td>
<td>4.10e-05</td>
<td>0.00140</td>
<td>8.76e</td>
</tr>
<tr>
<td>1000</td>
<td>1000</td>
<td>0.146</td>
<td>0.000189</td>
<td>0.0787</td>
<td>0.0508</td>
</tr>
<tr>
<td>10000</td>
<td>10000</td>
<td>19.0</td>
<td>0.00234</td>
<td>9.97</td>
<td>5.57</td>
</tr>
</tbody>
</table>
</div>
<p>We can get much more insight using Python <a href="https://docs.python.org/3/library/profile.html">cProfile</a> module,
which runs a program for us,
collects detailed information on how long functions ran,
and reports the result:</p>
<div class="code-sample lang-sh" title="profile.sh">
<div class="highlight"><pre><span></span><code>python -m cProfile -s tottime timing.py 1000x1000 <span class="p">|</span> head -n <span class="m">20</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="profile.out">
<div class="highlight"><pre><span></span><code>nrow,ncol,filter_col,select_col,filter_row,select_row
1000,1000,3.03e-01,6.26e-04,1.89e-01,1.25e-01
         2370750 function calls (2368230 primitive calls) in 1.136 \
         seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
  1836500    0.320    0.000    0.320    0.000 util.py:7(&lt;genexpr&gt;)
        1    0.154    0.154    0.302    0.302 df_col.py:54(filter)
     1000    0.137    0.000    0.137    0.000 timing.py:22(&lt;dictcomp&gt;)
4842/2342    0.132    0.000    0.524    0.000 {built-in method \
builtins.all}
     1000    0.107    0.000    0.107    0.000 df_col.py:58(&lt;dictcomp&gt;)
     1000    0.077    0.000    0.077    0.000 timing.py:13(&lt;listcomp&gt;)
     2500    0.069    0.000    0.521    0.000 util.py:4(dict_match)
        1    0.046    0.046    0.047    0.047 df_row.py:50(&lt;listcomp&gt;)
   500004    0.039    0.000    0.039    0.000 {method 'append' of 'list' \
   objects}
     1000    0.028    0.000    0.028    0.000 df_row.py:43(&lt;dictcomp&gt;)
        1    0.010    0.010    1.136    1.136 timing.py:1(&lt;module&gt;)
        5    0.001    0.000    0.001    0.000 {method 'read' of \
        '_io.BufferedReader' objects}
        3    0.001    0.000    0.003    0.001 df_col.py:8(__init__)
</code></pre></div>
</div>
<p>Ignoring the first two lines (which are the output of our program),
the table tells us:</p>
<ul>
<li>
<p>the number of times each function or method was called;</p>
</li>
<li>
<p>the total time spent in those calls (which is what we care about most);</p>
</li>
<li>
<p>the time spent per call; and</p>
</li>
<li>
<p>the cumulative time spent in that call and all the things it calls,
    both per call and in total.</p>
</li>
</ul>
<p>Right away we can see that the <code>dict_match</code> function
that checks the consistency of the rows in a row-oriented dataframe
is eating up a lot of time.
It’s only called in the constructor,
but on the other hand,
we’re constructing a new dataframe for each <code>filter</code> and <code>select</code>,
so removing that safety check would speed things up.</p>
<p>Looking down a little further,
the dictionary comprehension in <code>DfCol.filter</code> takes a lot of time as well.
That isn’t surprising:
we’re copying the values out of the columns into a temporary dictionary
for every row when we filter,
and building all those temporary dictionaries adds up to a lot of time.</p>
<div class="callout">
<h3>Engineering</h3>
<p>If science is the use of the experimental method to investigate the world,
engineering is the use of the experimental method
to investigate and improve the things that people build.
Good software designers collect and analyze data all the time
to find out whether one website design works better than another <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Kohavi2020">Kohavi2020</a>]</span>
or to improve the performance of CPUs <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Patterson2017">Patterson2017</a>]</span>.
A few simple experiments like these can save weeks or months of misguided effort.</p>
</div>
<h2 id="dataframe-summary">Section 17.4: Summary</h2>
<figure id="dataframe-concept-map">
<img alt="Concept map for dataframes" src="./dataframe/dataframe_concept_map.svg"/>
<figcaption markdown="1">Figure 17.5: Concepts for dataframes.</figcaption>
</figure>
<h2 id="dataframe-exercises">Section 17.5: Exercises</h2>
<h3 class="exercise">More efficient filtering</h3>
<p>Derive a class from <code>DfCol</code> and override its <code>filter</code> method
so that the user-defined filtering functions take zero or more columns
and an row index called <code>i_row</code> as parameters
and return <code>True</code> or <code>False</code> to signal whether the row passes the test.</p>
<ol>
<li>
<p>How much faster does this make filtering?</p>
</li>
<li>
<p>When would it be useful for filtering functions
    to take no column at all as parameters?</p>
</li>
</ol>
<h3 class="exercise">Empty dataframes</h3>
<p>An empty dataframe is as reasonable and as useful as an empty string or an empty list.
<code>DfCol</code> can represent this,
but <code>DfRow</code> cannot:
if the list of dictionaries is empty,
we cannot ask for columns’ names.
Derive another dataframe class from <code>DF</code> that uses row-wise storage
but can represent a dataframe with no rows.</p>
<h3 class="exercise">Unified constructors</h3>
<p>Modify the constructors of <code>DfRow</code> and <code>DfCol</code> to have the same signatures.
Where and why might this be useful?</p>
<h3 class="exercise">Fixture functions</h3>
<p>Read the documentation for the <code>@fixture</code> decorator in <a href="https://docs.pytest.org/">pytest</a>
and modify the tests in this chapter to use it.</p>
<h3 class="exercise">Using arrays</h3>
<p>Derive another dataframe class from <code>DF</code>
that uses Python’s <a href="https://docs.python.org/3/library/array.html">array</a> module for column-wise storage.
How does it performance compared to other implementations?</p>
<h3 class="exercise">Crossover</h3>
<ol>
<li>
<p>At what ratio of filters to selects are <code>DfRow</code> and <code>DfCol</code> equally fast?
    (Your answer may depend on the size of the dataframe.)</p>
</li>
<li>
<p>How does the relative performance of the two classes change
    if tables have a fixed number of columns (such as 10 or 20)
    but an increasing numbers of rows?
    Is this scenario more realistic?</p>
</li>
</ol>
<h3 class="exercise">Conversion</h3>
<p>Write a function to convert a <code>DfRow</code> into a <code>DfCol</code>
and another to do the opposite.
Which one is faster?
How does the difference in performance depend on
the size and shape of the dataframes being converted?</p>
<h3 class="exercise">Filtering by strings</h3>
<p>Modify the comparison of filter and select to work with tables
that contain columns of strings instead of columns of numbers
and see how that changes performance.
For testing,
creating random 4-letter strings using the characters A-Z
and then filter by:</p>
<ul>
<li>an exact match,</li>
<li>strings starting with a specific character, and</li>
<li>strings that contain a specific character</li>
</ul>
<h3 class="exercise">Join performance</h3>
<p>A join combines data from two tables based on matching keys.
For example,
if the two tables are:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Left</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a1</td>
</tr>
<tr>
<td>B</td>
<td>b1</td>
</tr>
<tr>
<td>C</td>
<td>c1</td>
</tr>
</tbody>
</table>
<p class="continue">and:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a2</td>
</tr>
<tr>
<td>A</td>
<td>a3</td>
</tr>
<tr>
<td>B</td>
<td>b2</td>
</tr>
</tbody>
</table>
<p class="continue">then the join is:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Left</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a1</td>
<td>a2</td>
</tr>
<tr>
<td>A</td>
<td>a1</td>
<td>a3</td>
</tr>
<tr>
<td>B</td>
<td>b1</td>
<td>b2</td>
</tr>
</tbody>
</table>
<p>Write a test to compare the performance of row-wise vs. column-wise storage
when joining two tables based on matching numeric keys.
Does the answer depend on the fraction of keys that match?</p>
<h3 class="exercise">Join optimization</h3>
<p>The simplest way to <a class="gl-ref" href="../glossary/#join" markdown="1">join</a> two tables is
to look for matching keys using a double loop.
An alternative is to build an <a class="gl-ref" href="../glossary/#index_database" markdown="1">index</a> for each table
and then use it to construct matches.
For example, suppose the tables are:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Left</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a1</td>
</tr>
<tr>
<td>B</td>
<td>b1</td>
</tr>
<tr>
<td>C</td>
<td>c1</td>
</tr>
</tbody>
</table>
<p class="continue">and:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a2</td>
</tr>
<tr>
<td>A</td>
<td>a3</td>
</tr>
<tr>
<td>B</td>
<td>b2</td>
</tr>
</tbody>
</table>
<p>The first step is to create a <code>Map</code> showing where each key is found in the first table:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nx">A</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">B</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">C</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">]}</span><span class="w"></span>
</code></pre></div>
<p class="continue">The second step is to create a similar <code>Map</code> for the second table:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nx">A</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">B</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">]}</span><span class="w"></span>
</code></pre></div>
<p class="continue">We can then loop over the keys in one of the maps,
look up values in the second map,
and construct all of the matches.</p>
<p>Write a function that joins two tables this way.
Is it faster or slower than using a double loop?
How does the answer depend on the number of keys and the fraction that match?</p>
</section>
<section class="new-chapter"><h1 id="pipeline">Chapter: Chapter 18: A Pipeline Runner</h1>

<div class="center">
<p class="todo">Coming soon.</p>
</div>
</section>
<section class="new-chapter"><h1 id="database">Chapter: Chapter 19: A Database</h1>

<div class="center">
<p class="todo">Coming soon.</p>
</div>
</section>
<section class="new-chapter"><h1 id="packman">Chapter: Chapter 20: A Package Manager</h1>

<div class="center">
<p class="todo">Coming soon.</p>
</div>
</section>
<section class="new-chapter"><h1 id="conclusion">Chapter: Chapter 21: Conclusion</h1>

<div class="page-toc"></div>
<figure id="conclusion-bicycle">
<img alt="De Rosa SK Pininfarina bicycle" src="./conclusion/derosa.jpg"/>
<figcaption markdown="1">Figure 21.1: De Rosa SK Pininfarina bicycle.</figcaption>
</figure>
<p>Consider the bicycle–more specifically,
the De Rosa SK Pininfarina (<a class="fig-ref" href="../conclusion/#conclusion-bicycle">Figure 21.1</a>).
I think it’s beautiful,
but I wouldn’t call it art,
because being beautiful isn’t its primary purpose.
It was created to be useful;
the fact that it can also be appreciated aesthetically is an intentional bonus.</p>
<p>English doesn’t have a word for things like this,
but there are lots of other examples.
Architecture and typography have deep roots,
and starting in the early 20th Century,
people like <a href="https://en.wikipedia.org/wiki/Christopher_Dresser">Christopher Dresser</a>,
<a href="https://en.wikipedia.org/wiki/Joseph_Claude_Sinel">Jo Sinel</a>,
and above all <a href="https://en.wikipedia.org/wiki/Raymond_Loewy">Raymond Loewy</a>
established industrial design around the idea that
mass-produced artifacts were worthy of serious analysis
from an aesthetic as well as a utilitarian point of view.</p>
<p>Now think about your favorite piece of software.
We have long accepted that its interface can and should be critiqued
in the same way as a power drill:</p>
<ul>
<li>Does it do what it’s supposed to?</li>
<li>Is it pleasurable to use?</li>
</ul>
<p>What’s missing is the third leg of the industrial design tripod:</p>
<ul>
<li>Did its design facilitate its manufacture and maintenance?</li>
</ul>
<p>At a deeper level,
what’s <em>really</em> missing is the combination of an agreed vocabulary and a suite of canonical examples
that would allow us to critique software
in the way that we can critique a couch or a train.
We use words like “elegant” when referring to Unix’s pipe-and-filter model,
but when asked to explain,
we run out of meaning long before any reasonably intelligent industrial designer
runs out of ways to think about the design of a new blender.
Will the materials hold up under constant use?
Can it be assembled at a reasonable cost?
Will people understand how to use it without having to wade through a manual?
Will it please the eye when it’s sitting on the counter?
Training in industrial design gives weight to all of these separately and together,
and gives students the tools they need to tell the good from the bad.</p>
<p>In retrospect,
I think this is what I was groping toward with <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Oram2007">Oram2007</a>, <a class="bib-ref" href="../bibliography/#Brown2011">Brown2011</a>, <a class="bib-ref" href="../bibliography/#Brown2012">Brown2012</a>]</span>.
I think that if our community had decided fifty years ago to think of what we do as
“industrial design for software”
rather than “software engineering”,
our conversations would be intellectually richer today.</p>
<p>I hope this book will help us get there.
I hope that we learn how to talk amongst ourselves about the beauty of software as well,
because it <em>is</em> beautiful,
and we deserve to have ways to say that.</p>
<p>I also hope that your journey won’t stop here.
If you would like to add a chapter to this book
or translate it into another language,
your help would be very welcome:
please see <a class="x-ref" href="#introduction">Chapter 1</a> and <a class="x-ref" href="#contributing">Appendix E</a> for more information.</p>
<div class="center">
<p>Start where you are.<br/>
Use what you have.<br/>
Help who you can.</p>
</div>
</section><section class="new-chapter"><h1 id="bibliography">Appendix: Appendix A: Bibliography</h1>

<div class="page-toc"></div>
<dl class="bib-list">
<dt id="Armstrong2013">Armstrong2013</dt>
<dd>Tavish Armstrong, editor.
<em>The Performance of Open Source Applications</em>.
Lulu, 2013.
ISBN 978-1304488787.</dd>
<dt id="Brand1995">Brand1995</dt>
<dd>Stewart Brand.
<em>How Buildings Learn: What Happens After They're Built</em>.
Penguin USA, 1995.
ISBN 978-0140139969.</dd>
<dt id="Brown2011">Brown2011</dt>
<dd>Amy Brown and Greg Wilson, editors.
<em>The Architecture of Open Source Applications: Elegance, Evolution, and a Few Fearless Hacks</em>.
Lulu, 2011.
ISBN 978-1257638017.</dd>
<dt id="Brown2012">Brown2012</dt>
<dd>Amy Brown and Greg Wilson, editors.
<em>The Architecture of Open Source Applications: Structure, Scale, and a Few More Fearless Hacks</em>.
Lulu, 2012.
ISBN 978-0201103427.</dd>
<dt id="Brown2016">Brown2016</dt>
<dd>Amy Brown and Michael DiBernardo, editors.
<em>500 Lines or Less: Experienced Programmers Solve Interesting Problems</em>.
Lulu, 2016.
ISBN 978-1329871274.</dd>
<dt id="Conery2021">Conery2021</dt>
<dd>Rob Conery.
<em>The Imposter's Handbook: A CS Primer for Self-Taught Developers</em>.
Independently published, 2021.
ISBN 978-8708185266.</dd>
<dt id="Goldberg1991">Goldberg1991</dt>
<dd>David Goldberg.
What every computer scientist should know about floating-point arithmetic.
<em>ACM Computing Surveys</em>, 3 1991.
<a href="https://doi.org/10.1145/103162.103163">doi:10.1145/103162.103163</a>.</dd>
<dt id="Kernighan1979">Kernighan1979</dt>
<dd>Brian W. Kernighan and P. J. Plauger.
<em>The Elements of Programming Style</em>.
McGraw-Hill, 1979.
ISBN 978-0070342071.</dd>
<dt id="Kernighan1981">Kernighan1981</dt>
<dd>Brian W. Kernighan and P. J. Plauger.
<em>Software Tools in Pascal</em>.
Addison-Wesley Professional, 1981.
ISBN 978-0201103427.</dd>
<dt id="Kernighan1983">Kernighan1983</dt>
<dd>Brian W. Kernighan and Rob Pike.
<em>The Unix Programming Environment</em>.
Prentice-Hall, 1983.
ISBN 978-0139376818.</dd>
<dt id="Kernighan1988">Kernighan1988</dt>
<dd>Brian W. Kernighan and Dennis M. Ritchie.
<em>The C Programming Language</em>.
Prentice-Hall, 1988.
ISBN 978-0131103627.</dd>
<dt id="Kohavi2020">Kohavi2020</dt>
<dd>Ron Kohavi, Diane Tang, and Ya Xu.
<em>Trustworthy Online Controlled Experiments: A Practical Guide to A/B Testing</em>.
Cambridge University Press, 2020.
ISBN 978-1108724265.</dd>
<dt id="Meszaros2007">Meszaros2007</dt>
<dd>Gerard Meszaros.
<em>xUnit Test Patterns: Refactoring Test Code</em>.
Addison-Wesley, 2007.
ISBN 978-0131495050.</dd>
<dt id="Nystrom2021">Nystrom2021</dt>
<dd>Robert Nystrom.
<em>Crafting Interpreters</em>.
Genever Benning, 2021.
ISBN 978-0990582939.</dd>
<dt id="Oram2007">Oram2007</dt>
<dd>Andy Oram and Greg Wilson, editors.
<em>Beautiful Code: Leading Programmers Explain How They Think</em>.
O'Reilly, 2007.
ISBN 978-0596510046.</dd>
<dt id="Patterson2017">Patterson2017</dt>
<dd>David A. Patterson and John L. Hennessy.
<em>Computer Organization and Design: The Hardware/Software Interface</em>.
Morgan Kaufmann, 2017.
ISBN 978-0128122754.</dd>
<dt id="Petre2016">Petre2016</dt>
<dd>Marian Petre and André <span class="bibtex-protected">van der Hoek</span>.
<em>Software Design Decoded: 66 Ways Experts Think</em>.
MIT Press, 2016.
ISBN 978-0262035187.</dd>
<dt id="Smith2011">Smith2011</dt>
<dd>Peter Smith.
<em>Software Build Systems: Principles and Experience</em>.
Addison-Wesley Professional, 2011.
ISBN 978-0134185965.</dd>
<dt id="Wilson2019">Wilson2019</dt>
<dd>Greg Wilson.
<em>Teaching Tech Together</em>.
Chapman &amp; Hall/CRC Press, 2019.
ISBN 978-0367352974.</dd>
<dt id="Wilson2022">Wilson2022</dt>
<dd>Greg Wilson.
Twelve quick tips for software design.
<em><span class="bibtex-protected">PLOS</span> Computational Biology</em>, 2 2022.
<a href="https://doi.org/10.1371/journal.pcbi.1009809">doi:10.1371/journal.pcbi.1009809</a>.</dd>
</dl>
</section>
<section class="new-chapter"><h1 id="syllabus">Appendix: Appendix B: Syllabus</h1>

<div class="page-toc"></div>
<ul>
<li><a href="../tester" markdown="1">A Testing Framework</a>
<ul>
<li markdown="1">Functions are objects you can save in data structures or pass to other functions.</li>
<li markdown="1">Python stores local and global variables in dictionary-like structures.</li>
<li markdown="1">A unit test function performs an operation on a fixture and passes, fails, or produces an error.</li>
<li markdown="1">A program can introspect to find functions and other objects at runtime.</li>
<li markdown="1">Temporarily replacing functions with mock objects can simplify testing.</li>
<li markdown="1">Python defines protocols so that users' code can be triggered by keywords in the language.</li>
</ul>
</li>
<li><a href="../interpreter" markdown="1">An Interpreter</a>
<ul>
<li markdown="1">Compilers and interpreters are just programs.</li>
<li markdown="1">Basic arithmetic operations are just functions that have special notation.</li>
<li markdown="1">Programs can be represented as trees, which can be stored as nested lists.</li>
<li markdown="1">Interpreters recurisvely dispatch operations to functions that implement low-level details.</li>
<li markdown="1">Programs store variables in stacked dictionaries called environments.</li>
<li markdown="1">One way to evaluate a program's design is to ask how extensible it is.</li>
</ul>
</li>
<li><a href="../backup" markdown="1">Versioned File Backups</a>
<ul>
<li markdown="1">Version control tools use hashing to uniquely identify each saved file.</li>
<li markdown="1">Cryptographic hash functions create identifiers that are randomly distributed and depend on every bit in their input.</li>
<li markdown="1">Hash functions often have streaming interfaces that can process files incrementally.</li>
<li markdown="1">Each snapshot of a set of files is recorded in a manifest.</li>
<li markdown="1">Using a mock filesystem to test version control is safer and faster than using the real thing.</li>
</ul>
</li>
<li><a href="../cache" markdown="1">A File Cache</a>
<ul>
<li markdown="1">Software systems often uses caches to store a subset of files in order to use less disk space.</li>
<li markdown="1">Caching systems can replace actual files with placeholders containing metadata.</li>
<li markdown="1">Object-oriented systems are often implemented in stages to break large design problems into smaller, more manageable ones.</li>
<li markdown="1">In a good design, derived classes only have to override a few (preferably none) of the methods implemented in parent classes.</li>
<li markdown="1">Implementing a minimum testable class allows early testing of core functionality.</li>
</ul>
</li>
<li><a href="../persistence" markdown="1">Object Persistence</a>
<ul>
<li markdown="1">A persistence framework saves and restores objects.</li>
<li markdown="1">Persistence must handle aliasing and circularity.</li>
<li markdown="1">Users should be able to extend persistence to handle objects of their own types.</li>
<li markdown="1">Software designs should be open for extension but closed for modification.</li>
<li markdown="1">Extensibility can be implemented using multiple inheritance, duck typing, or helper classes.</li>
</ul>
</li>
<li><a href="../binary" markdown="1">Binary Storage</a>
<ul>
<li markdown="1">Programs usually store integers using two's complement rather than sign and magnitude.</li>
<li markdown="1">Floating-point numbers have a sign, a mantissa, and an exponent.</li>
<li markdown="1">Characters are usually encoded as bytes using either ASCII, UTF-8, or UTF-32.</li>
<li markdown="1">Programs can use bitwise operators to manipulate the bits representing data directly.</li>
<li markdown="1">The relative error in a floating point number is usually more important than the absolute error.</li>
<li markdown="1">Low-level compiled languages usually store raw values, while high-level interpreted languages use boxed values.</li>
<li markdown="1">Sets of values can be packed into contiguous byte arrays for efficient transmission and storage.</li>
</ul>
</li>
<li><a href="../builder" markdown="1">A Build Manager</a>
<ul>
<li markdown="1">Build managers track dependencies between files and update files that are stale.</li>
<li markdown="1">Every build rule has a target, some dependencies, and a recipe for updating the target.</li>
<li markdown="1">Build rules form a directed graph which must not contain cycles.</li>
<li markdown="1">Pattern rules describe the dependencies and recipes for sets of similar files.</li>
<li markdown="1">Pattern rules can use automatic variables to specify targets and dependencies in recipes.</li>
</ul>
</li>
<li><a href="../templating" markdown="1">A Static Site Generator</a>
<ul>
<li markdown="1">Static site generators create HTML pages from templates, directives, and data.</li>
<li markdown="1">A static site generator must have the same core features as a programming language.</li>
<li markdown="1">Programs can use the Visitor pattern to separate traversal of a data structure from operations on its elements.</li>
<li markdown="1">HTML documents are usually represented in memory as trees using the Document Object Model (DOM).</li>
<li markdown="1">The style of code that programmers find easiest to read changes as they become more experienced.</li>
</ul>
</li>
<li><a href="../layout" markdown="1">Page Layout</a>
<ul>
<li markdown="1">A layout engine determines where to place text and other page elements based on their size and organization.</li>
<li markdown="1">Page elements are organized as a tree of basic blocks, rows, and columns.</li>
<li markdown="1">The layout engine calculates the position of each block based on its size and the position of its parent.</li>
<li markdown="1">Drawing blocks on top of each other from top to bottom is an easy way to render them.</li>
<li markdown="1">Use multiple inheritance and mixin classes to inject methods into classes without modifying their parent class.</li>
</ul>
</li>
<li><a href="../server" markdown="1">A Web Server</a>
<ul>
<li markdown="1">Every computer on a network has a unique IP address.</li>
<li markdown="1">The Domain Name System (DNS) translates human-readable names into IP addresses.</li>
<li markdown="1">The programs on each computer send and receive messages through numbered sockets.</li>
<li markdown="1">The program that receives a message must interpret the bytes in the message.</li>
<li markdown="1">The HyperText Transfer Protocol (HTTP) specifies one way to interact via messages over sockets.</li>
<li markdown="1">A minimal HTTP request has a method, a URL, and a protocol version.</li>
<li markdown="1">A complete HTTP request may also have headers and a body.</li>
<li markdown="1">An HTTP response has a status code, a status phrase, and optionally some headers and a body.</li>
<li markdown="1">HTTP is a stateless protocol: the application is responsible for remembering things between requests.</li>
</ul>
</li>
<li><a href="../matching" markdown="1">Matching Patterns</a>
<ul>
<li markdown="1">Use regular expressions to match patterns in text and extra data.</li>
<li markdown="1">Use inheritance to make matchers composable and extensible.</li>
<li markdown="1">Objects can delegate work to other objects using the Chain of Responsibility pattern.</li>
</ul>
</li>
<li><a href="../parser" markdown="1">Parsing Text</a>
<ul>
<li markdown="1">Use existing file formats rather than creating new ones.</li>
<li markdown="1">Parsing in two or more passes is often simpler than parsing in a single pass.</li>
<li markdown="1">Tokenize input text and then analyze the tokens.</li>
<li markdown="1">Every formal language corresponds to an abstract machine and vice versa.</li>
</ul>
</li>
<li><a href="../linter" markdown="1">A Style Checker</a>
<ul>
<li markdown="1">An abstract syntax tree (AST) represents the elements of a program as a data structure.</li>
<li markdown="1">A linter checks that a program conforms to a set of style and usage rules.</li>
<li markdown="1">Linters typically use the Visitor design pattern to find nodes of interest in an AST.</li>
<li markdown="1">Programs can modify a program's AST and then unparse it to create modified versions of the original program.</li>
<li markdown="1">Dynamic code modification is very powerful, but the technique can produce insecure and unmaintainable code.</li>
</ul>
</li>
<li><a href="../vm" markdown="1">A Virtual Machine</a>
<ul>
<li markdown="1">Every computer has a processor with a particular instruction set, some registers, and memory.</li>
<li markdown="1">Instructions are just numbers, but may be represented as assembly code.</li>
<li markdown="1">Instructions may refer to registers, memory, both, or neither.</li>
<li markdown="1">A processor usually executes instructions in order, but may jump to another location based if a conditional is true or false.</li>
<li markdown="1">An array is a block of adjacent locations in memory that can be indexed using an offset from its base address.</li>
</ul>
</li>
<li><a href="../debugger" markdown="1">A Debugger</a>
<ul>
<li markdown="1">Interactive programs can be tested by simulating input and recording output.</li>
<li markdown="1">Testing interactive programs is easier if their inputs and outputs can easily be replaced with mock objects.</li>
<li markdown="1">Debuggers usually implement breakpoints by temporarily replacing actual instructions with special ones.</li>
<li markdown="1">Using lookup tables for function or method dispatch makes programs easier to extend.</li>
</ul>
</li>
<li><a href="../dataframe" markdown="1">A Dataframe</a>
<ul>
<li markdown="1">Create abstract base classes to specify interfaces.</li>
<li markdown="1">Store two-dimensional data as rows or as columns.</li>
<li markdown="1">Use reflection to match data to function parameters.</li>
<li markdown="1">Measure performance to evaluate engineering tradeoffs.</li>
</ul>
</li>
<li><a href="../pipeline" markdown="1">A Pipeline Runner</a>
<ul>
<li markdown="1">FIXME</li>
</ul>
</li>
<li><a href="../database" markdown="1">A Database</a>
<ul>
<li markdown="1">FIXME</li>
</ul>
</li>
<li><a href="../packman" markdown="1">A Package Manager</a>
<ul>
<li markdown="1">FIXME</li>
</ul>
</li>
</ul>
</section>
<section class="new-chapter"><h1 id="license">Appendix: Appendix C: License</h1>

<div class="page-toc"></div>
<p>All of the written material is made available under the Creative
Commons - Attribution - NonCommercial 4.0 International license (CC-BY-NC-4.0),
while the software is made available under the Hippocratic License.</p>
<h2 id="license-writing">Section C.1: Writing</h2>
<p><em>This is a human-readable summary of (and not a substitute for) the license.
For the full legal text of this license, please see
<a href="https://creativecommons.org/licenses/by-nc/4.0/legalcode">https://creativecommons.org/licenses/by-nc/4.0/legalcode</a>.</em></p>
<p>All of this site is made available under the terms of the Creative Commons
Attribution - NonCommercial 4.0 license. You are free to:</p>
<ul>
<li>
<p><strong>Share</strong> — copy and redistribute the material in any medium or format</p>
</li>
<li>
<p><strong>Adapt</strong> — remix, transform, and build upon the material</p>
</li>
<li>
<p>The licensor cannot revoke these freedoms as long as you follow the license
    terms.</p>
</li>
</ul>
<p class="continue">Under the following terms:</p>
<ul>
<li>
<p><strong>Attribution</strong> — You must give appropriate credit, provide a link to the
    license, and indicate if changes were made. You may do so in any reasonable
    manner, but not in any way that suggests the licensor endorses you or your
    use.</p>
</li>
<li>
<p><strong>NonCommercial</strong> — You may not use the material for commercial purposes.</p>
</li>
<li>
<p><strong>No additional restrictions</strong> — You may not apply legal terms or technological
    measures that legally restrict others from doing anything the license
    permits.</p>
</li>
</ul>
<p class="continue"><strong>Notices:</strong></p>
<p>You do not have to comply with the license for elements of the material in the
public domain or where your use is permitted by an applicable exception or
limitation.</p>
<p>No warranties are given. The license may not give you all of the permissions
necessary for your intended use. For example, other rights such as publicity,
privacy, or moral rights may limit how you use the material.</p>
<h2 id="license-software">Section C.2: Software</h2>
<p>Licensor hereby grants permission by this license (“License”), free of charge,
to any person or entity (the “Licensee”) obtaining a copy of this software and
associated documentation files (the “Software”), to deal in the Software without
restriction, including without limitation the rights to use, copy, modify,
merge, publish, distribute, sublicense, and/or sell copies of the Software, and
to permit persons to whom the Software is furnished to do so, subject to the
following conditions:</p>
<ul>
<li>
<p>The above copyright notice and this License or a subsequent version published
    on the <a href="https://firstdonoharm.dev/">Hippocratic License Website</a> shall be
    included in all copies or substantial portions of the Software. Licensee has
    the option of following the terms and conditions either of the above
    numbered version of this License or of any subsequent version published on
    the Hippocratic License Website.</p>
</li>
<li>
<p>Compliance with Human Rights Laws and Human Rights Principles:</p>
<ol>
<li>
<p>Human Rights Laws. The Software shall not be used by any person or
    entity for any systems, activities, or other uses that violate any
    applicable laws, regulations, or rules that protect human, civil, labor,
    privacy, political, environmental, security, economic, due process, or
    similar rights (the “Human Rights Laws”). Where the Human Rights Laws of
    more than one jurisdiction are applicable to the use of the Software,
    the Human Rights Laws that are most protective of the individuals or
    groups harmed shall apply.</p>
</li>
<li>
<p>Human Rights Principles. Licensee is advised to consult the articles of
    the <a href="https://www.un.org/en/universal-declaration-human-rights/">United Nations Universal Declaration of Human Rights</a> and the
    <a href="https://www.unglobalcompact.org/what-is-gc/mission/principles">United Nations Global Compact</a> that define recognized principles
    of international human rights (the “Human Rights Principles”). It is
    Licensor’s express intent that all use of the Software be consistent
    with Human Rights Principles. If Licensor receives notification or
    otherwise learns of an alleged violation of any Human Rights Principles
    relating to Licensee’s use of the Software, Licensor may in its
    discretion and without obligation (i) (a) notify Licensee of such
    allegation and (b) allow Licensee 90 days from notification under (i)(a)
    to investigate and respond to Licensor regarding the allegation and (ii)
    (a) after the earlier of 90 days from notification under (i)(a), or
    Licensee’s response under (i)(b), notify Licensee of License termination
    and (b) allow Licensee an additional 90 days from notification under
    (ii)(a) to cease use of the Software.</p>
</li>
<li>
<p>Indemnity. Licensee shall hold harmless and indemnify Licensor against
    all losses, damages, liabilities, deficiencies, claims, actions,
    judgments, settlements, interest, awards, penalties, fines, costs, or
    expenses of whatever kind, including Licensor’s reasonable attorneys’
    fees, arising out of or relating to Licensee’s non-compliance with this
    License or use of the Software in violation of Human Rights Laws or
    Human Rights Principles.</p>
</li>
</ol>
</li>
<li>
<p>Enforceability: If any portion or provision of this License is determined to
     be invalid, illegal, or unenforceable by a court of competent jurisdiction,
     then such invalidity, illegality, or unenforceability shall not affect any
     other term or provision of this License or invalidate or render
     unenforceable such term or provision in any other jurisdiction. Upon a
     determination that any term or provision is invalid, illegal, or
     unenforceable, to the extent permitted by applicable law, the court may
     modify this License to affect the original intent of the parties as closely
     as possible. The section headings are for convenience only and are not
     intended to affect the construction or interpretation of this License. Any
     rule of construction to the effect that ambiguities are to be resolved
     against the drafting party shall not apply in interpreting this
     License. The language in this License shall be interpreted as to its fair
     meaning and not strictly for or against any party.</p>
</li>
</ul>
<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<p><em>The Hippocratic License is an <a href="https://ethicalsource.dev">Ethical Source license</a>.</em></p>
</section>
<section class="new-chapter"><h1 id="conduct">Appendix: Appendix D: Code of Conduct</h1>

<div class="page-toc"></div>
<p>In the interest of fostering an open and welcoming environment, we as
contributors and maintainers pledge to making participation in our project and
our community a harassment-free experience for everyone, regardless of age, body
size, disability, ethnicity, gender identity and expression, level of
experience, education, socioeconomic status, nationality, personal appearance,
race, religion, or sexual identity and orientation.</p>
<h2 id="conduct-standards">Section D.1: Our Standards</h2>
<p>Examples of behavior that contributes to creating a positive environment
include:</p>
<ul>
<li>using welcoming and inclusive language,</li>
<li>being respectful of differing viewpoints and experiences,</li>
<li>gracefully accepting constructive criticism,</li>
<li>focusing on what is best for the community, and</li>
<li>showing empathy towards other community members.</li>
</ul>
<p>Examples of unacceptable behavior by participants include:</p>
<ul>
<li>the use of sexualized language or imagery and unwelcome sexual
  attention or advances,</li>
<li>trolling, insulting/derogatory comments, and personal or political
  attacks,</li>
<li>public or private harassment,</li>
<li>publishing others’ private information, such as a physical or
  electronic address, without explicit permission, and</li>
<li>other conduct which could reasonably be considered inappropriate in
  a professional setting</li>
</ul>
<h2 id="conduct-responsibilities">Section D.2: Our Responsibilities</h2>
<p>Project maintainers are responsible for clarifying the standards of acceptable
behavior and are expected to take appropriate and fair corrective action in
response to any instances of unacceptable behavior.</p>
<p>Project maintainers have the right and responsibility to remove, edit, or reject
comments, commits, code, wiki edits, issues, and other contributions that are
not aligned to this Code of Conduct, or to ban temporarily or permanently any
contributor for other behaviors that they deem inappropriate, threatening,
offensive, or harmful.</p>
<h2 id="conduct-scope">Section D.3: Scope</h2>
<p>This Code of Conduct applies both within project spaces and in public spaces
when an individual is representing the project or its community. Examples of
representing a project or community include using an official project email
address, posting via an official social media account, or acting as an appointed
representative at an online or offline event. Representation of a project may be
further defined and clarified by project maintainers.</p>
<h2 id="conduct-enforcement">Section D.4: Enforcement</h2>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be
reported by emailing the project team. All complaints will be reviewed
and investigated and will result in a response that is deemed necessary and
appropriate to the circumstances. The project team is obligated to maintain
confidentiality with regard to the reporter of an incident.  Further details of
specific enforcement policies may be posted separately.</p>
<p>Project maintainers who do not follow or enforce the Code of Conduct in good
faith may face temporary or permanent repercussions as determined by other
members of the project’s leadership.</p>
<h2 id="conduct-attribution">Section D.5: Attribution</h2>
<p>This Code of Conduct is adapted from the <a href="https://www.contributor-covenant.org/">Contributor Covenant</a>
version 1.4.</p>
</section>
<section class="new-chapter"><h1 id="contributing">Appendix: Appendix E: Contributing</h1>

<div class="page-toc"></div>
<p>Contributions are very welcome;
please contact us by email or by filing an issue on this site.
All contributors must abide by our Code of Conduct.</p>
<h2 id="contributing-decisions">Section E.1: Making Decisions</h2>
<p>This project uses <a href="https://journals.sagepub.com/doi/10.1177/088610998600100206">Martha’s Rules</a> for consensus decision making:</p>
<ol>
<li>
<p>Before each meeting, anyone who wishes may sponsor a proposal by filing an
    issue in the GitHub repository tagged “proposal”.  People must file proposals
    at least 24 hours before a meeting in order for them to be considered at that
    meeting, and must include:</p>
<ul>
<li>a one-line summary (the subject line of the issue)</li>
<li>the full text of the proposal</li>
<li>any required background information</li>
<li>pros and cons</li>
<li>possible alternatives</li>
</ul>
</li>
<li>
<p>A quorum is established in a meeting if half or more of voting members are
    present.</p>
</li>
<li>
<p>Once a person has sponsored a proposal, they are responsible for it.  The
    group may not discuss or vote on the issue unless the sponsor or their
    delegate is present.  The sponsor is also responsible for presenting the
    item to the group.</p>
</li>
<li>
<p>After the sponsor presents the proposal, a “sense” vote is cast for the
    proposal before any discussion:</p>
<ul>
<li>Who likes the proposal?</li>
<li>Who can live with the proposal?</li>
<li>Who is uncomfortable with the proposal?</li>
</ul>
</li>
<li>
<p>If everyone likes or can live with the proposal, it passes immediately.</p>
</li>
<li>
<p>If most of the group is uncomfortable with the proposal, it is postponed for
    further rework by the sponsor.</p>
</li>
<li>
<p>Otherwise, members who are uncomfortable can briefly state their objections.
    A timer is then set for a brief discussion moderated by the facilitator.
    After 10 minutes or when no one has anything further to add (whichever comes
    first), the facilitator calls for a yes-or-no vote on the question: “Should
    we implement this decision over the stated objections?”  If a majority votes
    “yes” the proposal is implemented.  Otherwise, the proposal is returned to
    the sponsor for further work.</p>
</li>
</ol>
<h2 id="contributing-formatting">Section E.2: Formatting</h2>
<p>This material uses <a href="https://www.dmulholl.com/docs/ivy/main/">Ivy</a> with some custom extensions;
run <code>make</code> in the root directory to get a list of available commands.
Please see <code>CONTRIBUTING.md</code> in the root directory of <a href="https://github.com/gvwilson/sdxpy">our Git repository</a>
for more information.</p>
</section>
<section class="new-chapter"><h1 id="glossary">Appendix: Appendix F: Glossary</h1>

<div class="page-toc"></div>
<div class="glossary">
<dl>
<dt><span class="gl-key" id="absolute_error">absolute error</span></dt>
<dd>The absolute value of the difference between the observed and the correct value. Absolute error is usually less useful than <a href="#relative_error">relative error</a>.</dd>
<dt><span class="gl-key" id="abstract_class">abstract class</span></dt>
<dd>A class that defines or requires methods it does not implement. An abstract class typically specifies the methods that <a href="#child_class">child classes</a> must have without providing default implementations.</dd>
<dt><span class="gl-key" id="abstract_method">abstract method</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a <a href="#method">method</a> that is defined but not implemented. Programmers will define an abstract method in a <a href="#parent_class">parent class</a> to specify operations that <a href="#child_class">child classes</a> must provide.</dd>
<dt><span class="gl-key" id="abstract_syntax_tree">abstract syntax tree</span> (AST)</dt>
<dd>A deeply nested data structure, or <a href="#tree">tree</a>, that represents the structure of a program. For example, the AST might have a <a href="#node">node</a> representing a <code>while</code> loop with one <a href="#child_tree">child</a> representing the loop condition and another representing the loop body.</dd>
<dt><span class="gl-key" id="accidental_complexity">accidental complexity</span></dt>
<dd>The extra difficulty added to a problem because of poor notation, poor tooling, an unclear problem statement, distractions, etc. The term is used in contrast with <a href="#intrinsic_complexity">intrinsic complexity</a>.</dd>
<dt><span class="gl-key" id="actual_result">actual result (of test)</span></dt>
<dd>The value generated by running code in a test. If this matches the <a href="#expected_result">expected result</a>, the test <a href="#pass_test">passes</a>; if the two are different, the test <a href="#fail_test">fails</a>.</dd>
<dt><span class="gl-key" id="affordance">affordance</span></dt>
<dd>An action that a thing can do: for example, a door can be opened or a document can be printed. Good user interfaces make affordances easy to discover.</dd>
<dt><span class="gl-key" id="alias">alias</span></dt>
<dd>A second or subsequent reference to the same object. Aliases are useful, but increase the cognitive load on readers who have to remember that all these names refer to the same thing.</dd>
<dt><span class="gl-key" id="ansi_encoding">ANSI character encoding</span></dt>
<dd>An extension of <a href="#ascii">ASCII</a> that standardized the characters represented by the codes 128 to 255.</dd>
<dt><span class="gl-key" id="abi">Application Binary Interface</span> (ABI)</dt>
<dd>The low-level layout that a piece of software must have to work on a particular kind of machine.</dd>
<dt><span class="gl-key" id="api">Application Programming Interface</span> (API)</dt>
<dd>A set of functions provided by a software library or web service that other software can call.</dd>
<dt><span class="gl-key" id="argument">argument</span></dt>
<dd>A value passed into a function or method call.</dd>
<dt><span class="gl-key" id="ascii">ASCII character encoding</span></dt>
<dd>A standard way to represent the characters commonly used in the Western European languages as 7-bit integers, now largely superceded by <a href="#unicode">Unicode</a>.</dd>
<dt><span class="gl-key" id="assembler">assembler</span></dt>
<dd>A <a href="#compiler">compiler</a> that translates software written in <a href="#assembly_code">assembly code</a> into machine instructions.</dd>
<dt><span class="gl-key" id="assembly_code">assembly code</span></dt>
<dd>A low-level programming language whose statements correspond closely to the actual <a href="#instruction_set">instruction set</a> of a particular kind of processor.</dd>
<dt><span class="gl-key" id="assertion">assertion</span></dt>
<dd>A <a href="#boolean">Boolean</a> expression that must be true at a certain point in a program. Assertions may be built into the language (e.g., Python’s <code>assert</code> statement) or provided as functions (as with Node’s <code>assert</code> library).</dd>
<dt><span class="gl-key" id="associative_array">associative array</span></dt>
<dd>See <a href="#dictionary">dictionary</a>.</dd>
<dt><span class="gl-key" id="atomic_operation">atomic operation</span></dt>
<dd>An operation that is guaranteed to complete, i.e., one that cannot be interrupted part-way through.</dd>
<dt><span class="gl-key" id="atomic_value">atomic value</span></dt>
<dd>A value that cannot be broken down into smaller parts, such as a Boolean or integer.</dd>
<dt><span class="gl-key" id="attribute">attribute</span></dt>
<dd>A name-value pair associated with an object, used to store <a href="#metadata">metadata</a> about the object such as an array’s dimensions.</dd>
<dt><span class="gl-key" id="authentication">authentication</span></dt>
<dd>The process of establishing identity. Authentication relies on something someone knows (such as a password), something they have (such as a key card), or something they are (such as a fingerprint).</dd>
<dt><span class="gl-key" id="automatic_variable">automatic variable</span></dt>
<dd>A variable that is automatically given a value in a <a href="#build_rule">build rule</a>. For example, Make automatically assigns the name of a rule’s <a href="#build_target">target</a> to the automatic variable <code>$@</code>. Automatic variables are frequently used when writing <a href="#pattern_rule">pattern rules</a>.</dd>
<dt><span class="gl-key" id="backward_compatible">backward-compatible</span></dt>
<dd>A property of a system that enables interoperability with an older legacy system, or with input designed for such a system.</dd>
<dt><span class="gl-key" id="base_class">base class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a <a href="#class">class</a> from which other classes are derived.</dd>
<dt><span class="gl-key" id="batch_processing">batch processing</span></dt>
<dd>Executing a set of non-interactive tasks on a computer, such as backing up files or copying data from one database to another overnight.</dd>
<dt><span class="gl-key" id="benchmark">benchmark</span></dt>
<dd>A program or set of programs used to measure the performance of a computer system.</dd>
<dt><span class="gl-key" id="big_endian">big endian</span></dt>
<dd>A storage scheme in which the most significant part of a number is stored in the byte with the lowest address. For example, the 16-bit big-endian representation of 258 stores 0x01 in the lower byte and 0x02 in the higher byte.</dd>
<dt><span class="gl-key" id="binary_mode">binary mode</span></dt>
<dd>An option for reading or writing files in which each byte is transferred literally. The term is used in contrast with <a href="#text_mode">text mode</a>.</dd>
<dt><span class="gl-key" id="bit_mask">bit mask</span></dt>
<dd>A pattern of bits used to set or clear bits in a byte or <a href="#word_memory">word</a> in memory.</dd>
<dt><span class="gl-key" id="bit_shift">bit shifting</span></dt>
<dd>To move the bits in a byte or <a href="#word_memory">word</a> left or right.</dd>
<dt><span class="gl-key" id="bitwise_operation">bitwise operation</span></dt>
<dd>An operation that manipulates individual bits in memory. Common bitwise operations include <code>and</code>, <code>or</code>, <code>not</code>, and <code>xor</code>.</dd>
<dt><span class="gl-key" id="http_body">body (of HTTP request or response)</span></dt>
<dd>The “extra” data associated with an <a href="#http_request">HTTP request</a> or <a href="#http_response">response</a>, such as the file being uploaded or the page being returned for display.</dd>
<dt><span class="gl-key" id="boolean">Boolean</span></dt>
<dd>Relating to a variable or data type that can have either a logical value of true or false. Named for George Boole, a 19th century mathematician.</dd>
<dt><span class="gl-key" id="boxed_value">boxed value</span></dt>
<dd>A value (such as an integer) that is embedded in a larger structure in memory that carries <a href="#metadata">metadata</a> about its type, how many structures are referring to it, and so on.</dd>
<dt><span class="gl-key" id="breakpoint">breakpoint</span></dt>
<dd>A point in a program where a debugger should halt execution in order to interact with a user.</dd>
<dt><span class="gl-key" id="build_manager">build manager</span></dt>
<dd>A program that keeps track of how files depend on one another and runs commands to update any files that are out-of-date. Build managers were invented to <a href="#compile">compile</a> only those parts of programs that had changed, but are now often used to implement workflows in which plots depend on results files, which in turn depend on raw data files or configuration files.</dd>
<dt><span class="gl-key" id="build_recipe">build recipe</span></dt>
<dd>The part of a <a href="#build_rule">build rule</a> that describes how to update something that has fallen out-of-date.</dd>
<dt><span class="gl-key" id="build_rule">build rule</span></dt>
<dd>A specification for a <a href="#build_manager">build manager</a> that describes how some files depend on others and what to do if those files are out-of-date.</dd>
<dt><span class="gl-key" id="bytecode">bytecode</span></dt>
<dd>A set of instructions designed to be executed efficiently by an <a href="#interpreter">interpreter</a>.</dd>
<dt><span class="gl-key" id="cache">cache</span></dt>
<dd>Something that stores copies of data so that future requests for it can be satisfied more quickly. The CPU in a computer uses a hardware cache to hold recently-accessed values; many programs rely on a software cache to reduce network traffic and latency. Figuring out when something in a cache is out-of-date and should be replaced is one of the <a href="#two_hard_problems">two hard problems in computer science</a>.</dd>
<dt><span class="gl-key" id="call_stack">call stack</span></dt>
<dd>A data structure that stores information about the active subroutines executed.</dd>
<dt><span class="gl-key" id="catch_exception">catch (an exception)</span></dt>
<dd>To handle an error or other unexpected event represented by an <a href="#exception">exception</a>.</dd>
<dt><span class="gl-key" id="chain_of_responsibility_pattern">Chain of Responsibility pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which each <a href="#object">object</a> either handles a request or passes it on to another object.</dd>
<dt><span class="gl-key" id="child_tree">child (in a tree)</span></dt>
<dd>A <a href="#node">node</a> in a <a href="#node">tree</a> that is below another node (call the <a href="#parent_tree">parent</a>).</dd>
<dt><span class="gl-key" id="child_class">child class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a <a href="#class">class</a> derived from another class (called the <a href="#parent_class">parent class</a>).</dd>
<dt><span class="gl-key" id="class">class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a structure that combines data and operations (called <a href="#method">methods</a>). The program then uses a <a href="#constructor">constructor</a> to create an <a href="#object">object</a> with those properties and methods. Programmers generally put generic or reusable behavior in <a href="#parent_class">parent classes</a>, and more detailed or specific behavior in <a href="#child_class">child classes</a>.</dd>
<dt><span class="gl-key" id="class_method">class method</span></dt>
<dd>A function defined inside a class that takes the class object as an input rather than an instance of the class.</dd>
<dt><span class="gl-key" id="clear_breakpoint">clear a breakpoint</span></dt>
<dd>To remove a <a href="#breakpoint">breakpoint</a> from a program.</dd>
<dt><span class="gl-key" id="client">client</span></dt>
<dd>A program such as a browser that sends requests to a server and does something with the response.</dd>
<dt><span class="gl-key" id="code_point">code point</span></dt>
<dd>A number that uniquely identifies a character in the <a href="#unicode">Unicode</a> standard.</dd>
<dt><span class="gl-key" id="cognitive_load">cognitive load</span></dt>
<dd>The mental effort required to solve a problem.</dd>
<dt><span class="gl-key" id="collision">collision (in hashing)</span></dt>
<dd>A situation in which two or more values have the same <a href="#hash_code">hash code</a>.</dd>
<dt><span class="gl-key" id="column_wise">column-wise storage</span></dt>
<dd>To organize the memory of a two-dimensional table so that the values in each column are laid out in contiguous blocks.</dd>
<dt><span class="gl-key" id="csv">comma-separated values</span> (CSV)</dt>
<dd>A text format for tabular data in which each <a href="#record">record</a> is one row and <a href="#field">fields</a> are separated by commas. There are many minor variations, particularly around quoting of <a href="#string">strings</a>.</dd>
<dt><span class="gl-key" id="compile">compile</span></dt>
<dd>To translate textual source into another form. Programs in <a href="#compiled_language">compiled languages</a> are translated into machine instructions for a computer to run, and <a href="#markdown">Markdown</a> is usually translated into <a href="#html">HTML</a> for display.</dd>
<dt><span class="gl-key" id="compiled_language">compiled language</span></dt>
<dd>Originally, a language such as C or Fortran that is translated into machine instructions for execution. Languages such as Java are also compiled before execution, but into <a href="#bytecode">bytecode</a> instead of machine instructions, while <a href="#interpreted_language">interpreted languages</a> like JavaScript are compiled to byte code on the fly.</dd>
<dt><span class="gl-key" id="compiler">compiler</span></dt>
<dd>An application that translates programs written in some languages into machine instructions or <a href="#bytecode">bytecode</a>.</dd>
<dt><span class="gl-key" id="concrete_class">concrete class</span></dt>
<dd>A class that can actually be instantiated. The term is used in contrast with <a href="#abstract_class">abstract class</a>.</dd>
<dt><span class="gl-key" id="conditional_breakpoint">conditional breakpoint</span></dt>
<dd>A <a href="#breakpoint">breakpoint</a> at which the debugger should only halt if some user-specified condition is true.</dd>
<dt><span class="gl-key" id="conditional_jump">conditional jump</span></dt>
<dd>An instruction that tells a processor to start executing somewhere other than at the next address if a condition is true. Conditional jumps are used to implement higher-level constructs like <code>if</code> statements and loops.</dd>
<dt><span class="gl-key" id="confirmation_bias">confirmation bias</span></dt>
<dd>The tendency for someone to look for evidence that they are right rather than searching for reasons why they might be wrong.</dd>
<dt><span class="gl-key" id="constructor">constructor</span></dt>
<dd>A function that creates an <a href="#object">object</a> of a particular <a href="#class">class</a>.</dd>
<dt><span class="gl-key" id="context_manager">context manager</span></dt>
<dd>An object that automatically executes some operations at the start of a code block and some other operations at the end of the block.</dd>
<dt><span class="gl-key" id="control_code">control code</span></dt>
<dd>Originally a “character” that made a teletype perform some operation, such as moving to the next line or ringing the bell. Only a handful of control codes such as tab and newline are still in common use.</dd>
<dt><span class="gl-key" id="control_flow">control flow</span></dt>
<dd>The order in which a program executes statements and expressions.</dd>
<dt><span class="gl-key" id="utc">Coordinated Universal Time</span> (UTC)</dt>
<dd>The standard time against which all others are defined. UTC is the time at longitude 0°, and is not adjusted for daylight savings. <a href="#timestamp">Timestamps</a> are often reported in UTC so that they will be the same no matter what timezone the computer is in.</dd>
<dt><span class="gl-key" id="cryptographic_hash_function">cryptographic hash function</span></dt>
<dd>A <a href="#hash_function">hash function</a> that produces an apparently-random value for any input.</dd>
<dt><span class="gl-key" id="data_engineer">data engineer</span></dt>
<dd>Someone responsible for designing, developing and maintaining systems for collecting, storing, and analyzing data.</dd>
<dt><span class="gl-key" id="data_migration">data migration</span></dt>
<dd>The act of moving data from one system or format to another.</dd>
<dt><span class="gl-key" id="dataframe">dataframe</span></dt>
<dd>A two-dimensional data structure for storing tabular data in memory. Rows represent <a href="#record">records</a> and columns represent <a href="#field">fields</a>.</dd>
<dt><span class="gl-key" id="decorator">decorator</span></dt>
<dd>A function A that can be applied to another function B when function B is being defined to change its behavior in some way.</dd>
<dt><span class="gl-key" id="defensive_programming">defensive programming</span></dt>
<dd>A set of programming practices that assumes mistakes will happen and either reports or corrects them, such as inserting <a href="#assertion">assertions</a> to report situations that are not ever supposed to occur.</dd>
<dt><span class="gl-key" id="dependency">dependency (in build)</span></dt>
<dd>Something that a <a href="#build_target">build target</a> depends on.</dd>
<dt><span class="gl-key" id="derived_class">derived class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a class that is a direct or indirect extension of a <a href="#base_class">base class</a>.</dd>
<dt><span class="gl-key" id="design_by_contract">design by contract</span></dt>
<dd>A style of designing software in which functions specify the <a href="#pre_condition">pre-conditions</a> that must be true in order for them to run and the <a href="#post_condition">post-conditions</a> they guarantee will be true when they return. A function can then be replaced by one with weaker pre-conditions (i.e., it accepts a wider set of input) and/or stronger post-conditions (i.e., it produces a smaller range of output) without breaking anything else.</dd>
<dt><span class="gl-key" id="design_pattern">design pattern</span></dt>
<dd>A recurring pattern in software design that is specific enough to be worth naming, but not so specific that a single best implementation can be provided by a <a href="#library">library</a>.</dd>
<dt><span class="gl-key" id="dictionary">dictionary</span></dt>
<dd>A data structure that allows items to be looked up by value, sometimes called an <a href="#associative_array">associative array</a>. Dictionaries are often implemented using <a href="#hash_table">hash tables</a>.</dd>
<dt><span class="gl-key" id="dictionary_comprehension">dictionary comprehension</span></dt>
<dd>A single expression that constructs a dictionary by looping over key-value pairs.</dd>
<dt><span class="gl-key" id="dag">directed acyclic graph</span> (DAG)</dt>
<dd>A <a href="#directed_graph">directed graph</a> which does not contain any loops (i.e., it is not possible to reach a <a href="#node">node</a> from itself by following edges).</dd>
<dt><span class="gl-key" id="directed_graph">directed graph</span></dt>
<dd>A <a href="#graph_data">graph</a> whose <a href="#edge">edges</a> have directions.</dd>
<dt><span class="gl-key" id="disassemble">disassemble</span></dt>
<dd>To convert machine instructions into <a href="#assembly_code">assembly code</a> or some higher-level language.</dd>
<dt><span class="gl-key" id="disassembler">disassembler</span></dt>
<dd>A program that translates machine instructions into <a href="#assembly_code">assembly code</a> or some higher-level language.</dd>
<dt><span class="gl-key" id="dispatch">dispatch</span></dt>
<dd>To decide what operation to perform next based on the type of an object or its properties.</dd>
<dt><span class="gl-key" id="docstring">docstring</span></dt>
<dd>A string at the start of a module, class, or function in Python that is not assigned to a variable, which is used to hold the documentation for that part of code.</dd>
<dt><span class="gl-key" id="dom">Document Object Model</span> (DOM)</dt>
<dd>A standard, in-memory representation of <a href="#html">HTML</a> and <a href="#xml">XML</a>. Each <a href="#element">element</a> is stored as a <a href="#node">node</a> in a <a href="#tree">tree</a> with a set of named <a href="#attribute">attributes</a>; contained elements are <a href="#child_tree">child nodes</a>.</dd>
<dt><span class="gl-key" id="dns">Domain Name System</span> (DNS)</dt>
<dd>A decentralized naming system for computers that translates <a href="#hostname">hostnames</a> into the <a href="#ip_address">IP address</a> of particular computers.</dd>
<dt><span class="gl-key" id="dry_run">dry run</span></dt>
<dd>An execution of a program that doesn’t change anything.</dd>
<dt><span class="gl-key" id="duck_typing">duck typing</span></dt>
<dd>A programming style in which the methods an object happens to have determines how it can be used, rather than what classes it inherits from.</dd>
<dt><span class="gl-key" id="dynamic_dispatch">dynamic dispatch</span></dt>
<dd>To find a function or a property of an <a href="#object">object</a> by name while a program is running. For example, instead of getting a specific property of an object using <code>obj.name</code>, a program might use <code>obj[someVariable]</code>, where <code>someVariable</code> could hold <code>"name"</code> or some other property name.</dd>
<dt><span class="gl-key" id="dynamic_scoping">dynamic scoping</span></dt>
<dd>To find the value of a variable by looking at what is on the <a href="#call_stack">call stack</a> at the moment the lookup is done. Almost all programming languages use <a href="#lexical_scoping">lexical scoping</a> instead, since it is more predictable.</dd>
<dt><span class="gl-key" id="eager_evaluation">eager evaluation</span></dt>
<dd>Evaluating expressions before they are used.</dd>
<dt><span class="gl-key" id="eager_matching">eager matching</span></dt>
<dd>Matching as much as possible, as early as possible.</dd>
<dt><span class="gl-key" id="easy_mode">easy mode</span></dt>
<dd>A term borrowed from gaming meaning to do something with obstacles or difficulties simplified or removed, often for practice purposes.</dd>
<dt><span class="gl-key" id="edge">edge</span></dt>
<dd>A connection between two <a href="#node">nodes</a> in a <a href="#graph_data">graph</a>. An edge may have data associated with it, such as a name or distance.</dd>
<dt><span class="gl-key" id="element">element</span></dt>
<dd>A named component in an <a href="#html">HTML</a> or <a href="#xml">XML</a> document. Elements are usually written <code>&lt;name&gt;</code>…<code>&lt;/name&gt;</code>, where “…” represents the content of the element. Elements often have <a href="#attribute">attributes</a>.</dd>
<dt><span class="gl-key" id="enumeration">enumeration</span></dt>
<dd>A set of distinct named values defined in a program.</dd>
<dt><span class="gl-key" id="environment">environment</span></dt>
<dd>The set of variables currently defined in a program.</dd>
<dt><span class="gl-key" id="error_test">error (result of test)</span></dt>
<dd>Signalled when something goes wrong in a <a href="#unit_test">unit test</a> itself rather than in the system being tested. In this case, we do not know anything about the correctness of the system.</dd>
<dt><span class="gl-key" id="error_handling">error handling</span></dt>
<dd>What a program does to detect and correct for errors. Examples include printing a message and using a default configuration if the user-specified configuration cannot be found.</dd>
<dt><span class="gl-key" id="escape_sequence">escape sequence</span></dt>
<dd>A series of two or more characters used to represent a character that otherwise couldn’t be represented. For example, the escape sequence <code>\"</code> is used to represent a single <code>"</code> character inside a double-quoted string.</dd>
<dt><span class="gl-key" id="exception">exception</span></dt>
<dd>An object that stores information about an error or other unusual event in a program. One part of a program will create and <a href="#raise_exception">raise an exception</a> to signal that something unexpected has happened; another part will <a href="#catch_exception">catch</a> it.</dd>
<dt><span class="gl-key" id="exception_handler">exception handler</span></dt>
<dd>A piece of code that deals with an <a href="#exception">exception</a> after it is <a href="#catch_exception">caught</a>, e.g., by recording a message, retrying the operation that failed, or performing an alternate operation.</dd>
<dt><span class="gl-key" id="exclusive_or">exclusive or</span></dt>
<dd>A logical (or bitwise) operator that is true (or 1) if its arguments have different values and false (or 0) if they are the same. Exclusive or implements “either/or” or “one or the other”.</dd>
<dt><span class="gl-key" id="expected_result">expected result (of test)</span></dt>
<dd>The value that a piece of software is supposed to produce when tested in a certain way, or the state in which it is supposed to leave the system.</dd>
<dt><span class="gl-key" id="exponent">exponent</span></dt>
<dd>The portion of a floating-point number that controls placement of the decimal point.</dd>
<dt><span class="gl-key" id="extensibility">extensibility</span></dt>
<dd>How easily new features can be added to a program or existing features can be changed.</dd>
<dt><span class="gl-key" id="fail_test">failure (result of test)</span></dt>
<dd>A test fails if the <a href="#actual_result">actual result</a> does not match the <a href="#expected_result">expected result</a>.</dd>
<dt><span class="gl-key" id="false_negative">false negative</span></dt>
<dd>A report that something is missing when it is actually present.</dd>
<dt><span class="gl-key" id="false_positive">false positive</span></dt>
<dd>A report that something is present when it is actually absent.</dd>
<dt><span class="gl-key" id="falsy">falsy</span></dt>
<dd>Refers to a value that is treated as false in Boolean expressions. In Python, this includes empty strings and lists and the number zero.</dd>
<dt><span class="gl-key" id="field">field</span></dt>
<dd>A component of a <a href="#record">record</a> containing a single value. Every record in a database <a href="#table">table</a> has the same fields.</dd>
<dt><span class="gl-key" id="fsm">finite state machine</span> (FSM)</dt>
<dd>A theoretical model of computing consisting of a <a href="#directed_graph">directed graph</a> whose nodes represent the states of the computation and whose arcs show how to move from one state to another. Every <a href="#regular_expression">regular expression</a> corresponds to a finite state machine.</dd>
<dt><span class="gl-key" id="fixture">fixture</span></dt>
<dd>The thing on which a test is run, such as the <a href="#parameter">parameters</a> to the function being tested or the file being processed.</dd>
<dt><span class="gl-key" id="garbage_collection">garbage collection</span></dt>
<dd>An automatic process in a program that finds and recycles memory that is no longer being used.</dd>
<dt><span class="gl-key" id="generator_function">generator function</span></dt>
<dd>A function whose state is automatically saved when it returns a value so that execution can be restarted from that point the next time it is called. One example of generator functions use is to produce streams of values that can be processed by <code>for</code> loops.</dd>
<dt><span class="gl-key" id="generic_function">generic function</span></dt>
<dd>A collection of functions with similar purpose, each operating on a different class of data.</dd>
<dt><span class="gl-key" id="graph_data">graph (data structure)</span></dt>
<dd>A data structure in which <a href="#node">nodes</a> are connected to one another by <a href="#edge">edges</a>.</dd>
<dt><span class="gl-key" id="greedy_algorithm">greedy algorithm</span></dt>
<dd>An algorithm that consumes as much input as possible, as early as possible.</dd>
<dt><span class="gl-key" id="hash_code">hash code</span></dt>
<dd>A value generated by a <a href="#hash_function">hash function</a>. Good hash codes have the same properties as random numbers in order to reduce the frequency of <a href="#collision">collisions</a>.</dd>
<dt><span class="gl-key" id="hash_function">hash function</span></dt>
<dd>A function that turns arbitrary data into a bit array, or a <a href="#key">key</a>, of a fixed size. Hash functions are used to determine where data should be stored in a <a href="#hash_table">hash table</a>.</dd>
<dt><span class="gl-key" id="hash_table">hash table</span></dt>
<dd>A data structure that calculates a pseudo-random key (location) for each value passed to it and stores the value in that location. Hash tables enable fast lookup for arbitrary data. This occurs at the cost of extra memory because hash tables must always be larger than the amount of information they need to store, to avoid the possibility of data collisions, when the hash function returns the same key for two different values.</dd>
<dt><span class="gl-key" id="http_header">header (of HTTP request or response)</span></dt>
<dd>A name-value pair at the start of an <a href="#http_request">HTTP request</a> or <a href="#http_response">response</a>. Headers are used to specify what data formats the sender can handle, the date and time the message was sent, and so on.</dd>
<dt><span class="gl-key" id="helper_class">helper class</span></dt>
<dd>A class created to support another class, but which has no purpose on its own.</dd>
<dt><span class="gl-key" id="heterogeneous">heterogeneous</span></dt>
<dd>Containing mixed data types. For example, an array in Javascript can contain a mix of numbers, character strings, and values of other types.</dd>
<dt><span class="gl-key" id="hexadecimal">hexadecimal</span></dt>
<dd>A base-16 numerical representation that uses the letters A-F (or a-f) to represent the values from 10 to 15.</dd>
<dt><span class="gl-key" id="homogeneous">homogeneous</span></dt>
<dd>Containing a single data type. For example, a <a href="#vector">vector</a> must be homogeneous: its values must all be numeric, logical, etc.</dd>
<dt><span class="gl-key" id="hostname">hostname</span></dt>
<dd>The human-readable name for a networked computer, such as <code>example.com</code>.</dd>
<dt><span class="gl-key" id="http_method">HTTP method</span></dt>
<dd>The verb in an <a href="#http_request">HTTP request</a> that defines what the <a href="#client">client</a> wants to do. Common methods are <code>GET</code> (to get data) and <code>POST</code> (to submit data).</dd>
<dt><span class="gl-key" id="http_protocol_version">HTTP protocol version</span></dt>
<dd>Specifies the version of <a href="#http">HTTP</a> being used, which in turn defines what headers can appear, how they are to be interpreted, etc.</dd>
<dt><span class="gl-key" id="http_request">HTTP request</span></dt>
<dd>A precisely-formatted block of text sent from a <a href="#client">client</a> such as a browser to a <a href="#server">server</a> that specifies what resource is being requested, what data formats the client will accept, etc.</dd>
<dt><span class="gl-key" id="http_response">HTTP response</span></dt>
<dd>A precisely-formatted block of text sent from a <a href="#server">server</a> back to a <a href="#client">client</a> in reply to a <a href="#http_request">request</a>.</dd>
<dt><span class="gl-key" id="http_status_code">HTTP status code</span></dt>
<dd>A numerical code that indicates what happened when an <a href="#http_request">HTTP request</a> was processed, such as 200 (OK), 404 (not found), or 500 (internal server error).</dd>
<dt><span class="gl-key" id="html">HyperText Markup Language</span> (HTML)</dt>
<dd>The standard <a href="#markup_language">markup language</a> used for web pages. HTML is represented in memory using <a href="#dom">DOM</a> (Digital Object Model).</dd>
<dt><span class="gl-key" id="http">HypterText Transfer Protocol</span> (HTTP)</dt>
<dd>The protocol used to exchange information between browsers and websites, and more generally between other clients and servers. Communication consists of <a href="#http_request">requests</a> and <a href="#http_response">responses</a>.</dd>
<dt><span class="gl-key" id="immutable">immutable</span></dt>
<dd>Data that cannot be changed after being created. Immutable data is easier to think about, particularly if data structures are shared between several tasks, but may result in higher memory requirements.</dd>
<dt><span class="gl-key" id="index_database">index (a database)</span></dt>
<dd>An auxiliary data structure in a database used to speed up search for some entries. An index increases memory and disk requirements but reduces search time.</dd>
<dt><span class="gl-key" id="instance">instance</span></dt>
<dd>An <a href="#object">object</a> of a particular <a href="#class">class</a>.</dd>
<dt><span class="gl-key" id="instruction_pointer">instruction pointer</span></dt>
<dd>A special <a href="#register">register</a> in a processor that stores the address of the next instruction to execute.</dd>
<dt><span class="gl-key" id="instruction_set">instruction set</span></dt>
<dd>The basic operations that a particular processor can execute directly.</dd>
<dt><span class="gl-key" id="internet_protocol">Internet Protocol</span> (IP)</dt>
<dd>A set of specifications for ways computers can communicate. <a href="#tcp">TCP/IP</a> is the most widely used.</dd>
<dt><span class="gl-key" id="interpreted_language">interpreted language</span></dt>
<dd>A high-level language that is not executed directly by the computer, but instead is run by an <a href="#interpreter">interpreter</a> that translates program instructions into machine commands on the fly.</dd>
<dt><span class="gl-key" id="interpreter">interpreter</span></dt>
<dd>A program whose job it is to run programs written in a high-level <a href="#interpreted_language">interpreted language</a>. Interpreters can run interactively, but may also execute commands saved in a file.</dd>
<dt><span class="gl-key" id="intrinsic_complexity">intrinsic complexity</span></dt>
<dd>The inherent difficult of a problem. The term is used in contrast to <a href="#accidental_complexity">accidental complexity</a>.</dd>
<dt><span class="gl-key" id="introspection">introspection</span></dt>
<dd>See <a href="#reflection">reflection</a>.</dd>
<dt><span class="gl-key" id="ip_address">IP address</span> (IP)</dt>
<dd>A four-part number that uniquely identifies a computer on a network.</dd>
<dt><span class="gl-key" id="iso_date_format">ISO date format</span></dt>
<dd>An international for formatting dates. While the full standard is complex, the most common form is <code>YYYY-MM-DD</code>, i.e., a four-digit year, a two-digit month, and a two-digit day, separated by hyphens.</dd>
<dt><span class="gl-key" id="iterator_pattern">Iterator pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which a temporary <a href="#object">object</a> or <a href="#generator_function">generator function</a> produces each value from a collection in turn for processing. This pattern hides the differences between different kinds of data structures so that everything can be processed using loops.</dd>
<dt><span class="gl-key" id="json">JavaScript Object Notation</span> (JSON)</dt>
<dd>A way to represent data by combining basic values like numbers and character strings in <a href="#list">lists</a> and <a href="#dictionary">key/value</a> structures. The acronym stands for “JavaScript Object Notation”; unlike better-defined standards like <a href="#xml">XML</a>, it is unencumbered by a syntax for comments or ways to define a <a href="#schema">schema</a>.</dd>
<dt><span class="gl-key" id="join">join (tables)</span></dt>
<dd>An operation that combines two <a href="#table">tables</a>, typically by matching <a href="#key">keys</a> from one with keys from another.</dd>
<dt><span class="gl-key" id="key">key</span></dt>
<dd>A <a href="#field">field</a> or combination of fields whose value(s) uniquely identify a <a href="#record">record</a> within a <a href="#table">table</a> or dataset. Keys are often used to select specific records and in <a href="#join">joins</a>.</dd>
<dt><span class="gl-key" id="label_address">label (address in memory)</span></dt>
<dd>A human-readable name given to a particular location in memory when writing programs in <a href="#assembly_code">assembly code</a>.</dd>
<dt><span class="gl-key" id="layout_engine">layout engine</span></dt>
<dd>A piece of software that decides where to place text, images, and other elements on a page.</dd>
<dt><span class="gl-key" id="lazy_evaluation">lazy evaluation</span></dt>
<dd>Evaluating expressions only when absolutely necessary.</dd>
<dt><span class="gl-key" id="lazy_matching">lazy matching</span></dt>
<dd>Matching as little as possible while still finding a valid match.</dd>
<dt><span class="gl-key" id="lexical_scoping">lexical scoping</span></dt>
<dd>To look up the value associated with a name according to the textual structure of a program. Most programming languages use lexical scoping instead of <a href="#dynamic_scoping">dynamic scoping</a> because the latter is less predictable.</dd>
<dt><span class="gl-key" id="library">library</span></dt>
<dd>An installable collection of software, also often called a <a href="#module">module</a> or <a href="#package">package</a>.</dd>
<dt><span class="gl-key" id="link">link (a program)</span></dt>
<dd>To combine separately <a href="#compile">compiled</a> modules into a single runnable program.</dd>
<dt><span class="gl-key" id="linter">linter</span></dt>
<dd>A program that checks for common problems in software, such as violations of indentation rules or variable naming conventions. The name comes from the first tool of its kind, called <code>lint</code>.</dd>
<dt><span class="gl-key" id="liskov_substitution_principle">Liskov Substitution Principle</span></dt>
<dd>A design rule stating that it should be possible to replace objects in a program with objects of derived classes without breaking the program. <a href="#design_by_contract">Design by contract</a> is intended to enforce this rule.</dd>
<dt><span class="gl-key" id="list">list</span></dt>
<dd>A <a href="#vector">vector</a> that can contain values of many different (<a href="#heterogeneous">heterogeneous</a>) types.</dd>
<dt><span class="gl-key" id="list_comprehension">list comprehension</span></dt>
<dd>A single expression that constructs a list by looping over its items.</dd>
<dt><span class="gl-key" id="literal">literal</span></dt>
<dd>A representation of a fixed value in a program, such as the digits <code>123</code> for the number 123 or the characters <code>"abc"</code> for the string containing those three letters.</dd>
<dt><span class="gl-key" id="little_endian">little endian</span></dt>
<dd>A storage scheme in which the most significant part of a number is stored in the byte with the highest address. For example, the 16-bit big-endian representation of 258 stores 0x02 in the lower byte and 0x01 in the higher byte.</dd>
<dt><span class="gl-key" id="manifest">manifest</span></dt>
<dd>A list of something’s parts or components.</dd>
<dt><span class="gl-key" id="mantissa">mantissa</span></dt>
<dd>The portion of a floating-point number that defines its specific value.</dd>
<dt><span class="gl-key" id="markdown">Markdown</span></dt>
<dd>A <a href="#markup_language">markup language</a> with a simple syntax intended as a replacement for <a href="#html">HTML</a>.</dd>
<dt><span class="gl-key" id="markup_language">markup language</span></dt>
<dd>A set of rules for annotating text to define its meaning or how it should be displayed. The markup is usually not displayed, but instead controls how the underlying text is interpreted or shown. <a href="#markdown">Markdown</a> and <a href="#html">HTML</a> are widely-used markup languages for web pages.</dd>
<dt><span class="gl-key" id="metadata">metadata</span></dt>
<dd>Data about data, such as the time a dataset was archived.</dd>
<dt><span class="gl-key" id="method">method</span></dt>
<dd>An implementation of a <a href="#generic_function">generic function</a> that handles objects of a specific class.</dd>
<dt><span class="gl-key" id="method_injection">method injection</span></dt>
<dd>To add methods to an existing class after its definition.</dd>
<dt><span class="gl-key" id="minimum_testable_class">minimum testable class</span></dt>
<dd>The simplest extension to an <a href="#abstract_class">abstract class</a> that can actually be used, particularly in tests.</dd>
<dt><span class="gl-key" id="mixin">mixin</span></dt>
<dd>A class that is not meant to be instantiated itself, but which contains methods to be added to other classes (typically via <a href="#multiple_inheritance">multiple inheritance</a>).</dd>
<dt><span class="gl-key" id="mock_object">mock object</span></dt>
<dd>A simplified replacement for part of a program whose behavior is easy to control and predict. Mock objects are used in <a href="#unit_test">unit tests</a> to simulate databases, web services, and other complex systems.</dd>
<dt><span class="gl-key" id="module">module</span></dt>
<dd>A reusable software <a href="#package">package</a>, also often called a <a href="#library">library</a>.</dd>
<dt><span class="gl-key" id="multiple_inheritance">multiple inheritance</span></dt>
<dd>In a programming language, the ability to derive a <a href="#child_class">child class</a> from two or more <a href="#parent_class">parent classes</a>.</dd>
<dt><span class="gl-key" id="named_tuple">named tuple</span></dt>
<dd>A tuple whose fields can be accessed by name as well as by location. Named tuples are used to implement records that don’t have any associated <a href="#method">methods</a>.</dd>
<dt><span class="gl-key" id="node">node</span></dt>
<dd>An element of a <a href="#graph_data">graph</a> that is connected to other nodes by <a href="#edge">edges</a>. Nodes typically have data associated with them, such as names or weights.</dd>
<dt><span class="gl-key" id="object">object</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a structure that contains the data for a specific instance of a <a href="#class">class</a>. The operations the object is capable of are defined by the class’s <a href="#method">methods</a>.</dd>
<dt><span class="gl-key" id="oop">object-oriented programming</span> (OOP)</dt>
<dd>A style of programming in which functions and data are bound together in <a href="#object">objects</a> that only interact with each other through well-defined interfaces.</dd>
<dt><span class="gl-key" id="off_by_one_error">off-by-one error</span></dt>
<dd>A common error in programming in which the program refers to element <code>i</code> of a structure when it should refer to element <code>i-1</code> or <code>i+1</code>, or processes <code>N</code> elements when it should process <code>N-1</code> or <code>N+1</code>.</dd>
<dt><span class="gl-key" id="olap">online analytical processing</span> (OLAP)</dt>
<dd>Analyzing data in bulk. The term is used in contrast to <a href="#oltp">OLTP</a>.</dd>
<dt><span class="gl-key" id="oltp">online transaction processing</span> (OLTP)</dt>
<dd>Adding records to a database or querying individual records. The term is used in contrast to <a href="#olap">OLAP</a>.</dd>
<dt><span class="gl-key" id="op_code">op code</span></dt>
<dd>The numerical code for a particular instruction that a processor can execute.</dd>
<dt><span class="gl-key" id="open_closed_principle">Open-Closed Principle</span></dt>
<dd>A design rule stating that software should be open for extension but closed for modification, i.e., it should be possible to extend functionality without having to rewrite existing code.</dd>
<dt><span class="gl-key" id="overlay_configuration">overlay configuration</span></dt>
<dd>A technique for configuring programs in which several layers of configuration are used, each overriding settings in the ones before.</dd>
<dt><span class="gl-key" id="package">package</span></dt>
<dd>A collection of code, data, and documentation that can be distributed and re-used. Also referred to in some languages as a <a href="#library">library</a> or <a href="#module">module</a>.</dd>
<dt><span class="gl-key" id="parameter">parameter</span></dt>
<dd>The name that a function gives to one of the values passed to it when it is called.</dd>
<dt><span class="gl-key" id="parameter_sweeping">parameter sweeping</span></dt>
<dd>To execute a program multiple times with different parameters to find out how its behavior or performance depends on those parameters.</dd>
<dt><span class="gl-key" id="parent_tree">parent (in a tree)</span></dt>
<dd>A <a href="#node">node</a> in a <a href="#node">tree</a> that is above another node (called a <a href="#child_tree">child</a>). Every node in a tree except the <a href="#root_tree">root node</a> has a single parent.</dd>
<dt><span class="gl-key" id="parent_class">parent class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, the <a href="#class">class</a> from which a sub class (called the <a href="#child_class">child class</a>) is derived.</dd>
<dt><span class="gl-key" id="parser">parser</span></dt>
<dd>A function or program that reads data in a particular format and converts it to a data structure in memory. Every programming language has a parser that reads programs written in that language; parsers also exist for various data formats.</dd>
<dt><span class="gl-key" id="pass_test">pass (result of test)</span></dt>
<dd>A test passes if the <a href="#actual_result">actual result</a> matches the <a href="#expected_result">expected result</a>.</dd>
<dt><span class="gl-key" id="path_resolution">path resolution</span></dt>
<dd>The process of converting filename portion of a <a href="#url">URL</a> into a specific file on disk.</dd>
<dt><span class="gl-key" id="pattern_rule">pattern rule (in build)</span></dt>
<dd>A generic <a href="#build_rule">build rule</a> that describes how to update any file whose name matches a pattern. Pattern rules often use <a href="#automatic_variable">automatic variables</a> to represent the actual filenames.</dd>
<dt><span class="gl-key" id="persistence">persistence</span></dt>
<dd>The act of saving and restoring data, particularly <a href="#heterogeneous">heterogeneous</a> data with irregular structure.</dd>
<dt><span class="gl-key" id="phony_target">phony target</span></dt>
<dd>A <a href="#build_recipe">build recipe</a> that doesn’t update any files. Phony targets are typically used to make tasks such as running tests reproducible.</dd>
<dt><span class="gl-key" id="pipe_shell">pipe (in the Unix shell)</span></dt>
<dd>The <code>|</code> used to make the output of one command the input of the next.</dd>
<dt><span class="gl-key" id="placeholder_file">placeholder file</span></dt>
<dd>A file stored in place of some other file (such as a large dataset) that contains <a href="#metadata">metadata</a> about that other file.</dd>
<dt><span class="gl-key" id="polymorphism">polymorphism</span></dt>
<dd>Having many different implementations of the same interface. If a set of functions or objects are polymorphic, they can be called interchangeably.</dd>
<dt><span class="gl-key" id="port">port</span></dt>
<dd>A logical endpoint for communication, like a phone number in an office building. Only one program on a computer may use a particular port on that computer at any time.</dd>
<dt><span class="gl-key" id="post_condition">post-condition</span></dt>
<dd>Something that is guaranteed to be true after a function runs successfully. Post-conditions are often expressed as <a href="#assertion">assertions</a> that are guaranteed to be be true of a function’s results.</dd>
<dt><span class="gl-key" id="pre_condition">pre-condition</span></dt>
<dd>Something that must be true before a function runs in order for it to work correctly. Pre-conditions are often expressed as as <a href="#assertion">assertions</a> that must be true of a function’s inputs in order for it to run successfully.</dd>
<dt><span class="gl-key" id="precedence">precedence</span></dt>
<dd>The priority of an operation. For example, multiplication has a higher precedence than addition, so <code>a+b*c</code> is read as “the sum of <code>a</code> with the product of <code>b</code> and <code>c</code>”.</dd>
<dt><span class="gl-key" id="prerequisite">prerequisite</span></dt>
<dd>Something that a <a href="#build_target">build target</a> depends on.</dd>
<dt><span class="gl-key" id="protocol">protocol</span></dt>
<dd>A set of rules that something promises to obey, i.e., the contract between that thing and its users.</dd>
<dt><span class="gl-key" id="provenance">provenance</span></dt>
<dd>The sequence of steps that led to a particular result.</dd>
<dt><span class="gl-key" id="pythonic">Pythonic</span></dt>
<dd>Conforming to common Python programming style and practices.</dd>
<dt><span class="gl-key" id="query_parameter">query parameter</span></dt>
<dd>A key-value pair appended to the path portion of a [URL][url].</dd>
<dt><span class="gl-key" id="race_condition">race condition</span></dt>
<dd>A situation in which a result depends on the order in which two or more concurrent operations are carried out.</dd>
<dt><span class="gl-key" id="raise_exception">raise (an exception)</span></dt>
<dd>To signal that something unexpected or unusual has happened in a program by creating an <a href="#exception">exception</a> and handing it to the <a href="#error_handling">error-handling</a> system, which then tries to find a point in the program that will <a href="#catch_exception">catch</a> it.</dd>
<dt><span class="gl-key" id="record">record</span></dt>
<dd>A group of related values that are stored together. A record may be represented as a <a href="#tuple">tuple</a> or as a row in a <a href="#table">table</a>; in the latter case, every record in the table has the same <a href="#field">fields</a>.</dd>
<dt><span class="gl-key" id="recursion">recursion</span></dt>
<dd>To define something in terms of itself, or the act of a function invoking itself (directly or indirectly).</dd>
<dt><span class="gl-key" id="refactor">refactor</span></dt>
<dd>To rewrite existing code in order to make it simpler or more efficient without changing its functionality.</dd>
<dt><span class="gl-key" id="reflection">reflection</span></dt>
<dd>To inspect the properties of a running program in a generic way. Reflection relies on the fact that a program is just another data structure.</dd>
<dt><span class="gl-key" id="register">register</span></dt>
<dd>A small piece of memory (typically one <a href="#word_memory">word</a> long) built into a processor that operations can refer to directly.</dd>
<dt><span class="gl-key" id="regression">regression</span></dt>
<dd>A change that breaks something that used to work.</dd>
<dt><span class="gl-key" id="regular_expression">regular expression</span></dt>
<dd>A pattern for matching text, written as text itself. Regular expressions are sometimes called “regexp”, “regex”, or “RE”, and are powerful tools for working with text.</dd>
<dt><span class="gl-key" id="relational_database">relational database</span></dt>
<dd>A database that organizes information into <a href="#table">tables</a>, each of which has a fixed set of named <a href="#field">fields</a> (shown as columns) and a variable number of <a href="#record">records</a> (shown as rows).</dd>
<dt><span class="gl-key" id="relative_error">relative error</span></dt>
<dd>The absolute value of the difference between the actual and correct value divided by the correct value. For example, if the actual value is 9 and the correct value is 10, the relative error is 0.1. Relative error is usually more useful than <a href="#absolute_error">absolute error</a>.</dd>
<dt><span class="gl-key" id="reverse_lookup">reverse lookup</span></dt>
<dd>To find the key associated with a particular value in a table.</dd>
<dt><span class="gl-key" id="root_tree">root (in a tree)</span></dt>
<dd>The <a href="#node">node</a> in a <a href="#tree">tree</a> of which all other nodes are direct or indirect <a href="#child_tree">children</a>, or equivalently the only node in the tree that has no <a href="#parent_tree">parent</a>.</dd>
<dt><span class="gl-key" id="row_wise">row-wise storage</span></dt>
<dd>To organize the memory of a two-dimensional table so that the values in each row are laid out in contiguous blocks.</dd>
<dt><span class="gl-key" id="runtime">runtime</span></dt>
<dd>A program that implements the basic operations used in a programming language.</dd>
<dt><span class="gl-key" id="schema">schema</span></dt>
<dd>A specification of the format of a dataset, including the name, format, and content of each <a href="#table">table</a>.</dd>
<dt><span class="gl-key" id="scope">scope</span></dt>
<dd>A region of a program in which names can be defined without colliding with definitions in other parts of the program. In Python, each <a href="#module">module</a> and function creates a new scope.</dd>
<dt><span class="gl-key" id="server">server</span></dt>
<dd>A program that waits for requests from <a href="#client">clients</a> and sends them data in response.</dd>
<dt><span class="gl-key" id="sha256">SHA-256 hash code</span></dt>
<dd>A <a href="#cryptographic_hash_function">cryptographic hash function</a> that produces a 256-bit output.</dd>
<dt><span class="gl-key" id="sign_magnitude">sign and magnitude</span></dt>
<dd>A binary representation of integers in which one bit indicates whether the value is positive or negative and the remaining bits indicate its magnitude.</dd>
<dt><span class="gl-key" id="signature">signature</span></dt>
<dd>The ordered list of parameters and return values that specifies how a function must be called and what it returns.</dd>
<dt><span class="gl-key" id="singleton">singleton</span></dt>
<dd>A set with only one element, or a <a href="#class">class</a> with only one <a href="#instance">instance</a>.</dd>
<dt><span class="gl-key" id="singleton_pattern">Singleton pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> that creates a <a href="#singleton">singleton</a> <a href="#object">object</a> to manage some resource or service, such as a database or <a href="#cache">cache</a>. In <a href="#oop">object-oriented programming</a>, the pattern is usually implemented by hiding the <a href="#constructor">constructor</a> of the <a href="#class">class</a> in some way so that it can only be called once.</dd>
<dt><span class="gl-key" id="socket">socket</span></dt>
<dd>A communication channel between two computers that provides an interface similar to reading and writing files.</dd>
<dt><span class="gl-key" id="spread">spread</span></dt>
<dd>To automatically match the values from a list or dictionary supplied by the caller to the parameters of a function.</dd>
<dt><span class="gl-key" id="sql">SQL</span></dt>
<dd>The language used for writing queries for a <a href="#relational_database">relational database</a>. The term was originally an acronym for Structured Query Language.</dd>
<dt><span class="gl-key" id="stack_frame">stack frame</span></dt>
<dd>A section of the <a href="#call_stack">call stack</a> that records details of a single call to a specific function.</dd>
<dt><span class="gl-key" id="build_stale">stale (in build)</span></dt>
<dd>To be out-of-date compared to a <a href="#prerequisite">prerequisite</a>. A <a href="#build_manager">build manager</a>‘s job is to find and update things that are stale.</dd>
<dt><span class="gl-key" id="stderr">standard error</span></dt>
<dd>A predefined communication channel typically used to report errors.</dd>
<dt><span class="gl-key" id="stdin">standard input</span></dt>
<dd>A predefined communication channel typically used to read input from the keyboard or from the previous process in a <a href="#pipe_shell">pipe</a>.</dd>
<dt><span class="gl-key" id="stdout">standard output</span></dt>
<dd>A predefined communication channel typically used to send output to the screen or to the next process in a <a href="#pipe_shell">pipe</a>.</dd>
<dt><span class="gl-key" id="static_method">static method</span></dt>
<dd>A function that is defined within a class but does not require either the class itself or an instance of the class as a parameter.</dd>
<dt><span class="gl-key" id="static_site_generator">static site generator</span></dt>
<dd>A software tool that creates HTML pages from templates and content.</dd>
<dt><span class="gl-key" id="streaming_api">streaming API</span></dt>
<dd>An <a href="#api">API</a> that processes data in chunks rather than needing to have all of it in memory at once. Streaming APIs usually require handlers for events such as “start of data”, “next block”, and “end of data”.</dd>
<dt><span class="gl-key" id="string">string</span></dt>
<dd>A block of text in a program. The term is short for “character string”.</dd>
<dt><span class="gl-key" id="table">table</span></dt>
<dd>A set of <a href="#record">records</a> in a <a href="#relational_database">relational database</a> or <a href="#dataframe">dataframe</a>.</dd>
<dt><span class="gl-key" id="build_target">target (in build)</span></dt>
<dd>The file(s) that a <a href="#build_rule">build rule</a> will update if they are out-of-date compared to their <a href="#dependency">dependencies</a>.</dd>
<dt><span class="gl-key" id="template_method_pattern">Template Method pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which a <a href="#parent_class">parent class</a> defines an overall sequence of operations by calling <a href="#abstract_method">abstract methods</a> that <a href="#child_class">child classes</a> must then implement. Each child class then behaves in the same general way, but implements the steps differently.</dd>
<dt><span class="gl-key" id="test_fidelity">test fidelity</span></dt>
<dd>The degree to which a <a href="#mock_object">mock object</a> or other replacement for part or all of a system mimics the behavior of that system for testing purposes.</dd>
<dt><span class="gl-key" id="text_mode">text mode</span></dt>
<dd>An option for reading or writing files in which bytes are translated to or from characters and end-of-line markers are normalized. The term is used in contrast with <a href="#binary_mode">binary mode</a>.</dd>
<dt><span class="gl-key" id="throw_exception">throw exception</span></dt>
<dd>Another term for <a href="#raise_exception">raising</a> an exception.</dd>
<dt><span class="gl-key" id="toctou">time of check - time of use</span></dt>
<dd>A <a href="#race_condition">race condition</a> in which a process checks the state of something and then operates on it, but some other process might alter that state between the check and the operation.</dd>
<dt><span class="gl-key" id="timestamp">timestamp</span></dt>
<dd>A digital identifier showing the time at which something was created or accessed. Timestamps should use <a href="#iso_date_format">ISO date format</a> for portability.</dd>
<dt><span class="gl-key" id="token">token</span></dt>
<dd>An indivisible unit of text for a parser, such as a variable name or a number. Exactly what constitutes a token depends on the language.</dd>
<dt><span class="gl-key" id="topological_order">topological order</span></dt>
<dd>Any ordering of the <a href="#node">nodes</a> in a <a href="#graph_data">graph</a> that respects the direction of its <a href="#edge">edges</a>, i.e., if there is an edge from node A to node B, A comes before B in the ordering. There may be many topological orderings of a particular graph.</dd>
<dt><span class="gl-key" id="tcp">Transmission Control Protocol</span> (TCP/IP)</dt>
<dd>The most popular member of the <a href="#internet_protocol">IP</a> family of protocols. TCP/IP tries to deliver messages reliably and in order so that programs can communicate as if they were reading and writing files.</dd>
<dt><span class="gl-key" id="tree">tree</span></dt>
<dd>A <a href="#graph_data">graph</a> in which every node except the <a href="#root_tree">root</a> has exactly one <a href="#parent_tree">parent</a>.</dd>
<dt><span class="gl-key" id="truthy">truthy</span></dt>
<dd>Refers to a value that is treated as true in Boolean expressions. In Python, this includes non-empty strings and lists and numbers other than zero.</dd>
<dt><span class="gl-key" id="tuple">tuple</span></dt>
<dd>A value that has a fixed number of parts, such as the three color components of a red-green-blue color specification.</dd>
<dt><span class="gl-key" id="turing_machine">Turing Machine</span></dt>
<dd>A theoretical model of computation that manipulates symbols on an infinite tape according to a fixed table of rules. Any computation that can be expressed as an algorithm can be done by a Turing Machine.</dd>
<dt><span class="gl-key" id="two_hard_problems">two hard problems in computer science</span></dt>
<dd>Refers to a quote by Phil Karlton: “There are only two hard problems in computer science—cache invalidation and naming things.” Many variations add a third problem as a joke, such as <a href="#off_by_one_error">off-by-one errors</a>.</dd>
<dt><span class="gl-key" id="twos_complement">two’s complement</span></dt>
<dd>A binary representation of integers that “rolls over” like an odometer to represent negative values.</dd>
<dt><span class="gl-key" id="unicode">Unicode</span></dt>
<dd>A standard that defines numeric codes for many thousands of characters and symbols. Unicode does not define how those numbers are stored; that is done by standards like <a href="#utf_8">UTF-8</a>.</dd>
<dt><span class="gl-key" id="unit_test">unit test</span></dt>
<dd>A test that exercises one function or feature of a piece of software and produces <a href="#pass_test">pass</a>, <a href="#fail_test">fail</a>, or <a href="#error_test">error</a>.</dd>
<dt><span class="gl-key" id="url">Universal Resource Locator</span> (URL)</dt>
<dd>A multi-part identifier that specifies something on a computer network. A URL may contain a protocol (such as <code>http</code>), a <a href="#hostname">hostname</a> such as <code>example.com</code>, a <a href="#port">port</a> (such as 80), a path (such as <code>/homepage.html</code>), and various other things.</dd>
<dt><span class="gl-key" id="unparsing">unparsing</span></dt>
<dd>Converting an <a href="#abstract_syntax_tree">abstract syntax tree</a> back into source code.</dd>
<dt><span class="gl-key" id="upcall">upcall</span></dt>
<dd>The act of explicitly invoking a method of a <a href="#parent_class">parent class</a> from inside a <a href="#child_class">child class</a>. A method in a child class may upcall to the corresponding method in the parent class as parent of extending that method.</dd>
<dt><span class="gl-key" id="utf_32">UTF-32</span></dt>
<dd>A way to store the numeric codes representing <a href="#unicode">Unicode</a> characters in which every character is stored as a 32-bit integer.</dd>
<dt><span class="gl-key" id="utf_8">UTF-8</span></dt>
<dd>A way to store the numeric codes representing <a href="#unicode">Unicode</a> characters that is <a href="#backward_compatible">backward-compatible</a> with the older <a href="#ascii">ASCII</a> standard.</dd>
<dt><span class="gl-key" id="variable_length_encoding">variable-length encoding</span></dt>
<dd>Any technique for representing data in which a single logical unit of data may be represented by a variable number of bits or bytes.</dd>
<dt><span class="gl-key" id="vector">vector</span></dt>
<dd>A sequence of values, usually of <a href="#homogeneous">homogeneous</a> type.</dd>
<dt><span class="gl-key" id="version_control_system">version control system</span></dt>
<dd>A system for managing changes made to software during its development.</dd>
<dt><span class="gl-key" id="virtual_machine">virtual machine</span></dt>
<dd>A program that pretends to be a computer. This may seem a bit redundant, but VMs are quick to create and start up, and changes made inside the virtual machine are contained within that VM so we can install new <a href="#package">packages</a> or run a completely different operating system without affecting the underlying computer.</dd>
<dt><span class="gl-key" id="visitor_pattern">Visitor pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which the operation to be done is taken to each element of a data structure in turn. It is usually implemented by having a generator “visitor” that knows how to reach the structure’s elements, which is given a function or method to call for each in turn, and that carries out the specific operation.</dd>
<dt><span class="gl-key" id="watchpoint">watchpoint</span></dt>
<dd>A location or variable being monitored by a debugger. If the value at that location or in that variable changes, the debugger halts and gives the user a chance to inspect the program.</dd>
<dt><span class="gl-key" id="well_formed">well-formed</span></dt>
<dd>A piece of text that obeys the rules of a formal grammar is said to be well formed.</dd>
<dt><span class="gl-key" id="word_memory">word (of memory)</span></dt>
<dd>The unit of memory that a particular processor most naturally works with. While a byte is a fixed size (8 bits), a word may be 16, 32, or 64 bits long depending on the processor.</dd>
<dt><span class="gl-key" id="xml">XML</span></dt>
<dd>A set of rules for defining <a href="#html">HTML</a>-like tags and using them to format documents (typically data). XML was popular in the early 2000s, but its complexity led many programmers to adopt <a href="#json">JSON</a>, instead.</dd>
<dt><span class="gl-key" id="yaml">Yet Another Markup Language</span> (YAML)</dt>
<dd>Short for “YAML Ain’t Markup Language”, a way to represent nested data using indentation rather than the parentheses and commas of <a href="#json">JSON</a>. YAML is often used in configuration files and to define <a href="#parameter">parameters</a> for various flavors of <a href="#markdown">Markdown</a> documents.</dd>
<dt><span class="gl-key" id="z_buffering">z-buffering</span></dt>
<dd>A drawing method that keeps track of the depth of what lies “under” each pixel so that it displays whatever is nearest to the observer.</dd>
</dl>
</div>
</section>
<section class="new-chapter"><h1 id="credits">Appendix: Appendix G: Credits</h1>

<div class="page-toc"></div>
<p><strong>Greg Wilson</strong> has worked in industry and academia for 35 years, and is the author, co-author, or editor of several books, including <em>Beautiful Code</em>, <em>The Architecture of Open Source Applications</em>, <em>JavaScript for Data Science</em>, <em>Teaching Tech Together</em>, and <em>Research Software Engineering with Python</em>. He was the co-founder and first Executive Director of Software Carpentry and received ACM SIGSOFT’s Influential Educator Award in 2020.</p>
</section>
<section class="new-chapter"><h1 id="contents">Appendix: Appendix H: Index</h1>

<div class="page-toc"></div>
<ul class="ix-list">
<li>algorithm</li>
<li>…greedy: <a class="ix-ref" href="#matching" ix-ref="greedy">Matching Patterns</a>, <a class="ix-ref" href="#parser" ix-ref="greedy">Parsing Text</a></li>
<li>algorithm</li>
<li>…lazy: <a class="ix-ref" href="#matching" ix-ref="lazy">Matching Patterns</a>, <a class="ix-ref" href="#parser" ix-ref="lazy">Parsing Text</a></li>
<li>ANTLR: <a class="ix-ref" href="#parser" ix-ref="ANTLR">Parsing Text</a></li>
<li>Application Binary Interface: <a class="ix-ref" href="#vm" ix-ref="Application Binary Interface">A Virtual Machine</a></li>
<li>array</li>
<li>…implementation of: <a class="ix-ref" href="#vm" ix-ref="implementation of">A Virtual Machine</a></li>
<li>assembler: <a class="ix-ref" href="#vm" ix-ref="assembler">A Virtual Machine</a></li>
<li>assembly code: <a class="ix-ref" href="#vm" ix-ref="assembly code">A Virtual Machine</a></li>
<li>atomic operation: <a class="ix-ref" href="#cache" ix-ref="atomic operation">A File Cache</a></li>
<li>automatic variable (in build): <a class="ix-ref" href="#builder" ix-ref="automatic variable (in build)">A Build Manager</a></li>
<li>batch processing: <a class="ix-ref" href="#dataframe" ix-ref="batch processing">A Dataframe</a></li>
<li>benchmarking: <a class="ix-ref" href="#dataframe" ix-ref="benchmarking">A Dataframe</a></li>
<li>bitwise operation: <a class="ix-ref" href="#vm" ix-ref="bitwise operation">A Virtual Machine</a></li>
<li>breakpoint: <a class="ix-ref" href="#debugger" ix-ref="breakpoint">A Debugger</a></li>
<li>Brubeck, Matt: <a class="ix-ref" href="#layout" ix-ref="Brubeck, Matt">Page Layout</a></li>
<li>build</li>
<li>…automatic variable: <a class="ix-ref" href="#builder" ix-ref="automatic variable">A Build Manager</a></li>
<li>build</li>
<li>…clock synchronization: <a class="ix-ref" href="#builder" ix-ref="clock synchronization">A Build Manager</a></li>
<li>build</li>
<li>…dependency: <a class="ix-ref" href="#builder" ix-ref="dependency">A Build Manager</a></li>
<li>build</li>
<li>…hash code: <a class="ix-ref" href="#builder" ix-ref="hash code">A Build Manager</a></li>
<li>build</li>
<li>…pattern rule: <a class="ix-ref" href="#builder" ix-ref="pattern rule">A Build Manager</a></li>
<li>build</li>
<li>…recipe: <a class="ix-ref" href="#builder" ix-ref="recipe">A Build Manager</a></li>
<li>build</li>
<li>…rule: <a class="ix-ref" href="#builder" ix-ref="rule">A Build Manager</a></li>
<li>build</li>
<li>…stale: <a class="ix-ref" href="#builder" ix-ref="stale">A Build Manager</a></li>
<li>build</li>
<li>…timestamp: <a class="ix-ref" href="#builder" ix-ref="timestamp">A Build Manager</a></li>
<li>build manager: <a class="ix-ref" href="#builder" ix-ref="build manager">A Build Manager</a></li>
<li>build rule: <a class="ix-ref" href="#builder" ix-ref="build rule">A Build Manager</a></li>
<li>build target: <a class="ix-ref" href="#builder" ix-ref="build target">A Build Manager</a></li>
<li>C: <a class="ix-ref" href="#builder" ix-ref="C">A Build Manager</a></li>
<li>cache</li>
<li>…calculated values: <a class="ix-ref" href="#layout" ix-ref="calculated values">Page Layout</a></li>
<li>call stack: <a class="ix-ref" href="#interpreter" ix-ref="call stack">An Interpreter</a></li>
<li>…stack frame: <a class="ix-ref" href="#interpreter" ix-ref="stack frame">An Interpreter</a></li>
<li>Chain of Responsibility pattern: <a class="ix-ref" href="#matching" ix-ref="Chain of Responsibility pattern">Matching Patterns</a></li>
<li>clear (a breakpoint); breakpoint</li>
<li>…clear: <a class="ix-ref" href="#debugger" ix-ref="clear">A Debugger</a></li>
<li>client (web application): <a class="ix-ref" href="#server" ix-ref="client (web application)">A Web Server</a></li>
<li>clock synchronization (in build): <a class="ix-ref" href="#builder" ix-ref="clock synchronization (in build)">A Build Manager</a></li>
<li>cognitive load: <a class="ix-ref" href="#templating" ix-ref="cognitive load">A Static Site Generator</a></li>
<li>collision (in hashing): <a class="ix-ref" href="#backup" ix-ref="collision (in hashing)">Versioned File Backups</a></li>
<li>column-wise storage; storage</li>
<li>…column-wise: <a class="ix-ref" href="#dataframe" ix-ref="column-wise">A Dataframe</a></li>
<li>compiled language: <a class="ix-ref" href="#builder" ix-ref="compiled language">A Build Manager</a></li>
<li>…linking: <a class="ix-ref" href="#builder" ix-ref="linking">A Build Manager</a></li>
<li>conditional breakpoint: <a class="ix-ref" href="#debugger" ix-ref="conditional breakpoint">A Debugger</a></li>
<li>confirmation bias: <a class="ix-ref" href="#layout" ix-ref="confirmation bias">Page Layout</a></li>
<li>Cook, Mary Rose: <a class="ix-ref" href="#backup" ix-ref="Cook, Mary Rose">Versioned File Backups</a></li>
<li>coordinate system: <a class="ix-ref" href="#layout" ix-ref="coordinate system">Page Layout</a></li>
<li>cryptographic hash function: <a class="ix-ref" href="#backup" ix-ref="cryptographic hash function">Versioned File Backups</a></li>
<li>DAG: <a class="ix-ref" href="#builder" ix-ref="DAG">A Build Manager</a></li>
<li>data engineer: <a class="ix-ref" href="#dataframe" ix-ref="data engineer">A Dataframe</a></li>
<li>dataframe: <a class="ix-ref" href="#dataframe" ix-ref="dataframe">A Dataframe</a></li>
<li>debugger: <a class="ix-ref" href="#debugger" ix-ref="debugger">A Debugger</a>, <a class="ix-ref" href="#builder" ix-ref="debugger">A Build Manager</a></li>
<li>dependency (in build): <a class="ix-ref" href="#builder" ix-ref="dependency (in build)">A Build Manager</a></li>
<li>design by contract: <a class="ix-ref" href="#layout" ix-ref="design by contract">Page Layout</a></li>
<li>design pattern</li>
<li>…Chain of Responsibility: <a class="ix-ref" href="#matching" ix-ref="Chain of Responsibility">Matching Patterns</a></li>
<li>design pattern</li>
<li>…Template Method: <a class="ix-ref" href="#builder" ix-ref="Template Method">A Build Manager</a></li>
<li>design pattern</li>
<li>…Visitor: <a class="ix-ref" href="#linter" ix-ref="Visitor">A Style Checker</a>, <a class="ix-ref" href="#templating" ix-ref="Visitor">A Static Site Generator</a></li>
<li>directed acyclic graph (DAG): <a class="ix-ref" href="#builder" ix-ref="directed acyclic graph (DAG)">A Build Manager</a></li>
<li>DNS (Domain Name System): <a class="ix-ref" href="#server" ix-ref="DNS (Domain Name System)">A Web Server</a></li>
<li>docstring: <a class="ix-ref" href="#dataframe" ix-ref="docstring">A Dataframe</a>, <a class="ix-ref" href="#tester" ix-ref="docstring">A Testing Framework</a></li>
<li>DOM: <a class="ix-ref" href="#layout" ix-ref="DOM">Page Layout</a>, <a class="ix-ref" href="#matching" ix-ref="DOM">Matching Patterns</a>, <a class="ix-ref" href="#templating" ix-ref="DOM">A Static Site Generator</a></li>
<li>Domain Name System (DNS): <a class="ix-ref" href="#server" ix-ref="Domain Name System (DNS)">A Web Server</a></li>
<li>duck typing: <a class="ix-ref" href="#persistence" ix-ref="duck typing">Object Persistence</a></li>
<li>dynamic scoping: <a class="ix-ref" href="#interpreter" ix-ref="dynamic scoping">An Interpreter</a></li>
<li>eager matching: <a class="ix-ref" href="#matching" ix-ref="eager matching">Matching Patterns</a></li>
<li>EJS: <a class="ix-ref" href="#templating" ix-ref="EJS">A Static Site Generator</a></li>
<li>execution</li>
<li>…streaming: <a class="ix-ref" href="#backup" ix-ref="streaming">Versioned File Backups</a></li>
<li>fidelity (in testing): <a class="ix-ref" href="#server" ix-ref="fidelity (in testing)">A Web Server</a></li>
<li>finite state machine</li>
<li>…correspondence with regular expressions: <a class="ix-ref" href="#parser" ix-ref="correspondence with regular expressions">Parsing Text</a></li>
<li>fixture: <a class="ix-ref" href="#backup" ix-ref="fixture">Versioned File Backups</a></li>
<li>function signature: <a class="ix-ref" href="#layout" ix-ref="function signature">Page Layout</a></li>
<li>Git: <a class="ix-ref" href="#backup" ix-ref="Git">Versioned File Backups</a></li>
<li>greedy algorithm: <a class="ix-ref" href="#matching" ix-ref="greedy algorithm">Matching Patterns</a>, <a class="ix-ref" href="#parser" ix-ref="greedy algorithm">Parsing Text</a></li>
<li>hash code: <a class="ix-ref" href="#backup" ix-ref="hash code">Versioned File Backups</a></li>
<li>…in build: <a class="ix-ref" href="#builder" ix-ref="in build">A Build Manager</a></li>
<li>…SHA256: <a class="ix-ref" href="#backup" ix-ref="SHA256">Versioned File Backups</a></li>
<li>hash function: <a class="ix-ref" href="#backup" ix-ref="hash function">Versioned File Backups</a></li>
<li>…collision: <a class="ix-ref" href="#backup" ix-ref="collision">Versioned File Backups</a></li>
<li>…cryptographic: <a class="ix-ref" href="#backup" ix-ref="cryptographic">Versioned File Backups</a></li>
<li>header (HTTP): <a class="ix-ref" href="#server" ix-ref="header (HTTP)">A Web Server</a></li>
<li>Hoye, Mike: <a class="ix-ref" href="#layout" ix-ref="Hoye, Mike">Page Layout</a></li>
<li>HTML5 specification: <a class="ix-ref" href="#templating" ix-ref="HTML5 specification">A Static Site Generator</a></li>
<li>HTTP (Hypertext Transfer Protocol): <a class="ix-ref" href="#server" ix-ref="HTTP (Hypertext Transfer Protocol)">A Web Server</a></li>
<li>HTTP header: <a class="ix-ref" href="#server" ix-ref="HTTP header">A Web Server</a></li>
<li>HTTP request: <a class="ix-ref" href="#server" ix-ref="HTTP request">A Web Server</a></li>
<li>HTTP response: <a class="ix-ref" href="#server" ix-ref="HTTP response">A Web Server</a></li>
<li>HTTP status code: <a class="ix-ref" href="#server" ix-ref="HTTP status code">A Web Server</a></li>
<li>Human Resource Machine: <a class="ix-ref" href="#vm" ix-ref="Human Resource Machine">A Virtual Machine</a></li>
<li>Hypertext Transfer Protocol (HTTP): <a class="ix-ref" href="#server" ix-ref="Hypertext Transfer Protocol (HTTP)">A Web Server</a></li>
<li>IEEE 754 standard: <a class="ix-ref" href="#binary" ix-ref="IEEE 754 standard">Binary Storage</a></li>
<li>instruction pointer: <a class="ix-ref" href="#vm" ix-ref="instruction pointer">A Virtual Machine</a></li>
<li>instruction set: <a class="ix-ref" href="#vm" ix-ref="instruction set">A Virtual Machine</a></li>
<li>Internet Protocol (IP): <a class="ix-ref" href="#server" ix-ref="Internet Protocol (IP)">A Web Server</a></li>
<li>introspection: <a class="ix-ref" href="#persistence" ix-ref="introspection">Object Persistence</a></li>
<li>IP (Internet Protocol): <a class="ix-ref" href="#server" ix-ref="IP (Internet Protocol)">A Web Server</a></li>
<li>IP address: <a class="ix-ref" href="#server" ix-ref="IP address">A Web Server</a></li>
<li>Java: <a class="ix-ref" href="#builder" ix-ref="Java">A Build Manager</a></li>
<li>Jekyll: <a class="ix-ref" href="#templating" ix-ref="Jekyll">A Static Site Generator</a></li>
<li>Kernighan, Brian: <a class="ix-ref" href="#matching" ix-ref="Kernighan, Brian">Matching Patterns</a></li>
<li>label (on address): <a class="ix-ref" href="#vm" ix-ref="label (on address)">A Virtual Machine</a></li>
<li>language</li>
<li>…compiled: <a class="ix-ref" href="#builder" ix-ref="compiled">A Build Manager</a></li>
<li>layout engine: <a class="ix-ref" href="#layout" ix-ref="layout engine">Page Layout</a></li>
<li>lazy algorithm: <a class="ix-ref" href="#matching" ix-ref="lazy algorithm">Matching Patterns</a>, <a class="ix-ref" href="#parser" ix-ref="lazy algorithm">Parsing Text</a></li>
<li>lexical scoping: <a class="ix-ref" href="#interpreter" ix-ref="lexical scoping">An Interpreter</a></li>
<li>linking (compiled language): <a class="ix-ref" href="#builder" ix-ref="linking (compiled language)">A Build Manager</a></li>
<li>Liskov Substitution Principle: <a class="ix-ref" href="#layout" ix-ref="Liskov Substitution Principle">Page Layout</a></li>
<li>literal (in parsing): <a class="ix-ref" href="#parser" ix-ref="literal (in parsing)">Parsing Text</a></li>
<li>Make: <a class="ix-ref" href="#server" ix-ref="Make">A Web Server</a>, <a class="ix-ref" href="#builder" ix-ref="Make">A Build Manager</a></li>
<li>matching</li>
<li>…eager: <a class="ix-ref" href="#matching" ix-ref="eager">Matching Patterns</a></li>
<li>minimum testable class: <a class="ix-ref" href="#cache" ix-ref="minimum testable class">A File Cache</a></li>
<li>mixin class: <a class="ix-ref" href="#layout" ix-ref="mixin class">Page Layout</a></li>
<li>mock object: <a class="ix-ref" href="#debugger" ix-ref="mock object">A Debugger</a>, <a class="ix-ref" href="#backup" ix-ref="mock object">Versioned File Backups</a></li>
<li>multiple inheritance: <a class="ix-ref" href="#layout" ix-ref="multiple inheritance">Page Layout</a></li>
<li>Nystrom, Bob: <a class="ix-ref" href="#vm" ix-ref="Nystrom, Bob">A Virtual Machine</a></li>
<li>online analytical processing (OLAP); OLAP (online analytical processing): <a class="ix-ref" href="#dataframe" ix-ref="online analytical processing (OLAP); OLAP (online analytical processing)">A Dataframe</a></li>
<li>online transaction processing (OLTP); OLTP (online transaction processing): <a class="ix-ref" href="#dataframe" ix-ref="online transaction processing (OLTP); OLTP (online transaction processing)">A Dataframe</a></li>
<li>op code: <a class="ix-ref" href="#vm" ix-ref="op code">A Virtual Machine</a></li>
<li>Open-Closed Principle: <a class="ix-ref" href="#persistence" ix-ref="Open-Closed Principle">Object Persistence</a></li>
<li>operator precedence</li>
<li>…implementing: <a class="ix-ref" href="#parser" ix-ref="implementing">Parsing Text</a></li>
<li>parameter sweeping: <a class="ix-ref" href="#dataframe" ix-ref="parameter sweeping">A Dataframe</a></li>
<li>parser: <a class="ix-ref" href="#parser" ix-ref="parser">Parsing Text</a></li>
<li>…shunting-yard algorithm: <a class="ix-ref" href="#parser" ix-ref="shunting-yard algorithm">Parsing Text</a></li>
<li>pattern rule (in build): <a class="ix-ref" href="#builder" ix-ref="pattern rule (in build)">A Build Manager</a></li>
<li>persistence: <a class="ix-ref" href="#persistence" ix-ref="persistence">Object Persistence</a></li>
<li>PHP: <a class="ix-ref" href="#templating" ix-ref="PHP">A Static Site Generator</a></li>
<li>Polge, Thibault: <a class="ix-ref" href="#backup" ix-ref="Polge, Thibault">Versioned File Backups</a></li>
<li>polymorphism: <a class="ix-ref" href="#matching" ix-ref="polymorphism">Matching Patterns</a></li>
<li>port: <a class="ix-ref" href="#server" ix-ref="port">A Web Server</a></li>
<li>query parameter: <a class="ix-ref" href="#server" ix-ref="query parameter">A Web Server</a></li>
<li>race condition: <a class="ix-ref" href="#backup" ix-ref="race condition">Versioned File Backups</a></li>
<li>…time of check/time of use: <a class="ix-ref" href="#backup" ix-ref="time of check/time of use">Versioned File Backups</a></li>
<li>recipe (in build): <a class="ix-ref" href="#builder" ix-ref="recipe (in build)">A Build Manager</a></li>
<li>refactor: <a class="ix-ref" href="#debugger" ix-ref="refactor">A Debugger</a></li>
<li>register (in computer): <a class="ix-ref" href="#vm" ix-ref="register (in computer)">A Virtual Machine</a></li>
<li>row-wise storage; storage</li>
<li>…row-wise: <a class="ix-ref" href="#dataframe" ix-ref="row-wise">A Dataframe</a></li>
<li>rule</li>
<li>…build: <a class="ix-ref" href="#builder" ix-ref="build">A Build Manager</a></li>
<li>rule (in build): <a class="ix-ref" href="#builder" ix-ref="rule (in build)">A Build Manager</a></li>
<li>scoping</li>
<li>…dynamic: <a class="ix-ref" href="#interpreter" ix-ref="dynamic">An Interpreter</a></li>
<li>scoping</li>
<li>…lexical: <a class="ix-ref" href="#interpreter" ix-ref="lexical">An Interpreter</a></li>
<li>server (web application): <a class="ix-ref" href="#server" ix-ref="server (web application)">A Web Server</a></li>
<li>SHA256 hash code: <a class="ix-ref" href="#backup" ix-ref="SHA256 hash code">Versioned File Backups</a></li>
<li>shunting-yard algorithm: <a class="ix-ref" href="#parser" ix-ref="shunting-yard algorithm">Parsing Text</a></li>
<li>signature</li>
<li>…of function: <a class="ix-ref" href="#layout" ix-ref="of function">Page Layout</a></li>
<li>sin</li>
<li>…using regular expressions to parse HTML: <a class="ix-ref" href="#parser" ix-ref="using regular expressions to parse HTML">Parsing Text</a></li>
<li>socket: <a class="ix-ref" href="#server" ix-ref="socket">A Web Server</a></li>
<li>software design</li>
<li>…design by contract: <a class="ix-ref" href="#layout" ix-ref="design by contract">Page Layout</a></li>
<li>software design</li>
<li>…Liskov Substitution Principle: <a class="ix-ref" href="#layout" ix-ref="Liskov Substitution Principle">Page Layout</a></li>
<li>software design</li>
<li>…Open-Closed Principle: <a class="ix-ref" href="#persistence" ix-ref="Open-Closed Principle">Object Persistence</a></li>
<li>spreading (arguments): <a class="ix-ref" href="#dataframe" ix-ref="spreading (arguments)">A Dataframe</a></li>
<li>stack frame: <a class="ix-ref" href="#interpreter" ix-ref="stack frame">An Interpreter</a></li>
<li>Stack, Connor: <a class="ix-ref" href="#database" ix-ref="Stack, Connor">A Database</a></li>
<li>stale (in build): <a class="ix-ref" href="#builder" ix-ref="stale (in build)">A Build Manager</a></li>
<li>static method: <a class="ix-ref" href="#templating" ix-ref="static method">A Static Site Generator</a></li>
<li>static site generator: <a class="ix-ref" href="#templating" ix-ref="static site generator">A Static Site Generator</a></li>
<li>status code (HTTP): <a class="ix-ref" href="#server" ix-ref="status code (HTTP)">A Web Server</a></li>
<li>streaming API: <a class="ix-ref" href="#backup" ix-ref="streaming API">Versioned File Backups</a></li>
<li>target</li>
<li>…build: <a class="ix-ref" href="#builder" ix-ref="build">A Build Manager</a></li>
<li>TCP/IP (Transmission Control Protocol): <a class="ix-ref" href="#server" ix-ref="TCP/IP (Transmission Control Protocol)">A Web Server</a></li>
<li>Template Method pattern: <a class="ix-ref" href="#builder" ix-ref="Template Method pattern">A Build Manager</a></li>
<li>time of check/time of use: <a class="ix-ref" href="#backup" ix-ref="time of check/time of use">Versioned File Backups</a></li>
<li>timestamp</li>
<li>…in build: <a class="ix-ref" href="#builder" ix-ref="in build">A Build Manager</a></li>
<li>token (in parsing): <a class="ix-ref" href="#parser" ix-ref="token (in parsing)">Parsing Text</a></li>
<li>topological order: <a class="ix-ref" href="#linter" ix-ref="topological order">A Style Checker</a>, <a class="ix-ref" href="#builder" ix-ref="topological order">A Build Manager</a></li>
<li>Transmission Control Protocol (TCP/IP): <a class="ix-ref" href="#server" ix-ref="Transmission Control Protocol (TCP/IP)">A Web Server</a></li>
<li>Turing Machine: <a class="ix-ref" href="#parser" ix-ref="Turing Machine">Parsing Text</a></li>
<li>upcall: <a class="ix-ref" href="#debugger" ix-ref="upcall">A Debugger</a></li>
<li>version control system: <a class="ix-ref" href="#backup" ix-ref="version control system">Versioned File Backups</a></li>
<li>…Git: <a class="ix-ref" href="#backup" ix-ref="Git">Versioned File Backups</a></li>
<li>virtual machine: <a class="ix-ref" href="#vm" ix-ref="virtual machine">A Virtual Machine</a></li>
<li>…op code: <a class="ix-ref" href="#vm" ix-ref="op code">A Virtual Machine</a></li>
<li>Visitor pattern: <a class="ix-ref" href="#linter" ix-ref="Visitor pattern">A Style Checker</a>, <a class="ix-ref" href="#templating" ix-ref="Visitor pattern">A Static Site Generator</a></li>
<li>watchpoints: <a class="ix-ref" href="#debugger" ix-ref="watchpoints">A Debugger</a></li>
</ul>
</section></body>
</html>

