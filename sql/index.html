<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<script src="https://kit.fontawesome.com/4eee35f757.js"></script>
<link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
<link rel="stylesheet" href="./res/github.css" type="text/css">
<link rel="stylesheet" href="./res/tutorial.css" type="text/css">
<script defer data-domain="gvwilson.github.io/sql-tutorial" src="https://plausible.io/js/script.js"></script>
<title>An Introduction to SQL for Weary Data Scientists</title>

  </head>
  <body>
    <nav>
  <div class="row underline">
    <div class="col-2 left">
      <a class="navlink" href="./">Home</a>
    </div>
    <div class="col-10 right">
      <a href="https://github.com/gvwilson/sql-tutorial">repo</a>
      <a href="https://github.com/gvwilson/sql-tutorial/raw/main/sql-tutorial.zip">download</a>
      <a class="navlink" href="./license/">license</a>
      <a class="navlink" href="./conduct/">conduct</a>
      <a class="navlink" href="./contributing/">contributing</a>
      <a class="navlink" href="./colophon/">colophon</a>
    </div>
  </div>
</nav>

    <main>
      <h1>An Introduction to SQL for Weary Data Scientists</h1>
      
<!-- 0 -->
<!-- 0 -->

<blockquote>
  <p><strong>2024-02-07: Exercises Needed</strong></p>

  <p>This tutorial needs (at least) 40 exercises.
If you would like to propose one,
please <a href="https://github.com/gvwilson/sql-tutorial/issues">submit an issue</a>
with the question you would ask and the SQL you would want the learner to write.
It doesn’t have to use the databases in the <code class="language-plaintext highlighter-rouge">db</code> folder,
but that would make learners’ lives easier.
All contributions will be acknowledged in the lesson.</p>

  <p>Note: I’m asking for proposals partly because I’m lazy,
but also because I know from experience that
I often focus on a handful of things that I personally found challenging
and overlook other topics.
Asking for help is one way to compensate for those blind spots.</p>
</blockquote>

<!-- ---------------------------------------------------------------- -->
<section class="aside">
  <h2 class="aside">what this is</h2>

  <ul>
    <li>notes and working examples that instructors can use to perform a lesson
      <ul>
        <li>do <em>not</em> expect novices with no prior SQL experience to be able to learn from them</li>
      </ul>
    </li>
    <li>musical analogy
      <ul>
        <li>this is the chord changes and melody</li>
        <li>we expect instructors to create an arrangement and/or improvise while delivering</li>
        <li>see <a href="https://teachtogether.tech/"><em>Teaching Tech Together</em></a> for background</li>
      </ul>
    </li>
    <li>please see <a href="./license/">the license</a> for terms of use,
the <a href="./conduct/">Code of Conduct</a> for community standards,
and <a href="./contributing/">these guidelines</a> for notes on contributing</li>
    <li>about the author:
<a href="https://third-bit.com/">Greg Wilson</a> is a programmer, author, and educator based in Toronto</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">scope</h2>

  <ul>
    <li><a href="http://teachtogether.tech/en/index.html#s:process-personas">intended audience</a>
      <ul>
        <li>Rachel has a master’s degree in cell biology
and now works in a research hospital doing cell assays.</li>
        <li>She learned a bit of R in an undergrad biostatistics course
and has been through <a href="https://swcarpentry.github.io/shell-novice/">the Carpentries lesson on the Unix shell</a>.</li>
        <li>Rachel is thinking about becoming a data scientist
and would like to understand how data is stored and managed.</li>
        <li>Her work schedule is unpredictable and highly variable,
so she needs to be able to learn a bit at a time.</li>
      </ul>
    </li>
    <li>prerequisites
      <ul>
        <li>basic Unix command line: <code class="language-plaintext highlighter-rouge">cd</code>, <code class="language-plaintext highlighter-rouge">ls</code>, <code class="language-plaintext highlighter-rouge">*</code> wildcard</li>
        <li>basic tabular data analysis: filtering rows, aggregating within groups</li>
      </ul>
    </li>
    <li>learning outcomes
      <ol>
        <li>Explain the difference between a database and a database manager.</li>
        <li>Write SQL to select, filter, sort, group, and aggregate data.</li>
        <li>Define tables and insert, update, and delete records.</li>
        <li>Describe different types of join and write queries that use them to combine data.</li>
        <li>Use windowing functions to operate on adjacent rows.</li>
        <li>Explain what transactions are and write queries that roll back when constraints are violated.</li>
        <li>Explain what triggers are and write SQL to create them.</li>
        <li>Manipulate JSON data using SQL.</li>
        <li>Interact with a database using Python directly, from a Jupyter notebook, and via an ORM.</li>
      </ol>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">setup</h2>

  <ul>
    <li>Download <a href="https://github.com/gvwilson/sql-tutorial/raw/main/sql-tutorial.zip">the latest release</a></li>
    <li>Unzip the file in a temporary directory to create:
      <ul>
        <li><code class="language-plaintext highlighter-rouge">./db/*.db</code>: the <a href="https://sqlite.org/">SQLite</a> databases used in the examples</li>
        <li><code class="language-plaintext highlighter-rouge">./src/*.*</code>: SQL queries, Python scripts, and other source code</li>
        <li><code class="language-plaintext highlighter-rouge">./out/*.*</code>: expected output for examples</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">background concepts</h2>

  <ul>
    <li>A <a href="#g:database">database</a> is a collection of data that can be searched and retrieved</li>
    <li>A <a href="#g:dbms">database management system</a> (DBMS) is a program that manages a particular kind of database</li>
    <li>Each DBMS stores data in its own way
      <ul>
        <li><a href="https://sqlite.org/">SQLite</a> stores each database in a single file</li>
        <li><a href="https://www.postgresql.org/">PostgreSQL</a> spreads information across many files for higher performance</li>
      </ul>
    </li>
    <li>DBMS can be a library embedded in other programs (<a href="https://sqlite.org/">SQLite</a>) or a server (<a href="https://www.postgresql.org/">PostgreSQL</a>)</li>
    <li>A <a href="#g:rdbms">relational database management system</a> (RDBMS) stores data in tables and uses <a href="https://en.wikipedia.org/wiki/SQL">SQL</a> for queries
      <ul>
        <li>Unfortunately, every RDBMS has its own dialect of SQL</li>
      </ul>
    </li>
    <li>There are also <a href="#g:nosql">NoSQL databases</a> like <a href="https://www.mongodb.com/">MongoDB</a> that don’t use tables</li>
  </ul>

  <p><img src="./img/concept_map_overview.svg" alt="concept map: overview" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">connect to database</h2>

  <p class="inclusion"><a href="src/connect_penguins.sh">src/connect_penguins.sh</a></p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 data/penguins.db
</code></pre></div>  </div>

  <ul>
    <li>Not actually a query: starts an interactive session</li>
    <li>Alternative: provide a single query on the command line <code>sqlite3 <em>database</em> "<em>query</em>"</code></li>
    <li>Or put query in file and run <code>sqlite3 <em>database</em> &lt; <em>filename</em></code></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">select constant</h2>

  <p class="inclusion"><a href="src/select_1.sql">src/select_1.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/select_1.out">out/select_1.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">select</code> is a keyword</li>
    <li>Normally used to select data from table…</li>
    <li>…but if all we want is a constant value, we don’t need to specify one</li>
    <li>Semi-colon terminator is required</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">select all values from table</h2>

  <p class="inclusion"><a href="src/select_star.sql">src/select_star.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">little_penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/select_star.out">out/select_star.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Gentoo|Biscoe|51.3|14.2|218.0|5300.0|MALE
Adelie|Dream|35.7|18.0|202.0|3550.0|FEMALE
Adelie|Torgersen|36.6|17.8|185.0|3700.0|FEMALE
Chinstrap|Dream|55.8|19.8|207.0|4000.0|MALE
Adelie|Dream|38.1|18.6|190.0|3700.0|FEMALE
Adelie|Dream|36.2|17.3|187.0|3300.0|FEMALE
Adelie|Dream|39.5|17.8|188.0|3300.0|FEMALE
Gentoo|Biscoe|42.6|13.7|213.0|4950.0|FEMALE
Gentoo|Biscoe|52.1|17.0|230.0|5550.0|MALE
Adelie|Torgersen|36.7|18.8|187.0|3800.0|FEMALE
</code></pre></div>  </div>

  <ul>
    <li>An actual <a href="#g:query">query</a></li>
    <li>Use <code class="language-plaintext highlighter-rouge">*</code> to mean “all columns”</li>
    <li>Use <code>from <em>tablename</em></code> to specify table</li>
    <li>Output format is not particularly readable</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">administrative commands</h2>

  <p class="inclusion"><a href="src/admin_commands.sql">src/admin_commands.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">headers</span> <span class="k">on</span>
<span class="p">.</span><span class="k">mode</span> <span class="n">markdown</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">little_penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/admin_commands.out">out/admin_commands.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  |  island   | bill_length_mm | bill_depth_mm | flipper_length_mm | body_mass_g |  sex   |
|-----------|-----------|----------------|---------------|-------------------|-------------|--------|
| Gentoo    | Biscoe    | 51.3           | 14.2          | 218.0             | 5300.0      | MALE   |
| Adelie    | Dream     | 35.7           | 18.0          | 202.0             | 3550.0      | FEMALE |
| Adelie    | Torgersen | 36.6           | 17.8          | 185.0             | 3700.0      | FEMALE |
| Chinstrap | Dream     | 55.8           | 19.8          | 207.0             | 4000.0      | MALE   |
| Adelie    | Dream     | 38.1           | 18.6          | 190.0             | 3700.0      | FEMALE |
| Adelie    | Dream     | 36.2           | 17.3          | 187.0             | 3300.0      | FEMALE |
| Adelie    | Dream     | 39.5           | 17.8          | 188.0             | 3300.0      | FEMALE |
| Gentoo    | Biscoe    | 42.6           | 13.7          | 213.0             | 4950.0      | FEMALE |
| Gentoo    | Biscoe    | 52.1           | 17.0          | 230.0             | 5550.0      | MALE   |
| Adelie    | Torgersen | 36.7           | 18.8          | 187.0             | 3800.0      | FEMALE |
</code></pre></div>  </div>

  <ul>
    <li><a href="https://sqlite.org/">SQLite</a> administrative commands start with <code class="language-plaintext highlighter-rouge">.</code> and <em>aren’t</em> part of the SQL standard
      <ul>
        <li>PostgreSQL’s special commands start with <code class="language-plaintext highlighter-rouge">\</code></li>
      </ul>
    </li>
    <li>Use <code class="language-plaintext highlighter-rouge">.help</code> for a complete list</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">specify columns</h2>

  <p class="inclusion"><a href="src/specify_columns.sql">src/specify_columns.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">island</span><span class="p">,</span>
    <span class="n">sex</span>
<span class="k">from</span> <span class="n">little_penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/specify_columns.out">out/specify_columns.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  |  island   |  sex   |
|-----------|-----------|--------|
| Gentoo    | Biscoe    | MALE   |
| Adelie    | Dream     | FEMALE |
| Adelie    | Torgersen | FEMALE |
| Chinstrap | Dream     | MALE   |
| Adelie    | Dream     | FEMALE |
| Adelie    | Dream     | FEMALE |
| Adelie    | Dream     | FEMALE |
| Gentoo    | Biscoe    | FEMALE |
| Gentoo    | Biscoe    | MALE   |
| Adelie    | Torgersen | FEMALE |
</code></pre></div>  </div>

  <ul>
    <li>Specify column names separated by commas
      <ul>
        <li>In any order</li>
        <li>Duplicates allowed</li>
      </ul>
    </li>
    <li>Line breaks <strike>allowed</strike> encouraged for readability</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">sort</h2>

  <p class="inclusion"><a href="src/sort.sql">src/sort.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">little_penguins</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">island</span> <span class="k">asc</span><span class="p">,</span> <span class="n">sex</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/sort.out">out/sort.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  |  sex   |  island   |
|-----------|--------|-----------|
| Gentoo    | MALE   | Biscoe    |
| Gentoo    | MALE   | Biscoe    |
| Gentoo    | FEMALE | Biscoe    |
| Chinstrap | MALE   | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Dream     |
| Adelie    | FEMALE | Torgersen |
| Adelie    | FEMALE | Torgersen |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">order by</code> must follow <code class="language-plaintext highlighter-rouge">from</code> (which must follow <code class="language-plaintext highlighter-rouge">select</code>)</li>
    <li><code class="language-plaintext highlighter-rouge">asc</code> is ascending, <code class="language-plaintext highlighter-rouge">desc</code> is descending
      <ul>
        <li>Default is ascending, but please specify</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="exercise">
  <h2 class="exercise"></h2>

  <p><strong>Exercise 1</strong>: 
Write a SQL query to select the sex and body mass columns from the <code class="language-plaintext highlighter-rouge">little_penguins</code> in that order,
sorted such that the largest body mass appears first.</p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">limit output</h2>

  <ul>
    <li>Full dataset has 344 rows</li>
  </ul>

  <p class="inclusion"><a href="src/limit.sql">src/limit.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="n">island</span>
<span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/limit.out">out/limit.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Adelie  |        | Dream     |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li>Comments start with <code class="language-plaintext highlighter-rouge">--</code> and run to the end of the line</li>
    <li><code>limit <em>N</em></code> specifies maximum number of rows returned by query</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">page output</h2>

  <p class="inclusion"><a href="src/page.sql">src/page.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="n">island</span>
<span class="k">limit</span> <span class="mi">10</span> <span class="k">offset</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/page.out">out/page.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species |  sex   |  island   |
|---------|--------|-----------|
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  |        | Torgersen |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
| Adelie  | FEMALE | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li><code>offset <em>N</em></code> must follow <code class="language-plaintext highlighter-rouge">limit</code></li>
    <li>Specifies number of rows to skip from the start of the selection</li>
    <li>So this query skips the first 3 and shows the next 10</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">remove duplicates</h2>

  <p class="inclusion"><a href="src/distinct.sql">src/distinct.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/distinct.out">out/distinct.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  |  sex   |  island   |
|-----------|--------|-----------|
| Adelie    | MALE   | Torgersen |
| Adelie    | FEMALE | Torgersen |
| Adelie    |        | Torgersen |
| Adelie    | FEMALE | Biscoe    |
| Adelie    | MALE   | Biscoe    |
| Adelie    | FEMALE | Dream     |
| Adelie    | MALE   | Dream     |
| Adelie    |        | Dream     |
| Chinstrap | FEMALE | Dream     |
| Chinstrap | MALE   | Dream     |
| Gentoo    | FEMALE | Biscoe    |
| Gentoo    | MALE   | Biscoe    |
| Gentoo    |        | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">distinct</code> keyword must appear right after <code class="language-plaintext highlighter-rouge">select</code>
      <ul>
        <li>SQL was supposed to read like English</li>
      </ul>
    </li>
    <li>Shows distinct combinations</li>
    <li>Blanks in <code class="language-plaintext highlighter-rouge">sex</code> column show missing data
      <ul>
        <li>We’ll talk about this in a bit</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="exercise">
  <h2 class="exercise"></h2>

  <p><strong>Exercise 2</strong>: 
Write a SQL query to select the islands and species
from rows 50 to 60 inclusive of the <code class="language-plaintext highlighter-rouge">penguins</code> table.
Your result should have 11 rows.</p>

  <p><strong>Exercise 3</strong>: 
Modify your query to select distinct combinations of island and species
from the same rows
and compare the result to what you got in part 1.</p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">filter results</h2>

  <p class="inclusion"><a href="src/filter.sql">src/filter.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">island</span> <span class="o">=</span> <span class="s1">'Biscoe'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/filter.out">out/filter.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Adelie  | MALE   | Biscoe |
| Gentoo  | FEMALE | Biscoe |
| Gentoo  | MALE   | Biscoe |
| Gentoo  |        | Biscoe |
</code></pre></div>  </div>

  <ul>
    <li><code>where <em>condition</em></code> <a href="#g:filter">filters</a> the rows produced by selection</li>
    <li>Condition is evaluated independently for each row</li>
    <li>Only rows that pass the test appear in results</li>
    <li>Use single quotes for <code class="language-plaintext highlighter-rouge">'text data'</code> and double quotes for <code class="language-plaintext highlighter-rouge">"weird column names"</code>
      <ul>
        <li><a href="https://sqlite.org/">SQLite</a> will accept double-quoted text data but <a href="SQLFluff">SQLFluff</a> will complain</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="exercise">
  <h2 class="exercise"></h2>

  <p><strong>Exercise 4</strong>: 
Write a query to select the body masses from <code class="language-plaintext highlighter-rouge">penguins</code> that are less than 3000.0 grams.</p>

  <p><strong>Exercise 5</strong>: 
Write another query to select the species and sex of penguins that weight less than 3000.0 grams.
This shows that the columns displayed and those used in filtering are independent of each other.</p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">filter with more complex conditions</h2>

  <p class="inclusion"><a href="src/filter_and.sql">src/filter_and.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">island</span> <span class="o">=</span> <span class="s1">'Biscoe'</span> <span class="k">and</span> <span class="n">sex</span> <span class="o">!=</span> <span class="s1">'MALE'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/filter_and.out">out/filter_and.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Gentoo  | FEMALE | Biscoe |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">and</code>: both sub-conditions must be true</li>
    <li><code class="language-plaintext highlighter-rouge">or</code>: either or both part must be true</li>
    <li>Notice that the row for Gentoo penguins on Biscoe island with unknown (empty) sex didn’t pass the test
      <ul>
        <li>We’ll talk about this in a bit</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="exercise">
  <h2 class="exercise"></h2>

  <p><strong>Exercise 6</strong>: 
Use the <code class="language-plaintext highlighter-rouge">not</code> operator to select penguins that are <em>not</em> Gentoos.</p>

  <p><strong>Exercise 7</strong>: 
SQL’s <code class="language-plaintext highlighter-rouge">or</code> is an <a href="#g:inclusive_or">inclusive or</a>:
it succeeds if either <em>or both</em> conditions are true.
SQL does not provide a specific operator for <a href="#g:exclusive_or">exclusive or</a>,
which is true if either <em>but not both</em> conditions are true,
but the same effect can be achieved using <code class="language-plaintext highlighter-rouge">and</code>, <code class="language-plaintext highlighter-rouge">or</code>, and <code class="language-plaintext highlighter-rouge">not</code>.
Write a query to select penguins that are female <em>or</em> on Torgersen Island <em>but not both</em>.</p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">do calculations</h2>

  <p class="inclusion"><a href="src/calculations.sql">src/calculations.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">flipper_length_mm</span> <span class="o">/</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">body_mass_g</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">.</span><span class="mi">0</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">limit</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/calculations.out">out/calculations.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| flipper_length_mm / 10.0 | body_mass_g / 1000.0 |
|--------------------------|----------------------|
| 18.1                     | 3.75                 |
| 18.6                     | 3.8                  |
| 19.5                     | 3.25                 |
</code></pre></div>  </div>

  <ul>
    <li>Can do the usual kinds of arithmetic on individual values
      <ul>
        <li>Calculation done for each row independently</li>
      </ul>
    </li>
    <li>Column name shows the calculation done</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">rename columns</h2>

  <p class="inclusion"><a href="src/rename_columns.sql">src/rename_columns.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">flipper_length_mm</span> <span class="o">/</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span> <span class="k">as</span> <span class="n">flipper_cm</span><span class="p">,</span>
    <span class="n">body_mass_g</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">.</span><span class="mi">0</span> <span class="k">as</span> <span class="n">weight_kg</span><span class="p">,</span>
    <span class="n">island</span> <span class="k">as</span> <span class="n">where_found</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">limit</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/rename_columns.out">out/rename_columns.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| flipper_cm | weight_kg | where_found |
|------------|-----------|-------------|
| 18.1       | 3.75      | Torgersen   |
| 18.6       | 3.8       | Torgersen   |
| 19.5       | 3.25      | Torgersen   |
</code></pre></div>  </div>

  <ul>
    <li>Use <code><em>expression</em> as <em>name</em></code> to rename</li>
    <li>Give result of calculation a meaningful name</li>
    <li>Can also rename columns without modifying</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="exercise">
  <h2 class="exercise"></h2>

  <p><strong>Exercise 8</strong>: 
Write a single query that calculates and returns:</p>

  <ol>
    <li>A column called <code class="language-plaintext highlighter-rouge">what_where</code> that has the species and island of each penguin
separated by a single space.</li>
    <li>A column called <code class="language-plaintext highlighter-rouge">bill_ratio</code> that has the ratio of bill length to bill depth.</li>
  </ol>

  <p>You can use the <code class="language-plaintext highlighter-rouge">||</code> operator to concatenate text to solve part 1,
or look at <a href="https://sqlite.org/printf.html">the documentation for SQLite’s <code class="language-plaintext highlighter-rouge">format()</code> function</a>.</p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_select.svg" alt="concept map: selection" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">calculate with missing values</h2>

  <p class="inclusion"><a href="src/show_missing_values.sql">src/show_missing_values.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">flipper_length_mm</span> <span class="o">/</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span> <span class="k">as</span> <span class="n">flipper_cm</span><span class="p">,</span>
    <span class="n">body_mass_g</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">.</span><span class="mi">0</span> <span class="k">as</span> <span class="n">weight_kg</span><span class="p">,</span>
    <span class="n">island</span> <span class="k">as</span> <span class="n">where_found</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/show_missing_values.out">out/show_missing_values.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| flipper_cm | weight_kg | where_found |
|------------|-----------|-------------|
| 18.1       | 3.75      | Torgersen   |
| 18.6       | 3.8       | Torgersen   |
| 19.5       | 3.25      | Torgersen   |
|            |           | Torgersen   |
| 19.3       | 3.45      | Torgersen   |
</code></pre></div>  </div>

  <ul>
    <li>SQL uses a special value <a href="#g:null"><code>null</code></a> to representing missing data
      <ul>
        <li>Not 0 or empty string, but “I don’t know”</li>
      </ul>
    </li>
    <li>Flipper length and body weight not known for one of the first five penguins</li>
    <li>“I don’t know” divided by 10 or 1000 is “I don’t know”</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">null equality</h2>

  <ul>
    <li>Repeated from above so it doesn’t count against our query limit</li>
  </ul>

  <p class="inclusion"><a href="src/filter.sql">src/filter.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">island</span> <span class="o">=</span> <span class="s1">'Biscoe'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/filter.out">out/filter.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Adelie  | MALE   | Biscoe |
| Gentoo  | FEMALE | Biscoe |
| Gentoo  | MALE   | Biscoe |
| Gentoo  |        | Biscoe |
</code></pre></div>  </div>

  <ul>
    <li>If we ask for female penguins the row with the missing sex drops out</li>
  </ul>

  <p class="inclusion"><a href="src/null_equality.sql">src/null_equality.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">island</span> <span class="o">=</span> <span class="s1">'Biscoe'</span> <span class="k">and</span> <span class="n">sex</span> <span class="o">=</span> <span class="s1">'FEMALE'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/null_equality.out">out/null_equality.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species |  sex   | island |
|---------|--------|--------|
| Adelie  | FEMALE | Biscoe |
| Gentoo  | FEMALE | Biscoe |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">null inequality</h2>

  <ul>
    <li>But if we ask for penguins that <em>aren’t</em> female it drops out as well</li>
  </ul>

  <p class="inclusion"><a href="src/null_inequality.sql">src/null_inequality.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">island</span> <span class="o">=</span> <span class="s1">'Biscoe'</span> <span class="k">and</span> <span class="n">sex</span> <span class="o">!=</span> <span class="s1">'FEMALE'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/null_inequality.out">out/null_inequality.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species | sex  | island |
|---------|------|--------|
| Adelie  | MALE | Biscoe |
| Gentoo  | MALE | Biscoe |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">ternary logic</h2>

  <p class="inclusion"><a href="src/ternary_logic.sql">src/ternary_logic.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">null</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/ternary_logic.out">out/ternary_logic.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| null = null |
|-------------|
|             |
</code></pre></div>  </div>

  <ul>
    <li>If we don’t know the left and right values, we don’t know if they’re equal or not</li>
    <li>So the result is <code class="language-plaintext highlighter-rouge">null</code></li>
    <li>Get the same answer for <code class="language-plaintext highlighter-rouge">null != null</code></li>
    <li><a href="#g:ternary_logic">Ternary logic</a></li>
  </ul>

  <table>
  <tr>
    <th colspan="4">equality</th>
  </tr>
  <tr>
    <th></th>
    <th>X</th>
    <th>Y</th>
    <th>null</th>
  </tr>
  <tr>
    <th>X</th>
    <td>true</td>
    <td>false</td>
    <td>null</td>
  </tr>
  <tr>
    <th>Y</th>
    <td>false</td>
    <td>true</td>
    <td>null</td>
  </tr>
  <tr>
    <th>null</th>
    <td>null</td>
    <td>null</td>
    <td>null</td>
  </tr>
</table>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">handle null safely</h2>

  <p class="inclusion"><a href="src/safe_null_equality.sql">src/safe_null_equality.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">sex</span> <span class="k">is</span> <span class="k">null</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/safe_null_equality.out">out/safe_null_equality.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species | sex |  island   |
|---------|-----|-----------|
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Torgersen |
| Adelie  |     | Dream     |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
| Gentoo  |     | Biscoe    |
</code></pre></div>  </div>

  <ul>
    <li>Use <code class="language-plaintext highlighter-rouge">is null</code> and <code class="language-plaintext highlighter-rouge">is not null</code> to handle null safely</li>
    <li>Other parts of SQL handle nulls specially</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_null.svg" alt="concept map: null" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">aggregate</h2>

  <p class="inclusion"><a href="src/simple_sum.sql">src/simple_sum.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">sum</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_mass</span>
<span class="k">from</span> <span class="n">penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/simple_sum.out">out/simple_sum.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| total_mass |
|------------|
| 1437000.0  |
</code></pre></div>  </div>

  <ul>
    <li><a href="#g:aggregation">Aggregation</a> combines many values to produce one</li>
    <li><code class="language-plaintext highlighter-rouge">sum</code> is an <a href="#g:aggregation_func">aggregation function</a></li>
    <li>Combines corresponding values from multiple rows</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">common aggregation functions</h2>

  <p class="inclusion"><a href="src/common_aggregations.sql">src/common_aggregations.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="k">max</span><span class="p">(</span><span class="n">bill_length_mm</span><span class="p">)</span> <span class="k">as</span> <span class="n">longest_bill</span><span class="p">,</span>
    <span class="k">min</span><span class="p">(</span><span class="n">flipper_length_mm</span><span class="p">)</span> <span class="k">as</span> <span class="n">shortest_flipper</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">bill_length_mm</span><span class="p">)</span> <span class="o">/</span> <span class="k">avg</span><span class="p">(</span><span class="n">bill_depth_mm</span><span class="p">)</span> <span class="k">as</span> <span class="n">weird_ratio</span>
<span class="k">from</span> <span class="n">penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/common_aggregations.out">out/common_aggregations.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| longest_bill | shortest_flipper |   weird_ratio    |
|--------------|------------------|------------------|
| 59.6         | 172.0            | 2.56087082530644 |
</code></pre></div>  </div>

  <ul>
    <li>This actually shouldn’t work:
can’t calculate maximum or average if any values are null</li>
    <li>SQL does the useful thing instead of the right one</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">counting</h2>

  <p class="inclusion"><a href="src/count_behavior.sql">src/count_behavior.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">count_star</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">sex</span><span class="p">)</span> <span class="k">as</span> <span class="n">count_specific</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">sex</span><span class="p">)</span> <span class="k">as</span> <span class="n">count_distinct</span>
<span class="k">from</span> <span class="n">penguins</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/count_behavior.out">out/count_behavior.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| count_star | count_specific | count_distinct |
|------------|----------------|----------------|
| 344        | 333            | 2              |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">count(*)</code> counts rows</li>
    <li><code>count(<em>column</em>)</code> counts non-null entries in column</li>
    <li><code>count(distinct <em>column</em>)</code> counts distinct non-null entries</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">group</h2>

  <p class="inclusion"><a href="src/simple_group.sql">src/simple_group.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="k">as</span> <span class="n">average_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">sex</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/simple_group.out">out/simple_group.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  average_mass_g  |
|------------------|
| 4005.55555555556 |
| 3862.27272727273 |
| 4545.68452380952 |
</code></pre></div>  </div>

  <ul>
    <li>Put rows in <a href="#g:group">groups</a> based on distinct combinations of values in columns specified with <code class="language-plaintext highlighter-rouge">group by</code></li>
    <li>Then perform aggregation separately for each group</li>
    <li>But which is which?</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">behavior of unaggregated columns</h2>

  <p class="inclusion"><a href="src/unaggregated_columns.sql">src/unaggregated_columns.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="k">as</span> <span class="n">average_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">sex</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/unaggregated_columns.out">out/unaggregated_columns.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  sex   |  average_mass_g  |
|--------|------------------|
|        | 4005.55555555556 |
| FEMALE | 3862.27272727273 |
| MALE   | 4545.68452380952 |
</code></pre></div>  </div>

  <ul>
    <li>All rows in each group have the same value for <code class="language-plaintext highlighter-rouge">sex</code>, so no need to aggregate</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">arbitrary choice in aggregation</h2>

  <p class="inclusion"><a href="src/arbitrary_in_aggregation.sql">src/arbitrary_in_aggregation.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">body_mass_g</span>                   
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">sex</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/arbitrary_in_aggregation.out">out/arbitrary_in_aggregation.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  sex   | body_mass_g |
|--------|-------------|
|        |             |
| FEMALE | 3800.0      |
| MALE   | 3750.0      |
</code></pre></div>  </div>

  <ul>
    <li>If we don’t specify how to aggregate a column,
<a href="https://sqlite.org/">SQLite</a> chooses <em>any arbitrary value</em> from the group
      <ul>
        <li>All penguins in each group have the same sex because we grouped by that, so we get the right answer</li>
        <li>The body mass values are in the data but unpredictable</li>
        <li>A common mistake</li>
      </ul>
    </li>
    <li>Other database managers don’t do this
      <ul>
        <li>E.g., PostgreSQL complains that column must be used in an aggregation function</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">filter aggregated values</h2>

  <p class="inclusion"><a href="src/filter_aggregation.sql">src/filter_aggregation.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="k">as</span> <span class="n">average_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">sex</span>
<span class="k">having</span> <span class="n">average_mass_g</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/filter_aggregation.out">out/filter_aggregation.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| sex  |  average_mass_g  |
|------|------------------|
|      | 4005.55555555556 |
| MALE | 4545.68452380952 |
</code></pre></div>  </div>

  <ul>
    <li>Using <code>having <em>condition</em></code> instead of <code>where <em>condition</em></code> for aggregates</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">readable output</h2>

  <p class="inclusion"><a href="src/readable_aggregation.sql">src/readable_aggregation.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">average_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">sex</span>
<span class="k">having</span> <span class="n">average_mass_g</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/readable_aggregation.out">out/readable_aggregation.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| sex  | average_mass_g |
|------|----------------|
|      | 4005.6         |
| MALE | 4545.7         |
</code></pre></div>  </div>

  <ul>
    <li>Use <code>round(<em>value</em>, <em>decimals</em>)</code> to round off a number</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">filter aggregate inputs</h2>

  <p class="inclusion"><a href="src/filter_aggregate_inputs.sql">src/filter_aggregate_inputs.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span>
        <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">body_mass_g</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
        <span class="mi">1</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">average_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">sex</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/filter_aggregate_inputs.out">out/filter_aggregate_inputs.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  sex   | average_mass_g |
|--------|----------------|
|        | 3362.5         |
| FEMALE | 3417.3         |
| MALE   | 3729.6         |
</code></pre></div>  </div>

  <ul>
    <li><code>filter (where <em>condition</em>)</code> applies to <em>inputs</em></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_aggregate.svg" alt="concept map: aggregation" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">create in-memory database</h2>

  <p class="inclusion"><a href="src/in_memory_db.sh">src/in_memory_db.sh</a></p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 :memory:
</code></pre></div>  </div>

  <ul>
    <li>“Connect” to an <a href="#g:in_memory_db">in-memory database</a></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">create tables</h2>

  <p class="inclusion"><a href="src/create_work_job.sql">src/create_work_job.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">billable</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="k">work</span> <span class="p">(</span>
    <span class="n">person</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">job</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
</code></pre></div>  </div>

  <ul>
    <li><code>create table <em>name</em></code> followed by parenthesized list of columns</li>
    <li>Each column is a name, a data type, and optional extra information
      <ul>
        <li>E.g., <code class="language-plaintext highlighter-rouge">not null</code> prevents nulls from being added</li>
      </ul>
    </li>
    <li><code class="language-plaintext highlighter-rouge">.schema</code> is <em>not</em> standard SQL</li>
    <li><a href="https://sqlite.org/">SQLite</a> has added a few things
      <ul>
        <li><code class="language-plaintext highlighter-rouge">create if not exists</code></li>
        <li>upper-case keywords (SQL is case insensitive)</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">insert data</h2>

  <p class="inclusion"><a href="src/populate_work_job.sql">src/populate_work_job.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'calibrate'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'clean'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="k">work</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'mik'</span><span class="p">,</span> <span class="s1">'calibrate'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'mik'</span><span class="p">,</span> <span class="s1">'clean'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'mik'</span><span class="p">,</span> <span class="s1">'complain'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'po'</span><span class="p">,</span> <span class="s1">'clean'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'po'</span><span class="p">,</span> <span class="s1">'complain'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'tay'</span><span class="p">,</span> <span class="s1">'complain'</span><span class="p">);</span>
</code></pre></div>  </div>

  <p class="inclusion"><a href="out/insert_values.out">out/insert_values.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
| clean     | 0.5      |

| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
| tay    | complain  |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">update rows</h2>

  <p class="inclusion"><a href="src/update_work_job.sql">src/update_work_job.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">update</span> <span class="k">work</span>
<span class="k">set</span> <span class="n">person</span> <span class="o">=</span> <span class="s1">'tae'</span>
<span class="k">where</span> <span class="n">person</span> <span class="o">=</span> <span class="s1">'tay'</span><span class="p">;</span>
</code></pre></div>  </div>

  <p class="inclusion"><a href="out/update_rows.out">out/update_rows.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
| tae    | complain  |
</code></pre></div>  </div>

  <ul>
    <li>(Almost) always specify row(s) to update using <code class="language-plaintext highlighter-rouge">where</code>
      <ul>
        <li>Otherwise update all rows in table, which is usually not wanted</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">delete rows</h2>

  <p class="inclusion"><a href="src/delete_rows.sql">src/delete_rows.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">delete</span> <span class="k">from</span> <span class="k">work</span>
<span class="k">where</span> <span class="n">person</span> <span class="o">=</span> <span class="s1">'tae'</span><span class="p">;</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">work</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/delete_rows.out">out/delete_rows.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |    job    |
|--------|-----------|
| mik    | calibrate |
| mik    | clean     |
| mik    | complain  |
| po     | clean     |
| po     | complain  |
</code></pre></div>  </div>

  <ul>
    <li>Again, (almost) always specify row(s) to delete using <code class="language-plaintext highlighter-rouge">where</code></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">backing up</h2>

  <p class="inclusion"><a href="src/backing_up.sql">src/backing_up.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">backup</span> <span class="p">(</span>
    <span class="n">person</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">job</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">backup</span>
<span class="k">select</span>
    <span class="n">person</span><span class="p">,</span>
    <span class="n">job</span>
<span class="k">from</span> <span class="k">work</span>
<span class="k">where</span> <span class="n">person</span> <span class="o">=</span> <span class="s1">'tae'</span><span class="p">;</span>

<span class="k">delete</span> <span class="k">from</span> <span class="k">work</span>
<span class="k">where</span> <span class="n">person</span> <span class="o">=</span> <span class="s1">'tae'</span><span class="p">;</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">backup</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/backing_up.out">out/backing_up.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |   job    |
|--------|----------|
| tae    | complain |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_datamod.svg" alt="concept map: data definition and modification" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">join tables</h2>

  <p class="inclusion"><a href="src/cross_join.sql">src/cross_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span>
<span class="k">from</span> <span class="k">work</span> <span class="k">cross</span> <span class="k">join</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/cross_join.out">out/cross_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | calibrate | clean     | 0.5      |
| mik    | clean     | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| mik    | complain  | calibrate | 1.5      |
| mik    | complain  | clean     | 0.5      |
| po     | clean     | calibrate | 1.5      |
| po     | clean     | clean     | 0.5      |
| po     | complain  | calibrate | 1.5      |
| po     | complain  | clean     | 0.5      |
| tay    | complain  | calibrate | 1.5      |
| tay    | complain  | clean     | 0.5      |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:join">join</a> combines information from two tables</li>
    <li><a href="#g:cross_join">cross join</a> constructs their cross product
      <ul>
        <li>All combinations of rows from each</li>
      </ul>
    </li>
    <li>Result isn’t particularly useful: <code class="language-plaintext highlighter-rouge">job</code> and <code class="language-plaintext highlighter-rouge">name</code> don’t match</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">inner join</h2>

  <p class="inclusion"><a href="src/inner_join.sql">src/inner_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span>
<span class="k">from</span> <span class="k">work</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">job</span>
    <span class="k">on</span> <span class="k">work</span><span class="p">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/inner_join.out">out/inner_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| po     | clean     | clean     | 0.5      |
</code></pre></div>  </div>

  <ul>
    <li>Use <code><em>table</em>.<em>column</em></code> notation to specify columns
      <ul>
        <li>A column can have the same name as a table</li>
      </ul>
    </li>
    <li>Use <code>on <em>condition</em></code> to specify <a href="#g:join_condition">join condition</a></li>
    <li>Since <code class="language-plaintext highlighter-rouge">complain</code> doesn’t appear in <code class="language-plaintext highlighter-rouge">job.name</code>, none of those rows are kept</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">aggregate joined data</h2>

  <p class="inclusion"><a href="src/aggregate_join.sql">src/aggregate_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">billable</span><span class="p">)</span> <span class="k">as</span> <span class="n">pay</span>
<span class="k">from</span> <span class="k">work</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">job</span>
    <span class="k">on</span> <span class="k">work</span><span class="p">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">name</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/aggregate_join.out">out/aggregate_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
</code></pre></div>  </div>

  <ul>
    <li>Combines ideas we’ve seen before</li>
    <li>But Tay is missing from the table</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">left join</h2>

  <p class="inclusion"><a href="src/left_join.sql">src/left_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span>
<span class="k">from</span> <span class="k">work</span> <span class="k">left</span> <span class="k">join</span> <span class="n">job</span>
    <span class="k">on</span> <span class="k">work</span><span class="p">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/left_join.out">out/left_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |    job    |   name    | billable |
|--------|-----------|-----------|----------|
| mik    | calibrate | calibrate | 1.5      |
| mik    | clean     | clean     | 0.5      |
| mik    | complain  |           |          |
| po     | clean     | clean     | 0.5      |
| po     | complain  |           |          |
| tay    | complain  |           |          |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:left_outer_join">left outer join</a> keeps all rows from the left table</li>
    <li>Fills missing values from right table with null</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">aggregate left joins</h2>

  <p class="inclusion"><a href="src/aggregate_left_join.sql">src/aggregate_left_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">billable</span><span class="p">)</span> <span class="k">as</span> <span class="n">pay</span>
<span class="k">from</span> <span class="k">work</span> <span class="k">left</span> <span class="k">join</span> <span class="n">job</span>
    <span class="k">on</span> <span class="k">work</span><span class="p">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">name</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/aggregate_left_join.out">out/aggregate_left_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
| tay    |     |
</code></pre></div>  </div>

  <ul>
    <li>That’s better, but we’d like to see 0 rather than a blank</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">full outer join</h2>

  <ul>
    <li><a href="#g:full_outer_join">Full outer join</a> is the union of left outer join and right outer join</li>
    <li>Almost the same as cross join, but consider:</li>
  </ul>

  <p class="inclusion"><a href="src/full_outer_join.sql">src/full_outer_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="k">size</span> <span class="p">(</span>
    <span class="n">s</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="k">size</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'light'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'heavy'</span><span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">weight</span> <span class="p">(</span>
    <span class="n">w</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">size</span> <span class="k">full</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">weight</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/full_outer_join.out">out/full_outer_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   s   | w |
|-------|---|
| light |   |
| heavy |   |
</code></pre></div>  </div>

  <ul>
    <li>A cross join would produce empty result</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_join.svg" alt="concept map: join" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">coalesce values</h2>

  <p class="inclusion"><a href="src/coalesce.sql">src/coalesce.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">,</span>
    <span class="n">coalesce</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">billable</span><span class="p">),</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">pay</span>
<span class="k">from</span> <span class="k">work</span> <span class="k">left</span> <span class="k">join</span> <span class="n">job</span>
    <span class="k">on</span> <span class="k">work</span><span class="p">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">name</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/coalesce.out">out/coalesce.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person | pay |
|--------|-----|
| mik    | 2.0 |
| po     | 0.5 |
| tay    | 0.0 |
</code></pre></div>  </div>

  <ul>
    <li><code>coalesce(<em>val1</em>, <em>val2</em>, …)</code> returns first non-null value</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">negate incorrectly</h2>

  <ul>
    <li>Who doesn’t calibrate?</li>
  </ul>

  <p class="inclusion"><a href="src/negate_incorrectly.sql">src/negate_incorrectly.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">person</span>
<span class="k">from</span> <span class="k">work</span>
<span class="k">where</span> <span class="n">job</span> <span class="o">!=</span> <span class="s1">'calibrate'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/negate_incorrectly.out">out/negate_incorrectly.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |
|--------|
| mik    |
| po     |
| tay    |
</code></pre></div>  </div>

  <ul>
    <li>But Mik <em>does</em> calibrate</li>
    <li>Problem is that there’s an entry for Mik cleaning</li>
    <li>And since <code class="language-plaintext highlighter-rouge">'clean' != 'calibrate'</code>, that row is included in the results</li>
    <li>We need a different approach</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">set membership</h2>

  <p class="inclusion"><a href="src/set_membership.sql">src/set_membership.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span>
<span class="k">from</span> <span class="k">work</span>
<span class="k">where</span> <span class="n">person</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'mik'</span><span class="p">,</span> <span class="s1">'tay'</span><span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/set_membership.out">out/set_membership.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |   job    |
|--------|----------|
| po     | clean    |
| po     | complain |
</code></pre></div>  </div>

  <ul>
    <li><code>in <em>values</em></code> and <code>not in <em>values</em></code> do exactly what you expect</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">subqueries</h2>

  <p class="inclusion"><a href="src/subquery_set.sql">src/subquery_set.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">person</span>
<span class="k">from</span> <span class="k">work</span>
<span class="k">where</span> <span class="n">person</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span>
    <span class="k">select</span> <span class="k">distinct</span> <span class="n">person</span>
    <span class="k">from</span> <span class="k">work</span>
    <span class="k">where</span> <span class="n">job</span> <span class="o">=</span> <span class="s1">'calibrate'</span>
<span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/subquery_set.out">out/subquery_set.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person |
|--------|
| po     |
| tay    |
</code></pre></div>  </div>

  <ul>
    <li>Use a <a href="#g:subquery">subquery</a> to select the people who <em>do</em> calibrate</li>
    <li>Then select all the people who aren’t in that set</li>
    <li>Initially feels odd, but subqueries are useful in other ways</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">M to N relationships</h2>

  <ul>
    <li>Relationships between entities are usually characterized as:
      <ul>
        <li><a href="#g:1_to_1">1-to-1</a>:
fields in the same record</li>
        <li><a href="#g:1_to_many">1-to-many</a>:
the many have a <a href="#g:foreign_key">foreign key</a> referring to the one’s primary key</li>
        <li><a href="#g:many_to_many">many-to-many</a>:
don’t know how many keys to add to records (“maximum” never is)</li>
      </ul>
    </li>
    <li>Nearly-universal solution is a <a href="#g:join_table">join table</a>
      <ul>
        <li>Each record is a pair of foreign keys</li>
        <li>I.e., each record is the fact that records A and B are related</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">autoincrement and primary key</h2>

  <p class="inclusion"><a href="src/autoincrement.sql">src/autoincrement.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">person</span> <span class="p">(</span>
    <span class="n">ident</span> <span class="nb">integer</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">autoincrement</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">person</span> <span class="k">values</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'mik'</span><span class="p">),</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'po'</span><span class="p">),</span>
<span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'tay'</span><span class="p">);</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">person</span><span class="p">;</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">person</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'prevented'</span><span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/autoincrement.out">out/autoincrement.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident | name |
|-------|------|
| 1     | mik  |
| 2     | po   |
| 3     | tay  |
Runtime error near line 12: UNIQUE constraint failed: person.ident (19)
</code></pre></div>  </div>

  <ul>
    <li>Database <a href="#g:autoincrement">autoincrements</a> <code class="language-plaintext highlighter-rouge">ident</code> each time a new record is added</li>
    <li>Use that field as the <a href="#g:primary_key">primary key</a>
      <ul>
        <li>Uniquely identifies a particular record in a particular table</li>
      </ul>
    </li>
    <li>If Mik changes their name again,
we only have to change one fact in the database
      <ul>
        <li>Downside: manual queries are harder to read (who is person 17?)</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">internal tables</h2>

  <p class="inclusion"><a href="src/sequence_table.sql">src/sequence_table.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sqlite_sequence</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/sequence_table.out">out/sequence_table.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  name  | seq |
|--------|-----|
| person | 3   |
</code></pre></div>  </div>

  <ul>
    <li>Sequence numbers are <em>not</em> reset when rows are deleted</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">choose your own key</h2>

  <ul>
    <li>Can use any field (or combination of fields) in a table as a primary key
      <ul>
        <li>As long as value(s) unique for each record</li>
      </ul>
    </li>
  </ul>

  <p class="inclusion"><a href="src/primary_key.sql">src/primary_key.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">lab_equipment</span> <span class="p">(</span>
    <span class="k">size</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">color</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">num</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="k">size</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">lab_equipment</span> <span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">lab_equipment</span><span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">lab_equipment</span> <span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/primary_key.out">out/primary_key.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| size | color | num |
|------|-------|-----|
| 1.5  | blue  | 2   |
| 1.5  | green | 1   |
| 2.5  | blue  | 1   |
Runtime error near line 17: UNIQUE constraint failed: lab_equipment.size, lab_equipment.color (19)
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">alter tables</h2>

  <p class="inclusion"><a href="src/alter_tables.sql">src/alter_tables.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="n">job</span>
<span class="k">add</span> <span class="n">ident</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">update</span> <span class="n">job</span>
<span class="k">set</span> <span class="n">ident</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'calibrate'</span><span class="p">;</span>

<span class="k">update</span> <span class="n">job</span>
<span class="k">set</span> <span class="n">ident</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'clean'</span><span class="p">;</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/alter_tables.out">out/alter_tables.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   name    | billable | ident |
|-----------|----------|-------|
| calibrate | 1.5      | 1     |
| clean     | 0.5      | 2     |
</code></pre></div>  </div>

  <ul>
    <li>Add a column after the fact</li>
    <li>Since it can’t be null, we have to provide a default value
      <ul>
        <li>Really want to make it the primary key, but <a href="https://sqlite.org/">SQLite</a> doesn’t allow that (easily) after the fact</li>
      </ul>
    </li>
    <li>Then use <code class="language-plaintext highlighter-rouge">update</code> to modify existing records
      <ul>
        <li>Can modify any number of records at once</li>
        <li>So be careful about <code class="language-plaintext highlighter-rouge">where</code> clause</li>
      </ul>
    </li>
    <li><a href="#g:data_migration">Data migration</a></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">create new tables from old</h2>

  <p class="inclusion"><a href="src/insert_select.sql">src/insert_select.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">new_work</span> <span class="p">(</span>
    <span class="n">person_id</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">job_id</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">person_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">person</span> <span class="p">(</span><span class="n">ident</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">job</span> <span class="p">(</span><span class="n">ident</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">new_work</span>
<span class="k">select</span>
    <span class="n">person</span><span class="p">.</span><span class="n">ident</span> <span class="k">as</span> <span class="n">person_id</span><span class="p">,</span>
    <span class="n">job</span><span class="p">.</span><span class="n">ident</span> <span class="k">as</span> <span class="n">job_id</span>
<span class="k">from</span>
    <span class="p">(</span><span class="n">person</span> <span class="k">inner</span> <span class="k">join</span> <span class="k">work</span> <span class="k">on</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="k">work</span><span class="p">.</span><span class="n">person</span><span class="p">)</span>
    <span class="k">inner</span> <span class="k">join</span> <span class="n">job</span> <span class="k">on</span> <span class="n">job</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="k">work</span><span class="p">.</span><span class="n">job</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">new_work</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/insert_select.out">out/insert_select.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person_id | job_id |
|-----------|--------|
| 1         | 1      |
| 1         | 2      |
| 2         | 2      |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">new_work</code> is our join table</li>
    <li>Each column refers to a record in some other table</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">remove tables</h2>

  <p class="inclusion"><a href="src/drop_table.sql">src/drop_table.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">drop</span> <span class="k">table</span> <span class="k">work</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">new_work</span> <span class="k">rename</span> <span class="k">to</span> <span class="k">work</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/drop_table.out">out/drop_table.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE job (
    ident integer primary key autoincrement,
    name text not null,
    billable real not null
);
CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person (
    ident integer primary key autoincrement,
    name text not null
);
CREATE TABLE IF NOT EXISTS "work" (
    person_id integer not null,
    job_id integer not null,
    foreign key(person_id) references person(ident),
    foreign key(job_id) references job(ident)
);
</code></pre></div>  </div>

  <ul>
    <li>Remove the old table and rename the new one to take its place
      <ul>
        <li>Note <code class="language-plaintext highlighter-rouge">if exists</code></li>
      </ul>
    </li>
    <li>Be careful…</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">compare individual values to aggregates</h2>

  <ul>
    <li>Go back to penguins</li>
  </ul>

  <p class="inclusion"><a href="src/compare_individual_aggregate.sql">src/compare_individual_aggregate.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">body_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span>
    <span class="n">body_mass_g</span> <span class="o">&gt;</span> <span class="p">(</span>
        <span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span>
        <span class="k">from</span> <span class="n">penguins</span>
    <span class="p">)</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/compare_individual_aggregate.out">out/compare_individual_aggregate.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| body_mass_g |
|-------------|
| 4675.0      |
| 4250.0      |
| 4400.0      |
| 4500.0      |
| 4650.0      |
</code></pre></div>  </div>

  <ul>
    <li>Get average body mass in subquery</li>
    <li>Compare each row against that</li>
    <li>Requires two scans of the data, but there’s no way to avoid that</li>
    <li>Null values aren’t included in the average or in the final results</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">compare individual values to aggregates within groups</h2>

  <p class="inclusion"><a href="src/compare_within_groups.sql">src/compare_within_groups.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="p">,</span>
    <span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="n">averaged</span><span class="p">.</span><span class="n">avg_mass_g</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span> <span class="k">inner</span> <span class="k">join</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">species</span><span class="p">,</span>
        <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_mass_g</span>
    <span class="k">from</span> <span class="n">penguins</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">species</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">averaged</span>
    <span class="k">on</span> <span class="n">penguins</span><span class="p">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">averaged</span><span class="p">.</span><span class="n">species</span>
<span class="k">where</span> <span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span> <span class="o">&gt;</span> <span class="n">averaged</span><span class="p">.</span><span class="n">avg_mass_g</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/compare_within_groups.out">out/compare_within_groups.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
| Adelie  | 4675.0      | 3700.7     |
| Adelie  | 4250.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
</code></pre></div>  </div>

  <ul>
    <li>Subquery runs first to create temporary table <code class="language-plaintext highlighter-rouge">averaged</code> with average mass per species</li>
    <li>Join that with <code class="language-plaintext highlighter-rouge">penguins</code></li>
    <li>Filter to find penguins heavier than average within their species</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">common table expressions</h2>

  <p class="inclusion"><a href="src/common_table_expressions.sql">src/common_table_expressions.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">grouped</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">species</span><span class="p">,</span>
        <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_mass_g</span>
    <span class="k">from</span> <span class="n">penguins</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">species</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">penguins</span><span class="p">.</span><span class="n">species</span><span class="p">,</span>
    <span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="n">grouped</span><span class="p">.</span><span class="n">avg_mass_g</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">avg_mass_g</span>
<span class="k">from</span> <span class="n">penguins</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">grouped</span>
<span class="k">where</span> <span class="n">penguins</span><span class="p">.</span><span class="n">body_mass_g</span> <span class="o">&gt;</span> <span class="n">grouped</span><span class="p">.</span><span class="n">avg_mass_g</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/common_table_expressions.out">out/common_table_expressions.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| species | body_mass_g | avg_mass_g |
|---------|-------------|------------|
| Adelie  | 3750.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
| Adelie  | 4675.0      | 3700.7     |
| Adelie  | 4250.0      | 3700.7     |
| Adelie  | 3800.0      | 3700.7     |
</code></pre></div>  </div>

  <ul>
    <li>Use <a href="#g:cte">common table expression</a> (CTE) to make queries clearer
      <ul>
        <li>Nested subqueries quickly become difficult to understand</li>
      </ul>
    </li>
    <li>Database decides how to optimize</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">explain query plan</h2>

  <p class="inclusion"><a href="src/explain_query_plan.sql">src/explain_query_plan.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explain</span> <span class="n">query</span> <span class="n">plan</span>
<span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">body_mass_g</span><span class="p">)</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/explain_query_plan.out">out/explain_query_plan.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>QUERY PLAN
|--SCAN penguins
`--USE TEMP B-TREE FOR GROUP BY
</code></pre></div>  </div>

  <ul>
    <li><a href="https://sqlite.org/">SQLite</a> plans to scan every row of the table</li>
    <li>It will build a temporary B-tree data structure to group rows</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">enumerate rows</h2>

  <ul>
    <li>Every table has a special column called <code class="language-plaintext highlighter-rouge">rowid</code></li>
  </ul>

  <p class="inclusion"><a href="src/rowid.sql">src/rowid.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">rowid</span><span class="p">,</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">island</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/rowid.out">out/rowid.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rowid | species |  island   |
|-------|---------|-----------|
| 1     | Adelie  | Torgersen |
| 2     | Adelie  | Torgersen |
| 3     | Adelie  | Torgersen |
| 4     | Adelie  | Torgersen |
| 5     | Adelie  | Torgersen |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">rowid</code> is persistent within a session
      <ul>
        <li>I.e., if we delete the first 5 rows we now have row IDs 6…N</li>
      </ul>
    </li>
    <li><em>Do not rely on row ID</em>
      <ul>
        <li>In particular, do not use it as a key</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">if-else function</h2>

  <p class="inclusion"><a href="src/if_else.sql">src/if_else.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">sized_penguins</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">species</span><span class="p">,</span>
        <span class="n">iif</span><span class="p">(</span>
            <span class="n">body_mass_g</span> <span class="o">&lt;</span> <span class="mi">3500</span><span class="p">,</span>
            <span class="s1">'small'</span><span class="p">,</span>
            <span class="s1">'large'</span>
        <span class="p">)</span> <span class="k">as</span> <span class="k">size</span>
    <span class="k">from</span> <span class="n">penguins</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">size</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
<span class="k">from</span> <span class="n">sized_penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="k">size</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/if_else.out">out/if_else.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  | size  | num |
|-----------|-------|-----|
| Adelie    | small | 54  |
| Adelie    | large | 98  |
| Chinstrap | small | 17  |
| Chinstrap | large | 51  |
| Gentoo    | large | 124 |
</code></pre></div>  </div>

  <ul>
    <li><code>iif(<em>condition</em>, <em>true_result</em>, <em>false_result</em>)</code>
      <ul>
        <li>Note: <code class="language-plaintext highlighter-rouge">iif</code> with two i’s</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">select a case</h2>

  <ul>
    <li>What if we want small, medium, and large?</li>
    <li>Can nest <code class="language-plaintext highlighter-rouge">iif</code>, but quickly becomes unreadable</li>
  </ul>

  <p class="inclusion"><a href="src/case_when.sql">src/case_when.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">sized_penguins</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">species</span><span class="p">,</span>
        <span class="k">case</span>
            <span class="k">when</span> <span class="n">body_mass_g</span> <span class="o">&lt;</span> <span class="mi">3500</span> <span class="k">then</span> <span class="s1">'small'</span>
            <span class="k">when</span> <span class="n">body_mass_g</span> <span class="o">&lt;</span> <span class="mi">5000</span> <span class="k">then</span> <span class="s1">'medium'</span>
            <span class="k">else</span> <span class="s1">'large'</span>
        <span class="k">end</span> <span class="k">as</span> <span class="k">size</span>
    <span class="k">from</span> <span class="n">penguins</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">size</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
<span class="k">from</span> <span class="n">sized_penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="k">size</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/case_when.out">out/case_when.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  |  size  | num |
|-----------|--------|-----|
| Adelie    | large  | 1   |
| Adelie    | small  | 54  |
| Adelie    | medium | 97  |
| Chinstrap | small  | 17  |
| Chinstrap | medium | 51  |
| Gentoo    | medium | 56  |
| Gentoo    | large  | 68  |
</code></pre></div>  </div>

  <ul>
    <li>Evaluate <code class="language-plaintext highlighter-rouge">when</code> options in order and take first</li>
    <li>Result of <code class="language-plaintext highlighter-rouge">case</code> is null if no condition is true</li>
    <li>Use <code class="language-plaintext highlighter-rouge">else</code> as fallback</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">check range</h2>

  <p class="inclusion"><a href="src/check_range.sql">src/check_range.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">sized_penguins</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">species</span><span class="p">,</span>
        <span class="k">case</span>
            <span class="k">when</span> <span class="n">body_mass_g</span> <span class="k">between</span> <span class="mi">3500</span> <span class="k">and</span> <span class="mi">5000</span> <span class="k">then</span> <span class="s1">'normal'</span>
            <span class="k">else</span> <span class="s1">'abnormal'</span>
        <span class="k">end</span> <span class="k">as</span> <span class="k">size</span>
    <span class="k">from</span> <span class="n">penguins</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">size</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
<span class="k">from</span> <span class="n">sized_penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="k">size</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">species</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/check_range.out">out/check_range.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  |   size   | num |
|-----------|----------|-----|
| Adelie    | abnormal | 55  |
| Adelie    | normal   | 97  |
| Chinstrap | abnormal | 17  |
| Chinstrap | normal   | 51  |
| Gentoo    | abnormal | 62  |
| Gentoo    | normal   | 62  |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">between</code> can make queries easier to read</li>
    <li>But be careful of the <code class="language-plaintext highlighter-rouge">and</code> in the middle</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">yet another database</h2>

  <ul>
    <li><a href="#g:er_diagram">Entity-relationship diagram</a> (ER diagram) shows relationships between tables</li>
    <li>Like everything to do with databases, there are lots of variations</li>
  </ul>

  <p><img src="./img/assays_tables.svg" alt="assay database table diagram" /></p>

  <p><img src="./img/assays_er.svg" alt="assay ER diagram" /></p>

  <p class="inclusion"><a href="src/assay_staff.sql">src/assay_staff.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">staff</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/assay_staff.out">out/assay_staff.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident | personal |  family   | dept | age |
|-------|----------|-----------|------|-----|
| 1     | Kartik   | Gupta     |      | 46  |
| 2     | Divit    | Dhaliwal  | hist | 34  |
| 3     | Indrans  | Sridhar   | mb   | 47  |
| 4     | Pranay   | Khanna    | mb   | 51  |
| 5     | Riaan    | Dua       |      | 23  |
| 6     | Vedika   | Rout      | hist | 45  |
| 7     | Abram    | Chokshi   | gen  | 23  |
| 8     | Romil    | Kapoor    | hist | 38  |
| 9     | Ishaan   | Ramaswamy | mb   | 35  |
| 10    | Nitya    | Lal       | gen  | 52  |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">pattern matching</h2>

  <p class="inclusion"><a href="src/like_glob.sql">src/like_glob.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">personal</span><span class="p">,</span>
    <span class="n">family</span>
<span class="k">from</span> <span class="n">staff</span>
<span class="k">where</span> <span class="n">personal</span> <span class="k">like</span> <span class="s1">'%ya%'</span> <span class="k">or</span> <span class="n">family</span> <span class="n">glob</span> <span class="s1">'*De*'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/like_glob.out">out/like_glob.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| personal | family |
|----------|--------|
| Nitya    | Lal    |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">like</code> is the original SQL pattern matcher
      <ul>
        <li><code class="language-plaintext highlighter-rouge">%</code> matches zero or more characters at the start or end of a string</li>
        <li>Case insensitive by default</li>
      </ul>
    </li>
    <li><code class="language-plaintext highlighter-rouge">glob</code> supports Unix-style wildcards</li>
  </ul>

  <table>
    <thead>
      <tr>
        <th>name</th>
        <th>purpose</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">substr</code></td>
        <td>Get substring given starting point and length</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">trim</code></td>
        <td>Remove characters from beginning and end of string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">ltrim</code></td>
        <td>Remove characters from beginning of string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">rtrim</code></td>
        <td>Remove characters from end of string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">length</code></td>
        <td>Length of string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">replace</code></td>
        <td>Replace occurrences of substring with another string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">upper</code></td>
        <td>Return upper-case version of string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">lower</code></td>
        <td>Return lower-case version of string</td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">instr</code></td>
        <td>Find location of first occurrence of substring (returns 0 if not found)</td>
      </tr>
    </tbody>
  </table>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">select first and last rows</h2>

  <p class="inclusion"><a href="src/union_all.sql">src/union_all.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">experiment</span> <span class="k">order</span> <span class="k">by</span> <span class="n">started</span> <span class="k">asc</span> <span class="k">limit</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">experiment</span> <span class="k">order</span> <span class="k">by</span> <span class="n">started</span> <span class="k">desc</span> <span class="k">limit</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">started</span> <span class="k">asc</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/union_all.out">out/union_all.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident |    kind     |  started   |   ended    |
|-------|-------------|------------|------------|
| 17    | trial       | 2023-01-29 | 2023-01-30 |
| 35    | calibration | 2023-01-30 | 2023-01-30 |
| 36    | trial       | 2023-02-02 | 2023-02-03 |
| 25    | trial       | 2023-02-12 | 2023-02-14 |
| 2     | calibration | 2023-02-14 | 2023-02-14 |
| 40    | calibration | 2024-01-21 | 2024-01-21 |
| 12    | trial       | 2024-01-26 | 2024-01-28 |
| 44    | trial       | 2024-01-27 | 2024-01-29 |
| 34    | trial       | 2024-02-01 | 2024-02-02 |
| 14    | calibration | 2024-02-03 | 2024-02-03 |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">union all</code> combines records
      <ul>
        <li>Keeps duplicates: <code class="language-plaintext highlighter-rouge">union</code> on its own keeps unique records</li>
      </ul>
    </li>
    <li>Yes, it feels like the extra <code class="language-plaintext highlighter-rouge">select * from</code> should be unnecessary</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">intersection</h2>

  <p class="inclusion"><a href="src/intersect.sql">src/intersect.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">personal</span><span class="p">,</span>
    <span class="n">family</span><span class="p">,</span>
    <span class="n">dept</span><span class="p">,</span>
    <span class="n">age</span>
<span class="k">from</span> <span class="n">staff</span>
<span class="k">where</span> <span class="n">dept</span> <span class="o">=</span> <span class="s1">'mb'</span>
<span class="k">intersect</span>
<span class="k">select</span>
    <span class="n">personal</span><span class="p">,</span>
    <span class="n">family</span><span class="p">,</span>
    <span class="n">dept</span><span class="p">,</span>
    <span class="n">age</span> <span class="k">from</span> <span class="n">staff</span>
<span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/intersect.out">out/intersect.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| personal |  family   | dept | age |
|----------|-----------|------|-----|
| Indrans  | Sridhar   | mb   | 47  |
| Ishaan   | Ramaswamy | mb   | 35  |
</code></pre></div>  </div>

  <ul>
    <li>Tables being intersected must have same structure</li>
    <li>Intersection usually used when pulling values from different tables
      <ul>
        <li>In this case, would be clearer to use <code class="language-plaintext highlighter-rouge">where</code></li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">exclusion</h2>

  <p class="inclusion"><a href="src/except.sql">src/except.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">personal</span><span class="p">,</span>
    <span class="n">family</span><span class="p">,</span>
    <span class="n">dept</span><span class="p">,</span>
    <span class="n">age</span>
<span class="k">from</span> <span class="n">staff</span>
<span class="k">where</span> <span class="n">dept</span> <span class="o">=</span> <span class="s1">'mb'</span>
<span class="k">except</span>
    <span class="k">select</span>
        <span class="n">personal</span><span class="p">,</span>
        <span class="n">family</span><span class="p">,</span>
        <span class="n">dept</span><span class="p">,</span>
        <span class="n">age</span> <span class="k">from</span> <span class="n">staff</span>
    <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/except.out">out/except.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| personal | family | dept | age |
|----------|--------|------|-----|
| Pranay   | Khanna | mb   | 51  |
</code></pre></div>  </div>

  <ul>
    <li>Again, tables must have same structure
      <ul>
        <li>And this would be clearer with <code class="language-plaintext highlighter-rouge">where</code></li>
      </ul>
    </li>
    <li>SQL operates on sets, not tables, except where it doesn’t</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">random numbers and why not</h2>

  <p class="inclusion"><a href="src/random_numbers.sql">src/random_numbers.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">decorated</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">random</span><span class="p">()</span> <span class="k">as</span> <span class="n">rand</span><span class="p">,</span>
    <span class="n">personal</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">family</span> <span class="k">as</span> <span class="n">name</span>
    <span class="k">from</span> <span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">rand</span><span class="p">,</span>
    <span class="k">abs</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="k">as</span> <span class="n">selector</span><span class="p">,</span>
    <span class="n">name</span>
<span class="k">from</span> <span class="n">decorated</span>
<span class="k">where</span> <span class="n">selector</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/random_numbers.out">out/random_numbers.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|         rand         | selector |      name      |
|----------------------|----------|----------------|
| 1175447513360584797  | 6        | Divit Dhaliwal |
| -1544776661445066577 | 5        | Pranay Khanna  |
| -9091755230464281578 | 1        | Riaan Dua      |
| -3436533101074958267 | 6        | Romil Kapoor   |
| -1361395956632904964 | 7        | Nitya Lal      |
</code></pre></div>  </div>

  <ul>
    <li>There is no way to seed <a href="https://sqlite.org/">SQLite</a>’s random number generator</li>
    <li>Which means there is no way to reproduce one of its “random” sequences</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">creating index</h2>

  <p class="inclusion"><a href="src/create_use_index.sql">src/create_use_index.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explain</span> <span class="n">query</span> <span class="n">plan</span>
<span class="k">select</span> <span class="n">filename</span>
<span class="k">from</span> <span class="n">plate</span>
<span class="k">where</span> <span class="n">filename</span> <span class="k">like</span> <span class="s1">'%07%'</span><span class="p">;</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">plate_file</span> <span class="k">on</span> <span class="n">plate</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>

<span class="k">explain</span> <span class="n">query</span> <span class="n">plan</span>
<span class="k">select</span> <span class="n">filename</span>
<span class="k">from</span> <span class="n">plate</span>
<span class="k">where</span> <span class="n">filename</span> <span class="k">like</span> <span class="s1">'%07%'</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/create_use_index.out">out/create_use_index.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>QUERY PLAN
`--SCAN plate USING COVERING INDEX sqlite_autoindex_plate_1
QUERY PLAN
`--SCAN plate USING COVERING INDEX plate_file
</code></pre></div>  </div>

  <ul>
    <li>An <a href="#g:index">index</a> is an auxiliary data structure that enables faster access to records
      <ul>
        <li>Spend storage space to buy speed</li>
      </ul>
    </li>
    <li>Don’t have to mention it explicitly in queries
      <ul>
        <li>Database manager will use it automatically</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">generate sequence</h2>

  <p class="inclusion"><a href="src/generate_sequence.sql">src/generate_sequence.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">value</span> <span class="k">from</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/generate_sequence.out">out/generate_sequence.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>  </div>

  <ul>
    <li>A (non-standard) <a href="#g:table_valued_func">table-valued function</a></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">generate sequence based on data</h2>

  <p class="inclusion"><a href="src/data_range_sequence.sql">src/data_range_sequence.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="k">temp</span> <span class="p">(</span>
    <span class="n">num</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="k">temp</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span> <span class="n">value</span> <span class="k">from</span> <span class="n">generate_series</span> <span class="p">(</span>
    <span class="p">(</span><span class="k">select</span> <span class="k">min</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">from</span> <span class="k">temp</span><span class="p">),</span>
    <span class="p">(</span><span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">from</span> <span class="k">temp</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/data_range_sequence.out">out/data_range_sequence.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| value |
|-------|
| 1     |
| 2     |
| 3     |
| 4     |
| 5     |
</code></pre></div>  </div>

  <ul>
    <li>Must have the parentheses around the <code class="language-plaintext highlighter-rouge">min</code> and <code class="language-plaintext highlighter-rouge">max</code> selections to keep <a href="https://sqlite.org/">SQLite</a> happy</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">generate sequence of dates</h2>

  <p class="inclusion"><a href="src/date_sequence.sql">src/date_sequence.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="nb">date</span><span class="p">((</span><span class="k">select</span> <span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span> <span class="k">from</span> <span class="n">experiment</span><span class="p">)</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">some_day</span>
<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">value</span> <span class="k">from</span> <span class="n">generate_series</span><span class="p">(</span>
        <span class="p">(</span><span class="k">select</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">from</span> <span class="n">experiment</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/date_sequence.out">out/date_sequence.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  some_day  |
|------------|
| 2023-01-29 |
| 2023-01-30 |
| 2023-01-31 |
| 2023-02-01 |
| 2023-02-02 |
</code></pre></div>  </div>

  <ul>
    <li><a href="https://sqlite.org/">SQLite</a> represents dates as YYYY-MM-DD strings
or as Julian days or as Unix milliseconds or…
      <ul>
        <li>Julian days is fractional number of days since November 24, 4714 BCE</li>
      </ul>
    </li>
    <li><code class="language-plaintext highlighter-rouge">julianday</code> and <code class="language-plaintext highlighter-rouge">date</code> convert back and forth</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">count experiments started per day without gaps</h2>

  <p class="inclusion"><a href="src/experiments_per_day.sql">src/experiments_per_day.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span>
<span class="c1">-- complete sequence of days with 0 as placeholder for number of experiments</span>
<span class="n">all_days</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="nb">date</span><span class="p">((</span><span class="k">select</span> <span class="n">julianday</span><span class="p">(</span><span class="k">min</span><span class="p">(</span><span class="n">started</span><span class="p">))</span> <span class="k">from</span> <span class="n">experiment</span><span class="p">)</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">some_day</span><span class="p">,</span>
        <span class="mi">0</span> <span class="k">as</span> <span class="n">zeroes</span>
    <span class="k">from</span> <span class="p">(</span>
        <span class="k">select</span> <span class="n">value</span> <span class="k">from</span> <span class="n">generate_series</span><span class="p">(</span>
            <span class="p">(</span><span class="k">select</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">from</span> <span class="n">experiment</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">),</span>

<span class="c1">-- sequence of actual days with actual number of experiments started</span>
<span class="n">actual_days</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">started</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="n">started</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_exp</span>
    <span class="k">from</span> <span class="n">experiment</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">started</span>
<span class="p">)</span>

<span class="c1">-- combined by joining on day and taking actual number (if available) or zero</span>
<span class="k">select</span>
    <span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span> <span class="k">as</span> <span class="k">day</span><span class="p">,</span>
    <span class="n">coalesce</span><span class="p">(</span><span class="n">actual_days</span><span class="p">.</span><span class="n">num_exp</span><span class="p">,</span> <span class="n">all_days</span><span class="p">.</span><span class="n">zeroes</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_exp</span>
<span class="k">from</span>
    <span class="n">all_days</span> <span class="k">left</span> <span class="k">join</span> <span class="n">actual_days</span> <span class="k">on</span> <span class="n">all_days</span><span class="p">.</span><span class="n">some_day</span> <span class="o">=</span> <span class="n">actual_days</span><span class="p">.</span><span class="n">started</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/experiments_per_day.out">out/experiments_per_day.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|    day     | num_exp |
|------------|---------|
| 2023-01-29 | 1       |
| 2023-01-30 | 1       |
| 2023-01-31 | 0       |
| 2023-02-01 | 0       |
| 2023-02-02 | 1       |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">self join</h2>

  <p class="inclusion"><a href="src/self_join.sql">src/self_join.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">person</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">ident</span><span class="p">,</span>
        <span class="n">personal</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">family</span> <span class="k">as</span> <span class="n">name</span>
    <span class="k">from</span> <span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">person</span> <span class="k">as</span> <span class="n">left_person</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">person</span> <span class="k">as</span> <span class="n">right_person</span>
<span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/self_join.out">out/self_join.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|     name     |       name       |
|--------------|------------------|
| Kartik Gupta | Kartik Gupta     |
| Kartik Gupta | Divit Dhaliwal   |
| Kartik Gupta | Indrans Sridhar  |
| Kartik Gupta | Pranay Khanna    |
| Kartik Gupta | Riaan Dua        |
| Kartik Gupta | Vedika Rout      |
| Kartik Gupta | Abram Chokshi    |
| Kartik Gupta | Romil Kapoor     |
| Kartik Gupta | Ishaan Ramaswamy |
| Kartik Gupta | Nitya Lal        |
</code></pre></div>  </div>

  <ul>
    <li>Join a table to itself
      <ul>
        <li>Use <code class="language-plaintext highlighter-rouge">as</code> to create <a href="#g:alias">aliases</a> for copies of tables to distinguish them</li>
        <li>Nothing special about the names <code class="language-plaintext highlighter-rouge">left</code> and <code class="language-plaintext highlighter-rouge">right</code></li>
      </ul>
    </li>
    <li>Get all <math>n<sup>2</sup></math> pairs, including person with themself</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">generate unique pairs</h2>

  <p class="inclusion"><a href="src/unique_pairs.sql">src/unique_pairs.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">person</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">ident</span><span class="p">,</span>
        <span class="n">personal</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">family</span> <span class="k">as</span> <span class="n">name</span>
    <span class="k">from</span> <span class="n">staff</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">left_person</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">right_person</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">person</span> <span class="k">as</span> <span class="n">left_person</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">person</span> <span class="k">as</span> <span class="n">right_person</span>
<span class="k">on</span> <span class="n">left_person</span><span class="p">.</span><span class="n">ident</span> <span class="o">&lt;</span> <span class="n">right_person</span><span class="p">.</span><span class="n">ident</span>
<span class="k">where</span> <span class="n">left_person</span><span class="p">.</span><span class="n">ident</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">and</span> <span class="n">right_person</span><span class="p">.</span><span class="n">ident</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/unique_pairs.out">out/unique_pairs.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|      name       |      name       |
|-----------------|-----------------|
| Kartik Gupta    | Divit Dhaliwal  |
| Kartik Gupta    | Indrans Sridhar |
| Kartik Gupta    | Pranay Khanna   |
| Divit Dhaliwal  | Indrans Sridhar |
| Divit Dhaliwal  | Pranay Khanna   |
| Indrans Sridhar | Pranay Khanna   |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">left.ident &lt; right.ident</code> ensures distinct pairs without duplicates</li>
    <li>Use <code class="language-plaintext highlighter-rouge">left.ident &lt;= 4 and right.ident &lt;= 4</code> to limit output</li>
    <li>Quick check: <math>n(n-1)/2</math> pairs</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">filter pairs</h2>

  <p class="inclusion"><a href="src/filter_pairs.sql">src/filter_pairs.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span>
<span class="n">person</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">ident</span><span class="p">,</span>
        <span class="n">personal</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">family</span> <span class="k">as</span> <span class="n">name</span>
    <span class="k">from</span> <span class="n">staff</span>
<span class="p">),</span>

<span class="n">together</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">left_perf</span><span class="p">.</span><span class="n">staff</span> <span class="k">as</span> <span class="n">left_staff</span><span class="p">,</span>
        <span class="n">right_perf</span><span class="p">.</span><span class="n">staff</span> <span class="k">as</span> <span class="n">right_staff</span>
    <span class="k">from</span> <span class="n">performed</span> <span class="k">as</span> <span class="n">left_perf</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">performed</span> <span class="k">as</span> <span class="n">right_perf</span>
        <span class="k">on</span> <span class="n">left_perf</span><span class="p">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">right_perf</span><span class="p">.</span><span class="n">experiment</span>
    <span class="k">where</span> <span class="n">left_staff</span> <span class="o">&lt;</span> <span class="n">right_staff</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">left_person</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">person_1</span><span class="p">,</span>
    <span class="n">right_person</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">person_2</span>
<span class="k">from</span> <span class="n">person</span> <span class="k">as</span> <span class="n">left_person</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">person</span> <span class="k">as</span> <span class="n">right_person</span> <span class="k">join</span> <span class="n">together</span>
    <span class="k">on</span> <span class="n">left_person</span><span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">left_staff</span> <span class="k">and</span> <span class="n">right_person</span><span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">right_staff</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/filter_pairs.out">out/filter_pairs.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|    person_1     |     person_2     |
|-----------------|------------------|
| Kartik Gupta    | Vedika Rout      |
| Pranay Khanna   | Vedika Rout      |
| Indrans Sridhar | Romil Kapoor     |
| Abram Chokshi   | Ishaan Ramaswamy |
| Pranay Khanna   | Vedika Rout      |
| Kartik Gupta    | Abram Chokshi    |
| Abram Chokshi   | Romil Kapoor     |
| Kartik Gupta    | Divit Dhaliwal   |
| Divit Dhaliwal  | Abram Chokshi    |
| Pranay Khanna   | Ishaan Ramaswamy |
| Indrans Sridhar | Romil Kapoor     |
| Kartik Gupta    | Ishaan Ramaswamy |
| Kartik Gupta    | Nitya Lal        |
| Kartik Gupta    | Abram Chokshi    |
| Pranay Khanna   | Romil Kapoor     |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">existence and correlated subqueries</h2>

  <p class="inclusion"><a href="src/correlated_subquery.sql">src/correlated_subquery.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">building</span>
<span class="k">from</span> <span class="n">department</span>
<span class="k">where</span>
    <span class="k">exists</span> <span class="p">(</span>
        <span class="k">select</span> <span class="mi">1</span>
        <span class="k">from</span> <span class="n">staff</span>
        <span class="k">where</span> <span class="n">dept</span> <span class="o">=</span> <span class="n">department</span><span class="p">.</span><span class="n">ident</span>
    <span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/correlated_subquery.out">out/correlated_subquery.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>  </div>

  <ul>
    <li>Nobody works in Endocrinology</li>
    <li><code class="language-plaintext highlighter-rouge">select 1</code> could equally be <code class="language-plaintext highlighter-rouge">select true</code> or any other value</li>
    <li>A <a href="#g:correlated_subquery">correlated subquery</a> depends on a value from the outer query
      <ul>
        <li>Equivalent to nested loop</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">nonexistence</h2>

  <p class="inclusion"><a href="src/nonexistence.sql">src/nonexistence.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">building</span>
<span class="k">from</span> <span class="n">department</span>
<span class="k">where</span>
    <span class="k">not</span> <span class="k">exists</span> <span class="p">(</span>
        <span class="k">select</span> <span class="mi">1</span>
        <span class="k">from</span> <span class="n">staff</span>
        <span class="k">where</span> <span class="n">dept</span> <span class="o">=</span> <span class="n">department</span><span class="p">.</span><span class="n">ident</span>
    <span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/nonexistence.out">out/nonexistence.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|     name      | building |
|---------------|----------|
| Endocrinology | TGVH     |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">avoiding correlated subqueries</h2>

  <p class="inclusion"><a href="src/avoid_correlated_subqueries.sql">src/avoid_correlated_subqueries.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">department</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">name</span><span class="p">,</span>
    <span class="n">department</span><span class="p">.</span><span class="n">building</span> <span class="k">as</span> <span class="n">building</span>
<span class="k">from</span> <span class="n">department</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">staff</span>
    <span class="k">on</span> <span class="n">department</span><span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">staff</span><span class="p">.</span><span class="n">dept</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/avoid_correlated_subqueries.out">out/avoid_correlated_subqueries.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|       name        |     building     |
|-------------------|------------------|
| Genetics          | Chesson          |
| Histology         | Fashet Extension |
| Molecular Biology | Chesson          |
</code></pre></div>  </div>

  <ul>
    <li>The join might or might not be faster than the correlated subquery</li>
    <li>Hard to find unstaffed departments without either <code class="language-plaintext highlighter-rouge">not exists</code> or <code class="language-plaintext highlighter-rouge">count</code> and a check for 0</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">lead and lag</h2>

  <p class="inclusion"><a href="src/lead_lag.sql">src/lead_lag.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">ym_num</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m'</span><span class="p">,</span> <span class="n">started</span><span class="p">)</span> <span class="k">as</span> <span class="n">ym</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
    <span class="k">from</span> <span class="n">experiment</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">ym</span><span class="p">,</span>
    <span class="n">lag</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">)</span> <span class="k">as</span> <span class="n">prev_num</span><span class="p">,</span>
    <span class="n">num</span><span class="p">,</span>
    <span class="n">lead</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">)</span> <span class="k">as</span> <span class="n">next_num</span>
<span class="k">from</span> <span class="n">ym_num</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/lead_lag.out">out/lead_lag.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   ym    | prev_num | num | next_num |
|---------|----------|-----|----------|
| 2023-01 |          | 2   | 5        |
| 2023-02 | 2        | 5   | 5        |
| 2023-03 | 5        | 5   | 1        |
| 2023-04 | 5        | 1   | 6        |
| 2023-05 | 1        | 6   | 5        |
| 2023-06 | 6        | 5   | 3        |
| 2023-07 | 5        | 3   | 2        |
| 2023-08 | 3        | 2   | 4        |
| 2023-09 | 2        | 4   | 6        |
| 2023-10 | 4        | 6   | 4        |
| 2023-12 | 6        | 4   | 5        |
| 2024-01 | 4        | 5   | 2        |
| 2024-02 | 5        | 2   |          |
</code></pre></div>  </div>

  <ul>
    <li>Use <code class="language-plaintext highlighter-rouge">strftime</code> to extract year and month
      <ul>
        <li>Clumsy, but date/time handling is not <a href="https://sqlite.org/">SQLite</a>’s strong point</li>
      </ul>
    </li>
    <li>Use <a href="#g:window_func">window functions</a> <code class="language-plaintext highlighter-rouge">lead</code> and <code class="language-plaintext highlighter-rouge">lag</code> to shift values
      <ul>
        <li>Unavailable values are null</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">window functions</h2>

  <p class="inclusion"><a href="src/window_functions.sql">src/window_functions.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">ym_num</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m'</span><span class="p">,</span> <span class="n">started</span><span class="p">)</span> <span class="k">as</span> <span class="n">ym</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
    <span class="k">from</span> <span class="n">experiment</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">ym</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">ym</span><span class="p">,</span>
    <span class="n">num</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_done</span><span class="p">,</span>
    <span class="n">cume_dist</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span>
<span class="k">from</span> <span class="n">ym_num</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/window_functions.out">out/window_functions.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   ym    | num | num_done |      progress      |
|---------|-----|----------|--------------------|
| 2023-01 | 2   | 2        | 0.0769230769230769 |
| 2023-02 | 5   | 7        | 0.153846153846154  |
| 2023-03 | 5   | 12       | 0.230769230769231  |
| 2023-04 | 1   | 13       | 0.307692307692308  |
| 2023-05 | 6   | 19       | 0.384615384615385  |
| 2023-06 | 5   | 24       | 0.461538461538462  |
| 2023-07 | 3   | 27       | 0.538461538461538  |
| 2023-08 | 2   | 29       | 0.615384615384615  |
| 2023-09 | 4   | 33       | 0.692307692307692  |
| 2023-10 | 6   | 39       | 0.769230769230769  |
| 2023-12 | 4   | 43       | 0.846153846153846  |
| 2024-01 | 5   | 48       | 0.923076923076923  |
| 2024-02 | 2   | 50       | 1.0                |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">sum() over</code> does a running total</li>
    <li><code class="language-plaintext highlighter-rouge">cume_dist</code> is fraction <em>of rows seen so far</em></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">explain another query plan</h2>

  <p class="inclusion"><a href="src/explain_window_function.sql">src/explain_window_function.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explain</span> <span class="n">query</span> <span class="n">plan</span>
<span class="k">with</span> <span class="n">ym_num</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m'</span><span class="p">,</span> <span class="n">started</span><span class="p">)</span> <span class="k">as</span> <span class="n">ym</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
    <span class="k">from</span> <span class="n">experiment</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">ym</span>
<span class="p">)</span>
<span class="k">select</span>
    <span class="n">ym</span><span class="p">,</span>
    <span class="n">num</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_done</span><span class="p">,</span>
    <span class="n">cume_dist</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span>
<span class="k">from</span> <span class="n">ym_num</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">ym</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/explain_window_function.out">out/explain_window_function.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>QUERY PLAN
|--CO-ROUTINE (subquery-3)
|  |--CO-ROUTINE (subquery-4)
|  |  |--CO-ROUTINE ym_num
|  |  |  |--SCAN experiment
|  |  |  `--USE TEMP B-TREE FOR GROUP BY
|  |  |--SCAN ym_num
|  |  `--USE TEMP B-TREE FOR ORDER BY
|  `--SCAN (subquery-4)
`--SCAN (subquery-3)
</code></pre></div>  </div>

  <ul>
    <li>Becomes useful…eventually</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">partitioned windows</h2>

  <p class="inclusion"><a href="src/partition_window.sql">src/partition_window.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">y_m_num</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y'</span><span class="p">,</span> <span class="n">started</span><span class="p">)</span> <span class="k">as</span> <span class="nb">year</span><span class="p">,</span>
        <span class="n">strftime</span><span class="p">(</span><span class="s1">'%m'</span><span class="p">,</span> <span class="n">started</span><span class="p">)</span> <span class="k">as</span> <span class="k">month</span><span class="p">,</span>
        <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
    <span class="k">from</span> <span class="n">experiment</span>
    <span class="k">group</span> <span class="k">by</span> <span class="nb">year</span><span class="p">,</span> <span class="k">month</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="nb">year</span><span class="p">,</span>
    <span class="k">month</span><span class="p">,</span>
    <span class="n">num</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">partition</span> <span class="k">by</span> <span class="nb">year</span> <span class="k">order</span> <span class="k">by</span> <span class="k">month</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_done</span>
<span class="k">from</span> <span class="n">y_m_num</span>
<span class="k">order</span> <span class="k">by</span> <span class="nb">year</span><span class="p">,</span> <span class="k">month</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/partition_window.out">out/partition_window.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| year | month | num | num_done |
|------|-------|-----|----------|
| 2023 | 01    | 2   | 2        |
| 2023 | 02    | 5   | 7        |
| 2023 | 03    | 5   | 12       |
| 2023 | 04    | 1   | 13       |
| 2023 | 05    | 6   | 19       |
| 2023 | 06    | 5   | 24       |
| 2023 | 07    | 3   | 27       |
| 2023 | 08    | 2   | 29       |
| 2023 | 09    | 4   | 33       |
| 2023 | 10    | 6   | 39       |
| 2023 | 12    | 4   | 43       |
| 2024 | 01    | 5   | 5        |
| 2024 | 02    | 2   | 7        |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">partition by</code> creates groups</li>
    <li>So this counts experiments started since the beginning of each year</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">blobs</h2>

  <p class="inclusion"><a href="src/blob.sql">src/blob.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">images</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">content</span> <span class="nb">blob</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">images</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'biohazard'</span><span class="p">,</span> <span class="n">readfile</span><span class="p">(</span><span class="s1">'img/biohazard.png'</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">'crush'</span><span class="p">,</span> <span class="n">readfile</span><span class="p">(</span><span class="s1">'img/crush.png'</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">'fire'</span><span class="p">,</span> <span class="n">readfile</span><span class="p">(</span><span class="s1">'img/fire.png'</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">'radioactive'</span><span class="p">,</span> <span class="n">readfile</span><span class="p">(</span><span class="s1">'img/radioactive.png'</span><span class="p">)),</span>
<span class="p">(</span><span class="s1">'tripping'</span><span class="p">,</span> <span class="n">readfile</span><span class="p">(</span><span class="s1">'img/tripping.png'</span><span class="p">));</span>

<span class="k">select</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="k">length</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="k">from</span> <span class="n">images</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/blob.out">out/blob.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|    name     | length(content) |
|-------------|-----------------|
| biohazard   | 19629           |
| crush       | 15967           |
| fire        | 18699           |
| radioactive | 16661           |
| tripping    | 17208           |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:blob">blob</a> is a binary large object
      <ul>
        <li>Bytes in, bytes out…</li>
      </ul>
    </li>
    <li>If you think that’s odd, check out <a href="https://fossil-scm.org/">Fossil</a></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">yet another database</h2>

  <p class="inclusion"><a href="src/lab_log_db.sh">src/lab_log_db.sh</a></p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sqlite3 data/lab_log.db
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/lab_log_schema.sql">src/lab_log_schema.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="k">schema</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/lab_log_schema.out">out/lab_log_schema.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE person(
       ident            integer primary key autoincrement,
       details          text not null
);
CREATE TABLE machine(
       ident            integer primary key autoincrement,
       name             text not null,
       details          text not null
);
CREATE TABLE usage(
       ident            integer primary key autoincrement,
       log              text not null
);
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">store JSON</h2>

  <p class="inclusion"><a href="src/json_in_table.sql">src/json_in_table.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">machine</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/json_in_table.out">out/json_in_table.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident |      name      |                         details                         |
|-------|----------------|---------------------------------------------------------|
| 1     | WY401          | {"acquired": "2023-05-01"}                              |
| 2     | Inphormex      | {"acquired": "2021-07-15", "refurbished": "2023-10-22"} |
| 3     | AutoPlate 9000 | {"note": "needs software update"}                       |
</code></pre></div>  </div>

  <ul>
    <li>Store heterogeneous data as JSON-formatted text (with double-quoted strings)
      <ul>
        <li>Database parses it each time it is queried</li>
      </ul>
    </li>
    <li>Alternatively store as blob
      <ul>
        <li>Can’t just view it</li>
        <li>But more efficient</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">select field from JSON</h2>

  <p class="inclusion"><a href="src/json_field.sql">src/json_field.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">details</span><span class="o">-&gt;</span><span class="s1">'$.acquired'</span> <span class="k">as</span> <span class="n">single_arrow</span><span class="p">,</span>
    <span class="n">details</span><span class="o">-&gt;&gt;</span><span class="s1">'$.acquired'</span> <span class="k">as</span> <span class="n">double_arrow</span>
<span class="k">from</span> <span class="n">machine</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/json_field.out">out/json_field.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| single_arrow | double_arrow |
|--------------|--------------|
| "2023-05-01" | 2023-05-01   |
| "2021-07-15" | 2021-07-15   |
|              |              |
</code></pre></div>  </div>

  <ul>
    <li>Single arrow <code class="language-plaintext highlighter-rouge">-&gt;</code> returns JSON representation result</li>
    <li>Double arrow <code class="language-plaintext highlighter-rouge">-&gt;&gt;</code> returns SQL text, integer, real, or null</li>
    <li>Left side is column</li>
    <li>Right side is <a href="#g:path_expression">path expression</a>
      <ul>
        <li>Start with <code class="language-plaintext highlighter-rouge">$</code> (meaning “root”)</li>
        <li>Fields separated by <code class="language-plaintext highlighter-rouge">.</code></li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">JSON array access</h2>

  <p class="inclusion"><a href="src/json_array.sql">src/json_array.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">ident</span><span class="p">,</span>
    <span class="n">json_array_length</span><span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="s1">'$'</span><span class="p">)</span> <span class="k">as</span> <span class="k">length</span><span class="p">,</span>
    <span class="n">log</span><span class="o">-&gt;</span><span class="s1">'$[0]'</span> <span class="k">as</span> <span class="k">first</span>
<span class="k">from</span> <span class="k">usage</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/json_array.out">out/json_array.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident | length |                            first                             |
|-------|--------|--------------------------------------------------------------|
| 1     | 4      | {"machine":"Inphormex","person":["Gabrielle","Dub\u00e9"]}   |
| 2     | 5      | {"machine":"Inphormex","person":["Marianne","Richer"]}       |
| 3     | 2      | {"machine":"sterilizer","person":["Josette","Villeneuve"]}   |
| 4     | 1      | {"machine":"sterilizer","person":["Maude","Goulet"]}         |
| 5     | 2      | {"machine":"AutoPlate 9000","person":["Brigitte","Michaud"]} |
| 6     | 1      | {"machine":"sterilizer","person":["Marianne","Richer"]}      |
| 7     | 3      | {"machine":"WY401","person":["Maude","Goulet"]}              |
| 8     | 1      | {"machine":"AutoPlate 9000"}                                 |
</code></pre></div>  </div>

  <ul>
    <li><a href="https://sqlite.org/">SQLite</a> (and other database managers) has lots of JSON manipulation functions</li>
    <li><code class="language-plaintext highlighter-rouge">json_array_length</code> gives number of elements in selected array</li>
    <li>subscripts start with 0</li>
    <li>Characters outside 7-bit ASCII represented as Unicode escapes</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">unpack JSON array</h2>

  <p class="inclusion"><a href="src/json_unpack.sql">src/json_unpack.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">ident</span><span class="p">,</span>
    <span class="n">json_each</span><span class="p">.</span><span class="k">key</span> <span class="k">as</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">json_each</span><span class="p">.</span><span class="n">value</span> <span class="k">as</span> <span class="n">value</span>
<span class="k">from</span> <span class="k">usage</span><span class="p">,</span> <span class="n">json_each</span><span class="p">(</span><span class="k">usage</span><span class="p">.</span><span class="n">log</span><span class="p">)</span>
<span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/json_unpack.out">out/json_unpack.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident | key |                            value                             |
|-------|-----|--------------------------------------------------------------|
| 1     | 0   | {"machine":"Inphormex","person":["Gabrielle","Dub\u00e9"]}   |
| 1     | 1   | {"machine":"Inphormex","person":["Gabrielle","Dub\u00e9"]}   |
| 1     | 2   | {"machine":"WY401","person":["Gabrielle","Dub\u00e9"]}       |
| 1     | 3   | {"machine":"Inphormex","person":["Gabrielle","Dub\u00e9"]}   |
| 2     | 0   | {"machine":"Inphormex","person":["Marianne","Richer"]}       |
| 2     | 1   | {"machine":"AutoPlate 9000","person":["Marianne","Richer"]}  |
| 2     | 2   | {"machine":"sterilizer","person":["Marianne","Richer"]}      |
| 2     | 3   | {"machine":"AutoPlate 9000","person":["Monique","Marcotte"]} |
| 2     | 4   | {"machine":"sterilizer","person":["Marianne","Richer"]}      |
| 3     | 0   | {"machine":"sterilizer","person":["Josette","Villeneuve"]}   |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">json_each</code> is another table-valued function</li>
    <li>Use <code>json_each.<em>name</em></code> to get properties of unpacked array</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">last element of array</h2>

  <p class="inclusion"><a href="src/json_array_last.sql">src/json_array_last.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">ident</span><span class="p">,</span>
    <span class="n">log</span><span class="o">-&gt;</span><span class="s1">'$[#-1].machine'</span> <span class="k">as</span> <span class="k">final</span>
<span class="k">from</span> <span class="k">usage</span>
<span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/json_array_last.out">out/json_array_last.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident |    final     |
|-------|--------------|
| 1     | "Inphormex"  |
| 2     | "sterilizer" |
| 3     | "Inphormex"  |
| 4     | "sterilizer" |
| 5     | "sterilizer" |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">modify JSON</h2>

  <p class="inclusion"><a href="src/json_modify.sql">src/json_modify.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">ident</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">json_set</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="s1">'$.sold'</span><span class="p">,</span> <span class="n">json_quote</span><span class="p">(</span><span class="s1">'2024-01-25'</span><span class="p">))</span> <span class="k">as</span> <span class="n">updated</span>
<span class="k">from</span> <span class="n">machine</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/json_modify.out">out/json_modify.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident |      name      |                           updated                            |
|-------|----------------|--------------------------------------------------------------|
| 1     | WY401          | {"acquired":"2023-05-01","sold":"2024-01-25"}                |
| 2     | Inphormex      | {"acquired":"2021-07-15","refurbished":"2023-10-22","sold":" |
|       |                | 2024-01-25"}                                                 |
| 3     | AutoPlate 9000 | {"note":"needs software update","sold":"2024-01-25"}         |
</code></pre></div>  </div>

  <ul>
    <li>Updates the in-memory copy of the JSON, <em>not</em> the database record</li>
    <li>Please use <code class="language-plaintext highlighter-rouge">json_quote</code> rather than trying to format JSON with string operations</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">refresh penguins</h2>

  <p class="inclusion"><a href="src/count_penguins.sql">src/count_penguins.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/count_penguins.out">out/count_penguins.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  | num |
|-----------|-----|
| Adelie    | 152 |
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>  </div>

  <ul>
    <li>We will restore full database after each example</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">tombstones</h2>

  <p class="inclusion"><a href="src/make_active.sql">src/make_active.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="n">penguins</span>
<span class="k">add</span> <span class="n">active</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">update</span> <span class="n">penguins</span>
<span class="k">set</span> <span class="n">active</span> <span class="o">=</span> <span class="n">iif</span><span class="p">(</span><span class="n">species</span> <span class="o">=</span> <span class="s1">'Adelie'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/active_penguins.sql">src/active_penguins.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">active</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/active_penguins.out">out/active_penguins.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  | num |
|-----------|-----|
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>  </div>

  <ul>
    <li>Use a <a href="#g:tombstone">tombstone</a> to mark (in)active records</li>
    <li>Every query must now include it</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">importing CSV data</h2>

  <ul>
    <li><a href="https://sqlite.org/">SQLite</a> and most other database managers have tools for importing and exporting <a href="#g:csv">CSV</a></li>
    <li>In <a href="https://sqlite.org/">SQLite</a>:
      <ul>
        <li>Define table</li>
        <li>Import data</li>
        <li>Convert empty strings to nulls (if desired)</li>
        <li>Convert types from text to whatever (not shown below)</li>
      </ul>
    </li>
  </ul>

  <p class="inclusion"><a href="src/create_penguins.sql">src/create_penguins.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">drop</span> <span class="k">table</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">penguins</span><span class="p">;</span>
<span class="p">.</span><span class="k">mode</span> <span class="n">csv</span> <span class="n">penguins</span>
<span class="p">.</span><span class="n">import</span> <span class="n">misc</span><span class="o">/</span><span class="n">penguins</span><span class="p">.</span><span class="n">csv</span> <span class="n">penguins</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">species</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">species</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">island</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">island</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">bill_length_mm</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">bill_length_mm</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">bill_depth_mm</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">bill_depth_mm</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">flipper_length_mm</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">flipper_length_mm</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">body_mass_g</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">body_mass_g</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">update</span> <span class="n">penguins</span> <span class="k">set</span> <span class="n">sex</span> <span class="o">=</span> <span class="k">null</span> <span class="k">where</span> <span class="n">sex</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">views</h2>

  <p class="inclusion"><a href="src/views.sql">src/views.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">view</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span>
<span class="n">active_penguins</span> <span class="p">(</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">island</span><span class="p">,</span>
    <span class="n">bill_length_mm</span><span class="p">,</span>
    <span class="n">bill_depth_mm</span><span class="p">,</span>
    <span class="n">flipper_length_mm</span><span class="p">,</span>
    <span class="n">body_mass_g</span><span class="p">,</span>
    <span class="n">sex</span>
<span class="p">)</span> <span class="k">as</span>
<span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">island</span><span class="p">,</span>
    <span class="n">bill_length_mm</span><span class="p">,</span>
    <span class="n">bill_depth_mm</span><span class="p">,</span>
    <span class="n">flipper_length_mm</span><span class="p">,</span>
    <span class="n">body_mass_g</span><span class="p">,</span>
    <span class="n">sex</span>
<span class="k">from</span> <span class="n">penguins</span>
<span class="k">where</span> <span class="n">active</span><span class="p">;</span>

<span class="k">select</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num</span>
<span class="k">from</span> <span class="n">active_penguins</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">species</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/views.out">out/views.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  species  | num |
|-----------|-----|
| Chinstrap | 68  |
| Gentoo    | 124 |
</code></pre></div>  </div>

  <ul>
    <li>A <a href="#g:view">view</a> is a saved query that other queries can invoke</li>
    <li>View is re-run each time it’s used</li>
    <li>Like a CTE, but:
      <ul>
        <li>Can be shared between queries</li>
        <li>Views came first</li>
      </ul>
    </li>
    <li>Some databases offer <a href="#g:materialized_view">materialized views</a>
      <ul>
        <li>Update-on-demand temporary tables</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_temp.svg" alt="concept map: temporary tables" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">hours reminder</h2>

  <p class="inclusion"><a href="src/all_jobs.sql">src/all_jobs.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">billable</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'calibrate'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'clean'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/all_jobs.out">out/all_jobs.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
| clean     | 0.5      |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">add check</h2>

  <p class="inclusion"><a href="src/all_jobs_check.sql">src/all_jobs_check.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">billable</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">check</span> <span class="p">(</span><span class="n">billable</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'calibrate'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/all_jobs_check.out">out/all_jobs_check.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Runtime error near line 9: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">check</code> adds constraint to table
      <ul>
        <li>Must produce a Boolean result</li>
        <li>Run each time values added or modified</li>
      </ul>
    </li>
    <li>But changes made before the error have taken effect</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">ACID</h2>

  <ul>
    <li><a href="#g:atomic">Atomic</a>: change cannot be broken down into smaller ones (i.e., all or nothing)</li>
    <li><a href="#g:consistent">Consistent</a>: database goes from one consistent state to another</li>
    <li><a href="#g:isolated">Isolated</a>: looks like changes happened one after another</li>
    <li><a href="#g:durable">Durable</a>: if change takes place, it’s still there after a restart</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">transactions</h2>

  <p class="inclusion"><a href="src/transaction.sql">src/transaction.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">billable</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">check</span> <span class="p">(</span><span class="n">billable</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'calibrate'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

<span class="k">begin</span> <span class="n">transaction</span><span class="p">;</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'clean'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">rollback</span><span class="p">;</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/transaction.out">out/transaction.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li>Statements outside transaction execute and are committed immediately</li>
    <li>Statement(s) inside transaction don’t take effect until:
      <ul>
        <li><code class="language-plaintext highlighter-rouge">end transaction</code> (success)</li>
        <li><code class="language-plaintext highlighter-rouge">rollback</code> (undo)</li>
      </ul>
    </li>
    <li>Can have any number of statements inside a transaction</li>
    <li>But <em>cannot</em> nest transactions in <a href="https://sqlite.org/">SQLite</a>
      <ul>
        <li>Other databases support this</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">rollback in constraint</h2>

  <p class="inclusion"><a href="src/rollback_constraint.sql">src/rollback_constraint.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">billable</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">check</span> <span class="p">(</span><span class="n">billable</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">on</span> <span class="n">conflict</span> <span class="k">rollback</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
    <span class="p">(</span><span class="s1">'calibrate'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
    <span class="p">(</span><span class="s1">'clean'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/rollback_constraint.out">out/rollback_constraint.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Runtime error near line 11: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li>All of second <code class="language-plaintext highlighter-rouge">insert</code> rolled back as soon as error occurred</li>
    <li>But first <code class="language-plaintext highlighter-rouge">insert</code> took effect</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">rollback in statement</h2>

  <p class="inclusion"><a href="src/rollback_statement.sql">src/rollback_statement.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">billable</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">check</span> <span class="p">(</span><span class="n">billable</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">or</span> <span class="k">rollback</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'calibrate'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">or</span> <span class="k">rollback</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'clean'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">job</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/rollback_statement.out">out/rollback_statement.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Runtime error near line 11: CHECK constraint failed: billable &gt; 0.0 (19)
|   name    | billable |
|-----------|----------|
| calibrate | 1.5      |
</code></pre></div>  </div>

  <ul>
    <li>Constraint is in table definition</li>
    <li>Action is in statement</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">upsert</h2>

  <p class="inclusion"><a href="src/upsert.sql">src/upsert.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">jobs_done</span> <span class="p">(</span>
    <span class="n">person</span> <span class="nb">text</span> <span class="k">unique</span><span class="p">,</span>
    <span class="n">num</span> <span class="nb">integer</span> <span class="k">default</span> <span class="mi">0</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">jobs_done</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'zia'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">.</span><span class="n">print</span> <span class="s1">'after first'</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">jobs_done</span><span class="p">;</span>
<span class="p">.</span><span class="n">print</span>


<span class="k">insert</span> <span class="k">into</span> <span class="n">jobs_done</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'zia'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">.</span><span class="n">print</span> <span class="s1">'after failed'</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">jobs_done</span><span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">jobs_done</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'zia'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">on</span> <span class="n">conflict</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="k">do</span> <span class="k">update</span> <span class="k">set</span> <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">.</span><span class="n">print</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">after upsert'</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">jobs_done</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/upsert.out">out/upsert.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after first
| person | num |
|--------|-----|
| zia    | 1   |

Runtime error near line 15: UNIQUE constraint failed: jobs_done.person (19)
after failed
| person | num |
|--------|-----|
| zia    | 1   |
\nafter upsert
| person | num |
|--------|-----|
| zia    | 2   |
</code></pre></div>  </div>

  <ul>
    <li><a href="#g:upsert">upsert</a> stands for “update or insert”
      <ul>
        <li>Create if record doesn’t exist</li>
        <li>Update if it does</li>
      </ul>
    </li>
    <li>Not standard SQL but widely implemented</li>
    <li>Example also shows use of <a href="https://sqlite.org/">SQLite</a> <code class="language-plaintext highlighter-rouge">.print</code> command</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">normalization</h2>

  <ul>
    <li>
      <p>First <a href="#g:normal_form">normal form</a> (1NF):
every field of every record contains one indivisible value.</p>
    </li>
    <li>
      <p>Second normal form (2NF) and third normal form (3NF):
every value in a record that isn’t a key depends solely on the key,
not on other values.</p>
    </li>
    <li>
      <p><a href="#g:denormalization">Denormalization</a>: explicitly store values that could be calculated on the fly</p>
      <ul>
        <li>To simplify queries and/or make processing faster</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">create trigger</h2>

  <ul>
    <li>A <a href="#g:trigger">trigger</a> automatically runs before or after a specified operation</li>
    <li>Can have side effects (e.g., update some other table)</li>
    <li>And/or implement checks (e.g., make sure other records exist)</li>
    <li>Add processing overhead…</li>
    <li>…but data is either cheap or correct, never both</li>
    <li>Inside trigger, refer to old and new versions of record
as <code>old.<em>column</em></code> and <code>new.<em>column</em></code></li>
  </ul>

  <p class="inclusion"><a href="src/trigger_setup.sql">src/trigger_setup.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Track hours of lab work.</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">job</span> <span class="p">(</span>
    <span class="n">person</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">reported</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span> <span class="k">check</span> <span class="p">(</span><span class="n">reported</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Explicitly store per-person total rather than using sum().</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">total</span> <span class="p">(</span>
    <span class="n">person</span> <span class="nb">text</span> <span class="k">unique</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">hours</span> <span class="nb">real</span>
<span class="p">);</span>

<span class="c1">-- Initialize totals.</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">total</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'gene'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'august'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">-- Define a trigger.</span>
<span class="k">create</span> <span class="k">trigger</span> <span class="n">total_trigger</span>
<span class="k">before</span> <span class="k">insert</span> <span class="k">on</span> <span class="n">job</span>
<span class="k">begin</span>
    <span class="c1">-- Check that the person exists.</span>
    <span class="k">select</span> <span class="k">case</span>
        <span class="k">when</span> <span class="k">not</span> <span class="k">exists</span> <span class="p">(</span><span class="k">select</span> <span class="mi">1</span> <span class="k">from</span> <span class="n">total</span> <span class="k">where</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span><span class="p">.</span><span class="n">person</span><span class="p">)</span>
        <span class="k">then</span> <span class="n">raise</span><span class="p">(</span><span class="k">rollback</span><span class="p">,</span> <span class="s1">'Unknown person '</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
    <span class="c1">-- Update their total hours (or fail if non-negative constraint violated).</span>
    <span class="k">update</span> <span class="n">total</span>
    <span class="k">set</span> <span class="n">hours</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">+</span> <span class="k">new</span><span class="p">.</span><span class="n">reported</span>
    <span class="k">where</span> <span class="n">total</span><span class="p">.</span><span class="n">person</span> <span class="o">=</span> <span class="k">new</span><span class="p">.</span><span class="n">person</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/trigger_successful.sql">src/trigger_successful.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'gene'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'august'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'gene'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/trigger_successful.out">out/trigger_successful.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| person | reported |
|--------|----------|
| gene   | 1.5      |
| august | 0.5      |
| gene   | 1.0      |

| person | hours |
|--------|-------|
| gene   | 2.5   |
| august | 0.5   |
</code></pre></div>  </div>

</section>
<section>

  <h1 id="trigger-firing">081: trigger firing</h1>

  <p class="inclusion"><a href="src/trigger_firing.sql">src/trigger_firing.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">job</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'gene'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'august'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/trigger_firing.out">out/trigger_firing.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Runtime error near line 6: CHECK constraint failed: reported &gt;= 0.0 (19)

| person | hours |
|--------|-------|
| gene   | 0.0   |
| august | 0.0   |
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">represent graphs</h2>

  <p class="inclusion"><a href="src/lineage_setup.sql">src/lineage_setup.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">lineage</span> <span class="p">(</span>
    <span class="n">parent</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">child</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">lineage</span> <span class="k">values</span>
<span class="p">(</span><span class="s1">'Arturo'</span><span class="p">,</span> <span class="s1">'Clemente'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Darío'</span><span class="p">,</span> <span class="s1">'Clemente'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Clemente'</span><span class="p">,</span> <span class="s1">'Homero'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Clemente'</span><span class="p">,</span> <span class="s1">'Ivonne'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Ivonne'</span><span class="p">,</span> <span class="s1">'Lourdes'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Soledad'</span><span class="p">,</span> <span class="s1">'Lourdes'</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Lourdes'</span><span class="p">,</span> <span class="s1">'Santiago'</span><span class="p">);</span>
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/represent_graph.sql">src/represent_graph.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">lineage</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/represent_graph.out">out/represent_graph.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  parent  |  child   |
|----------|----------|
| Arturo   | Clemente |
| Darío    | Clemente |
| Clemente | Homero   |
| Clemente | Ivonne   |
| Ivonne   | Lourdes  |
| Soledad  | Lourdes  |
| Lourdes  | Santiago |
</code></pre></div>  </div>

  <p><img src="./img/lineage.svg" alt="lineage diagram" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">recursive query</h2>

  <p class="inclusion"><a href="src/recursive_lineage.sql">src/recursive_lineage.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="k">recursive</span> <span class="n">descendent</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="s1">'Clemente'</span> <span class="k">as</span> <span class="n">person</span><span class="p">,</span>
        <span class="mi">0</span> <span class="k">as</span> <span class="n">generations</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="k">select</span>
        <span class="n">lineage</span><span class="p">.</span><span class="n">child</span> <span class="k">as</span> <span class="n">person</span><span class="p">,</span>
        <span class="n">descendent</span><span class="p">.</span><span class="n">generations</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">as</span> <span class="n">generations</span>
    <span class="k">from</span> <span class="n">descendent</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">lineage</span>
        <span class="k">on</span> <span class="n">descendent</span><span class="p">.</span><span class="n">person</span> <span class="o">=</span> <span class="n">lineage</span><span class="p">.</span><span class="n">parent</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">person</span><span class="p">,</span>
    <span class="n">generations</span>
<span class="k">from</span> <span class="n">descendent</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/recursive_lineage.out">out/recursive_lineage.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|  person  | generations |
|----------|-------------|
| Clemente | 0           |
| Homero   | 1           |
| Ivonne   | 1           |
| Lourdes  | 2           |
| Santiago | 3           |
</code></pre></div>  </div>

  <ul>
    <li>Use a <a href="#g:recursive_cte">recursive CTE</a> to create a temporary table (<code class="language-plaintext highlighter-rouge">descendent</code>)</li>
    <li><a href="#g:base_case">Base case</a> seeds this table</li>
    <li><a href="#g:recursive_case">Recursive case</a> relies on value(s) already in that table and external table(s)</li>
    <li><code class="language-plaintext highlighter-rouge">union all</code> to combine rows
      <ul>
        <li>Can use <code class="language-plaintext highlighter-rouge">union</code> but that has lower performance (must check uniqueness each time)</li>
      </ul>
    </li>
    <li>Stops when the recursive case yields an empty row set (nothing new to add)</li>
    <li>Then select the desired values from the CTE</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">contact tracing database</h2>

  <p class="inclusion"><a href="src/contact_person.sql">src/contact_person.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">person</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/contact_person.out">out/contact_person.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| ident |         name          |
|-------|-----------------------|
| 1     | Juana Baeza           |
| 2     | Agustín Rodríquez     |
| 3     | Ariadna Caraballo     |
| 4     | Micaela Laboy         |
| 5     | Verónica Altamirano   |
| 6     | Reina Rivero          |
| 7     | Elias Merino          |
| 8     | Minerva Guerrero      |
| 9     | Mauro Balderas        |
| 10    | Pilar Alarcón         |
| 11    | Daniela Menéndez      |
| 12    | Marco Antonio Barrera |
| 13    | Cristal Soliz         |
| 14    | Bernardo Narváez      |
| 15    | Óscar Barrios         |
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/contact_contacts.sql">src/contact_contacts.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">contact</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/contact_contacts.out">out/contact_contacts.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|       left        |         right         |
|-------------------|-----------------------|
| Agustín Rodríquez | Ariadna Caraballo     |
| Agustín Rodríquez | Verónica Altamirano   |
| Juana Baeza       | Verónica Altamirano   |
| Juana Baeza       | Micaela Laboy         |
| Pilar Alarcón     | Reina Rivero          |
| Cristal Soliz     | Marco Antonio Barrera |
| Cristal Soliz     | Daniela Menéndez      |
| Daniela Menéndez  | Marco Antonio Barrera |
</code></pre></div>  </div>

  <p><img src="./img/contact_tracing.svg" alt="contact diagram" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">bidirectional contacts</h2>

  <p class="inclusion"><a href="src/bidirectional.sql">src/bidirectional.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">temporary</span> <span class="k">table</span> <span class="n">bi_contact</span> <span class="p">(</span>
    <span class="k">left</span> <span class="nb">text</span><span class="p">,</span>
    <span class="k">right</span> <span class="nb">text</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">bi_contact</span>
<span class="k">select</span>
    <span class="k">left</span><span class="p">,</span> <span class="k">right</span> <span class="k">from</span> <span class="n">contact</span>
    <span class="k">union</span> <span class="k">all</span>
    <span class="k">select</span> <span class="k">right</span><span class="p">,</span> <span class="k">left</span> <span class="k">from</span> <span class="n">contact</span>
<span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/bidirectional.out">out/bidirectional.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| original_count |
|----------------|
| 8              |

| num_contact |
|-------------|
| 16          |
</code></pre></div>  </div>

  <ul>
    <li>Create a <a href="#g:temporary_table">temporary table</a> rather than using a long chain of CTEs
      <ul>
        <li>Only lasts as long as the session (not saved to disk)</li>
      </ul>
    </li>
    <li>Duplicate information rather than writing more complicated query</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">update group identifiers</h2>

  <p class="inclusion"><a href="src/update_group_ids.sql">src/update_group_ids.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="k">left</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">left_name</span><span class="p">,</span>
    <span class="k">left</span><span class="p">.</span><span class="n">ident</span> <span class="k">as</span> <span class="n">left_ident</span><span class="p">,</span>
    <span class="k">right</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">right_name</span><span class="p">,</span>
    <span class="k">right</span><span class="p">.</span><span class="n">ident</span> <span class="k">as</span> <span class="n">right_ident</span><span class="p">,</span>
    <span class="k">min</span><span class="p">(</span><span class="k">left</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span> <span class="k">right</span><span class="p">.</span><span class="n">ident</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_ident</span>
<span class="k">from</span>
    <span class="p">(</span><span class="n">person</span> <span class="k">as</span> <span class="k">left</span> <span class="k">join</span> <span class="n">bi_contact</span> <span class="k">on</span> <span class="k">left</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">bi_contact</span><span class="p">.</span><span class="k">left</span><span class="p">)</span>
    <span class="k">join</span> <span class="n">person</span> <span class="k">as</span> <span class="k">right</span> <span class="k">on</span> <span class="n">bi_contact</span><span class="p">.</span><span class="k">right</span> <span class="o">=</span> <span class="k">right</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/update_group_ids.out">out/update_group_ids.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|       left_name       | left_ident |      right_name       | right_ident | new_ident |
|-----------------------|------------|-----------------------|-------------|-----------|
| Juana Baeza           | 1          | Micaela Laboy         | 4           | 1         |
| Juana Baeza           | 1          | Verónica Altamirano   | 5           | 1         |
| Agustín Rodríquez     | 2          | Ariadna Caraballo     | 3           | 2         |
| Agustín Rodríquez     | 2          | Verónica Altamirano   | 5           | 2         |
| Ariadna Caraballo     | 3          | Agustín Rodríquez     | 2           | 2         |
| Micaela Laboy         | 4          | Juana Baeza           | 1           | 1         |
| Verónica Altamirano   | 5          | Agustín Rodríquez     | 2           | 2         |
| Verónica Altamirano   | 5          | Juana Baeza           | 1           | 1         |
| Reina Rivero          | 6          | Pilar Alarcón         | 10          | 6         |
| Pilar Alarcón         | 10         | Reina Rivero          | 6           | 6         |
| Daniela Menéndez      | 11         | Cristal Soliz         | 13          | 11        |
| Daniela Menéndez      | 11         | Marco Antonio Barrera | 12          | 11        |
| Marco Antonio Barrera | 12         | Cristal Soliz         | 13          | 12        |
| Marco Antonio Barrera | 12         | Daniela Menéndez      | 11          | 11        |
| Cristal Soliz         | 13         | Daniela Menéndez      | 11          | 11        |
| Cristal Soliz         | 13         | Marco Antonio Barrera | 12          | 12        |
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">new_ident</code> is minimum of own identifier and identifiers one step away</li>
    <li>Doesn’t keep people with no contacts</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">recursive labeling</h2>

  <p class="inclusion"><a href="src/recursive_labeling.sql">src/recursive_labeling.sql</a></p>
  <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="k">recursive</span> <span class="n">labeled</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">person</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">name</span><span class="p">,</span>
        <span class="n">person</span><span class="p">.</span><span class="n">ident</span> <span class="k">as</span> <span class="n">label</span>
    <span class="k">from</span>
        <span class="n">person</span>
    <span class="k">union</span> <span class="c1">-- not 'union all'</span>
    <span class="k">select</span>
        <span class="n">person</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">name</span><span class="p">,</span>
        <span class="n">labeled</span><span class="p">.</span><span class="n">label</span> <span class="k">as</span> <span class="n">label</span>
    <span class="k">from</span>
        <span class="p">(</span><span class="n">person</span> <span class="k">join</span> <span class="n">bi_contact</span> <span class="k">on</span> <span class="n">person</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">bi_contact</span><span class="p">.</span><span class="k">left</span><span class="p">)</span>
        <span class="k">join</span> <span class="n">labeled</span> <span class="k">on</span> <span class="n">bi_contact</span><span class="p">.</span><span class="k">right</span> <span class="o">=</span> <span class="n">labeled</span><span class="p">.</span><span class="n">name</span>
    <span class="k">where</span> <span class="n">labeled</span><span class="p">.</span><span class="n">label</span> <span class="o">&lt;</span> <span class="n">person</span><span class="p">.</span><span class="n">ident</span>
<span class="p">)</span>
<span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="k">min</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">as</span> <span class="n">group_id</span>
<span class="k">from</span> <span class="n">labeled</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">name</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span><span class="p">;</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/recursive_labeling.out">out/recursive_labeling.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|         name          | group_id |
|-----------------------|----------|
| Agustín Rodríquez     | 1        |
| Ariadna Caraballo     | 1        |
| Juana Baeza           | 1        |
| Micaela Laboy         | 1        |
| Verónica Altamirano   | 1        |
| Pilar Alarcón         | 6        |
| Reina Rivero          | 6        |
| Elias Merino          | 7        |
| Minerva Guerrero      | 8        |
| Mauro Balderas        | 9        |
| Cristal Soliz         | 11       |
| Daniela Menéndez      | 11       |
| Marco Antonio Barrera | 11       |
| Bernardo Narváez      | 14       |
| Óscar Barrios         | 15       |
</code></pre></div>  </div>

  <ul>
    <li>Use <code class="language-plaintext highlighter-rouge">union</code> instead of <code class="language-plaintext highlighter-rouge">union all</code> to prevent <a href="#g:infinite_recursion">infinite recursion</a></li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">check your understanding</h2>

  <p><img src="./img/concept_map_cte.svg" alt="concept map: common table expressions" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">query from Python</h2>

  <p class="inclusion"><a href="src/basic_python_query.py">src/basic_python_query.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"db/penguins.db"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select count(*) from penguins;"</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/basic_python_query.out">out/basic_python_query.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[(344,)]
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">sqlite3</code> is part of Python’s standard library</li>
    <li>Create a connection to a database file</li>
    <li>Get a <a href="#g:cursor">cursor</a> by executing a query
      <ul>
        <li>More common to create cursor and use that to run queries</li>
      </ul>
    </li>
    <li>Fetch all rows at once as list of tuples</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">incremental fetch</h2>

  <p class="inclusion"><a href="src/incremental_fetch.py">src/incremental_fetch.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"db/penguins.db"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select species, island from penguins limit 5;"</span><span class="p">)</span>
<span class="k">while</span> <span class="n">row</span> <span class="p">:</span><span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/incremental_fetch.out">out/incremental_fetch.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">cursor.fetchone</code> returns <code class="language-plaintext highlighter-rouge">None</code> when no more data</li>
    <li>There is also <code class="language-plaintext highlighter-rouge">fetchmany(N)</code> to fetch (up to) a certain number of rows</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">insert, delete, and all that</h2>

  <p class="inclusion"><a href="src/insert_delete.py">src/insert_delete.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"create table example(num integer);"</span><span class="p">)</span>

<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"insert into example values (10), (20);"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"after insertion"</span><span class="p">,</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from example;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">())</span>

<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"delete from example where num &lt; 15;"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"after deletion"</span><span class="p">,</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from example;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/insert_delete.out">out/insert_delete.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after insertion [(10,), (20,)]
after deletion [(20,)]
</code></pre></div>  </div>

  <ul>
    <li>Each <code class="language-plaintext highlighter-rouge">execute</code> is its own transaction</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">interpolate values</h2>

  <p class="inclusion"><a href="src/interpolate.py">src/interpolate.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"create table example(num integer);"</span><span class="p">)</span>

<span class="n">cursor</span><span class="p">.</span><span class="n">executemany</span><span class="p">(</span><span class="s">"insert into example values (?);"</span><span class="p">,</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,)])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"after insertion"</span><span class="p">,</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from example;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/interpolate.out">out/interpolate.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after insertion [(10,), (20,)]
</code></pre></div>  </div>

  <ul>
    <li>From <a href="https://xkcd.com/327/">XKCD</a></li>
  </ul>

  <p><img src="./img/xkcd_327_exploits_of_a_mom.png" alt="XKCD Exploits of a Mom" /></p>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">script execution</h2>

  <p class="inclusion"><a href="src/script_execution.py">src/script_execution.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s">"""</span><span class="se">\
</span><span class="s">drop table if exists example;
create table example(num integer);
insert into example values (10), (20);
"""</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"after insertion"</span><span class="p">,</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from example;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/script_execution.out">out/script_execution.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after insertion [(10,), (20,)]
</code></pre></div>  </div>

  <ul>
    <li>But what if something goes wrong?</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">SQLite exceptions in Python</h2>

  <p class="inclusion"><a href="src/exceptions.py">src/exceptions.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s">"""</span><span class="se">\
</span><span class="s">create table example(num integer check(num &gt; 0));
insert into example values (10);
insert into example values (-1);
insert into example values (20);
"""</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="p">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">except</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"SQLite exception: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"after execution"</span><span class="p">,</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from example;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/exceptions.out">out/exceptions.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQLite exception: CHECK constraint failed: num &gt; 0
after execution [(10,)]
</code></pre></div>  </div>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">Python in SQLite</h2>

  <p class="inclusion"><a href="src/embedded_python.py">src/embedded_python.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s">"""</span><span class="se">\
</span><span class="s">create table example(num integer);
insert into example values (-10), (10), (20), (30);
"""</span>


<span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">20</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">":memory:"</span><span class="p">)</span>
<span class="n">connection</span><span class="p">.</span><span class="n">create_function</span><span class="p">(</span><span class="s">"clip"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select num, clip(num) from example;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/embedded_python.out">out/embedded_python.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-10, 0)
(10, 10)
(20, 20)
(30, 20)
</code></pre></div>  </div>

  <ul>
    <li><a href="https://sqlite.org/">SQLite</a> calls back into Python to execute the function</li>
    <li>Other databases can run Python (and other languages) in the database server process</li>
    <li>Be careful</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">handle dates and times</h2>

  <p class="inclusion"><a href="src/dates_times.py">src/dates_times.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="c1"># Convert date to ISO-formatted string when writing to database
</span><span class="k">def</span> <span class="nf">_adapt_date_iso</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">.</span><span class="n">isoformat</span><span class="p">()</span>


<span class="n">sqlite3</span><span class="p">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">_adapt_date_iso</span><span class="p">)</span>


<span class="c1"># Convert ISO-formatted string to date when reading from database
</span><span class="k">def</span> <span class="nf">_convert_date</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">date</span><span class="p">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>


<span class="n">sqlite3</span><span class="p">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">"date"</span><span class="p">,</span> <span class="n">_convert_date</span><span class="p">)</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s">"""</span><span class="se">\
</span><span class="s">create table events(
    happened date not null,
    description text not null
);
"""</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">":memory:"</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="p">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>

<span class="n">cursor</span><span class="p">.</span><span class="n">executemany</span><span class="p">(</span>
    <span class="s">"insert into events values (?, ?);"</span><span class="p">,</span>
    <span class="p">[(</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s">"started tutorial"</span><span class="p">),</span> <span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="s">"finished tutorial"</span><span class="p">)],</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from events;"</span><span class="p">).</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/dates_times.out">out/dates_times.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(datetime.date(2024, 1, 10), 'started tutorial')
(datetime.date(2024, 1, 29), 'finished tutorial')
</code></pre></div>  </div>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">sqlite3.PARSE_DECLTYPES</code> tells <code class="language-plaintext highlighter-rouge">sqlite3</code> library to use converts based on declared column types</li>
    <li>Adapt on the way in, convert on the way out</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">SQL in Jupyter notebooks</h2>

  <p class="inclusion"><a href="src/install_jupysql.sh">src/install_jupysql.sh</a></p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>jupysql
</code></pre></div>  </div>

  <ul>
    <li>And then inside the notebook:</li>
  </ul>

  <p class="inclusion"><a href="src/load_ext.text">src/load_ext.text</a></p>
  <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%load_ext sql
</code></pre></div>  </div>

  <ul>
    <li>Loads extension</li>
  </ul>

  <p class="inclusion"><a href="src/jupyter_connect.text">src/jupyter_connect.text</a></p>
  <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%sql sqlite:///data/penguins.db
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/jupyter_connect.out">out/jupyter_connect.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connecting to 'sqlite:///data/penguins.db'
</code></pre></div>  </div>

  <ul>
    <li>Connects to database
      <ul>
        <li><code class="language-plaintext highlighter-rouge">sqlite://</code> with two slashes is the protocol</li>
        <li><code class="language-plaintext highlighter-rouge">/data/penguins.db</code> (one leading slash) is a local path</li>
      </ul>
    </li>
    <li>Single percent sign <code class="language-plaintext highlighter-rouge">%sql</code> introduces one-line command</li>
    <li>Use double percent sign <code class="language-plaintext highlighter-rouge">%%sql</code> to indicate that the rest of the cell is SQL</li>
  </ul>

  <p class="inclusion"><a href="src/jupyter_select.text">src/jupyter_select.text</a></p>
  <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%%sql
select species, count(*) as num
from penguins
group by species;
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/jupyter_select.out">out/jupyter_select.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running query in 'sqlite:///data/penguins.db'
</code></pre></div>  </div>

  <table>
  <thead>
    <tr>
      <th>species</th>
      <th>num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Adelie</td>
      <td>152</td>
    </tr>
    <tr>
      <td>Chinstrap</td>
      <td>68</td>
    </tr>
    <tr>
      <td>Gentoo</td>
      <td>124</td>
    </tr>
  </tbody>
</table>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">Pandas and SQL</h2>

  <p class="inclusion"><a href="src/install_pandas.sh">src/install_pandas.sh</a></p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>pandas
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/select_pandas.py">src/select_pandas.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"db/penguins.db"</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s">"select species, count(*) as num from penguins group by species;"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/select_pandas.out">out/select_pandas.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>species  num
0     Adelie  152
1  Chinstrap   68
2     Gentoo  124
</code></pre></div>  </div>

  <ul>
    <li>Be careful about datatype conversion</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">Polars and SQL</h2>

  <p class="inclusion"><a href="src/install_polars.sh">src/install_polars.sh</a></p>
  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>polars pyarrow adbc-driver-sqlite
</code></pre></div>  </div>

  <p class="inclusion"><a href="src/select_polars.py">src/select_polars.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="n">pl</span>

<span class="n">query</span> <span class="o">=</span> <span class="s">"select species, count(*) as num from penguins group by species;"</span>
<span class="n">uri</span> <span class="o">=</span> <span class="s">"sqlite:///db/penguins.db"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">read_database_uri</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s">"adbc"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/select_polars.out">out/select_polars.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shape: (3, 2)
┌───────────┬─────┐
│ species   ┆ num │
│ ---       ┆ --- │
│ str       ┆ i64 │
╞═══════════╪═════╡
│ Adelie    ┆ 152 │
│ Chinstrap ┆ 68  │
│ Gentoo    ┆ 124 │
└───────────┴─────┘
</code></pre></div>  </div>

  <ul>
    <li>The <a href="#g:uri">Uniform Resource Identifier</a> (URI) specifies the database</li>
    <li>The query is the query</li>
    <li>Use the ADBC engine instead of the default ConnectorX</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">object-relational mapper</h2>

  <p class="inclusion"><a href="src/orm.py">src/orm.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">select</span>


<span class="k">class</span> <span class="nc">Department</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">building</span><span class="p">:</span> <span class="nb">str</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">"sqlite:///db/assays.db"</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Department</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">session</span><span class="p">.</span><span class="k">exec</span><span class="p">(</span><span class="n">statement</span><span class="p">).</span><span class="nb">all</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>  </div>
  <p class="inclusion"><a href="out/orm.out">out/orm.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>building='Chesson' name='Genetics' ident='gen'
building='Fashet Extension' name='Histology' ident='hist'
building='Chesson' name='Molecular Biology' ident='mb'
building='TGVH' name='Endocrinology' ident='end'
</code></pre></div>  </div>

  <ul>
    <li>An <a href="#g:orm">object-relational mapper</a> (ORM) translates table columns to object properties and vice versa</li>
    <li>SQLModel relies on Python type hints</li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="topic">
  <h2 class="topic">relations with ORM</h2>

  <p class="inclusion"><a href="src/orm_relation.py">src/orm_relation.py</a></p>
  <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">select</span>


<span class="k">class</span> <span class="nc">Department</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">building</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># start
</span><span class="k">class</span> <span class="nc">Staff</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">personal</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">family</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dept</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">foreign_key</span><span class="o">=</span><span class="s">"department.ident"</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">"sqlite:///db/assays.db"</span><span class="p">)</span>
<span class="n">SQLModel</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Department</span><span class="p">,</span> <span class="n">Staff</span><span class="p">).</span><span class="n">where</span><span class="p">(</span><span class="n">Staff</span><span class="p">.</span><span class="n">dept</span> <span class="o">==</span> <span class="n">Department</span><span class="p">.</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dept</span><span class="p">,</span> <span class="n">staff</span> <span class="ow">in</span> <span class="n">session</span><span class="p">.</span><span class="k">exec</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">dept</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">staff</span><span class="p">.</span><span class="n">personal</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">staff</span><span class="p">.</span><span class="n">family</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1"># end
</span></code></pre></div>  </div>
  <p class="inclusion"><a href="out/orm_relation.out">out/orm_relation.out</a></p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Histology: Divit Dhaliwal
Molecular Biology: Indrans Sridhar
Molecular Biology: Pranay Khanna
Histology: Vedika Rout
Genetics: Abram Chokshi
Histology: Romil Kapoor
Molecular Biology: Ishaan Ramaswamy
Genetics: Nitya Lal
</code></pre></div>  </div>

  <ul>
    <li>Make foreign keys explicit in class definitions</li>
    <li>SQLModel automatically does the join
      <ul>
        <li>The two staff with no department aren’t included in the result</li>
      </ul>
    </li>
  </ul>

  <!-- ---------------------------------------------------------------- -->
</section>

<section class="aside">
  <h2 class="aside">Appendices</h2>

  <h3 id="terms">Terms</h3>

  <dl>
  
  <dt id="g:1_to_1">1-to-1 relation</dt>
  <dd>A relationship between two tables in which each record from the first table matches exactly one record from the second and vice versa.
</dd>
  
  <dt id="g:1_to_many">1-to-many relation</dt>
  <dd>A relationship between two tables in which each record from the first table matches zero or more records from the second, but each record from the second table matches exactly one record from the first.
</dd>
  
  <dt id="g:aggregation">aggregation</dt>
  <dd>Combining several values to produce one.
</dd>
  
  <dt id="g:aggregation_func">aggregation function</dt>
  <dd>A function used to produce one value from many, such as maximum or addition.
</dd>
  
  <dt id="g:alias">alias</dt>
  <dd>An alternate name used temporarily for a table or column.
</dd>
  
  <dt id="g:atomic">atomic</dt>
  <dd>An operation that cannot be broken into smaller operations.
</dd>
  
  <dt id="g:autoincrement">autoincrement</dt>
  <dd>Automatically add one to a value.
</dd>
  
  <dt id="g:base_case">base case</dt>
  <dd>A starting point for recursion that does not depend on previous recursive calculations.
</dd>
  
  <dt id="g:blob">Binary Large Object (blob)</dt>
  <dd>Bytes that are handled as-is rather than being interpreted as numbers, text, or other data types.
</dd>
  
  <dt id="g:cross_join">cross join</dt>
  <dd>A join that creates the cross-product of rows from two tables.
</dd>
  
  <dt id="g:cte">common table expression (CTE)</dt>
  <dd>A temporary table created at the start of a query, usually to simplify writing the query.
</dd>
  
  <dt id="g:consistent">consistent</dt>
  <dd>A state in which all constraints are satisfied, e.g., all columns contain allowed values and all foreign keys refer to primary keys.
</dd>
  
  <dt id="g:correlated_subquery">correlated subquery</dt>
  <dd>A subquery that depends on a value or values from the enclosing query, and which must therefore be executed once for each of those values.
</dd>
  
  <dt id="g:csv">comma-separated values (CSV)</dt>
  <dd>A text format for tabular data that uses commas to separate columns.
</dd>
  
  <dt id="g:cursor">cursor</dt>
  <dd>A reference to the current location in the results of an ongoing query.
</dd>
  
  <dt id="g:data_migration">data migration</dt>
  <dd>To move data from one form to another, e.g., from one set of tables to a new set or from one DBMS to another.
</dd>
  
  <dt id="g:database">database</dt>
  <dd>A collection of data that can be searched and retrieved.
</dd>
  
  <dt id="g:dbms">database management system (DBMS)</dt>
  <dd>A program that manages a particular kind of database.
</dd>
  
  <dt id="g:denormalization">denormalization</dt>
  <dd>To deliberately introduce duplication or other violate normal forms, typically to improve query performance.
</dd>
  
  <dt id="g:durable">durable</dt>
  <dd>Guaranteed to survive shutdown and restart.
</dd>
  
  <dt id="g:er_diagram">entity-relationship diagram</dt>
  <dd>A graphical depiction of the relationships between tables in a database.
</dd>
  
  <dt id="g:exclusive_or">exclusive or</dt>
  <dd>A Boolean operation that is true if either but not both of its conditions are true. SQL does not provide an exclusive or operator, but the same result can be achieved using operators it has.
</dd>
  
  <dt id="g:filter">filter</dt>
  <dd>To select records based on whether they pass some Boolean test.
</dd>
  
  <dt id="g:foreign_key">foreign key</dt>
  <dd>A value in one table that identifies a primary key in another table.
</dd>
  
  <dt id="g:full_outer_join">full outer join</dt>
  <dd>A join that produces the union of a left outer join and a right outer join.
</dd>
  
  <dt id="g:group">group</dt>
  <dd>A set of records that share a common property, such as having the same value in a particular column.
</dd>
  
  <dt id="g:in_memory_db">in-memory database</dt>
  <dd>A database that is stored in memory rather than on disk.
</dd>
  
  <dt id="g:inclusive_or">inclusive or</dt>
  <dd>A Boolean operator that is true if either or both of its conditions are true. SQL’s <code class="language-plaintext highlighter-rouge">or</code> is inclusive.
</dd>
  
  <dt id="g:index">index</dt>
  <dd>An auxiliary data structure that enables faster access to records.
</dd>
  
  <dt id="g:infinite_recursion">infinite recursion</dt>
  <dd>See “infinite recursion”.
</dd>
  
  <dt id="g:isolated">isolated</dt>
  <dd>The appearance of having executed in an otherwise-idle system.
</dd>
  
  <dt id="g:join">join</dt>
  <dd>To combine records from two tables.
</dd>
  
  <dt id="g:join_condition">join condition</dt>
  <dd>The criteria used to decide which rows from each table in a join are combined.
</dd>
  
  <dt id="g:join_table">join table</dt>
  <dd>A table that exists solely to enable information from two tables to be connected.
</dd>
  
  <dt id="g:left_outer_join">left outer join</dt>
  <dd>A join that is guaranteed to keep all rows from the first (left) table. Columns from the right table are filled with actual values if available or with null otherwise.
</dd>
  
  <dt id="g:many_to_many">many-to-many relation</dt>
  <dd>A relationship between two tables in which each record from the first table may match zero or more records from the second and vice versa.
</dd>
  
  <dt id="g:materialized_view">materialized view</dt>
  <dd>A view that is stored on disk and updated on demand.
</dd>
  
  <dt id="g:normal_form">normal form</dt>
  <dd>One of several (loosely defined) rules for organizing data in tables.
</dd>
  
  <dt id="g:nosql">NoSQL database</dt>
  <dd>Any database that doesn’t use the relational model.
</dd>
  
  <dt id="g:null">null</dt>
  <dd>A special value representing “not known”.
</dd>
  
  <dt id="g:orm">object-relational mapper (ORM)</dt>
  <dd>A library that translates objects in a program into database queries and the results of those queries back into objects.
</dd>
  
  <dt id="g:path_expression">path expression</dt>
  <dd>An expression identifying an element or a set of elements in a JSON structure.
</dd>
  
  <dt id="g:primary_key">primary key</dt>
  <dd>A value or values in a database table that uniquely identifies each record in that table.
</dd>
  
  <dt id="g:query">query</dt>
  <dd>A command to perform some operation in a database (typically data retrieval).
</dd>
  
  <dt id="g:recursive_cte">recursive CTE</dt>
  <dd>A common table expression that refers to itself. Every recursive CTE must have a base case and a recursive case.
</dd>
  
  <dt id="g:recursive_case">recursive case</dt>
  <dd>The second or subsequent step in self-referential accumulation of data.
</dd>
  
  <dt id="g:rdbms">relational database management system (RDBMS)</dt>
  <dd>A database management system that stores data in tables with columns and rows.
</dd>
  
  <dt id="g:subquery">subquery</dt>
  <dd>A query used within another query.
</dd>
  
  <dt id="g:table_valued_func">table-valued function</dt>
  <dd>A function that returns multiple values rather than a single value.
</dd>
  
  <dt id="g:temporary_table">temporary table</dt>
  <dd>A table that is explicitly constructed in memory outside any particular query.
</dd>
  
  <dt id="g:ternary_logic">ternary logic</dt>
  <dd>A logic based on three values: true, false, and “don’t know” (represented as null).
</dd>
  
  <dt id="g:tombstone">tombstone</dt>
  <dd>A marker value added to a record to show that it is no longer active. Tombstones are used as an alternative to deleting data.
</dd>
  
  <dt id="g:trigger">trigger</dt>
  <dd>An action that runs automatically when something happens in a database, typically insertion or deletion.
</dd>
  
  <dt id="g:upsert">upsert</dt>
  <dd>To update a record if it exists or insert (create) a new record if it doesn’t.
</dd>
  
  <dt id="g:uri">Uniform Resource Identifier (URI)</dt>
  <dd>A string that identifies a resource (such as a web page or database) and the protocol used to access it.
</dd>
  
  <dt id="g:view">view</dt>
  <dd>A rearrangement of data in a database that is regenerated on demand.
</dd>
  
  <dt id="g:window_func">window function</dt>
  <dd>A function that combines data from adjacent rows in a database query’s result.
</dd>
  
</dl>

  <h3 id="acknowledgments">Acknowledgments</h3>

  <p>This tutorial would not have been possible without:</p>

  <ul>
    <li><a href="http://andialbrecht.de/">Andi Albrecht</a>’s <a href="https://pypi.org/project/sqlparse/"><code class="language-plaintext highlighter-rouge">sqlparse</code></a> module</li>
    <li><a href="https://tapoueh.org/">Dimitri Fontaine</a>’s <a href="https://theartofpostgresql.com/"><em>The Art of PostgreSQL</em></a></li>
    <li>David Rozenshtein’s <em>The Essence of SQL</em> (now sadly out of print)</li>
  </ul>

  <p>I would also like to thank the following for spotting issues, making suggestions, or submitting changes:</p>

  <ul>
    <li>Phillip Cloud</li>
    <li>Conor Flynn</li>
    <li>Jay Graves</li>
    <li>Sam Hames</li>
    <li>Adam Hawkes</li>
    <li>Robert Kern</li>
    <li>Olivier Leroy</li>
    <li>Kevin Marshall</li>
    <li>Roy Pardee</li>
    <li>Manos Pitsidianakis</li>
    <li>Daniel Possenriede</li>
    <li>Adam Rosien</li>
    <li>Thomas Sandmann</li>
    <li>Simon Willison</li>
  </ul>

</section>


    </main>
    <footer>
  <i class="fa fa-copyright"></i> <time datetime="2024-02-11T06:04:09-05:00">2024</time> Greg Wilson
  &middot;
  <a href="mailto:gvwilson@third-bit.com"><i class="fas fa-envelope-square" aria-hidden="true" title="author email"></i></a>
  <a href=""><i class="fab fa-github" aria-hidden="true" title="GitHub repository"></i></a>
  <a href="./license/"><i class="fab fa-creative-commons-by" aria-hidden="true" title="license"></i></a>
  &middot;
  <time datetime="2024-02-11T06:04:09-05:00">Last built 2024-02-11:06:04:09</time>
</footer>

  </body>
</html>
